<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16-next.png">
  <link rel="mask-icon" href="../images/logo.svg" color="#222">

<link rel="stylesheet" href="../css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"csms.tech","root":"/","images":"../images","scheme":"Gemini","darkmode":true,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeIn","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"../search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="../js/config.js"></script>

    <meta name="description" content="Memory 相关的术语说明 Main Memory - 也经常称为 Physical Memory，计算机上的 Fast Data Storage Area。 Virtual Memory - Main Memory 的一个抽象层，他几乎有无限大的空间，Virtual Memory 不是 Main Memory Resident Memory - 驻留（Reside）在 Main Memory">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux 内存管理">
<meta property="og:url" content="http://csms.tech/202306021537/index.html">
<meta property="og:site_name" content="L B T">
<meta property="og:description" content="Memory 相关的术语说明 Main Memory - 也经常称为 Physical Memory，计算机上的 Fast Data Storage Area。 Virtual Memory - Main Memory 的一个抽象层，他几乎有无限大的空间，Virtual Memory 不是 Main Memory Resident Memory - 驻留（Reside）在 Main Memory">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.csms.tech/img_287.png">
<meta property="og:image" content="https://i.csms.tech/img_288.png">
<meta property="og:image" content="https://i.csms.tech/img_239.png">
<meta property="og:image" content="https://i.csms.tech/img_238.png">
<meta property="article:published_time" content="2023-06-02T07:37:57.000Z">
<meta property="article:modified_time" content="2025-02-04T06:02:00.000Z">
<meta property="article:author" content="COSMOS">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.csms.tech/img_287.png">


<link rel="canonical" href="http://csms.tech/202306021537/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://csms.tech/202306021537/","path":"202306021537/","title":"Linux 内存管理"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Linux 内存管理 | L B T</title>
  








  <noscript>
    <link rel="stylesheet" href="../css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">L B T</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记 录 过 去 的 经 验</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="../index.html" rel="section"><i class="fa fa-earth-americas fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="../categories/" rel="section"><i class="fa fa-folder-tree fa-fw"></i>总目录<span class="badge">51</span></a></li><li class="menu-item menu-item-linux"><a href="../categories/Linux" rel="section"><i class="fa fa-brands fa-linux fa-fw"></i>Linux</a></li><li class="menu-item menu-item-python"><a href="../categories/Python" rel="section"><i class="fa fa-brands fa-python fa-fw"></i>Python</a></li><li class="menu-item menu-item-docker"><a href="../categories/Docker" rel="section"><i class="fa fa-brands fa-docker fa-fw"></i>Docker</a></li><li class="menu-item menu-item-kubernetes"><a href="../categories/Kubernetes" rel="section"><i class="fa fa-dharmachakra fa-fw"></i>Kubernetes</a></li><li class="menu-item menu-item-tags"><a href="../tags/" rel="section"><i class="fa fa-tornado fa-fw"></i>标签<span class="badge">79</span></a></li><li class="menu-item menu-item-archives"><a href="../archives/" rel="section"><i class="fa fa-rectangle-list fa-fw"></i>列表<span class="badge">250</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章总目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Memory-%E7%9B%B8%E5%85%B3%E7%9A%84%E6%9C%AF%E8%AF%AD%E8%AF%B4%E6%98%8E"><span class="nav-number">1.</span> <span class="nav-text">Memory 相关的术语说明</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MMU"><span class="nav-number">2.</span> <span class="nav-text">MMU</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Freeing-Memory"><span class="nav-number">3.</span> <span class="nav-text">Freeing Memory</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%86%85%E5%AD%98%E5%88%86%E5%B1%82%E7%BB%93%E6%9E%84"><span class="nav-number">4.</span> <span class="nav-text">进程的内存分层结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#OOM"><span class="nav-number">5.</span> <span class="nav-text">OOM</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Slab"><span class="nav-number">6.</span> <span class="nav-text">Slab</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Memory-Paging"><span class="nav-number">7.</span> <span class="nav-text">Memory Paging</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%86%85%E5%AD%98%E5%88%86%E9%A1%B5%E5%A4%A7%E5%B0%8F"><span class="nav-number">7.1.</span> <span class="nav-text">查看内存分页大小</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%85%E9%99%A4%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84%E5%88%86%E9%A1%B5%E7%BC%93%E5%AD%98"><span class="nav-number">7.2.</span> <span class="nav-text">清除系统内存中的分页缓存</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E7%8A%B6%E6%80%81%E7%9B%91%E6%B5%8B%E5%B7%A5%E5%85%B7"><span class="nav-number">8.</span> <span class="nav-text">内存状态监测工具</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#NUMA-%E6%9E%B6%E6%9E%84%E5%8F%8A%E5%85%B6%E6%80%A7%E8%83%BD%E7%BB%9F%E8%AE%A1%E6%95%B0%E6%8D%AE"><span class="nav-number">8.1.</span> <span class="nav-text">NUMA 架构及其性能统计数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#numastat"><span class="nav-number">8.1.1.</span> <span class="nav-text">numastat</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pmap"><span class="nav-number">8.2.</span> <span class="nav-text">pmap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Memory-Paging-%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E7%9B%91%E6%8E%A7"><span class="nav-number">8.3.</span> <span class="nav-text">Memory Paging 性能数据监控</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vmstat"><span class="nav-number">8.4.</span> <span class="nav-text">vmstat</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PSI"><span class="nav-number">8.5.</span> <span class="nav-text">PSI</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="nav-number">9.</span> <span class="nav-text">内存压力测试工具</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#memtester"><span class="nav-number">9.1.</span> <span class="nav-text">memtester</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#stress-%E5%B7%A5%E5%85%B7"><span class="nav-number">9.2.</span> <span class="nav-text">stress 工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dd"><span class="nav-number">9.3.</span> <span class="nav-text">dd</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#tmpfs"><span class="nav-number">10.</span> <span class="nav-text">tmpfs</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#tmpfs-%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4"><span class="nav-number">10.1.</span> <span class="nav-text">tmpfs 使用步骤</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-Bibliography"><span class="nav-number">11.</span> <span class="nav-text">参考链接|Bibliography</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%84%9A%E6%B3%A8"><span class="nav-number">12.</span> <span class="nav-text">脚注</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">COSMOS</p>
  <div class="site-description" itemprop="description">得 能 莫 忘</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="../archives/">
          <span class="site-state-item-count">250</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="../categories/">
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">目录</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="../tags/">
        <span class="site-state-item-count">79</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202306021537/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Linux 内存管理 | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux 内存管理
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-06-02 15:37:57" itemprop="dateCreated datePublished" datetime="2023-06-02T15:37:57+08:00">2023-06-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-04 14:02:00" itemprop="dateModified" datetime="2025-02-04T14:02:00+08:00">2025-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="Memory-相关的术语说明"><a href="#Memory-相关的术语说明" class="headerlink" title="Memory 相关的术语说明"></a>Memory 相关的术语说明</h1><ul>
<li><code>Main Memory</code> - 也经常称为 <code>Physical Memory</code>，计算机上的 Fast Data Storage Area。</li>
<li><code>Virtual Memory</code> - Main Memory 的一个抽象层，他几乎有无限大的空间，Virtual Memory 不是 Main Memory</li>
<li><code>Resident Memory</code> - 驻留（Reside）在 Main Memory 中的内存，相当于实际使用的物理内存（Main Memory&#x2F;Physical Memory），如 <code>top</code> 命令中的 <code>RES</code>、<code>ps aux</code> 命令中的 <code>RSS</code> 就是指 Resident Memory.</li>
<li><code>Anonymous Memory</code> - 未关联文件系统位置和路径的内存，通常指 Process Address Space 中的程序运行过程中的数据（Working Data），通常被称为 <code>Heap</code></li>
<li><code>Address Space</code> - 内存地址空间，内存地址相关的上下文（Context），包含程序（Processes）和内核（Kernel）使用的 Virtual Address Space</li>
<li><code>Segment</code> - 用于标识 Virtual Memory 中的有特殊作用的一个区域，如可执行程序（Executable）或可写（Writable）的 Page</li>
<li><code>Instruction Text</code> - CPU 指令（Instructions） 在内存中的引用地址，通常位于 <code>Segment</code> 中</li>
<li><code>OOM</code> - Out Of Memory，当内核检测到系统可用内存不足时采取的动作</li>
<li><code>Page</code> - OS 和 CPU 使用和分配内存的单位，早期大小一般为 4 或 8 Kbytes，现代化的 CPU 和 OS 通常支持 Multi Page Sizes</li>
<li><code>Page Fault</code> - 通常在需要访问的内容不存在于 Virtual Memory 中时，系统产生一个中断，导致所需内容加载入内存</li>
<li><code>Paging</code> - 当内存中的内容不再使用或内存空间不足时进行的在内存和 Storage Devices 中的内容交换，主要是为了空出内存供需要内存的进程使用</li>
<li><code>Swapping</code> - Linux 中将不再使用或内存空间不足时，将部分内存中的内容 Paging 到 Swap Devices</li>
<li><code>Swap</code> - Linux 中 Swapping 时，将内容转移到的目标，可能是 Storage Devices 上的一个区域，被称为 Physical Swap Device，或者是一个文件系统文件，称为 Swap File。</li>
</ul>
<p><a href="https://csms.tech/202405311003/#Memory">Memory 部分概念详细说明参考</a></p>
<h1 id="MMU"><a href="#MMU" class="headerlink" title="MMU"></a>MMU</h1><p>Memory Management Unit（MMU） 负责虚拟内存地址（Virtual Memory Address）到物理内存地址（Physical Memory Address）的转换</p>
<p><img src="https://i.csms.tech/img_287.png"></p>
<h1 id="Freeing-Memory"><a href="#Freeing-Memory" class="headerlink" title="Freeing Memory"></a>Freeing Memory</h1><p>当系统上可用内存低或不足时，系统会采用一系列的手段释放内存。主要包括下图所示方式<br><img src="https://i.csms.tech/img_288.png"></p>
<ul>
<li><strong>Free List</strong><br>  不在使用中的 Pages 列表，也称为 Idle Memory，这部分内存可以被系统立即分配给需要的程序使用</li>
<li><strong>Page Cache</strong><br>  文件系统缓存（Filesystem Cache）。有个 <code>swappiness</code> 的参数可以配置系统是使用 <code>Page Cache</code> 还是 <code>Swapping</code> 来释放内存</li>
<li><strong>Swapping</strong><br>  通过内核进程 <code>kswapd</code> 实现 Paging Out 到 Swap Device 或者 File System-Based Swap File，这只有在系统上有 Swap 时才有用。</li>
<li><strong>Reaping</strong><br>  也被称为 <strong>Shrinking</strong> ，当系统可用内存小到一个临界值后，内核就会开始释放可以回收的内存</li>
<li><strong>OOM Killer</strong><br>  <strong>Out Of Memory Killer</strong> ，系统内存不足时，系统会使用 OOM Killer 机制来 kill 掉某个进程来释放内存。</li>
</ul>
<p>在 Linux 中，当系统可用内存低于阈值（<code>vm.min_free_kbytes</code>）时，Page Out Daemon（<code>kswapd</code>） 会启动 <strong>Page Scanning</strong> ，</p>
<h1 id="进程的内存分层结构"><a href="#进程的内存分层结构" class="headerlink" title="进程的内存分层结构"></a>进程的内存分层结构</h1><p>进程的内存结构一般被分成多个 <code>segment</code>，包括</p>
<ul>
<li><strong><code>Executable Text segment</code></strong> - 存放程序代码（the executable CPU Instructions）, 只读</li>
<li><strong><code>Executable Data section</code></strong> - 存放程序初始化全局变量（global variables），通常 <strong>可读写</strong> ，写权限用于程序运行期间更新变量值。</li>
<li><strong><code>Heap section</code></strong> - 程序运行过程中动态分配的内存，属于 Anonymous Memory</li>
<li><strong><code>Stack section</code></strong> - 调用程序功能时的临时数据存储，如函数参数、返回地址、本地变量等。</li>
</ul>
<p><img src="https://i.csms.tech/img_239.png"></p>
<p>下图展示了 C 程序（Program）在内存中的分层结构(layout of a C program in memory)<br><img src="https://i.csms.tech/img_238.png"></p>
<blockquote>
<ul>
<li>其中， <strong><code>Data section</code></strong>  被分成了 2 部分，包括 <code>(a) initialized data</code> 和 <code>(b) uninitialized data</code></li>
</ul>
</blockquote>
<p>使用 GNU 工具 <code>size</code> 可以检查 <strong>Projram</strong> 在磁盘上的 <strong>内存布局</strong>。这些值在程序编译时确定，并不会在程序运行时变化，因此它们是固定不变的。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">size /usr/sbin/sshd</span></span><br><span class="line">   text	   data	    bss	    dec	    hex	filename</span><br><span class="line"> 817397	  15460	  37664	 870521	  d4879	/usr/sbin/sshd</span><br></pre></td></tr></table></figure>
<p>输出信息中：</p>
<ul>
<li><code>text</code> : 代表 <code>Text section</code> 的大小</li>
<li><code>data</code> : 初始化数据段(<code>initialized data</code>)的大小，包含已初始化的全局和静态变量。</li>
<li><code>bss</code> : 未初始化数据段的大小，包含未初始化的全局和静态变量。</li>
<li><code>dec</code> : 上述所有部分的总大小，以十进制表示。</li>
<li><code>hex</code> : 上述所有部分的总大小，以十六进制表示。</li>
</ul>
<span id="more"></span>

<h1 id="OOM"><a href="#OOM" class="headerlink" title="OOM"></a>OOM</h1><p><code>OOM (Out-Of-memory)</code> 是 Linux 内核机制（<code>kernel reaper routine</code>），用来确保系统始终有可用内存。当系统可用内存太低时，系统使用 OOM 机制 Kill 掉选中的进程以释放内存空间。Linux 中的每个进程有一个 <code>OOM Score</code>值，值越大，被 Kill 掉的可能性越大，OOM 值是根据所使用的内存占比计算而来，占用内存比例越高，OOM Score 越大。可以在 <code>/proc/&lt;PID&gt;/oom_score</code> 中看到 OOM Score 值</p>
<h1 id="Slab"><a href="#Slab" class="headerlink" title="Slab"></a>Slab</h1><p>Linux 内核中的 <strong>slab 分配器（slab allocator）</strong> 是一种专门用于内核对象内存管理的内存分配机制。它最早由 Jeff Bonwick 在 SunOS 中引入，后来被移植到 Linux 内核中，用于高效地分配和回收小内核对象。</p>
<ol>
<li><p><strong>背景与动机</strong></p>
<p> 在内核中，许多数据结构（如 <code>inode</code> 、 <code>dentry</code> 、 <code>task_struct</code> 、 <code>buffer_head</code> 等）通常较小且创建与销毁频繁。如果为每个对象单独申请一个完整的内存页（通常 <code>4KB</code> ），不仅浪费内存，还会增加内存分配与释放的开销。传统的分配器（如伙伴系统）虽然适合管理大块内存，但在处理大量小对象时容易导致内部碎片和效率低下。为了解决这一问题，内核引入了 slab 分配器，其目标是：</p>
<ul>
<li><strong>高效重用</strong> ： 通过缓存已经分配好的内存块，避免重复初始化；</li>
<li><strong>减少碎片</strong> ： 将内存按照对象大小进行预先划分，尽量减少内存浪费；</li>
<li><strong>快速分配与释放</strong> ： 为频繁分配和释放的小对象提供更快的内存管理方案。</li>
</ul>
</li>
<li><p><strong>工作原理</strong></p>
<p> <strong>slab Allocator</strong> 的基本思想是将内存分成一个个 <code>slab</code>（即内存块或缓存区），每个 <code>slab</code> 用来存储某一种类型的内核对象。其核心工作流程如下：</p>
<p> <strong>预先分配</strong></p>
<ul>
<li>内核根据需要为某一类型的对象创建一个或多个 <code>slab</code> ，每个 <code>slab</code> 包含多个固定大小的内存块。</li>
</ul>
<p> <strong>对象缓存</strong></p>
<ul>
<li>当内核请求分配对象时，首先从相应类型的 <code>slab</code> 缓存中查找空闲的内存块，如果有空闲块就直接返回并标记为使用中；如果没有，则从 <code>buddy</code> 分配器中申请新的内存页来创建新的 <code>slab</code> 。</li>
</ul>
<p> <strong>对象释放</strong></p>
<ul>
<li>当对象不再使用时，不会立即释放回全局内存池，而是归还到 <code>slab</code> 缓存中供以后重用。</li>
</ul>
<p> <strong>回收和扩展</strong></p>
<ul>
<li><code>slab Allocator</code> 还会对 <code>slab</code> 的使用情况进行监控，若某个 <code>slab</code> 长时间没有被使用，可能会被回收；反之，若对象需求增加，则动态扩展 <code>slab</code> 缓存。</li>
</ul>
</li>
<li><p><strong>数据结构与实现</strong></p>
<p> 在 Linux 内核中，<code>slab Allocator</code> (分配器)主要使用以下几个数据结构：</p>
<ul>
<li><p><strong>slab cache（缓存）</strong></p>
<p>  每种需要频繁分配的对象都有一个对应的 <code>slab cache</code>（例如 <code>dentry_cache</code> 、 <code>inode_cache</code> 等）。该缓存记录了每个 <code>slab</code> 的信息，包括 <code>slab</code> 列表、空闲对象列表、对象大小等。</p>
</li>
<li><p><strong>slab（缓存块）</strong></p>
<p>  每个 <code>slab</code> 是由一个或多个连续的内存页构成，内部划分为若干个相同大小的对象区域。每个 <code>slab</code> 维护一个链表，用于记录哪些对象是空闲的，哪些是正在使用的。</p>
</li>
<li><p><strong>对象（object）</strong></p>
<p>  每个对象就是一个固定大小的内存块，用于存储内核数据结构。对象的大小是固定的，由 <code>slab cache</code> 在创建时确定。</p>
</li>
</ul>
</li>
<li><p><strong>常见的实现版本有</strong> ：</p>
<ul>
<li><strong>SLAB</strong> ： 早期的 slab 分配器实现；</li>
<li><strong>SLUB</strong> ： 目前较常用的实现，代码更简单、调试更友好，并且对 NUMA 支持较好；</li>
<li><strong>SLOB</strong> ： 专门针对内存资源较少的嵌入式系统设计，适用于内存较小的场景。</li>
</ul>
</li>
<li><p><strong>优势与不足</strong></p>
<p> <strong>优势</strong></p>
<ul>
<li><strong>效率高</strong> ：通过缓存机制避免了频繁的内存初始化和释放，提高了分配速度。</li>
<li><strong>降低碎片化</strong> ：对象尺寸固定，内存分配更精细，减少了内部碎片问题。</li>
<li><strong>重用性好</strong> ：内核对象一旦创建，可以在多个请求中反复使用，降低了整体内存开销。</li>
<li><strong>实时性</strong> ：slab 分配器支持快速的对象分配和回收，满足内核对实时性的要求。</li>
</ul>
<p><strong>不足</strong></p>
<ul>
<li><strong>内存占用问题</strong> ：为了保持一定的缓存，slab 分配器可能会预留一些未被使用的内存，导致一定的内存浪费，尤其在系统负载低时可能看起来 <em>闲置</em> 的内存较多。</li>
<li><strong>复杂性</strong> ：对于内核开发者来说，slab 分配器的内部实现较为复杂，不同版本（SLAB、SLUB、SLOB）各有特点和调优方式。</li>
</ul>
</li>
</ol>
<p>系统管理员可以通过查看 <code>/proc/slabinfo</code> 和使用工具如 <code>slabtop</code> 来监控 Slab Allocator (分配器)的状态，观察哪些缓存占用内存较多，以便进行性能调优和内存泄漏检测。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">slabtop -o</span></span><br><span class="line"> Active / Total Objects (% used)    : 4595213 / 5203376 (88.3%)</span><br><span class="line"> Active / Total Slabs (% used)      : 137883 / 137883 (100.0%)</span><br><span class="line"> Active / Total Caches (% used)     : 128 / 177 (72.3%)</span><br><span class="line"> Active / Total Size (% used)       : 690123.11K / 836332.98K (82.5%)</span><br><span class="line"> Minimum / Average / Maximum Object : 0.01K / 0.16K / 10.69K</span><br><span class="line"></span><br><span class="line">  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME                   </span><br><span class="line">3436563 3436563 100%    0.10K  88117       39    352468K buffer_head            </span><br><span class="line">197370  81175  41%    0.02K   1161      170      4644K lsm_file_cache         </span><br><span class="line">187124 104948  56%    0.57K   6683       28    106928K radix_tree_node        </span><br><span class="line">173632 101593  58%    0.50K   5426       32     86816K kmalloc-512            </span><br><span class="line">173460 173435  99%    0.19K   8260       21     33040K dentry                 </span><br><span class="line">135996  77335  56%    0.19K   6476       21     25904K kmalloc-192            </span><br><span class="line">108672  55519  51%    0.03K    849      128      3396K kmalloc-32             </span><br><span class="line"> 70272  33871  48%    0.06K   1098       64      4392K kmalloc-64             </span><br><span class="line"> 59168  14303  24%    0.25K   1849       32     14792K kmalloc-256            </span><br><span class="line"> 55424   9991  18%    0.06K    866       64      3464K vmap_area              </span><br><span class="line"> 51872  48949  94%    0.12K   1621       32      6484K kernfs_node_cache      </span><br><span class="line"> 33664  18854  56%    0.06K    526       64      2104K anon_vma_chain         </span><br><span class="line"> 31239  24021  76%    0.20K    801       39      6408K vm_area_struct         </span><br><span class="line"> 29988  29768  99%    0.04K    294      102      1176K ext4_extent_status     </span><br><span class="line"> 29841  29841 100%    0.19K   1421       21      5684K ext4_groupinfo_4k      </span><br><span class="line"> 28064  11838  42%    0.12K    877       32      3508K kmalloc-128            </span><br><span class="line"> 27324  27197  99%    1.15K   1012       27     32384K ext4_inode_cache       </span><br><span class="line"> 24576  24576 100%    0.02K     96      256       384K kmalloc-16             </span><br><span class="line"> 24025   9748  40%    0.31K    961       25      7688K nf_conntrack  </span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>

<h1 id="Memory-Paging"><a href="#Memory-Paging" class="headerlink" title="Memory Paging"></a>Memory Paging</h1><p><a href="https://csms.tech/202405311003/#Paging">Memory Paging 说明</a></p>
<h2 id="查看内存分页大小"><a href="#查看内存分页大小" class="headerlink" title="查看内存分页大小"></a>查看内存分页大小</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">getconf PAGESIZE</span></span><br><span class="line">4096</span><br></pre></td></tr></table></figure>



<h2 id="清除系统内存中的分页缓存"><a href="#清除系统内存中的分页缓存" class="headerlink" title="清除系统内存中的分页缓存"></a>清除系统内存中的分页缓存</h2><p>如果系统内存不足或者定位内存相关问题，需要清空内存中的分页缓存（Memory Page Cache，将当前没有使用的所有内存分页要么写回到磁盘，要么丢弃），可以使用以下方法</p>
<ul>
<li><code>echo 3 &gt; /proc/sys/vm/drop_caches</code></li>
</ul>
<h1 id="内存状态监测工具"><a href="#内存状态监测工具" class="headerlink" title="内存状态监测工具"></a>内存状态监测工具</h1><h2 id="NUMA-架构及其性能统计数据"><a href="#NUMA-架构及其性能统计数据" class="headerlink" title="NUMA 架构及其性能统计数据"></a>NUMA 架构及其性能统计数据</h2><p><strong>NUMA(Non-Uniform Memory Access)</strong> 架构是有多个处理器插槽（Multiple Processor Sockets）的系统常用 CPU Memory 架构。 <a href="https://csms.tech/202405311003/#NUMA">NUMA 概念说明</a></p>
<p>使用 <code>lscpu</code> 命令可以查看系统上的 NUMA 信息，示例如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lscpu</span></span><br><span class="line">Architecture:          x86_64</span><br><span class="line">CPU op-mode(s):        32-bit, 64-bit</span><br><span class="line">Byte Order:            Little Endian</span><br><span class="line">CPU(s):                56</span><br><span class="line">On-line CPU(s) list:   0-55</span><br><span class="line">Thread(s) per core:    2</span><br><span class="line">Core(s) per socket:    14</span><br><span class="line">Socket(s)：                 2</span><br><span class="line">NUMA node(s)：         2</span><br><span class="line">Vendor ID：           GenuineIntel</span><br><span class="line">CPU family：          6</span><br><span class="line">Model：              79</span><br><span class="line">Model name：        Intel(R) Xeon(R) CPU E5-2680 v4 @ 2.40GHz</span><br><span class="line">Stepping：              1</span><br><span class="line">CPU MHz：             1200.439</span><br><span class="line">CPU max MHz:           3300.0000</span><br><span class="line">CPU min MHz:           1200.0000</span><br><span class="line">BogoMIPS：            4800.21</span><br><span class="line">Hypervisor vendor：           VT-x</span><br><span class="line">L1d cache：          32K</span><br><span class="line">L1i cache：          32K</span><br><span class="line">L2 cache：           256K</span><br><span class="line">L3 cache：           35840K</span><br><span class="line">NUMA node0 CPU(s)：    0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54</span><br><span class="line">NUMA node1 CPU(s)：    1,3,5,7,9,11,13,15,17,19,21,23,25,27,29,31,33,35,37,39,41,43,45,47,49,51,53,55</span><br><span class="line">Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc aperfmperf eagerfpu pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 sdbg fma cx16 xtpr pdcm pcid dca sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm abm 3dnowprefetch epb cat_l3 cdp_l3 invpcid_single ssbd rsb_ctxsw ibrs ibpb stibp tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm cqm rdt_a rdseed adx smap intel_pt xsaveopt cqm_llc cqm_occup_llc cqm_mbm_total cqm_mbm_local dtherm ida arat pln pts md_clear spec_ctrl intel_stibp flush_l1d</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>根据如上输出，可以得到以下 CPU 和 内存以及 NUMA 相关信息：</p>
<ul>
<li><code>Socket(s)：  2</code> ： 系统上存在 2 个物理处理器（2 个插槽中）</li>
<li><code>Core(s) per socket:    14</code> ： 每个物理处理器有 14 个核心（Core）</li>
<li><code>Thread(s) per core</code> ： 每个 Core 上有 2 个物理线程（即 2 个 CPU）。</li>
<li><code>CPU(s):  56</code> : 根据以上的信息，系统上总的 CPU 个数为 2(Sockets) * 14(Cores) * 2(Threads) &#x3D; 56 CPUs</li>
<li><code>On-line CPU(s) list:   0-55</code> ： 所有 CPUs 都可正常工作（On-line），CPU 编号为 0-55</li>
<li><code>NUMA node(s)：   2</code> ： 这 56 个 CPU 被划分为 2 个 NUMA 节点（Node），分别为 <code>NUMA node0</code> 和 <code>NUMA node1</code></li>
<li><code>NUMA node0 CPU(s)</code> ： <code>NUMA node0</code> 包含了编号为 <code>0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54</code> 的 CPU</li>
<li><code>NUMA node1 CPU(s)</code> ： <code>NUMA node1</code> 包含了编号为 <code>1,3,5,7,9,11,13,15,17,19,21,23,25,27,29,31,33,35,37,39,41,43,45,47,49,51,53,55</code> 的 CPU</li>
</ul>
<h3 id="numastat"><a href="#numastat" class="headerlink" title="numastat"></a>numastat</h3><p><code>numastat</code> 命令提供了 NUMA 相关的统计数据。<code>numastat</code> 在 <code>numactl</code> 包中，可能需要安装。通过 <code>numastat</code> 数据，可以有效定位 NUMA 相关的性能瓶颈并进行优化。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">numastat</span> </span><br><span class="line">                           node0           node1</span><br><span class="line">numa_hit              6095298439      1325526809</span><br><span class="line">numa_miss              549449041       871134026</span><br><span class="line">numa_foreign           871134026       549449041</span><br><span class="line">interleave_hit             34449           34600</span><br><span class="line">local_node            6095331131      1325556133</span><br><span class="line">other_node             549416349       871104702</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>以上示例显示系统上存在 2 个 NUMA Node，分别为 <code>node0</code> 和 <code>node1</code>，其他参数说明如下：</p>
<ul>
<li><code>numa_hit</code> ： 该值表示处理器访问本地 NUMA 节点内存的次数。例如，<code>node0</code> 的值为 <code>6095298439</code>，意味着 <code>node0</code> 处理器访问其本地内存的次数为 <code>6095298439</code> 次。</li>
<li><code>numa_miss</code> ： 该值表示处理器访问远程 NUMA 节点内存的次数，即访问不属于当前节点的内存。例如，<code>node0</code> 的值为 <code>549449041</code>，意味着 <code>node0</code> 处理器访问 <code>node1</code> 的内存的次数为 <code>549449041</code> 次。</li>
<li><code>numa_foreign</code> ： 该值表示远程内存的访问次数，<code>numa_foreign</code> 等同于 <code>numa_miss</code>，只是它特别指向其他 NUMA 节点访问本节点的次数。</li>
<li><code>interleave_hit</code> ： 该值表示跨节点间交替分配的内存访问命中的次数。在一些内存配置中，内存被分配为交替访问模式。例如，<code>node0</code> 的值为 <code>34449</code>，意味着有 <code>34449</code> 次跨节点交替分配的内存访问命中。</li>
<li><code>local_node</code> ： 该值表示从当前节点访问本地节点内存的次数。例如，<code>node0</code> 的值为 <code>6095331131</code>，意味着 <code>node0</code> 节点访问了本地节点的内存 <code>6095331131</code> 次。</li>
<li><code>other_node</code> ： 该值表示从当前节点访问其他节点的内存的次数。例如，<code>node0</code> 的值为 <code>549416349</code>，意味着 <code>node0</code> 节点访问了其他节点（<code>node1</code>）的内存 <code>549416349</code> 次。</li>
</ul>
<p>如果要管理和分配 NUMA Node 内存和 CPU 分配，可以使用 Linux 内核提供的 NUMA 管理工具 <code>numactrl</code></p>
<p><strong>查看每个 NUMA Node 的内存使用详细情况</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">free -h</span></span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:            94G         85G        6.2G         27M        2.6G        8.2G</span><br><span class="line">Swap:           31G         31G          0B</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">numastat -m</span></span><br><span class="line"></span><br><span class="line">Per-node system memory usage (in MBs):</span><br><span class="line">                          Node 0          Node 1           Total</span><br><span class="line">                 --------------- --------------- ---------------</span><br><span class="line">MemTotal                48039.76        48379.14        96418.90</span><br><span class="line">MemFree                  5300.99           52.67         5353.66</span><br><span class="line">MemUsed                 42738.77        48326.47        91065.24</span><br><span class="line">Active                  32927.99        45329.47        78257.46</span><br><span class="line">Inactive                 3676.32         2161.68         5838.00</span><br><span class="line">Active(anon)            32791.08        45328.27        78119.35</span><br><span class="line">Inactive(anon)           3326.99         2158.76         5485.75</span><br><span class="line">Active(file)              136.91            1.20          138.11</span><br><span class="line">Inactive(file)            349.33            2.92          352.25</span><br><span class="line">Unevictable                 0.00            0.00            0.00</span><br><span class="line">Mlocked                     0.00            0.00            0.00</span><br><span class="line">Dirty                       0.52            0.00            0.52</span><br><span class="line">Writeback                   0.00            0.00            0.00</span><br><span class="line">FilePages                 540.79           14.50          555.29</span><br><span class="line">Mapped                     47.16            8.71           55.88</span><br><span class="line">AnonPages               36064.04        47476.64        83540.68</span><br><span class="line">Shmem                      17.97            9.51           27.48</span><br><span class="line">KernelStack                 8.41            5.19           13.59</span><br><span class="line">PageTables                 88.83          160.49          249.32</span><br><span class="line">NFS_Unstable                0.00            0.00            0.00</span><br><span class="line">Bounce                      0.00            0.00            0.00</span><br><span class="line">WritebackTmp                0.00            0.00            0.00</span><br><span class="line">Slab                     3835.94          120.64         3956.58</span><br><span class="line">SReclaimable             3429.04           39.62         3468.66</span><br><span class="line">SUnreclaim                406.89           81.02          487.92</span><br><span class="line">AnonHugePages             638.00          376.00         1014.00</span><br><span class="line">HugePages_Total             0.00            0.00            0.00</span><br><span class="line">HugePages_Free              0.00            0.00            0.00</span><br><span class="line">HugePages_Surp              0.00            0.00            0.00</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>以上输出中，相关字段说明如下：</p>
<ul>
<li><code>Active</code> ： 活跃的内存页，即最近使用过的页，分为 <code>Active(anon)</code> （匿名页）和  <code>Active(file) </code> （文件页）。</li>
<li><code>Inactive</code> ： 非活跃的内存页，可能被交换或回收，分为 <code>Inactive(anon)</code> （匿名页）和  <code>Inactive(file) </code> （文件页）。</li>
<li><code>Anonymous Pages</code> : 匿名页，通常是分配给进程的堆或栈，即程序运行过程中产生的数据</li>
<li><code>File Pages</code> ： 文件缓存页，通常用于文件缓存</li>
<li><code>Dirty</code> ： 脏页，尚未写入磁盘的页。文件在内存中已经更改，但是还未刷新写入磁盘</li>
<li><code>Writeback</code> ： 正在写回磁盘的页。</li>
<li><code>Mapped</code> ： 被映射到进程地址空间的内存页。</li>
<li><code>AnonPages</code> ： 匿名页的总量。包括 <code>Active(anon)</code> 和 <code>Inactive(anon)</code></li>
<li><code>Shmem</code> ： 使用共享内存的页。</li>
<li><code>KernelStack</code> ： 分配给内核栈的内存。</li>
</ul>
<p>根据以上输出信息可知，目前系统可用内存还有 <code>8.2G</code>，已使用 <code>85G</code>，根据 <code>numastat -m</code> 输出的信息，可以看到更为详细的内存使用情况：</p>
<ul>
<li>Node 0 的可用内存较多（<code>5300.99 MB</code>），而 Node 1 几乎没有可用内存（<code>52.67 MB</code>）。</li>
<li>Node 1 的 <code>Active</code> 和 <code>AnonPages</code> 比 Node 0 高，可能表示有大量的进程绑定在 Node 1。</li>
<li>匿名页（<code>AnonPages</code>）占据了绝大部分内存（总计 <code>83540.68 MB</code>），表明进程分配的堆和栈内存较多。</li>
<li>文件页（<code>FilePages</code>）总计只有 <code>555.29 MB</code>，说明系统的 I&#x2F;O 缓存使用较少，可能 I&#x2F;O 压力较低。</li>
</ul>
<p>根据以上分析，可以大致通过以下思路优化内存使用：</p>
<ul>
<li>Node 1 的内存使用接近极限（<code>MemFree</code> 仅 <code>52.67 MB</code>）。如果可能，重新分配负载，平衡 NUMA 节点的内存压力。</li>
<li>如果内存分配倾斜严重，可以调整进程绑定策略（如使用 <code>numactl</code> 或调整应用程序配置）。</li>
<li>匿名内存占用过高，可能需要分析应用程序的内存使用情况，优化分配或减少内存泄漏。</li>
<li>如果适用，可以启用大页（HugePages），减少页表开销。</li>
</ul>
<p><strong>查看指定进程在 NUMA Node 上的内存统计数据</strong> ，可以看到进程在各个 NUMA Nodes 上使用的内存，进程可以使用 PID 或者进程名指定，具体规则请查看 <code>man numastat</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">numastat -p nginx</span> </span><br><span class="line"></span><br><span class="line">Per-node process memory usage (in MBs)</span><br><span class="line">PID                             Node 0          Node 1           Total</span><br><span class="line">---------------------  --------------- --------------- ---------------</span><br><span class="line">19093 (nginx)                     1.14            2.68            3.82</span><br><span class="line">19094 (nginx)                   111.97           22.85          134.82</span><br><span class="line">19095 (nginx)                   111.82           22.86          134.67</span><br><span class="line">19096 (nginx)                   108.61           26.57          135.18</span><br><span class="line">19097 (nginx)                   133.85            0.78          134.63</span><br><span class="line">19098 (nginx)                   134.07            0.78          134.86</span><br><span class="line">19099 (nginx)                   115.19           19.42          134.61</span><br><span class="line">19100 (nginx)                   133.68            0.78          134.46</span><br><span class="line">19101 (nginx)                   133.92            0.78          134.70</span><br><span class="line">19102 (nginx)                   120.01           15.09          135.10</span><br><span class="line">19103 (nginx)                   134.19            0.78          134.97</span><br><span class="line">19104 (nginx)                   117.56           17.11          134.67</span><br><span class="line">19105 (nginx)                   134.18            0.78          134.96</span><br><span class="line">19107 (nginx)                   123.85           10.89          134.74</span><br><span class="line">19108 (nginx)                   133.75            0.78          134.53</span><br><span class="line">19109 (nginx)                   125.45            9.31          134.76</span><br><span class="line">19110 (nginx)                   125.35            9.88          135.23</span><br><span class="line">19111 (nginx)                   127.91            7.35          135.26</span><br><span class="line">19112 (nginx)                   129.58            6.88          136.45</span><br><span class="line">19113 (nginx)                   133.79            0.78          134.57</span><br><span class="line">19114 (nginx)                   127.70            7.44          135.13</span><br><span class="line">19115 (nginx)                     1.40            3.73            5.13</span><br><span class="line">23050 (node_exporter)            16.91            0.02           16.93</span><br><span class="line">---------------------  --------------- --------------- ---------------</span><br><span class="line">Total                          2535.86          188.34         2724.19</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="pmap"><a href="#pmap" class="headerlink" title="pmap"></a>pmap</h2><p><code>pmap</code> 命令会显示进程的 Memory Mappings（内存地址映射），包括 <em>内存地址</em> 、 <em>大小</em> 、 <em>权限</em> 、 <em>Mapped Objects（映射的对象）</em> 。详细说明请参考 <code>man pmap</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pmap 19112</span></span><br><span class="line">19112:   nginx: worker process                                                    </span><br><span class="line">0000000000400000   1052K r-x-- nginx</span><br><span class="line">0000000000706000      4K r---- nginx</span><br><span class="line">0000000000707000     88K rw--- nginx</span><br><span class="line">000000000071d000    208K rw---   [ anon ]</span><br><span class="line">00007f520dcf1000   5120K rw-s- zero (deleted)</span><br><span class="line">00007f520e1f1000     48K r-x-- libnss_files-2.17.so</span><br><span class="line">00007f520e628000      4K rw--- libselinux.so.1</span><br><span class="line">00007f520e629000      8K rw---   [ anon ]</span><br><span class="line">00007f520e62b000     88K r-x-- libresolv-2.17.so</span><br><span class="line">00007f520ea47000      4K r---- libkeyutils.so.1.5</span><br><span class="line">00007f520ea48000      4K rw--- libkeyutils.so.1.5</span><br><span class="line">00007f520ea49000     56K r-x-- libkrb5support.so.0.1</span><br><span class="line">00007f520ee6d000      4K r---- libgcc_s-4.8.5-20150702.so.1</span><br><span class="line">00007f520ee6e000      4K rw--- libgcc_s-4.8.5-20150702.so.1</span><br><span class="line">00007f520ee6f000   1028K r-x-- libm-2.17.so</span><br><span class="line">00007f520f462000      8K rw--- libstdc++.so.6.0.19</span><br><span class="line">00007f520f479000    196K r-x-- libk5crypto.so.3.1</span><br><span class="line">...</span><br><span class="line">00007f5211991000      4K rw---   [ anon ]</span><br><span class="line">00007fff7b380000    132K rw---   [ stack ]</span><br><span class="line">00007fff7b3a6000      8K r-x--   [ anon ]</span><br><span class="line">ffffffffff600000      4K r-x--   [ anon ]</span><br><span class="line"> total           215628K</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>使用 <code>-x, --extended</code> 选项显示扩展信息，主要是显示更为详细的 Virtual Memory 和 RSS 信息</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pmap -x 19112</span></span><br><span class="line">19112:   nginx: worker process                                                    </span><br><span class="line">Address           Kbytes     RSS   Dirty Mode  Mapping</span><br><span class="line">0000000000400000    1052     476       0 r-x-- nginx</span><br><span class="line">0000000000706000       4       4       4 r---- nginx</span><br><span class="line">0000000000707000      88      84      76 rw--- nginx</span><br><span class="line">000000000071d000     208      28      28 rw---   [ anon ]</span><br><span class="line">...</span><br><span class="line">ffffffffff600000       4       0       0 r-x--   [ anon ]</span><br><span class="line">---------------- ------- ------- ------- </span><br><span class="line">total kB          215628  139768  137324</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>使用 <code>-X</code> 或者 <code>-XX</code> 选项显示更详细的扩展信息</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pmap -X 19112</span></span><br><span class="line">19112:   nginx: worker process                                                    </span><br><span class="line">         Address Perm   Offset Device       Inode   Size    Rss    Pss Referenced Anonymous Swap Locked Mapping</span><br><span class="line">        00400000 r-xp 00000000  08:04 10741908403   1052    476     26        476         0    0      0 nginx</span><br><span class="line">        00706000 r--p 00106000  08:04 10741908403      4      4      0          4         4    0      0 nginx</span><br><span class="line">        00707000 rw-p 00107000  08:04 10741908403     88     84     22         84        76    0      0 nginx</span><br><span class="line">        0071d000 rw-p 00000000  00:00           0    208     28     20         24        28    0      0 </span><br><span class="line">        00f5b000 rw-p 00000000  00:00           0   3912   3912   3282       3564      3912    0      0 [heap]</span><br><span class="line">        0132d000 rw-p 00000000  00:00           0   2092   1964   1964       1936      1964    0      0 [heap]</span><br><span class="line">    7f5204c61000 rw-p 00000000  00:00           0 132672 130720 130720     124988    130720    0      0 </span><br><span class="line">    7f520cdf1000 rw-s 00000000  00:04   811209810  10240      0      0          0         0    0      0 zero (deleted)</span><br><span class="line">    7f520d7f1000 rw-s 00000000  00:04   811209809   5120      0      0          0         0    0      0 zero (deleted)</span><br><span class="line">    7f520dcf1000 rw-s 00000000  00:04   811209808   5120      0      0          0         0    0      0 zero (deleted)</span><br><span class="line">    7f520e1f1000 r-xp 00000000  08:04 12884906638     48      8      0          8         0    0      0 libnss_files-2.17.so</span><br><span class="line">    7f520e1fd000 ---p 0000c000  08:04 12884906638   2044      0      0          0         0    0      0 libnss_files-2.17.so</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>使用 <code>-p, --show-path</code> 选项显示更详细的引用路径信息</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pmap -x -p 19112</span></span><br><span class="line">19112:   nginx: worker process                                                    </span><br><span class="line">Address           Kbytes     RSS   Dirty Mode  Mapping</span><br><span class="line">0000000000400000    1052     476       0 r-x-- /usr/local/nginx/sbin/nginx</span><br><span class="line">0000000000706000       4       4       4 r---- /usr/local/nginx/sbin/nginx</span><br><span class="line">0000000000707000      88      84      76 rw--- /usr/local/nginx/sbin/nginx</span><br><span class="line">000000000071d000     208      28      28 rw---   [ anon ]</span><br><span class="line">0000000000f5b000    3912    3912    3912 rw---   [ anon ]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Memory-Paging-性能数据监控"><a href="#Memory-Paging-性能数据监控" class="headerlink" title="Memory Paging 性能数据监控"></a>Memory Paging 性能数据监控</h2><p><code>sar</code> 命令的 <code>-B	Paging statistics</code> 选项提供了内存 Paging 相关的统计数据。 <a href="https://csms.tech/202301171137/#sar-检查系统-Memory-Paging-统计数据"><code>sar -B</code> 命令及输出字段解释</a></p>
<h2 id="vmstat"><a href="#vmstat" class="headerlink" title="vmstat"></a>vmstat</h2><p><code>vmstat</code> 是一个系统全局性（System Wide）工具，主要用来监测 Virtual 和 Physical Memory 的统计数据 </p>
<p><a href="https://csms.tech/202301171137/#vmstat"><code>vmstat</code> 使用介绍</a></p>
<h2 id="PSI"><a href="#PSI" class="headerlink" title="PSI"></a>PSI</h2><p><strong>PSI(Pressure Stall Information)</strong> 是 Linux 4.20 引进的一个新特性，用于提供有关 CPU、内存和 IO 子系统的资源压力信息。PSI 帮助管理员和开发者理解系统的资源瓶颈，优化性能和可靠性。</p>
<p><a href="https://csms.tech/20241128094720/#Pressure-Stall-Information">PSI 介绍</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /proc/pressure/memory</span></span><br><span class="line">some avg10=2.84 avg60=1.23 avg300=0.32 total=1468344</span><br><span class="line">full avg10=1.85 avg60=0.66 avg300=0.16 total=702578</span><br></pre></td></tr></table></figure>
<p>在以上的 PSI 统计数据中，可以看出 Memory 压力在持续增加，10s 的平均延迟（2.84）比 300s 的平均延迟（0.32）大了很多。 <strong>这个延迟表述的是进程因为内存原因暂停等待的时间占比</strong></p>
<h1 id="内存压力测试工具"><a href="#内存压力测试工具" class="headerlink" title="内存压力测试工具"></a>内存压力测试工具</h1><h2 id="memtester"><a href="#memtester" class="headerlink" title="memtester"></a>memtester</h2><p>使用 docker 运行工具</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">$ docker run --rm -it dockerpinata/memtester:<span class="number">1</span> memtester</span><br><span class="line">memtester version <span class="number">4.3</span><span class="number">.0</span> (<span class="number">64</span>-bit)</span><br><span class="line">Copyright (C) <span class="number">2001</span>-<span class="number">2012</span> Charles Cazabon.</span><br><span class="line">Licensed under the GNU General Public License version <span class="number">2</span> (only).</span><br><span class="line"></span><br><span class="line">pagesize <span class="keyword">is</span> <span class="number">4096</span></span><br><span class="line">pagesizemask <span class="keyword">is</span> <span class="number">0xfffffffffffff000</span></span><br><span class="line">need memory argument, <span class="keyword">in</span> MB</span><br><span class="line"></span><br><span class="line">Usage: memtester [-p physaddrbase [-d device]] &lt;mem&gt;[B|K|M|G] [loops]</span><br></pre></td></tr></table></figure>

<h2 id="stress-工具"><a href="#stress-工具" class="headerlink" title="stress 工具"></a>stress 工具</h2><p><code>stress</code> 是一个用于模拟系统负载的工具，可以使用它来创建临时的内存负载。通过模拟负载，系统将使用更多的内存。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">yum install -y stress</span><br></pre></td></tr></table></figure>
<p>使用以下命令可以创建一个临时的内存负载</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">stress --vm <span class="number">1</span> --vm-<span class="built_in">bytes</span> &lt;MEMORY_SIZE&gt;</span><br></pre></td></tr></table></figure>

<h2 id="dd"><a href="#dd" class="headerlink" title="dd"></a>dd</h2><p><code>dd</code> 命令可以用于创建大文件并占用磁盘空间，从而间接提升系统的内存使用率。您可以使用以下命令创建一个指定大小的临时文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/zero of=tempfile bs=1M count=&lt;MEMORY_SIZE&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="tmpfs"><a href="#tmpfs" class="headerlink" title="tmpfs"></a>tmpfs</h1><p>Linux 中 <code>tmpfs</code> 是一种基于内存的临时文件系统，它将内存作为存储介质，可以在需要快速读写文件的场景下使用。</p>
<p><strong>注意事项</strong>：</p>
<ul>
<li><code>tmpfs</code> 是基于内存的临时文件系统，因此上面的数据在系统重启后将丢失</li>
<li>当 <code>tmpfs</code> 文件系统使用的内存达到上限值，写入操作会失败，因此需要确保分配给 <code>tmpfs</code> 文件系统使用的内存适合需求</li>
<li>要确保系统有足够的可用内存来支持挂载 <code>tmpfs</code> 文件系统。</li>
</ul>
<h2 id="tmpfs-使用步骤"><a href="#tmpfs-使用步骤" class="headerlink" title="tmpfs 使用步骤"></a>tmpfs 使用步骤</h2><ol>
<li>创建一个目录作为文件系统挂载点 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir /mnt/ramdisk/</span><br></pre></td></tr></table></figure></li>
<li>使用 <code>mount</code> 命令以 <code>tmpfs</code> 的类型挂载文件系统 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mount -t tmpfs -o size=1G tmpfs /mnt/ramdisk/</span><br></pre></td></tr></table></figure>
这将在 <code>/mnt/ramdisk</code> 目录下挂载一个 1GB 大小的 <code>tmpfs</code> 文件系统。根据需要调整 <code>size</code> 参数的值。之后便可以像操作其他文件系统一样在 <code>/mnt/ramdisk</code> 目录下读写文件。任何写入该目录的数据都将存储在内存中。</li>
</ol>
<h1 id="参考链接-Bibliography"><a href="#参考链接-Bibliography" class="headerlink" title="参考链接|Bibliography"></a>参考链接|Bibliography</h1><p><a target="_blank" rel="noopener" href="https://s.csms.tech/file/Systems.Performance.Enterprise.and.the.Cloud.2nd.Edition.2020.12.pdf">Systems Performance: Enterprise and the Cloud v2</a></p>
<h1 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h1><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://s.csms.tech/file/Systems.Performance.Enterprise.and.the.Cloud.2nd.Edition.2020.12.pdf">Systems Performance: Enterprise and the Cloud v2</a> #7.1 Terminology<a href="#fnref:1" rev="footnote"> ↩</a></span></li></ol></div></div>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="../tags/Linux/" rel="tag"><i class="fa fa-tag"></i> Linux</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="../202306011739/" rel="prev" title="向 Telegram 发送消息">
                  <i class="fa fa-chevron-left"></i> 向 Telegram 发送消息
                </a>
            </div>
            <div class="post-nav-item">
                <a href="../202306051707/" rel="next" title="Grafana 使用">
                  Grafana 使用 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">COSMOS</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="300" alpha="0.3" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="../js/comments.js"></script><script src="../js/utils.js"></script><script src="../js/motion.js"></script><script src="../js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="../js/third-party/search/local-search.js"></script>




  <script src="../js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"fl9999","repo":"fl9999.github.io","client_id":"a11bf6f7860762b725b5","client_secret":"a99046105f8bddc72ec718d54dc3fd7f22070821","admin_user":"fl9999","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"d41d8cd98f00b204e9800998ecf8427e"}</script>
<script src="../js/third-party/comments/gitalk.js"></script>

</body>
</html>
