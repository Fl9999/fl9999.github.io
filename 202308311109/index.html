<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16-next.png">
  <link rel="mask-icon" href="../images/logo.svg" color="#222">

<link rel="stylesheet" href="../css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"csms.tech","root":"/","images":"../images","scheme":"Gemini","darkmode":true,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeIn","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"../search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="../js/config.js"></script>

    <meta name="description" content="环境信息 Centos 7 ansible-core 2.16 Docker image python:3.12.3  安装ansible-core 版本及 Python 版本支持对应关系    ansible-core Version Control Node Python Target Python &#x2F; PowerShell    2.16 Python 3.10 - 3.12 Py">
<meta property="og:type" content="article">
<meta property="og:title" content="Ansible 使用介绍">
<meta property="og:url" content="http://csms.tech/202308311109/index.html">
<meta property="og:site_name" content="L B T">
<meta property="og:description" content="环境信息 Centos 7 ansible-core 2.16 Docker image python:3.12.3  安装ansible-core 版本及 Python 版本支持对应关系    ansible-core Version Control Node Python Target Python &#x2F; PowerShell    2.16 Python 3.10 - 3.12 Py">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-08-31T03:09:16.000Z">
<meta property="article:modified_time" content="2025-03-06T06:03:00.000Z">
<meta property="article:author" content="COSMOS">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="ansible">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://csms.tech/202308311109/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://csms.tech/202308311109/","path":"202308311109/","title":"Ansible 使用介绍"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Ansible 使用介绍 | L B T</title>
  








  <noscript>
    <link rel="stylesheet" href="../css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">L B T</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记 录 过 去 的 经 验</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="../index.html" rel="section"><i class="fa fa-earth-americas fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="../categories/" rel="section"><i class="fa fa-folder-tree fa-fw"></i>总目录<span class="badge">51</span></a></li><li class="menu-item menu-item-linux"><a href="../categories/Linux" rel="section"><i class="fa fa-brands fa-linux fa-fw"></i>Linux</a></li><li class="menu-item menu-item-python"><a href="../categories/Python" rel="section"><i class="fa fa-brands fa-python fa-fw"></i>Python</a></li><li class="menu-item menu-item-docker"><a href="../categories/Docker" rel="section"><i class="fa fa-brands fa-docker fa-fw"></i>Docker</a></li><li class="menu-item menu-item-kubernetes"><a href="../categories/Kubernetes" rel="section"><i class="fa fa-dharmachakra fa-fw"></i>Kubernetes</a></li><li class="menu-item menu-item-tags"><a href="../tags/" rel="section"><i class="fa fa-tornado fa-fw"></i>标签<span class="badge">78</span></a></li><li class="menu-item menu-item-archives"><a href="../archives/" rel="section"><i class="fa fa-rectangle-list fa-fw"></i>列表<span class="badge">250</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章总目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E4%BF%A1%E6%81%AF"><span class="nav-number">1.</span> <span class="nav-text">环境信息</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ansible-%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="nav-number">3.</span> <span class="nav-text">Ansible 配置说明</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Inventory-%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="nav-number">4.</span> <span class="nav-text">Inventory 配置说明</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Inventory-%E5%A4%9A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%94%AF%E6%8C%81"><span class="nav-number">4.1.</span> <span class="nav-text">Inventory 多配置文件支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#INI-%E6%A0%BC%E5%BC%8F%E7%9A%84-Inventory"><span class="nav-number">4.2.</span> <span class="nav-text">INI 格式的 Inventory</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%98%E9%87%8F"><span class="nav-number">4.2.1.</span> <span class="nav-text">变量</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E4%B8%BB%E6%9C%BA%E5%88%AB%E5%90%8D"><span class="nav-number">4.2.1.1.</span> <span class="nav-text">使用主机别名</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#YAML-%E6%A0%BC%E5%BC%8F%E7%9A%84-Inventory"><span class="nav-number">4.3.</span> <span class="nav-text">YAML 格式的 Inventory</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%98%E9%87%8F-1"><span class="nav-number">4.3.1.</span> <span class="nav-text">变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E5%8F%AF%E4%BB%A5%E4%B8%BA%E6%89%80%E6%9C%89%E4%B8%BB%E6%9C%BA%E5%85%B1%E7%94%A8%E7%9A%84%E5%8F%98%E9%87%8F"><span class="nav-number">4.3.2.</span> <span class="nav-text">定义可以为所有主机共用的变量</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E4%B8%BB%E6%9C%BA%E5%88%AB%E5%90%8D-1"><span class="nav-number">4.3.2.1.</span> <span class="nav-text">使用主机别名</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ansible-%E4%BD%BF%E7%94%A8"><span class="nav-number">5.</span> <span class="nav-text">ansible 使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Patterns"><span class="nav-number">5.1.</span> <span class="nav-text">Patterns</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ansible-doc-%E4%BD%BF%E7%94%A8"><span class="nav-number">6.</span> <span class="nav-text">ansible-doc 使用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ansible-inventory"><span class="nav-number">7.</span> <span class="nav-text">ansible-inventory</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ansible-%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="nav-number">8.</span> <span class="nav-text">ansible 常用模块</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#command"><span class="nav-number">8.1.</span> <span class="nav-text">command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shell"><span class="nav-number">8.2.</span> <span class="nav-text">shell</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ping"><span class="nav-number">8.3.</span> <span class="nav-text">ping</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#setup"><span class="nav-number">8.4.</span> <span class="nav-text">setup</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hostname"><span class="nav-number">8.5.</span> <span class="nav-text">hostname</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lineinfile"><span class="nav-number">8.6.</span> <span class="nav-text">lineinfile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#reboot"><span class="nav-number">8.7.</span> <span class="nav-text">reboot</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#service"><span class="nav-number">8.8.</span> <span class="nav-text">service</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#systemd-service"><span class="nav-number">8.9.</span> <span class="nav-text">systemd_service</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#debug"><span class="nav-number">8.10.</span> <span class="nav-text">debug</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF"><span class="nav-number">9.</span> <span class="nav-text">常见错误</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Permission-denied"><span class="nav-number">9.1.</span> <span class="nav-text">Permission denied</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Connection-timed-out"><span class="nav-number">9.2.</span> <span class="nav-text">Connection timed out</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="nav-number">10.</span> <span class="nav-text">参考链接</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%84%9A%E6%B3%A8"><span class="nav-number">11.</span> <span class="nav-text">脚注</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">COSMOS</p>
  <div class="site-description" itemprop="description">得 能 莫 忘</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="../archives/">
          <span class="site-state-item-count">250</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="../categories/">
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">目录</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="../tags/">
        <span class="site-state-item-count">78</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202308311109/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Ansible 使用介绍 | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Ansible 使用介绍
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-08-31 11:09:16" itemprop="dateCreated datePublished" datetime="2023-08-31T11:09:16+08:00">2023-08-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-03-06 14:03:00" itemprop="dateModified" datetime="2025-03-06T14:03:00+08:00">2025-03-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Centos 7</li>
<li>ansible-core 2.16</li>
<li>Docker image python:3.12.3</li>
</ul>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/reference_appendices/release_and_maintenance.html#ansible-core-target-node-python-support"><code>ansible-core</code> 版本及 Python 版本支持对应关系</a></p>
<table>
<thead>
<tr>
<th>ansible-core Version</th>
<th>Control Node Python</th>
<th>Target Python &#x2F; PowerShell</th>
</tr>
</thead>
<tbody><tr>
<td>2.16</td>
<td>Python 3.10 - 3.12</td>
<td>Python 2.7<br/>Python 3.6 - 3.12<br/>Powershell 3 - 5.1</td>
</tr>
</tbody></table>
<p>为了环境部署方便灵活，可以选择使用 <code>python:3.12.3</code> 的 Docker 镜像，以其为基础环境安装 <code>ansible-core 2.16</code> 或者直接使用 <code>ansible</code> 镜像启动。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker run --<span class="built_in">rm</span> -it python:3.12.3 bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /etc/os-release</span> </span><br><span class="line">PRETTY_NAME=&quot;Debian GNU/Linux 12 (bookworm)&quot;</span><br><span class="line">NAME=&quot;Debian GNU/Linux&quot;</span><br><span class="line">VERSION_ID=&quot;12&quot;</span><br><span class="line">VERSION=&quot;12 (bookworm)&quot;</span><br><span class="line">VERSION_CODENAME=bookworm</span><br><span class="line">ID=debian</span><br><span class="line">HOME_URL=&quot;https://www.debian.org/&quot;</span><br><span class="line">SUPPORT_URL=&quot;https://www.debian.org/support&quot;</span><br><span class="line">BUG_REPORT_URL=&quot;https://bugs.debian.org/&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">python --version</span></span><br><span class="line">Python 3.12.3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pip install ansible</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pip list</span></span><br><span class="line">Package      Version</span><br><span class="line">------------ -------</span><br><span class="line">ansible      9.5.1</span><br><span class="line">ansible-core 2.16.6</span><br><span class="line">cffi         1.16.0</span><br><span class="line">cryptography 42.0.7</span><br><span class="line">Jinja2       3.1.4</span><br><span class="line">MarkupSafe   2.1.5</span><br><span class="line">packaging    24.0</span><br><span class="line">pip          24.0</span><br><span class="line">pycparser    2.22</span><br><span class="line">PyYAML       6.0.1</span><br><span class="line">resolvelib   1.0.1</span><br><span class="line">setuptools   69.5.1</span><br><span class="line">wheel        0.43.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible --version</span></span><br><span class="line">ansible [core 2.16.6]</span><br><span class="line">  config file = None</span><br><span class="line">  configured module search path = [&#x27;/root/.ansible/plugins/modules&#x27;, &#x27;/usr/share/ansible/plugins/modules&#x27;]</span><br><span class="line">  ansible python module location = /usr/local/lib/python3.12/site-packages/ansible</span><br><span class="line">  ansible collection location = /root/.ansible/collections:/usr/share/ansible/collections</span><br><span class="line">  executable location = /usr/local/bin/ansible</span><br><span class="line">  python version = 3.12.3 (main, May 14 2024, 07:23:41) [GCC 12.2.0] (/usr/local/bin/python)</span><br><span class="line">  jinja version = 3.1.4</span><br><span class="line">  libyaml = True</span><br></pre></td></tr></table></figure>

<h1 id="Ansible-配置说明"><a href="#Ansible-配置说明" class="headerlink" title="Ansible 配置说明"></a>Ansible 配置说明</h1><p>Ansible 主配置文件为 <code>/etc/ansible/ansible.cfg</code>，<em><strong>其中的配置都可以被 <code>ansible-playbook</code> 或者命令行参数覆盖</strong></em>。</p>
<blockquote>
<p>ansible 默认会读取环境变量 <code>ANSIBLE_CONFIG</code> 指定的配置文件，当前路径下的 <code>ansible.cfg</code>，以及用户家目录下的 <code>.ansible.cfg</code>，以及 <code>/etc/ansible/ansible.cfg</code> 作为配置文件，已第一个找到的为准</p>
</blockquote>
<p>常用配置说明</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>inventory</code></td>
<td>指定 inventory （主机列表）文件的路径，默认为 <code>/etc/ansible/hosts</code></td>
<td></td>
</tr>
<tr>
<td><code>remote_user</code></td>
<td>（未指定用户时）连接远程主机时使用的用户</td>
<td></td>
</tr>
<tr>
<td><code>remote_port</code></td>
<td>连接远程主机时使用的(默认)端口</td>
<td></td>
</tr>
<tr>
<td><code>host_key_checking</code></td>
<td>默认启用。检查主机密钥可以防止服务器欺骗和中间人攻击。<br/>如果主机重新安装并且在 <code>know_hosts</code> 中拥有不同的密钥，ansible 会提示确认密钥。<br/>如果要禁用此行为，可以配置为 <code>False</code></td>
<td></td>
</tr>
<tr>
<td><code>ask_pass</code></td>
<td>默认为 False。当设置为 True 时，ansible 要求输入远端服务器的密码，即使配置了免密登录</td>
<td></td>
</tr>
<tr>
<td><code>log_path</code></td>
<td>日志文件，默认 <code>/var/log/ansible.log </code></td>
<td></td>
</tr>
<tr>
<td><code>pattern</code></td>
<td>当没有给出 <code>pattern</code> 时的默认 <code>pattern</code>，默认值是 <code>*</code> 即所有主机</td>
<td></td>
</tr>
</tbody></table>
<p>配置示例</p>
<figure class="highlight shell"><figcaption><span>/etc/ansible/ansible.cfg</span></figcaption><table><tr><td class="code"><pre><span class="line">[defaults]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认的 inventory 文件路径</span></span><br><span class="line">inventory = /etc/ansible/hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭主机密钥检查，方便新主机的快速添加</span></span><br><span class="line">host_key_checking = False</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认的远程用户</span></span><br><span class="line">remote_user = ansible</span><br></pre></td></tr></table></figure>

<h1 id="Inventory-配置说明"><a href="#Inventory-配置说明" class="headerlink" title="Inventory 配置说明"></a>Inventory 配置说明</h1><p>默认的 inventory 配置文件路径为 <code>/etc/ansible/hosts</code>，主要用来配置 Managed Hosts 列表 <sup id="fnref:3"><a href="#fn:3" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[How to build your inventory](https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html#how-to-build-your-inventory)">[3]</span></a></sup></p>
<p>在命令行中，可以使用选项 <code>-i &lt;path&gt;</code> 指定不同的 <code>inventory</code> 或者可以在 <code>ansible</code> 配置文件 <code>ansible.cfg</code> 中使用指令 <code>inventory</code> 指定 <code>inventory</code> 文件位置。 </p>
<blockquote>
<p>命令行中可以使用 <code>-i &lt;path1&gt; -i &lt;path2&gt; ...</code> 指定多个 <code>inventory</code>  </p>
</blockquote>
<p><code>inventory</code> 文件支持多种格式，最常见的是 <code>INI</code> 和 <code>YAML</code> 格式。</p>
<ul>
<li>Ansible 默认创建了 2 个组：<ul>
<li><code>all</code> : 包含所有主机</li>
<li><code>ungrouped</code> : 包含所有不在其他组（<code>all</code> 除外）中的所有主机。<blockquote>
<p>任何一个主机都会至少在 2 个组中，要么 <strong>在 <code>all</code> 和某个组中</strong>，要么 <strong>在 <code>all</code> 和 <code>ungrouped</code> 组</strong>。</p>
</blockquote>
</li>
</ul>
</li>
<li><strong>一个主机可以包含在多个组中</strong></li>
<li><strong><code>parent/child</code> 组</strong>，<code>child</code> 组被包含在 <code>parent</code> 组中。<ul>
<li>INI 配置格式中，使用 <code>:children</code> 后缀配置 <code>parent</code></li>
<li>YAML 配置格式中，使用 <code>children:</code> 配置 <code>parent</code><blockquote>
<ul>
<li>任何在 <code>child</code> 组中的主机自动成为 <code>parent</code> 组中的一员</li>
<li>一个组可以包括多个 <code>parent</code> 和 <code>child</code> 组，<em><strong>但是不能形成循环关系</strong></em></li>
<li>一个主机可以在多个组中，但是在运行时，只能有一个实例存在，Ansible 会自动将属于多个组的主机合并。</li>
</ul>
</blockquote>
</li>
</ul>
</li>
<li><strong>主机范围匹配</strong>。如果有格式相似的主机，可以通过<strong>范围格式</strong>使用一条指令来添加多台主机。<ul>
<li>INI 配置格式中，使用以下格式  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[webservers]</span><br><span class="line">www[01:50].example.com</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 指定步长增长</span></span></span><br><span class="line">www[01:50:2].example.com</span><br><span class="line">      </span><br><span class="line">db-[a:f].example.com</span><br></pre></td></tr></table></figure></li>
<li>YAML 配置格式中，使用以下格式  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">  webservers:</span><br><span class="line">    hosts:</span><br><span class="line">      www[01:50].example.com:</span><br><span class="line">      </span><br><span class="line">      ## 指定步长增长</span><br><span class="line">      www[01:50:2].example.com:</span><br><span class="line">      db-[a:f].example.com:</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>范围格式</strong> 的第一项和最后一项也包括在内。即匹配 <code>www01</code> 和 <code>www50</code></p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h2 id="Inventory-多配置文件支持"><a href="#Inventory-多配置文件支持" class="headerlink" title="Inventory 多配置文件支持"></a>Inventory 多配置文件支持</h2><p>在主机数量较多，或者组织结构较复杂的情况下，使用单个 Inventory 配置文件会导致主机管理较为复杂。将单个 Inventory 配置文件按照项目或者组织或其他规则进行分割会显著降低维护复杂度。</p>
<p>Inventory 多配置文件支持，可以使用以下方法之一</p>
<ul>
<li>按照项目或者组织或其他规则将主机分割到多个配置中，命令行中可以使用 <code>-i &lt;path1&gt; -i &lt;path2&gt; ...</code> 指定多个 <code>inventory</code></li>
<li>按照项目或者组织或其他规则将主机分割放置在多个文件中，并将所有文件统一放置在一个单独的目录中（如 <code>/etc/ansible/inventory/</code>），在命令行中使用选项 <code>-i /etc/ansible/inventory/</code> 或者在 Ansible 配置文件(<code>ansible.cfg</code>)中使用指令 <code>inventory</code> 配置目录。<blockquote>
<p><em><strong>注意事项</strong></em>： Ansible 使用字典顺序加载配置文件，如果在不同的配置文件中配置了 <code>parent groups</code> 和 <code>child groups</code>，那么定义 <code>child groups</code> 的配置要先用定义 <code>parent groups</code> 的文件加载，否则 Ansible 加载配置会报错： <code>Unable to parse /path/to/source_of_parent_groups as an inventory source</code> <sup id="fnref:4"><a href="#fn:4" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Managing inventory load order](https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html#managing-inventory-load-order)">[4]</span></a></sup> </p>
</blockquote>
</li>
<li>使用 <code>group_vars</code> 和 <code>host_vars</code> 目录分别存储组变量和主机变量 <sup id="fnref:7"><a href="#fn:7" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Organizing host and group variables](https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html#organizing-host-and-group-variables)">[7]</span></a></sup><blockquote>
<p><em><strong>注意事项</strong></em>： 组变量和主机变量必须使用 YAML 格式，合法的文件扩展名包括： <code>.yaml</code>、<code>yml</code>、<code>.json</code> 或者无文件扩展名</p>
</blockquote>
</li>
</ul>
<h2 id="INI-格式的-Inventory"><a href="#INI-格式的-Inventory" class="headerlink" title="INI 格式的 Inventory"></a>INI 格式的 Inventory</h2><p>主机列表中的主机可以单独出现，也可以位于某个或者多个 <strong>组(<code>[]</code> 开头的行)中</strong></p>
<figure class="highlight shell"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="code"><pre><span class="line">ansible-demo1.local</span><br><span class="line">ansible-demo2.local</span><br><span class="line"></span><br><span class="line">[webserver]</span><br><span class="line">webserver1.local</span><br><span class="line">webserver2.local</span><br><span class="line"></span><br><span class="line">[nginxserver]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">匹配多个主机：nginx1.local， nginx2.local， nginx3.local， nginx4.local</span></span><br><span class="line">nginx[1:4].local variable1=value1 variable2=value2</span><br><span class="line">nginx-bak.local ansible_ssh_host=10.10.0.1 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=PASSWORD</span><br><span class="line">127.0.0.1 http_port=80 maxRequestPerChild=808</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>连接主机使用的常用配置说明 <sup id="fnref:6"><a href="#fn:6" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Connecting to hosts: behavioral inventory parameters](https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html#connecting-to-hosts-behavioral-inventory-parameters)">[6]</span></a></sup></p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>ansible_host</code></td>
<td>远程主机地址</td>
<td></td>
</tr>
<tr>
<td><code>ansible_port</code></td>
<td>远程主机端口</td>
<td></td>
</tr>
<tr>
<td><code>ansible_user</code></td>
<td>连接远程主机的 ssh 用户<br/>Ansible 默认使用 control node 上执行 <code>ansible</code> 的用户名来连接远程主机 <sup id="fnref:9"><a href="#fn:9" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Setting a remote user](https://docs.ansible.com/ansible/latest/inventory_guide/connection_details.html#setting-a-remote-user)">[9]</span></a></sup></td>
<td></td>
</tr>
<tr>
<td><code>ansible_password</code></td>
<td>连接远程主机的 ssh 用户密码，建议使用 key 连接</td>
<td></td>
</tr>
<tr>
<td><code>ansible_ssh_private_key_file</code></td>
<td>连接远程主机的 ssh 私钥文件路径</td>
<td></td>
</tr>
<tr>
<td><code>ansible_become</code> <br/> <code>ansible_sudo</code>   <br/> <code>ansible_su</code></td>
<td>用户权限提升</td>
<td></td>
</tr>
<tr>
<td><code>ansible_become_method</code></td>
<td>用户权限提升(escalation)的方式</td>
<td></td>
</tr>
<tr>
<td><code>ansible_become_user</code> <br/> <code>ansible_sudo_user</code>     <br/> <code>ansible_su_user</code></td>
<td>用户权限提升(escalation)后的用户</td>
<td></td>
</tr>
<tr>
<td><code>ansible_become_password</code> <br/> <code>ansible_sudo_password</code> <br/> <code>ansible_su_password</code></td>
<td><code>sudo</code> 密码(这种方式并不安全,强烈建议使用 <code>--ask-sudo-pass</code>)</td>
<td></td>
</tr>
<tr>
<td><code>ansible_become_exe</code><br/> <code>ansible_sudo_exe</code> <br/> <code>ansible_su_exe</code> <br/></td>
<td>设置用户权限提升(escalation)后的可执行文件</td>
<td></td>
</tr>
<tr>
<td><code>ansible_connection</code></td>
<td>与主机的连接类型.比如:<code>local</code>, <code>ssh</code> 或者 <code>paramiko</code><br/>Ansible 1.2 以前默认使用 <code>paramiko</code>。1.2 以后默认使用 <code>smart</code>,<code>smart</code> 方式会根据是否支持 <code>ControlPersist</code>, 来判断 <code>ssh</code> 方式是否可行.</td>
<td></td>
</tr>
<tr>
<td><code>ansible_shell_type</code></td>
<td>目标系统的 shell 类型.默认情况下,命令的执行使用 <code>sh</code> 语法,可设置为 <code>csh</code> 或 <code>fish</code>.</td>
<td></td>
</tr>
<tr>
<td><code>ansible_python_interpreter</code></td>
<td>目标主机的 python 路径<br/>系统中有多个 Python, 或者命令路径不是 <code>/usr/bin/python</code></td>
<td></td>
</tr>
</tbody></table>
<span id="more"></span>

<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>在 <code>inventory</code> 的配置中，可以添加变量，以在 playbook 中使用变量，实现对不同主机的个性化配置。变量分好几个层级：</p>
<ul>
<li>主机变量： 跟在主机后面直接设置，变量的作用域仅限于主机。<em><strong>由于对变量名没有限制，所以前面的那些 ansible 的配置如果打错字了也不会报错，ansible 会认为这是一个主机变量</strong></em> <figure class="highlight shell"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="code"><pre><span class="line">127.0.0.1 http_port=80 maxRequestPerChild=808</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>变量值中包含空格，需要用引号（单引号&#x2F;双引号）</strong></p>
</blockquote>
</li>
<li>组变量： 组变量需要新开一个 <code>section</code>， 配置在名为 <code>[组名:vars]</code> 的 <code>section</code> 中   <figure class="highlight shell"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="code"><pre><span class="line">[localloops]</span><br><span class="line">127.0.0.[1:5] ansible_connection=paramiko ansible_ssh_user=root</span><br><span class="line"></span><br><span class="line">[localloops:vars]</span><br><span class="line">http_port=8080</span><br></pre></td></tr></table></figure>
<blockquote>
<p>因为主机可以在多个组中定义，假如在多个组中定义的同一个主机的同名变量的值不一样，Ansible 使用以下优先级使用变量： <sup id="fnref:5"><a href="#fn:5" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[How variables are merged](https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html#how-variables-are-merged)">[5]</span></a></sup></p>
<ul>
<li>host</li>
<li>child group</li>
<li>parent group</li>
<li>all group</li>
</ul>
</blockquote>
</li>
</ul>
<h4 id="使用主机别名"><a href="#使用主机别名" class="headerlink" title="使用主机别名"></a>使用主机别名</h4><p>在 Inventory 中定义主机时，可以使用主机别名</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">jumper ansible_port=5555 ansible_host=192.0.2.50</span><br></pre></td></tr></table></figure>

<h2 id="YAML-格式的-Inventory"><a href="#YAML-格式的-Inventory" class="headerlink" title="YAML 格式的 Inventory"></a>YAML 格式的 Inventory</h2><p>基本的 YAML 格式的 Inventory 文件内容如下 <sup id="fnref:3"><a href="#fn:3" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[How to build your inventory](https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html#how-to-build-your-inventory)">[3]</span></a></sup></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ungrouped:</span><br><span class="line">  hosts:</span><br><span class="line">    mail.example.com:</span><br><span class="line">webservers:</span><br><span class="line">  hosts:</span><br><span class="line">    foo.example.com:</span><br><span class="line">    bar.example.com:</span><br><span class="line">dbservers:</span><br><span class="line">  hosts:</span><br><span class="line">    one.example.com:</span><br><span class="line">    two.example.com:</span><br><span class="line">    three.example.com:</span><br><span class="line">east:</span><br><span class="line">  hosts:</span><br><span class="line">    foo.example.com:</span><br><span class="line">    one.example.com:</span><br><span class="line">    two.example.com:</span><br><span class="line">west:</span><br><span class="line">  hosts:</span><br><span class="line">    bar.example.com:</span><br><span class="line">    three.example.com:</span><br><span class="line">prod:</span><br><span class="line">  children:</span><br><span class="line">    east:</span><br><span class="line">test:</span><br><span class="line">  children:</span><br><span class="line">    west:</span><br></pre></td></tr></table></figure>

<h3 id="变量-1"><a href="#变量-1" class="headerlink" title="变量"></a>变量</h3><p>主机变量定义</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">atlanta:</span><br><span class="line">  hosts:</span><br><span class="line">    host1:</span><br><span class="line">      http_port: 80</span><br><span class="line">      maxRequestsPerChild: 808</span><br><span class="line">    host2:</span><br><span class="line">      http_port: 303</span><br><span class="line">      maxRequestsPerChild: 909</span><br></pre></td></tr></table></figure>
<p>组变量定义</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">atlanta:</span><br><span class="line">  hosts:</span><br><span class="line">    host1:</span><br><span class="line">    host2:</span><br><span class="line">  vars:</span><br><span class="line">    ntp_server: ntp.atlanta.example.com</span><br><span class="line">    proxy: proxy.atlanta.example.com</span><br></pre></td></tr></table></figure>

<h3 id="定义可以为所有主机共用的变量"><a href="#定义可以为所有主机共用的变量" class="headerlink" title="定义可以为所有主机共用的变量"></a>定义可以为所有主机共用的变量</h3><p>假如有些变量可以被所有主机或者大部分主机所使用（继承），可以将其定义在 <code>all</code> 组中，<code>all</code> 组是 Ansible 自动创建的，用于包含所有主机，因此在这个组中定义的变量会被所有主机继承。</p>
<figure class="highlight shell"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="code"><pre><span class="line">all:</span><br><span class="line">  vars:</span><br><span class="line">    ansible_user: admin</span><br><span class="line">    ansible_ssh_private_key_file: /path/to/private/key</span><br><span class="line">    example_variable: value</span><br><span class="line"></span><br><span class="line">ansible_controller_host:</span><br><span class="line">  hosts:</span><br><span class="line">    docker_host:</span><br><span class="line">      ansible_host: 127.17.0.1</span><br><span class="line"></span><br><span class="line">test_target1:</span><br><span class="line">  hosts:</span><br><span class="line">    ansible-target-centos79-1:</span><br><span class="line">      ansible_host: ansible-target-centos79-1</span><br><span class="line">    ansible-target-centos79-2:</span><br><span class="line">      ansible_host: ansible-target-centos79-2</span><br><span class="line">      ansible_port: 22</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>所有这些变量将适用于 <code>ansible_controller_host</code> 组和 <code>test_target1</code> 组中定义的所有主机，除非在特定主机或其他组中明确覆盖了这些变量。</p>
<p>在主机较多的场景下，需要将变量分离以方便管理维护，可以使用 <code>group_vars</code> 文件，在 Inventory 配置文件的同级目录下创建目录 <code>group_vars</code>，在其下创建文件 <code>all.yml</code></p>
<figure class="highlight shell"><figcaption><span>/etc/ansible/group_vars/all.yml</span></figcaption><table><tr><td class="code"><pre><span class="line">ansible_user: admin</span><br><span class="line">ansible_ssh_private_key_file: /path/to/private/key</span><br><span class="line">example_variable: value</span><br></pre></td></tr></table></figure>

<p>Inventory 文件如下：</p>
<figure class="highlight shell"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">ansible_controller_host:</span><br><span class="line">  hosts:</span><br><span class="line">    docker_host:</span><br><span class="line">      ansible_host: 127.17.0.1</span><br><span class="line"></span><br><span class="line">test_target1:</span><br><span class="line">  hosts:</span><br><span class="line">    ansible-target-centos79-1:</span><br><span class="line">      ansible_host: ansible-target-centos79-1</span><br><span class="line">    ansible-target-centos79-2:</span><br><span class="line">      ansible_host: ansible-target-centos79-2</span><br><span class="line">      ansible_port: 22</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="使用主机别名-1"><a href="#使用主机别名-1" class="headerlink" title="使用主机别名"></a>使用主机别名</h4><p>在 Inventory 中定义主机时，可以使用主机别名</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">  hosts:</span><br><span class="line">    jumper:</span><br><span class="line">      ansible_port: 5555</span><br><span class="line">      ansible_host: 192.0.2.50</span><br></pre></td></tr></table></figure>



<h1 id="ansible-使用"><a href="#ansible-使用" class="headerlink" title="ansible 使用"></a>ansible 使用</h1><p>在配置好 inventory 后，要使 ansible 可以连接到 Managed Host，需要使用密码或者 key 的方式进行认证，建议使用 Private Key 的方式进行认证。<a href="https://csms.tech/202208171033/#ssh-免密登陆">参考文档配置 ssh 公私钥免密码认证过程</a></p>
<p>配置完 hosts 之后，在命令行中可以调用一些命令来使用 ansible，如 <code>ansible all -m ping</code>。命令行的 ansible 工具大体格式如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ansible &lt;pattern&gt; -m &lt;module&gt; -a &lt;arguments&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Patterns"><a href="#Patterns" class="headerlink" title="Patterns"></a>Patterns</h2><p><code>pattern</code> 是一个标识，指定出了要操作的目标主机，常用的 <code>patterns</code> 如下 <sup id="fnref:8"><a href="#fn:8" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Common patterns](https://docs.ansible.com/ansible/latest/inventory_guide/intro_patterns.html#common-patterns)">[8]</span></a></sup></p>
<table>
<thead>
<tr>
<th>描述</th>
<th>Pattern(s)</th>
<th>Targets</th>
</tr>
</thead>
<tbody><tr>
<td>所有主机</td>
<td><code>all</code><br/><code>*</code></td>
<td></td>
</tr>
<tr>
<td>一个主机</td>
<td><code>host1</code> <br/><code>ip/域名</code></td>
<td></td>
</tr>
<tr>
<td>多个主机</td>
<td><code>host1:host2</code><br/><code>host1,host2</code><br/><code>192.168.1.*</code> <br/><code>192.0.*</code><br/><code>*.example.com</code><br/><code>*.com</code></td>
<td>建议用 <code>,</code>，在主机或者组中有 <code>:</code> 字符时必须用 <code>,</code>     <br/><em><strong>如果主机名和组名冲突，则以先出现的为准。</strong></em></td>
</tr>
<tr>
<td>一个组</td>
<td><code>webservers</code></td>
<td></td>
</tr>
<tr>
<td>多个组</td>
<td><code>webservers:dbservers</code></td>
<td>取两个组的 <strong>并集</strong>   <br/><em><strong>如果主机名和组名冲突，则以先出现的为准。</strong></em></td>
</tr>
<tr>
<td>排除组</td>
<td><code>webservers:!atlanta</code></td>
<td>所有在 <code>webservers</code> 组中，但是不在 <code>atlanta</code> 组中</td>
</tr>
<tr>
<td>组的交集</td>
<td>webservers:&amp;staging</td>
<td>any hosts in webservers that are also in staging</td>
</tr>
<tr>
<td>slice（切片操作）</td>
<td><code>webservers[0]</code> 第一个主机<br/><code>webservers[-1]</code>  最后一个主机<br/><code>webservers[0:2]</code> 第 1 个到第 3 个（包含）<br/> <code>webservers[1:]</code>  第 2 个到最后一个<br/><code>webservers[:3]</code> 第一个到第 4 个</td>
<td></td>
</tr>
<tr>
<td>正则表达式匹配</td>
<td>&#96;~(web</td>
<td>db).*.example.com<code>以</code>~&#96; 开头的匹配表达式表示使用正则匹配</td>
</tr>
</tbody></table>
<blockquote>
<ul>
<li>可以混用： <code>one*.com:dbservers</code></li>
<li><strong>如果 Inventory 中使用了别名（alias），必须使用别名来匹配</strong>。YAML 格式中明确使用了别名。</li>
</ul>
</blockquote>
<p>ansible 命令常用选项</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>-m, --module-name</code></td>
<td>指定模块<br/><strong>默认为 <code>command</code></strong></td>
<td><code>ansible all -m ping </code></td>
</tr>
<tr>
<td><code>--become-user &#39;BECOME_USER&#39;</code></td>
<td>作，默认为 <code>root</code> &lt;br&#x2F;切换到指定的用户执行操&gt;<strong>需要配合 <code>-b, --become</code> 选项使用</strong></td>
<td><code>ansible all -m command -a &quot;ls /root/&quot; -b --become-user root</code></td>
</tr>
<tr>
<td><code>-b, --become</code></td>
<td>提升权限到 <code>root</code> 权限，需要用户有 <code>sudo</code> 权限</td>
<td></td>
</tr>
<tr>
<td><code>--list-hosts</code></td>
<td>列出 <code>pattern</code> 匹配的主机列表，不执行其他任何操作</td>
<td><code>ansible --list-hosts</code></td>
</tr>
<tr>
<td><code>-C, --check</code></td>
<td><code>Check mode</code>，不执行任何实际操作，而是对要执行的操作进行验证</td>
<td></td>
</tr>
<tr>
<td><code>-k, --ask-pass</code></td>
<td>询问连接密码</td>
<td></td>
</tr>
<tr>
<td><code>-o, --one-line</code></td>
<td>输出到一行里面</td>
<td></td>
</tr>
<tr>
<td><code>-f ,--forks</code></td>
<td>指定并发执行的数量，默认为 5</td>
<td></td>
</tr>
</tbody></table>
<h1 id="ansible-doc-使用"><a href="#ansible-doc-使用" class="headerlink" title="ansible-doc 使用"></a>ansible-doc 使用</h1><p><code>ansible-doc</code> 命令提供 Ansible 安装的模块的简要文档（帮助）信息，其帮助示例中的代码可以直接复制粘贴到 Playbook 中使用。</p>
<h1 id="ansible-inventory"><a href="#ansible-inventory" class="headerlink" title="ansible-inventory"></a>ansible-inventory</h1><p><code>ansible-inventory</code> 命令用于列出 Ansible Inventory 的详细配置。 </p>
<h1 id="ansible-常用模块"><a href="#ansible-常用模块" class="headerlink" title="ansible 常用模块"></a>ansible 常用模块</h1><h2 id="command"><a href="#command" class="headerlink" title="command"></a>command</h2><p><code>command</code> 是 ansible 默认的模块。<em><strong>command 模块不支持 shell 变量,也不支持管道&#x2F;重定向 等 shell 相关的功能.如果你想使用 shell 相关的这些功能, 请使用 <code>shell</code> 模块.</strong></em> <sup id="fnref:2"><a href="#fn:2" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Parallelism and Shell Commands](https://ansible-tran.readthedocs.io/en/latest/docs/intro_adhoc.html)">[2]</span></a></sup></p>
<h2 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h2><p><code>shell</code> 模块启动一个 <code>shell</code> 然后执行命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ansible raleigh -m shell -a <span class="string">&#x27;echo $TERM&#x27;</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用 Ansible ad hoc 命令行接口时(与使用 Playbooks 的情况相反)，尤其要注意 shell 引号的规则。<em><strong>比如在上面的例子中，如果使用双引号 <code>&quot;echo $TERM&quot;</code>，会求出 <code>TERM</code> 变量在当前系统的值，而我们实际希望的是把这个命令传递</strong></em> <em>到其它机器执行。</em></p>
</blockquote>
<p><strong>以下示例展示在 <code>shell</code> 模块中使用 <code>awk</code> 命令的正确用法</strong></p>
<ul>
<li><p>在本地（localhost） 的 Shell 中执行如下命令</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /home/logs/nginx/access; <span class="built_in">cat</span> *.<span class="built_in">log</span> | awk -F<span class="string">&#x27;|&#x27;</span> <span class="string">&#x27;&#123;print $5&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c</span></span><br><span class="line"> 405946 request_method:GET</span><br><span class="line">      1 request_method:HEAD</span><br><span class="line">     25 request_method:OPTIONS</span><br><span class="line"> 262838 request_method:POST</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>以上命令中，出现了 <code>$</code> 符号，如果外层使用 <code>&quot;&quot;</code> 嵌套，如 <code>ansible-3 172.31.26.138 -m shell -a &quot;cd /home/logs/nginx/access; cat *.log | awk -F&#39;|&#39; &#39;&#123;print $5&#125;&#39; | sort | uniq -c&quot;</code> ，会导致 <code>$5</code> 被解析为 Ansible 管理主机上的变量。</li>
<li><code>awk</code> 命令中的 <code>&#123;print $5&#125;</code> 需要使用单引号 <code>&#39;</code>，如果 <code>ansible -a</code> 参数使用 <code>&#39;</code> 会出现冲突</li>
</ul>
<p>  要解决此问题， <strong>需要使用以下方法</strong> ：</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ansible-3 172.31.26.138 -m shell -a <span class="string">&#x27;cd /home/logs/nginx/access; cat *.log | awk -F&quot;|&quot; &#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27;&#123;print $5&#125;&#x27;</span><span class="string">&quot;&#x27;&quot;</span><span class="string">&#x27; | sort | uniq -c&#x27;</span></span></span><br><span class="line">172.31.26.138 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">      2 request_method:-</span><br><span class="line"> 664343 request_method:GET</span><br><span class="line">      1 request_method:HEAD</span><br><span class="line">     27 request_method:OPTIONS</span><br><span class="line"> 430357 request_method:POST</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>外层的单引号： <code>&#39;...&#39;</code> 是 Ansible <code>shell -a</code> 命令需要的包裹方式。 </p>
<p><code>awk</code> 中的单引号需要先用双引号： <code>&quot;</code> 结束外层单引号。再写单引号： <code>&#39;...&#39;</code> （用于 <code>awk</code>）。 最后再用双引号： <code>&quot;</code> 重新回到外层单引号范围</p>
</blockquote>
</li>
</ul>
<h2 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h2><p>用来测试到目标服务器的连通性</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all -m ping</span></span><br><span class="line">[WARNING]: Invalid characters were found in group names but not replaced, use -vvvv to see details</span><br><span class="line">k8s-master1 | UNREACHABLE! =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;msg&quot;: &quot;Failed to connect to the host via ssh: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).&quot;, </span><br><span class="line">    &quot;unreachable&quot;: true</span><br><span class="line">&#125;</span><br><span class="line">[WARNING]: Platform linux on host k8s-uat-master2 is using the discovered Python interpreter at /usr/bin/python, but future installation of</span><br><span class="line">another Python interpreter could change this. See https://docs.ansible.com/ansible/2.9/reference_appendices/interpreter_discovery.html for more</span><br><span class="line">information.</span><br><span class="line">k8s-master2 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="setup"><a href="#setup" class="headerlink" title="setup"></a>setup</h2><p>使用 <code>setup</code> 模块，ansible 可以收集各个 Managed Hosts 的 <code>facts</code>，其中包含了 Managed Hosts 的很多元数据。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible k8s-master-nodes[0] -m setup</span></span><br><span class="line"></span><br><span class="line">k8s-uat-master1 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;ansible_all_ipv4_addresses&quot;: [</span><br><span class="line">            &quot;10.244.0.1&quot;, </span><br><span class="line">            &quot;172.31.30.123&quot;, </span><br><span class="line">            &quot;10.244.0.0&quot;, </span><br><span class="line">            &quot;172.17.0.1&quot;</span><br><span class="line">        ], </span><br><span class="line">        &quot;ansible_all_ipv6_addresses&quot;: [</span><br><span class="line">            &quot;fe80::84d:ccff:fe5f:56c5&quot;, </span><br><span class="line">            &quot;fe80::3c4a:4bff:fe20:512&quot;, </span><br><span class="line">            &quot;fe80::836:c2ff:fefb:e925&quot;, </span><br><span class="line">            &quot;fe80::146d:22ff:fe20:cf86&quot;</span><br><span class="line">        ], </span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>配合 <code>setup</code> 模块的 <code>filter</code> 参数，可以从输出中过滤出各种信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible fm-k8s-uat-master-nodes[0] -m setup -a <span class="string">&quot;filter=ansible_default_ipv4&quot;</span></span></span><br><span class="line">k8s-master1 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;ansible_default_ipv4&quot;: &#123;</span><br><span class="line">            &quot;address&quot;: &quot;172.31.30.123&quot;, </span><br><span class="line">            &quot;alias&quot;: &quot;eth0&quot;, </span><br><span class="line">            &quot;broadcast&quot;: &quot;172.31.31.255&quot;, </span><br><span class="line">            &quot;gateway&quot;: &quot;172.31.16.1&quot;, </span><br><span class="line">            &quot;interface&quot;: &quot;eth0&quot;, </span><br><span class="line">            &quot;macaddress&quot;: &quot;0a:36:c2:fb:e9:25&quot;, </span><br><span class="line">            &quot;mtu&quot;: 9001, </span><br><span class="line">            &quot;netmask&quot;: &quot;255.255.240.0&quot;, </span><br><span class="line">            &quot;network&quot;: &quot;172.31.16.0&quot;, </span><br><span class="line">            &quot;type&quot;: &quot;ether&quot;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Playbook 中可以使用 <code>ansible_facts</code> 变量直接引用 <code>facts</code></p>
<h2 id="hostname"><a href="#hostname" class="headerlink" title="hostname"></a>hostname</h2><p>修改主机名，<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/hostname_module.html#ansible-builtin-hostname-module-manage-hostname">官方文档说明</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">- name: Set a hostname</span><br><span class="line">  ansible.builtin.hostname:</span><br><span class="line">    name: web01</span><br><span class="line"></span><br><span class="line">- name: Set a hostname specifying strategy</span><br><span class="line">  ansible.builtin.hostname:</span><br><span class="line">    name: web01</span><br><span class="line">    use: systemd</span><br></pre></td></tr></table></figure>

<h2 id="lineinfile"><a href="#lineinfile" class="headerlink" title="lineinfile"></a>lineinfile</h2><p>此模块用了确定给定的 <strong>一行内容</strong> 是否在指定文件中，或者替换文件中存在的 <strong>一行</strong> 内容。<strong>仅在需要修改单行内容时使用此模块</strong> <sup id="fnref:10"><a href="#fn:10" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[ansible.builtin.lineinfile module – Manage lines in text files](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/lineinfile_module.html#ansible-builtin-lineinfile-module-manage-lines-in-text-files) ">[10]</span></a></sup> </p>
<p>如果需要对多行文本或者是整块文本做修改，可以参考 <code>ansible.builtin.blockinfile</code>、<code>ansible.builtin.replace</code>、<code>ansible.builtin.copy</code> or <code>ansible.builtin.template</code> 等模块</p>
<h2 id="reboot"><a href="#reboot" class="headerlink" title="reboot"></a>reboot</h2><h2 id="service"><a href="#service" class="headerlink" title="service"></a>service</h2><p><code>ansible.builtin.service</code> 管理远程主机上的服务状态。 <sup id="fnref:11"><a href="#fn:11" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[ansible.builtin.service](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/service_module.html#ansible-collections-ansible-builtin-service-module)">[11]</span></a></sup></p>
<ul>
<li><code>ansible.builtin.service</code> 模块相当于是底层服务管理工具（<code>systemd</code>、<code>sysvini</code> 等）的一个代理。默认情况会使用 <code>ansible.builtin.setup</code> 中发现的服务管理工具来管理远程主机上的服务状态。也可以使用 <code>use</code> 参数手动指定。</li>
<li><code>ansible.builtin.service</code> 中的参数不一定适用于所有的底层服务管理工具（<code>systemd</code>、<code>sysvini</code> 等）</li>
</ul>
<p>常用参数</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>name</code><br/><strong>string &#x2F; required</strong></td>
<td>服务名称</td>
<td></td>
</tr>
<tr>
<td><code>enabled</code><br/><strong>boolean</strong></td>
<td>服务是否要开机启动，可选值包括<br/>- <code>false</code><br/>- <code>true</code></td>
<td></td>
</tr>
<tr>
<td><code>state</code><br/><strong>string</strong></td>
<td>期望的（desired）服务状态。可选值包括：<br/>- <code>started</code> &#x2F; <code>stopped</code> : 如果服务状态已满足，不执行任何操作<br/>- <code>restarted</code>: 重启<br/>- <code>reloaded</code></td>
<td></td>
</tr>
<tr>
<td><code>use</code><br/><strong>string</strong></td>
<td>默认情况下，系统使用 <code>ansible_service_mgr</code> 中的服务管理工具。如果此值为空，则使用传统的 <code>service</code> 模块（命令）</td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p>除了 <code>name</code> 为必须的参数，<code>enabled</code> 和 <code>state</code> 至少要有一个存在</p>
</blockquote>
<h2 id="systemd-service"><a href="#systemd-service" class="headerlink" title="systemd_service"></a>systemd_service</h2><p><code>ansible.builtin.systemd_service</code> 管理 <code>systemd</code> 系统上的服务</p>
<p><code>ansible.builtin.systemd</code> 和 <code>ansible.builtin.systemd_service</code> 相同</p>
<p>常用参数</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>name</code><br/><strong>string &#x2F; required</strong></td>
<td>服务名称</td>
<td></td>
</tr>
<tr>
<td><code>enabled</code><br/><strong>boolean</strong></td>
<td>服务是否要开机启动，可选值包括<br/>- <code>false</code><br/>- <code>true</code></td>
<td></td>
</tr>
<tr>
<td><code>state</code><br/><strong>string</strong></td>
<td>期望的（desired）服务状态。可选值包括：<br/>- <code>started</code> &#x2F; <code>stopped</code> : 如果服务状态已满足，不执行任何操作<br/>- <code>restarted</code>: 重启<br/>- <code>reloaded</code></td>
<td></td>
</tr>
<tr>
<td><code>daemon_reexec</code><br/><strong>boolean</strong><br/>aliases: <code>systemctl daemon-reexec</code></td>
<td>在执行任何操作前，先执行 <code>systemctl daemon-reexec</code> 。<br/>默认值为 <code>false</code></td>
<td></td>
</tr>
<tr>
<td><code>daemon_reload</code><br/><strong>boolean</strong><br/>aliases: <code>systemctl daemon-reload</code></td>
<td>执行 <code>systemctl daemon-reload</code>。 <br/>默认值为 <code>false </code></td>
<td></td>
</tr>
</tbody></table>
<h2 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h2><p><code>ansible.builtin.debug</code> 可单独使用或者和 <code>when</code> 语句使用来打印调试信息，常用的参数包括 <code>msg</code> 和 <code>var</code>（用于调试变量）</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">- name: Print the gateway for each host when defined</span><br><span class="line">  ansible.builtin.debug:</span><br><span class="line">    msg: System &#123;&#123; inventory_hostname &#125;&#125; has gateway &#123;&#123; ansible_default_ipv4.gateway &#125;&#125;</span><br><span class="line">  when: ansible_default_ipv4.gateway is defined</span><br><span class="line"></span><br><span class="line">- name: Get uptime information</span><br><span class="line">  ansible.builtin.shell: /usr/bin/uptime</span><br><span class="line">  register: result</span><br><span class="line"></span><br><span class="line">- name: Print return information from the previous task</span><br><span class="line">  ansible.builtin.debug:</span><br><span class="line">    var: result</span><br><span class="line">    verbosity: 2</span><br><span class="line"></span><br><span class="line">- name: Display all variables/facts known for a host</span><br><span class="line">  ansible.builtin.debug:</span><br><span class="line">    var: hostvars[inventory_hostname]</span><br><span class="line">    verbosity: 4</span><br><span class="line"></span><br><span class="line">- name: Prints two lines of messages, but only if there is an environment value set</span><br><span class="line">  ansible.builtin.debug:</span><br><span class="line">    msg:</span><br><span class="line">    - &quot;Provisioning based on YOUR_KEY which is: &#123;&#123; lookup(&#x27;ansible.builtin.env&#x27;, &#x27;YOUR_KEY&#x27;) &#125;&#125;&quot;</span><br><span class="line">    - &quot;These servers were built using the password of &#x27;&#123;&#123; password_used &#125;&#125;&#x27;. Please retain this for later use.&quot;</span><br></pre></td></tr></table></figure>

<h1 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h1><h2 id="Permission-denied"><a href="#Permission-denied" class="headerlink" title="Permission denied"></a>Permission denied</h2><p>在以普通用户 <code>ssh</code> 登陆远程主机（Managed Host）的情况下，执行某些操作可能因为普通用户权限不足导致操作失败</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible my-hosts -m <span class="built_in">command</span> -a <span class="string">&quot;cat /root/.ssh/authorized_keys&quot;</span></span> </span><br><span class="line">k8s-master2 | FAILED | rc=1 &gt;&gt;</span><br><span class="line">cat: /root/.ssh/authorized_keys: Permission deniednon-zero return code</span><br><span class="line"></span><br><span class="line">k8s-master1 | FAILED | rc=1 &gt;&gt;</span><br><span class="line">cat: /root/.ssh/authorized_keys: Permission deniednon-zero return code</span><br><span class="line"></span><br><span class="line">k8s-master3 | FAILED | rc=1 &gt;&gt;</span><br><span class="line">cat: /root/.ssh/authorized_keys: Permission deniednon-zero return code</span><br></pre></td></tr></table></figure>

<p>此种情况，可以使用以下方式解决。 <strong>前提是远程登陆使用的用户具有 <a href="!--swig%EF%BF%BC31--"><code>sudo</code> 权限</a></strong> 。建议使用 <code>-b</code> 选项。</p>
<ul>
<li>使用 <code>sudo</code> 命令。如果用户没有 <code>sudo</code> 权限，ansible 会被阻塞，后台等待用户输入 <code>sudo</code> 密码，直到等待超时失败。具体报错参考以下示例中的 <code>k8s-master2</code> 输出<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible my-hosts -m <span class="built_in">command</span> -a <span class="string">&quot;sudo cat /root/.ssh/authorized_keys&quot;</span></span> </span><br><span class="line">k8s-master1 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">no-port-forwarding,no-agent-forwarding,no-X11-forwarding,command=&quot;echo &#x27;Please login as the user \&quot;centos\&quot; rather than the user \&quot;root\&quot;.&#x27;;echo;sleep 10&quot; ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCGKLNMv82MQJUuQ9aZPsDofBj96aQlS1kNV2doSwyLatgMNBZ6rzgQuNOJ2DH87IzD1mZ0wL7iApvk6gkxSxcz5tmbU8dfYOYJdlBlhxGk2Nkg2V3P9FPC0hBY73szEV+1DUoqwl+COAsAXO9Uiebr0faQvWOkVT7pypunnjPrBBUaaXn2IcoPIdXZfXVLjXH2JbWSHL5J+yIGHewSMzZ/Xx7u6hwxUP0QLFHrnhD0WDukoBjoUZ2sshMP+DHgoyWjCg+uVpmjJAksp80f34WfNku5Grt90kYEj+N+x2JQ1Y4aQIXASIwDshicbJIsl+RMIMmwe+TElUJ6g9aa0qCr op2-east1-1031</span><br><span class="line">k8s-master3 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">no-port-forwarding,no-agent-forwarding,no-X11-forwarding,command=&quot;echo &#x27;Please login as the user \&quot;centos\&quot; rather than the user \&quot;root\&quot;.&#x27;;echo;sleep 10&quot; ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCGKLNMv82MQJUuQ9aZPsDofBj96aQlS1kNV2doSwyLatgMNBZ6rzgQuNOJ2DH87IzD1mZ0wL7iApvk6gkxSxcz5tmbU8dfYOYJdlBlhxGk2Nkg2V3P9FPC0hBY73szEV+1DUoqwl+COAsAXO9Uiebr0faQvWOkVT7pypunnjPrBBUaaXn2IcoPIdXZfXVLjXH2JbWSHL5J+yIGHewSMzZ/Xx7u6hwxUP0QLFHrnhD0WDukoBjoUZ2sshMP+DHgoyWjCg+uVpmjJAksp80f34WfNku5Grt90kYEj+N+x2JQ1Y4aQIXASIwDshicbJIsl+RMIMmwe+TElUJ6g9aa0qCr op2-east1-1031</span><br><span class="line"></span><br><span class="line">k8s-master2 | FAILED! =&gt; &#123;</span><br><span class="line">  &quot;ansible_facts&quot;: &#123;</span><br><span class="line">      &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">  &#125;, </span><br><span class="line">  &quot;changed&quot;: false, </span><br><span class="line">  &quot;module_stderr&quot;: &quot;Shared connection to 172.31.30.115 closed.\r\n&quot;, </span><br><span class="line">  &quot;module_stdout&quot;: &quot;[sudo] password for centos: \r\n\r\n&#123;\&quot;changed\&quot;: true, \&quot;end\&quot;: \&quot;2023-09-01 09:24:40.247480\&quot;, \&quot;stdout\&quot;: \&quot;\&quot;, \&quot;cmd\&quot;: [\&quot;sudo\&quot;, \&quot;cat\&quot;, \&quot;/root/.ssh/authorized_keys\&quot;], \&quot;failed\&quot;: true, \&quot;delta\&quot;: \&quot;0:05:02.696092\&quot;, \&quot;stderr\&quot;: \&quot;\\nWe trust you have received the usual lecture from the local System\\nAdministrator. It usually boils down to these three things:\\n\\n    #1) Respect the privacy of others.\\n    #2) Think before you type.\\n    #3) With great power comes great responsibility.\\n\\nsudo: timed out reading password\&quot;, \&quot;rc\&quot;: 1, \&quot;invocation\&quot;: &#123;\&quot;module_args\&quot;: &#123;\&quot;creates\&quot;: null, \&quot;executable\&quot;: null, \&quot;_uses_shell\&quot;: false, \&quot;strip_empty_ends\&quot;: true, \&quot;_raw_params\&quot;: \&quot;sudo cat /root/.ssh/authorized_keys\&quot;, \&quot;removes\&quot;: null, \&quot;argv\&quot;: null, \&quot;warn\&quot;: true, \&quot;chdir\&quot;: null, \&quot;stdin_add_newline\&quot;: true, \&quot;stdin\&quot;: null&#125;&#125;, \&quot;start\&quot;: \&quot;2023-09-01 09:19:37.551388\&quot;, \&quot;warnings\&quot;: [\&quot;Consider using &#x27;become&#x27;, &#x27;become_method&#x27;, and &#x27;become_user&#x27; rather than running sudo\&quot;], \&quot;msg\&quot;: \&quot;non-zero return code\&quot;&#125;\r\n&quot;, </span><br><span class="line">  &quot;msg&quot;: &quot;MODULE FAILURE\nSee stdout/stderr for the exact error&quot;, </span><br><span class="line">  &quot;rc&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>使用 <code>ansible -b</code> 选项。如果用户没有 <code>sudo</code> 权限， ansible 会因为没有输入 <code>sudo</code> 密码而执行失败，具体报错（<code>Missing sudo password</code>）参考以下示例中的 <code>k8s-master2</code> 输出<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible my-hosts -m <span class="built_in">command</span> -a <span class="string">&quot;cat /root/.ssh/authorized_keys&quot;</span> -b</span></span><br><span class="line">k8s-master2 | FAILED | rc=-1 &gt;&gt;</span><br><span class="line">Missing sudo password</span><br><span class="line"></span><br><span class="line">k8s-master1 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">no-port-forwarding,no-agent-forwarding,no-X11-forwarding,command=&quot;echo &#x27;Please login as the user \&quot;centos\&quot; rather than the user \&quot;root\&quot;.&#x27;;echo;sleep 10&quot; ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCGKLNMv82MQJUuQ9aZPsDofBj96aQlS1kNV2doSwyLatgMNBZ6rzgQuNOJ2DH87IzD1mZ0wL7iApvk6gkxSxcz5tmbU8dfYOYJdlBlhxGk2Nkg2V3P9FPC0hBY73szEV+1DUoqwl+COAsAXO9Uiebr0faQvWOkVT7pypunnjPrBBUaaXn2IcoPIdXZfXVLjXH2JbWSHL5J+yIGHewSMzZ/Xx7u6hwxUP0QLFHrnhD0WDukoBjoUZ2sshMP+DHgoyWjCg+uVpmjJAksp80f34WfNku5Grt90kYEj+N+x2JQ1Y4aQIXASIwDshicbJIsl+RMIMmwe+TElUJ6g9aa0qCr op2-east1-1031</span><br><span class="line">[WARNING]: Platform linux on host k8s-uat-master3 is using the discovered Python interpreter at /usr/bin/python, but future installation of</span><br><span class="line">another Python interpreter could change this. See https://docs.ansible.com/ansible/2.9/reference_appendices/interpreter_discovery.html for more</span><br><span class="line">information.</span><br><span class="line">k8s-master3 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">no-port-forwarding,no-agent-forwarding,no-X11-forwarding,command=&quot;echo &#x27;Please login as the user \&quot;centos\&quot; rather than the user \&quot;root\&quot;.&#x27;;echo;sleep 10&quot; ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCGKLNMv82MQJUuQ9aZPsDofBj96aQlS1kNV2doSwyLatgMNBZ6rzgQuNOJ2DH87IzD1mZ0wL7iApvk6gkxSxcz5tmbU8dfYOYJdlBlhxGk2Nkg2V3P9FPC0hBY73szEV+1DUoqwl+COAsAXO9Uiebr0faQvWOkVT7pypunnjPrBBUaaXn2IcoPIdXZfXVLjXH2JbWSHL5J+yIGHewSMzZ/Xx7u6hwxUP0QLFHrnhD0WDukoBjoUZ2sshMP+DHgoyWjCg+uVpmjJAksp80f34WfNku5Grt90kYEj+N+x2JQ1Y4aQIXASIwDshicbJIsl+RMIMmwe+TElUJ6g9aa0qCr op2-east1-1031</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Connection-timed-out"><a href="#Connection-timed-out" class="headerlink" title="Connection timed out"></a>Connection timed out</h2><p>使用以下 playbook 报错：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">- name: manage Nginx Status</span><br><span class="line">  hosts: nginx</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">  - name: Ensure that nginx is started</span><br><span class="line">    ansible.builtin.service:</span><br><span class="line">      name: nginx  </span><br><span class="line">      enabled: false</span><br><span class="line">      state: stopped</span><br></pre></td></tr></table></figure>

<p>执行结果如下，报错： <code>&#123;&quot;changed&quot;: false, &quot;msg&quot;: &quot;Unable to disable service nginx: Failed to execute operation: Connection timed out\n&quot;&#125;</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible-playbook -vv  --diff playbooks/playbook.yml</span></span><br><span class="line"></span><br><span class="line">PLAYBOOK: playbook.yml **************************************************************************************************************************************</span><br><span class="line">1 plays in playbooks/playbook.yml</span><br><span class="line"></span><br><span class="line">PLAY [manage Nginx Status] **********************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **************************************************************************************************************************************</span><br><span class="line">task path: /etc/ansible/playbooks/playbook.yml:2</span><br><span class="line">ok: [nginx_2]</span><br><span class="line"></span><br><span class="line">TASK [Ensure that nginx is started] *************************************************************************************************************************</span><br><span class="line">task path: /etc/ansible/playbooks/playbook.yml:8</span><br><span class="line">fatal: [nginx_2]: FAILED! =&gt; &#123;&quot;changed&quot;: false, &quot;msg&quot;: &quot;Unable to disable service nginx: Failed to execute operation: Connection timed out\n&quot;&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP **************************************************************************************************************************************************</span><br><span class="line">nginx_2        : ok=1    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>

<p><strong>问题原因</strong> 是此操作需要 <code>sudo</code> 权限来运行。参考以下内容，加入 <code>become: true</code> 指令即可</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">- name: manage Nginx Status</span><br><span class="line">  hosts: nginx</span><br><span class="line">  become: true</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">  - name: Ensure that nginx is started</span><br><span class="line">    ansible.builtin.service:</span><br><span class="line">      name: nginx  </span><br><span class="line">      enabled: false</span><br><span class="line">      state: stopped</span><br></pre></td></tr></table></figure>

<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#control-node-requirements">ansible 官方文档</a><br><a target="_blank" rel="noopener" href="https://ansible-tran.readthedocs.io/en/latest/docs/intro_adhoc.html">Ansible中文权威指南</a><br><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/index_module.html">Index of all Modules</a></p>
<h1 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h1><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/reference_appendices/release_and_maintenance.html#ansible-core-control-node-python-support">ansible-core control node Python support</a><a href="#fnref:1" rev="footnote"> ↩</a></span></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">2.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://ansible-tran.readthedocs.io/en/latest/docs/intro_adhoc.html">Parallelism and Shell Commands</a><a href="#fnref:2" rev="footnote"> ↩</a></span></li><li id="fn:3"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">3.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html#how-to-build-your-inventory">How to build your inventory</a><a href="#fnref:3" rev="footnote"> ↩</a></span></li><li id="fn:4"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">4.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html#managing-inventory-load-order">Managing inventory load order</a><a href="#fnref:4" rev="footnote"> ↩</a></span></li><li id="fn:5"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">5.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html#how-variables-are-merged">How variables are merged</a><a href="#fnref:5" rev="footnote"> ↩</a></span></li><li id="fn:6"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">6.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html#connecting-to-hosts-behavioral-inventory-parameters">Connecting to hosts: behavioral inventory parameters</a><a href="#fnref:6" rev="footnote"> ↩</a></span></li><li id="fn:7"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">7.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html#organizing-host-and-group-variables">Organizing host and group variables</a><a href="#fnref:7" rev="footnote"> ↩</a></span></li><li id="fn:8"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">8.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/inventory_guide/intro_patterns.html#common-patterns">Common patterns</a><a href="#fnref:8" rev="footnote"> ↩</a></span></li><li id="fn:9"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">9.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/inventory_guide/connection_details.html#setting-a-remote-user">Setting a remote user</a><a href="#fnref:9" rev="footnote"> ↩</a></span></li><li id="fn:10"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">10.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/lineinfile_module.html#ansible-builtin-lineinfile-module-manage-lines-in-text-files">ansible.builtin.lineinfile module – Manage lines in text files</a><a href="#fnref:10" rev="footnote"> ↩</a></span></li><li id="fn:11"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">11.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/service_module.html#ansible-collections-ansible-builtin-service-module">ansible.builtin.service</a><a href="#fnref:11" rev="footnote"> ↩</a></span></li></ol></div></div>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="../tags/Linux/" rel="tag"><i class="fa fa-tag"></i> Linux</a>
              <a href="../tags/ansible/" rel="tag"><i class="fa fa-tag"></i> ansible</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="../202308311739/" rel="prev" title="Linux sudo 使用介绍">
                  <i class="fa fa-chevron-left"></i> Linux sudo 使用介绍
                </a>
            </div>
            <div class="post-nav-item">
                <a href="../202309011341/" rel="next" title="Ansible playbook 使用介绍">
                  Ansible playbook 使用介绍 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">COSMOS</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="300" alpha="0.3" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="../js/comments.js"></script><script src="../js/utils.js"></script><script src="../js/motion.js"></script><script src="../js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="../js/third-party/search/local-search.js"></script>




  <script src="../js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"fl9999","repo":"fl9999.github.io","client_id":"a11bf6f7860762b725b5","client_secret":"a99046105f8bddc72ec718d54dc3fd7f22070821","admin_user":"fl9999","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"d41d8cd98f00b204e9800998ecf8427e"}</script>
<script src="../js/third-party/comments/gitalk.js"></script>

</body>
</html>
