<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"csms.tech","root":"/","images":"images","scheme":"Gemini","darkmode":true,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeIn","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="js/config.js"></script>

    <meta name="description" content="得 能 莫 忘">
<meta property="og:type" content="website">
<meta property="og:title" content="L B T">
<meta property="og:url" content="http://csms.tech/index.html">
<meta property="og:site_name" content="L B T">
<meta property="og:description" content="得 能 莫 忘">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="COSMOS">
<meta property="article:tag" content="博客, 记录，技术">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://csms.tech/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>L B T</title>
  








  <noscript>
    <link rel="stylesheet" href="css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">L B T</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记 录 过 去 的 经 验</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="index.html" rel="section"><i class="fa fa-earth-americas fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-folder-tree fa-fw"></i>总目录<span class="badge">51</span></a></li><li class="menu-item menu-item-linux"><a href="/categories/Linux" rel="section"><i class="fa fa-brands fa-linux fa-fw"></i>Linux</a></li><li class="menu-item menu-item-python"><a href="/categories/Python" rel="section"><i class="fa fa-brands fa-python fa-fw"></i>Python</a></li><li class="menu-item menu-item-docker"><a href="/categories/Docker" rel="section"><i class="fa fa-brands fa-docker fa-fw"></i>Docker</a></li><li class="menu-item menu-item-kubernetes"><a href="/categories/Kubernetes" rel="section"><i class="fa fa-dharmachakra fa-fw"></i>Kubernetes</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tornado fa-fw"></i>标签<span class="badge">79</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-rectangle-list fa-fw"></i>列表<span class="badge">249</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章总目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">COSMOS</p>
  <div class="site-description" itemprop="description">得 能 莫 忘</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">249</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">目录</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">79</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202304191340/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="202304191340/" class="post-title-link" itemprop="url">linux namespace 简介</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-19 13:41:02" itemprop="dateCreated datePublished" datetime="2023-04-19T13:41:02+08:00">2023-04-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-20 15:02:00" itemprop="dateModified" datetime="2025-02-20T15:02:00+08:00">2025-02-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Centos 7 5.4.239-1</li>
</ul>
<p>Linux 的 namespace 的作用是 <strong>隔离内核资</strong> ，目前主要实现了以下 namespace</p>
<ul>
<li><code>mount namespace</code> - 文件系统挂载点</li>
<li><code>UTS namespace</code> - 主机名</li>
<li><code>IPC namespace</code> - POSIX 进程间通信消息队列</li>
<li><code>PID namespace</code> - 进程 pid 数字空间</li>
<li><code>network namespace</code> - network</li>
<li><code>user namespace</code> - user ID 数字空间</li>
<li><code>cgroup</code> - 资源使用控制</li>
<li><code>time</code> - 隔离时钟（Clock）</li>
</ul>
<p>其中，除了 <code>network namespace</code>，其他 namespace 的操作需要使用 C 语言调用系统 API 实现。<code>network namespace</code> 的增删改查功能已经集成到了 Linux 的 <code>ip</code> 工具集的 <code>netns</code> 子命令中</p>
<p>Linux 里面的 namespace 给处在其中的进程造成 2 个错觉：</p>
<ol>
<li>它是系统里面唯一的进程</li>
<li>它独享系统的所有资源</li>
</ol>
<p>默认情况下，Linux 里面的所有进程处在和宿主机相同的 namespace ，即初始 namespace 里，默认享有全局系统资源。</p>
<p><strong><code>lsns</code> 命令可以查看当前系统上存在哪些 Namespace</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lsns</span></span><br><span class="line">        NS TYPE   NPROCS     PID USER             COMMAND</span><br><span class="line">4026531834 time      251       1 root             /lib/systemd/systemd --system --deserialize 52</span><br><span class="line">4026531835 cgroup    224       1 root             /lib/systemd/systemd --system --deserialize 52</span><br><span class="line">4026531836 pid       224       1 root             /lib/systemd/systemd --system --deserialize 52</span><br><span class="line">4026531837 user      686       1 root             /lib/systemd/systemd --system --deserialize 52</span><br><span class="line">4026531838 uts       221       1 root             /lib/systemd/systemd --system --deserialize 52</span><br><span class="line">4026531839 ipc       224       1 root             /lib/systemd/systemd --system --deserialize 52</span><br><span class="line">4026531840 net       229       1 root             /lib/systemd/systemd --system --deserialize 52</span><br><span class="line">4026531841 mnt       213       1 root             /lib/systemd/systemd --system --deserialize 52</span><br><span class="line">4026531862 mnt         1      61 root             kdevtmpfs</span><br><span class="line">4026532219 mnt         1 1426338 root             /lib/systemd/systemd-udevd</span><br><span class="line">4026532220 uts         1 1426338 root             /lib/systemd/systemd-udevd</span><br><span class="line">4026532230 mnt         1 2124756 root             /lib/systemd/systemd-logind</span><br><span class="line">4026532231 uts         1 2124756 root             /lib/systemd/systemd-logind</span><br><span class="line">4026532232 mnt         1 1426274 systemd-timesync /lib/systemd/systemd-timesyncd</span><br><span class="line">4026532233 mnt         1 1426257 root             /usr/sbin/irqbalance --foreground</span><br><span class="line">4026532326 mnt         1 2134793 root             /usr/sbin/NetworkManager --no-daemon</span><br><span class="line">4026532593 cgroup      7  937225 root             python manage.py runserver 0.0.0.0:8080</span><br><span class="line">4026532603 mnt         1 1416468 472              grafana server --homepath=/usr/share/grafana --config=/etc/grafana/grafana.ini --packaging=docker cfg:defau</span><br><span class="line">4026532604 uts         1 1416468 472              grafana server --homepath=/usr/share/grafana --config=/etc/grafana/grafana.ini --packaging=docker cfg:defau</span><br><span class="line">4026532605 ipc         1 1416468 472              grafana server --homepath=/usr/share/grafana --config=/etc/grafana/grafana.ini --packaging=docker cfg:defau</span><br><span class="line">4026532606 pid         1 1416468 472              grafana server --homepath=/usr/share/grafana --config=/etc/grafana/grafana.ini --packaging=docker cfg:defau</span><br><span class="line">4026532607 net         1 1416468 472              grafana server --homepath=/usr/share/grafana --config=/etc/grafana/grafana.ini --packaging=docker cfg:defau</span><br><span class="line">4026532664 cgroup      1 1416468 472              grafana server --homepath=/usr/share/grafana --config=/etc/grafana/grafana.ini --packaging=docker cfg:defau</span><br><span class="line">4026532665 mnt         1 1416534 1001             /opt/bitnami/blackbox-exporter/bin/blackbox_exporter --config.file=/etc/blackbox/blackbox.yml</span><br><span class="line">4026532666 uts         1 1416534 1001             /opt/bitnami/blackbox-exporter/bin/blackbox_exporter --config.file=/etc/blackbox/blackbox.yml</span><br><span class="line">4026532667 ipc         1 1416534 1001             /opt/bitnami/blackbox-exporter/bin/blackbox_exporter --config.file=/etc/blackbox/blackbox.yml</span><br><span class="line">4026532668 pid         1 1416534 1001             /opt/bitnami/blackbox-exporter/bin/blackbox_exporter --config.file=/etc/blackbox/blackbox.yml</span><br><span class="line">4026532669 net         1 1416534 1001             /opt/bitnami/blackbox-exporter/bin/blackbox_exporter --config.file=/etc/blackbox/blackbox.yml</span><br></pre></td></tr></table></figure>

<p>想要查看某个进程都在哪些 namespace 中，可以找到进程 ID （PID），通过查看以下内容或者 namespace 信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ps -elf | grep nginx</span></span><br><span class="line">4 S root     32679 32659  0  80   0 -  2248 sigsus Apr07 ?        00:00:00 nginx: master process nginx -g daemon off;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ll /proc/32679/ns/</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:51 cgroup -&gt; cgroup:[4026531835]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:51 ipc -&gt; ipc:[4026534784]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:51 mnt -&gt; mnt:[4026534583]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:51 net -&gt; net:[4026534787]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:51 pid -&gt; pid:[4026534878]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:51 pid_for_children -&gt; pid:[4026534878]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:51 user -&gt; user:[4026531837]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:51 uts -&gt; uts:[4026534877]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过以上命令，可以看到 <code>nginx</code> 进程所属的 namespace，要查看系统初始 namespace ，可以查看 PID 为 1 的进程的 namespace 信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ll /proc/1/ns/</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:53 cgroup -&gt; cgroup:[4026531835]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:53 ipc -&gt; ipc:[4026531839]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:53 mnt -&gt; mnt:[4026531840]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:53 net -&gt; net:[4026531992]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:53 pid -&gt; pid:[4026531836]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:53 pid_for_children -&gt; pid:[4026531836]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:53 user -&gt; user:[4026531837]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:53 uts -&gt; uts:[4026531838]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>链接文件的内容的格式为 ns 类型: [inode number]。这里的 <code>inode number</code> 则用来标识一个 namespace，我们也可以把它理解为 namespace 的 ID。如果两个进程的某个 namespace 文件指向同一个链接文件，说明其相关资源在同一个 namespace 中。 <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[不能不知道的三个docker容器隔离核心技术：namespace、cgroups、rootfs](https://zhuanlan.zhihu.com/p/374503196)">[1]</span></a></sup></p>
</blockquote>
<h1 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h1><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/374503196">不能不知道的三个docker容器隔离核心技术：namespace、cgroups、rootfs</a><a href="#fnref:1" rev="footnote"> ↩</a></span></li></ol></div></div>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202301171137/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="202301171137/" class="post-title-link" itemprop="url">linux 系统状态查看</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-01-17 11:37:49" itemprop="dateCreated datePublished" datetime="2023-01-17T11:37:49+08:00">2023-01-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-19 14:02:00" itemprop="dateModified" datetime="2025-02-19T14:02:00+08:00">2025-02-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Centos 7 kernel 5.4.221</li>
</ul>
<h1 id="启动过程"><a href="#启动过程" class="headerlink" title="启动过程"></a>启动过程</h1><p>在 <code>systemd</code> 管理的系统中，提供了工具 <code>systemd-analyze</code> 用于分析具体的启动过程，使用 <code>systemd-analyze --help</code> 查看使用帮助</p>
<h2 id="检查系统启动时间"><a href="#检查系统启动时间" class="headerlink" title="检查系统启动时间"></a>检查系统启动时间</h2><p>使用 <code>systemd-analyze</code> 命令会显示系统启动所用的时间，等同于 <code>systemd-analyze time</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemd-analyze</span> </span><br><span class="line">Startup finished in 1.830s (kernel) + 36.827s (userspace) = 38.657s </span><br><span class="line">graphical.target reached after 12.604s in userspace</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>systemd-analyze blame</code> 列出系统上各个 Unit 启动的时间</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemd-analyze blame</span></span><br><span class="line">          6.414s wazuh-agent.service</span><br><span class="line">          3.161s dracut-initqueue.service</span><br><span class="line">          2.473s network.service</span><br><span class="line">          1.004s watchdog.service</span><br><span class="line">          ...</span><br><span class="line">            45ms sysstat.service</span><br><span class="line">            14ms plymouth-switch-root.service</span><br><span class="line">            14ms systemd-journald.service</span><br><span class="line">             4ms systemd-logind.service</span><br><span class="line">             3ms sys-kernel-config.mount</span><br><span class="line">             3ms initrd-udevadm-cleanup-db.service</span><br><span class="line">             3ms systemd-random-seed.service</span><br><span class="line">             2ms google-shutdown-scripts.service</span><br></pre></td></tr></table></figure>

<p><strong>列出系统各个 Unit 启动消耗的时间</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemd-analyze critical-chain</span></span><br><span class="line">The time when unit became active or started is printed after the &quot;@&quot; character.</span><br><span class="line">The time the unit took to start is printed after the &quot;+&quot; character.</span><br><span class="line"></span><br><span class="line">graphical.target @12.604s</span><br><span class="line">└─multi-user.target @12.601s</span><br><span class="line">  └─skylight-agent.service @36.639s</span><br><span class="line">    └─network.target @9.073s</span><br><span class="line">      └─NetworkManager.service @8.795s +275ms</span><br><span class="line">        └─dbus.service @8.788s</span><br><span class="line">          └─basic.target @8.774s</span><br><span class="line">            └─sockets.target @8.772s</span><br><span class="line">              └─snapd.socket @8.766s +5ms</span><br><span class="line">                └─sysinit.target @8.669s</span><br><span class="line">                  └─cloud-init.service @6.850s +1.811s</span><br><span class="line">                    └─systemd-networkd-wait-online.service @4.970s +1.871s</span><br><span class="line">                      └─systemd-networkd.service @4.864s +91ms</span><br><span class="line">                        └─network-pre.target @4.850s</span><br><span class="line">                          └─cloud-init-local.service @3.228s +1.620s</span><br><span class="line">                            └─systemd-remount-fs.service @1.113s +93ms</span><br><span class="line">                              └─systemd-fsck-root.service @1.030s +69ms</span><br><span class="line">                                └─systemd-journald.socket @853ms</span><br><span class="line">                                  └─-.mount @692ms</span><br><span class="line">                                    └─-.slice @692ms</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="查看内存信息"><a href="#查看内存信息" class="headerlink" title="查看内存信息"></a>查看内存信息</h1><p>内存相关概念说明：</p>
<ul>
<li><strong>VSS ,Virtual Set Size , VIRT</strong> - 虚拟耗用内存（包含共享库占用的内存）， <strong>通常 VIRT 是系统承诺分配给应用的内存，不是实际使用的内存</strong></li>
<li><strong>RSS , Resident Set Size , RES</strong> - 实际使用物理内存（包含共享库占用的内存）</li>
<li><strong>PSS , Proportional Set Size</strong> - 实际使用的物理内存（比例分配共享库占用的内存）。 <strong><code>top</code> 命令中的 <code>SHR</code> 列展示的就是共享库按比例分配给进程的内存</strong></li>
<li><strong>USS , Unique Set Size</strong> - 进程独自占用的物理内存（不包含共享库占用的内存）</li>
</ul>
<h2 id="系统内存使用量统计"><a href="#系统内存使用量统计" class="headerlink" title="系统内存使用量统计"></a>系统内存使用量统计</h2><h3 id="free"><a href="#free" class="headerlink" title="free"></a>free</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">free -h</span></span><br><span class="line">               total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:            15Gi       7.8Gi       707Mi       449Mi       7.0Gi       6.9Gi</span><br><span class="line">Swap:           30Gi       1.0Gi        29Gi</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h3><p>例如查看使用内存排名前十的进程：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ps aux | sort -k4,4nr | head -n 10</span><br></pre></td></tr></table></figure>

<h3 id="sar-命令"><a href="#sar-命令" class="headerlink" title="sar 命令"></a>sar 命令</h3><p><a href="#sar-%E6%A3%80%E6%9F%A5%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AD%98%E7%BB%9F%E8%AE%A1%E6%95%B0%E6%8D%AE">使用 <code>sar</code> 命令检查系统上的内存及 Swap 使用情况</a></p>
<h2 id="查看某个进程使用的内存量"><a href="#查看某个进程使用的内存量" class="headerlink" title="查看某个进程使用的内存量"></a>查看某个进程使用的内存量</h2><p>比如检查 <code>docker</code> 使用的内存量，首先通过 <code>ps</code> 命令查询到 <code>docker</code> 的 PID 信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ps -elf | grep docker</span></span><br><span class="line">4 S root      1243     1  4  80   0 - 1067527 futex_ Jan03 ?      15:14:45 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br></pre></td></tr></table></figure>
<p>例如此处的 <code>docker</code> 进程的 PID 为 1243</p>
<ul>
<li><p>使用 <code>top</code> 命令动态查看 <code>docker</code> 使用的内存信息</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">top -p 1243</span></span><br><span class="line">top - 11:47:40 up 14 days,  2:09,  3 users,  load average: 0.65, 1.42, 1.70</span><br><span class="line">Tasks:   1 total,   0 running,   1 sleeping,   0 stopped,   0 zombie</span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">Cpu(s):  1.0 us,  0.6 sy,  0.0 ni, 98.3 <span class="built_in">id</span>,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span></span><br><span class="line">KiB Mem : 32068748 total,  2494500 free, 18536188 used, 11038060 buff/cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used.  9586340 avail Mem </span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                           </span><br><span class="line"> 1243 root      20   0 4270108   1.4g  53956 S   1.0  4.6 914:55.80 dockerd</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <code>ps aux</code> 命令查看内存使用量</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ps aux | grep 1243</span></span><br><span class="line">root      1243  4.5  4.6 4270108 1486460 ?     Ssl  Jan03 914:57 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br></pre></td></tr></table></figure>

<p>  输出结果中</p>
<ul>
<li>第 3、4 列 (<code>4.5  4.6</code>) 分别表示 <code>cpu 使用率</code>、<code>内存使用率</code>。</li>
<li>第 5、6 列 (<code>4270108 1486460</code>) 分别表示 <code>虚拟内存使用量</code>、<code>物理内存使用量</code>，单位为 <code>k</code>。</li>
</ul>
</li>
<li><p>通过进程的 <code>status</code> 文件查看内存使用</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /proc/1243/status</span></span><br><span class="line">Name:	dockerd</span><br><span class="line">Umask:	0022</span><br><span class="line">State:	S (sleeping)</span><br><span class="line">Pid:	1243</span><br><span class="line">PPid:	1</span><br><span class="line">VmPeak:	 4270364 kB</span><br><span class="line">VmSize:	 4270108 kB</span><br><span class="line">VmLck:	       0 kB</span><br><span class="line">VmPin:	       0 kB</span><br><span class="line">VmHWM:	 1562204 kB</span><br><span class="line">VmRSS:	 1492340 kB</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>其中，<code>VmRSS</code> 为进程使用的物理内存</p>
</li>
<li><p>使用 <code>pmap</code> 命令查看进程使用的内存信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pmap -x 1243</span><br><span class="line">pmap -p 1243</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <code>pidstat</code> 命令查看进程使用的内存信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pidstat -r -t -p 1424681 1 1</span></span><br><span class="line">Linux 6.8.0-1017-aws (U-3TSDMAL9IVFAQ) 	11/26/2024 	_x86_64_	(4 CPU)</span><br><span class="line"></span><br><span class="line">04:15:40 PM   UID      TGID       TID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command</span><br><span class="line">04:15:41 PM 408001114   1424681         -      0.00      0.00 34656400  256620   1.59  chrome</span><br><span class="line">04:15:41 PM 408001114         -   1424681      0.00      0.00 34656400  256620   1.59  |__chrome</span><br><span class="line">04:15:41 PM 408001114         -   1424696      0.00      0.00 34656400  256620   1.59  |__sandbox_ipc_thr</span><br><span class="line">04:15:41 PM 408001114         -   1424702      0.00      0.00 34656400  256620   1.59  |__chrome</span><br><span class="line">04:15:41 PM 408001114         -   1424703      0.00      0.00 34656400  256620   1.59  |__HangWatcher</span><br><span class="line">04:15:41 PM 408001114         -   1424704      0.00      0.00 34656400  256620   1.59  |__ThreadPoolServi</span><br><span class="line">04:15:41 PM 408001114         -   1424705      0.00      0.00 34656400  256620   1.59  |__ThreadPoolForeg</span><br><span class="line">04:15:41 PM 408001114         -   1424706      0.00      0.00 34656400  256620   1.59  |__ThreadPoolForeg</span><br><span class="line"></span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="202301171137/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202405231459/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="202405231459/" class="post-title-link" itemprop="url">Ansible playbooks 使用介绍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-05-23 14:59:10" itemprop="dateCreated datePublished" datetime="2024-05-23T14:59:10+08:00">2024-05-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-12 09:02:00" itemprop="dateModified" datetime="2025-02-12T09:02:00+08:00">2025-02-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>ansible-core 2.16</li>
<li>Docker image python:3.12.3</li>
</ul>
<a href="/202308311109/" title="Ansible 安装部署参考">Ansible 安装部署参考</a>  

<a href="/202405241042/" title="Ansible templates 使用介绍">Ansible templates 使用介绍</a>  

<h1 id="Ansible-Playbook-语法"><a href="#Ansible-Playbook-语法" class="headerlink" title="Ansible Playbook 语法"></a>Ansible Playbook 语法</h1><p>Playbooks 使用 YAML 语法定义（描述）。一个 <code>playbook</code> 由一个或多个 <code>play</code> 依序组成。每个 <code>play</code> 运行一个或多个 <code>task</code>，每个 <code>task</code> 也称为一个 <code>module</code></p>
<p>每一个 <code>play</code> 中包含了一个 <code>tasks</code> 列表，<code>tasks</code> 列表中的每个 <code>task</code> 在其对应的 <code>hosts</code> 上 <em><strong>依次执行</strong></em>。<strong>即一个 <code>task</code> 执行完毕，下一个 <code>task</code> 才会执行</strong>。</p>
<p>在运行 playbook 的过程中，<strong>如果一个 <code>host</code> 执行 <code>task</code> 失败，这个 <code>host</code> 将从整个 playbook 中移除</strong>。如果发生执行失败的情况，需要修正 <code>playbook</code> 中的错误，重新执行。</p>
<p>Ansible playbook 示例：</p>
<figure class="highlight shell"><figcaption><span>playbook.yml</span></figcaption><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">- name: Update web servers</span><br><span class="line">  hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">  - name: Ensure apache is at the latest version</span><br><span class="line">    ansible.builtin.yum:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: latest</span><br><span class="line"></span><br><span class="line">  - name: Write the apache config file</span><br><span class="line">    ansible.builtin.template:</span><br><span class="line">      src: /srv/httpd.j2</span><br><span class="line">      dest: /etc/httpd.conf</span><br><span class="line"></span><br><span class="line">- name: Update db servers</span><br><span class="line">  hosts: databases</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    port: 8080</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">  - name: Ensure postgresql is at the latest version</span><br><span class="line">    ansible.builtin.yum:</span><br><span class="line">      name: postgresql</span><br><span class="line">      state: latest</span><br><span class="line"></span><br><span class="line">  - name: Ensure that postgresql is started</span><br><span class="line">    ansible.builtin.service:</span><br><span class="line">      name: postgresql</span><br><span class="line">      state: started</span><br><span class="line">      </span><br><span class="line">---</span><br><span class="line">- name: Install multiple packages</span><br><span class="line">  hosts: webservers</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install packages</span><br><span class="line">      apt:</span><br><span class="line">        name: &quot;&#123;&#123; item &#125;&#125;&quot;</span><br><span class="line">        state: present</span><br><span class="line">      loop:</span><br><span class="line">        - nginx</span><br><span class="line">        - git</span><br><span class="line">        - curl      </span><br></pre></td></tr></table></figure>

<p>一个 Ansible playbook 由一个或多个 <code>plays</code> 组成，每个 <code>play</code> 包含以下部分：</p>
<ul>
<li><code>name</code> : 描述性的名称</li>
<li><code>hosts</code> : 指定目标主机</li>
<li><code>become</code> : 提升权限（默认是使用 <code>sudo</code> 提升到 <code>root</code> 用户）</li>
<li><code>remote_user</code> : 用于连接到远程主机的账户。(<strong>如果 Inventory 中定义了远程连接的用户，会覆盖此处的配置</strong>)</li>
<li><code>tasks</code> : 要执行的一系列任务列表</li>
<li><code>vars</code> : 用于定义变量，便于管理和重用</li>
<li><code>gather_facts</code> : 收集 <code>Facts</code>， 默认值为 <code>yes</code></li>
</ul>
<p><code>tasks</code> 是一个任务列表，每个任务执行特定的操作。任务包含以下元素：</p>
<ul>
<li><code>name</code> : 描述任务的目的。</li>
<li><code>module_name</code> : Ansible 模块名称，如 <code>apt</code>、<code>service</code> 等。</li>
<li><code>module_options</code> : 模块的参数，以键值对的形式提供。</li>
<li><code>when</code> : 条件语句，控制任务是否执行。</li>
<li><code>loop</code> : 循环执行任务</li>
</ul>
<p>执行以下命令运行 <code>playbook.yml</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ansible-playbook playbook.yml -f 10</span><br></pre></td></tr></table></figure>

<p>常用选项说明</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>-f</code><br/><code>--forks</code></td>
<td>指定并发执行的数量，默认为 5</td>
<td></td>
</tr>
<tr>
<td><code>-v</code><br/><code>--verbose</code> <br/><code>-vvvvvv</code></td>
<td>打印 debug 信息，详细程度从 <code>-v</code> 到 <code>-vvvvvv</code></td>
<td></td>
</tr>
<tr>
<td><code>-C</code><br/><code>--check</code></td>
<td><code>Check mode</code>，不执行任何实际操作，而是对要执行的操作进行验证</td>
<td></td>
</tr>
<tr>
<td><code>-D</code><br/><code>--diff</code></td>
<td>- <strong>只使用 <code>--diff</code> 会执行 play 定义的实际操作</strong>，并对所有受影响的文件或者模板显示其变更前后的具体差异<br/>- <strong>和 <code>--check</code> 一起使用，不会执行 play 定义的实际操作，只显示变更前后的差异</strong>，可以在实际执行前，调试&#x2F;预览将要进行的变更，防止意外配置变更或文件修改<br/>主要用于文件或者模板的变更，对于其他类型的任务（如包安装、服务管理、修改主机名等），不会显示具体的差异（ <strong>配合 <code>--check</code> 使用时，结果会显示为 <code>skipping</code>，实际执行时结果为 <code>changed</code></strong> ）。</td>
<td></td>
</tr>
<tr>
<td><code>--list-hosts</code></td>
<td>不执行任何实际操作，只列出符合 <code>pattern</code> 的目标主机</td>
<td></td>
</tr>
<tr>
<td><code>--list-tasks</code></td>
<td>不执行任何实际操作，只列出将要执行的 <code>task</code></td>
<td></td>
</tr>
<tr>
<td><code>--syntax-check</code></td>
<td>不执行任何实际操作，只检查 playbook 文件是否有语法错误</td>
<td></td>
</tr>
</tbody></table>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="202405231459/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202308311739/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="202308311739/" class="post-title-link" itemprop="url">Linux sudo 使用介绍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-08-31 11:09:16" itemprop="dateCreated datePublished" datetime="2023-08-31T11:09:16+08:00">2023-08-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-11 16:02:00" itemprop="dateModified" datetime="2025-02-11T16:02:00+08:00">2025-02-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><strong>环境信息</strong></p>
<ul>
<li>Centos 7</li>
</ul>
<p><code>sudo</code> 可以配置适当的权限授予普通用户，使普通用户执行 <code>root</code> 用户才能执行的操作</p>
<p>配置 <code>sudo</code> 权限的主要配置文件为 <code>/etc/sudoers</code>。<code>/etc/sudoers</code>是一个只读文件，不能直接使用 <code>vim</code> 等编辑器来编辑，要修改此文件，需要以 <code>root</code> 用户身份使用 <code>visudo</code> 命令来修改。</p>
<p>主要配置文件内容如下</p>
<figure class="highlight shell"><figcaption><span>/etc/sudoers</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Allow root to run any commands anywhere</span></span></span><br><span class="line">root    ALL=(ALL)       ALL</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">wheel  ALL=(ALL)       NOPASSWD: ALL</span></span><br></pre></td></tr></table></figure>

<p>各列值含义说明：</p>
<ul>
<li><code>root</code> 第一列为用户名，如 <code>root</code>、<code>users</code>；<code>%wheel</code> 以 <code>%</code> 开头表示这是一个组，而不是用户</li>
<li><code>ALL=(ALL)</code> 第二列等号左边的 <code>ALL</code> 表示允许从任何主机登录当前的用户账户；等号右边的 <code>ALL</code> 表示第一列的用户可以切换成系统中任何一个其它用户（如：<code>su users</code>）；</li>
<li><code>ALL</code> 第三列表示第一列的用户能下达的命令，<code>ALL</code> 表示可以下达任何命令。<code>NOPASSWD: ALL</code> 意味着成员可以执行指定的命令而无需输入密码。</li>
</ul>
<p>当我们以普通用户身份（以 <code>test</code> 为例）登录，在使用 <code>sudo</code> 命令时报出如下信息：</p>
<p><code>test is not in the sudoers file.  This incident will be reported.</code></p>
<p>则说明该用户没有在 <code>/etc/sudoers</code> 文件中进行配置，因此无法使用 <code>sudo</code> 命令</p>
<p>AWS 的 Centos 镜像部署后的虚拟机默认使用 <code>centos</code> 用户登陆，登陆后即可执行 <code>sudo su -</code> 切换到 <code>root</code> 用户，此配置由 <code> /etc/sudoers.d/90-cloud-init-users</code> 配置，内容如下：</p>
<figure class="highlight shell"><figcaption><span>/etc/sudoers.d/90-cloud-init-users</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /etc/sudoers.d/90-cloud-init-users</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Created by cloud-init v. 19.4 on Mon, 31 Oct 2022 07:58:58 +0000</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">User rules <span class="keyword">for</span> centos</span></span><br><span class="line">centos ALL=(ALL) NOPASSWD:ALL</span><br></pre></td></tr></table></figure>
<p>若要禁止此行为，删除此文件即可。</p>
<h1 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h1><h2 id="限制特定用户只能执行指定目录下的脚本"><a href="#限制特定用户只能执行指定目录下的脚本" class="headerlink" title="限制特定用户只能执行指定目录下的脚本"></a>限制特定用户只能执行指定目录下的脚本</h2><p>在 <code>visudo</code> 中，你可以使用 <code>Cmnd_Alias</code> 限制用户只能执行特定目录下的脚本。假设你想让用户 <code>centos</code> 只能执行 <code>/usr/local/scripts/</code> 目录下的脚本，可以按照以下方式配置：</p>
<figure class="highlight shell"><figcaption><span>visudo</span></figcaption><table><tr><td class="code"><pre><span class="line">Cmnd_Alias ALLOWED_SCRIPTS = /usr/local/scripts/*</span><br><span class="line"></span><br><span class="line">centos ALL=(ALL) NOPASSWD: ALLOWED_SCRIPTS</span><br></pre></td></tr></table></figure>
<p><strong>含义</strong> ：</p>
<ul>
<li><p><strong>Cmnd_Alias ALLOWED_SCRIPTS &#x3D; &#x2F;usr&#x2F;local&#x2F;scripts&#x2F;</strong>*</p>
<p>  定义 <code>ALLOWED_SCRIPTS</code> ，表示 <strong>允许执行 &#x2F;usr&#x2F;local&#x2F;scripts&#x2F; 目录下的所有脚本</strong> 。</p>
</li>
<li><p><strong>qqc ALL&#x3D;(ALL) NOPASSWD: ALLOWED_SCRIPTS</strong></p>
<p>  允许 <code>centos</code> 用户以 <code>sudo</code> 执行 <code>ALLOWED_SCRIPTS</code> 目录下的所有脚本，且无需输入密码。</p>
</li>
</ul>
<p>切换到 <code>centos</code> 用户，并尝试执行：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo /usr/local/scripts/test.sh</span><br></pre></td></tr></table></figure>
<p><strong>成功执行</strong> ，说明规则生效。</p>
<p>但是，如果 <code>centos</code> 用户 <strong>试图运行 <code>/bin/bash</code> 或 <code>/usr/bin/python</code> ，或者访问其他路径</strong> ：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo /bin/bash</span></span><br><span class="line">Sorry, user centos is not allowed to execute &#x27;/bin/bash&#x27; as root on this host.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>如果希望 <code>centos</code> 用户可以查看自己可以运行的命令：</strong></p>
<figure class="highlight shell"><figcaption><span>visudo</span></figcaption><table><tr><td class="code"><pre><span class="line">Cmnd_Alias ALLOWED_SCRIPTS = /usr/local/scripts/*</span><br><span class="line">qqc ALL=(ALL) NOPASSWD: ALLOWED_SCRIPTS, /usr/bin/sudo -l</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这样，<code>centos</code> 用户可以运行:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo -l</span><br></pre></td></tr></table></figure>
<p>来查看自己被允许的 <code>sudo</code> 命令。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202207261420/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="202207261420/" class="post-title-link" itemprop="url">Nginx 服务常用配置说明</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-26 14:21:02" itemprop="dateCreated datePublished" datetime="2022-07-26T14:21:02+08:00">2022-07-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 10:02:00" itemprop="dateModified" datetime="2025-02-07T10:02:00+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Linux/%E5%B8%B8%E7%94%A8%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">常用服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Nginx-服务配置"><a href="#Nginx-服务配置" class="headerlink" title="Nginx 服务配置"></a>Nginx 服务配置</h1><h2 id="全局通用配置"><a href="#全局通用配置" class="headerlink" title="全局通用配置"></a>全局通用配置</h2><figure class="highlight shell"><figcaption><span>nginx.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">user nginx nginx;    </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建议设置为 cpu 核心数或者 cpu 核心数的 2 倍，进程会包含一个 `master process`，多个 `worker process`</span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">master process 负责绑定端口、调度进程等，不负责业务的处理</span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">worker process 是业务进程，负责业务的处理</span></span><br><span class="line">worker_processes auto;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一个 worker 进程可以打开的最大的 fd 个数，受 Linux 内核限制</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">理论值应该是系统最多打开文件数（<span class="built_in">ulimit</span> -n）与 nginx 进程数相除</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可通过 <span class="built_in">ulimit</span> 设置或修改系统文件：`/etc/securit/limits.conf`</span></span><br><span class="line">worker_rlimit_nofile 1024；</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cpu 亲和性设置</span> </span><br><span class="line">worker_cpu_affinity    0001 0010 0100 1000;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">工作进程调度优先级，-20 到 19 之间的值，值越小越优先调用。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果系统同时运行多个任务，你可能需要提高 nginx 的工作进程的优先级</span> </span><br><span class="line">worker_priority 0；              </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ssl 硬件加速服务器，需要硬件支持</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ssl_engine ssl_engine device;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nginx 是否以守护进程运行，是否让 nignx 运行于后台；调试时可为 off，使得所有信息直接输出在控制台</span></span><br><span class="line">daemon      on | off;         </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">events 模块中包含 nginx 中所有处理连接的设置。</span></span><br><span class="line">events &#123;</span><br><span class="line">    # 每个 worker 进程允许的最多连接数, </span><br><span class="line">    # nginx 服务最大连接数：worker_processes * worker_connections (受 worker_rlimit_nofile 限制)</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">    use epoll;</span><br><span class="line">    </span><br><span class="line">    # 是否允许一次性地响应多个用户请求</span><br><span class="line">    multi_accept on;                    </span><br><span class="line"></span><br><span class="line">    # 是否打开 nginx 的 accept 锁；此锁能够让多个 worker 进行轮流地、序列化地与新的客户端建立连接；</span><br><span class="line">    # 而通常当一个 worker 进程的负载达到其上限的 7/8，master 就尽可能不将请求调度至 worker.</span><br><span class="line">	accept_mutex on | off;              </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">HTTP 模块控制着 nginx http 处理的所有核心特性</span></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    # 是否在错误页面中显示和响应头字段中发出 nginx 版本号。</span><br><span class="line">    # 安全考虑建议关闭</span><br><span class="line">    server_tokens on | off | string; </span><br><span class="line">    </span><br><span class="line">    # 是否启用 sendfile 内核复制模式功能。作为静态服务器可以提供最大的 IO 访问速度。</span><br><span class="line">    sendfile on | off; </span><br><span class="line">    </span><br><span class="line">    # 尽快发送数据，否则会在数据包达到一定大小后再发送数据。这样会减少网络通信次数，降低阻塞概率，但也会影响响应及时性。</span><br><span class="line">    # 比较适合于文件下载这类的大数据通信场景。</span><br><span class="line">    tcp_nodelay on|off; </span><br><span class="line">    </span><br><span class="line">    # 单位s，适当降低此值可以提高响应连接数量</span><br><span class="line">    keepalive_timeout  65; </span><br><span class="line">    </span><br><span class="line">    # 一次长连接上允许的最大请求数</span><br><span class="line">    keepalive_requests 100；       </span><br><span class="line">    </span><br><span class="line">    # 禁止指定浏览器使用 keepalive</span><br><span class="line">    keepalive_disable msie6|none；    </span><br><span class="line">    </span><br><span class="line">    # 读取 http 请求首部的超时时长。如果客户端在此时间内未传输整个头，则会向客户端返回 408（请求超时）错误</span><br><span class="line">    client_header_timeout 1;     </span><br><span class="line">    </span><br><span class="line">    # 读取 http 请求包体的超时时间。</span><br><span class="line">    client_body_timeout 2;</span><br><span class="line">    </span><br><span class="line">    # 发送响应的超时时长。超时后连接将关闭。</span><br><span class="line">    send_timeout 5;  </span><br><span class="line">    </span><br><span class="line">    # http 请求包体的最大值，常用于限定客户端所能够请求的最大包体，根据请求首部中的 Content-Length 来检查，以避免无用的传输。</span><br><span class="line">    client_max_body_size 1m;</span><br><span class="line">    </span><br><span class="line">    # 限制客户端每秒传输的字节数，默认为0，表示没有限制。单位 Byte/s</span><br><span class="line">    limit_rate 0;</span><br><span class="line">    </span><br><span class="line">    # nginx 向客户端发送响应报文时，如果大小超过了此处指定的值，则后续的发送过程开始限速，单位 Byte</span><br><span class="line">    limit_rate_after 0;</span><br><span class="line">    </span><br><span class="line">    # 是否忽略不合法的 http 首部，默认为 on，off 意味着请求首部中出现不合规的首部将拒绝响应。</span><br><span class="line">    ignore_invalid_headers on|off;</span><br><span class="line">    </span><br><span class="line">    # 用户访问的文件不存在时，是否将其记录到错误日志中。</span><br><span class="line">    log_not_found on|off;   </span><br><span class="line">    </span><br><span class="line">    # nginx 使用的 dns 地址，及缓存解析结果的时间               </span><br><span class="line">    resolver 8.8.8.8 [valid=time] [ipv6=on|off];</span><br><span class="line">    </span><br><span class="line">    # dns 解析超时时间 </span><br><span class="line">    resolver_timeout 2；     </span><br><span class="line">    </span><br><span class="line">    # 是否打开文件缓存功能，max：用于缓存条目的最大值，</span><br><span class="line">    # inactive：某缓存条目在指定时长内没有被访问过时，将自动被删除，即缓存有效期，通常默认为 60s。</span><br><span class="line">    open_file_cache off;  </span><br><span class="line">    open_file_cache max=N [inactive=time];    </span><br><span class="line">    </span><br><span class="line">    # 是否缓存文件找不到或没有权限访问等相关信息。</span><br><span class="line">    open_file_cache_errors on | off; </span><br><span class="line">    </span><br><span class="line">    # 多长时间检查一次缓存中的条目是否超出非活动时长。</span><br><span class="line">    # 建议值：小于等于 open_file_cache inactive</span><br><span class="line">    open_file_cache_valid 60;   </span><br><span class="line">    </span><br><span class="line">    # 在 open_file_cache inactive指 定的时长内被访问超过此处指定的次数时，才不会被删除（删除低命中率的缓存）。</span><br><span class="line">    open_file_cache_min_uses 2;     </span><br><span class="line">    </span><br><span class="line">    # 开启内容压缩，可以有效降低客户端的访问流量和网络带宽</span><br><span class="line">    gzip on | off;</span><br><span class="line">    </span><br><span class="line">    # 内容超过最少长度后才开启压缩，太短的内容压缩效果不佳，且会浪费系统资源。</span><br><span class="line">    # 压缩长度会作为 http 响应头 Content-Length 字段返回给客户端。 建议值：64</span><br><span class="line">    gzip_min_length length;</span><br><span class="line">    </span><br><span class="line">    # 压缩级别，默认值为 1。范围为1～9级，压缩级别越高压缩率越高，但对系统性能要求越高。建议值：4</span><br><span class="line">    gzip_comp_level 1~9;</span><br><span class="line">    </span><br><span class="line">    # 压缩内容类型，默认为 text/html;。只压缩 html 文本，一般我们都会压缩 js、css、json 之类的，可以把这些常见的文本数据都配上。</span><br><span class="line">    如：text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;</span><br><span class="line">    gzip_types mime-type …;     </span><br><span class="line">    </span><br><span class="line">    # 自动显示目录</span><br><span class="line">    autoindex on;</span><br><span class="line">    </span><br><span class="line">    # off ： 以人类易读的方式显示文件大小，on：以 bytes 显示文件大小</span><br><span class="line">    autoindex_exact_size off;</span><br><span class="line">    </span><br><span class="line">    # 定义限制区域，imit_req_zone 只能放在 http &#123;&#125; 内，使用此限制可以在 http &#123;&#125; （对服务器内所有的网站生效）、server &#123;&#125; （对具体的一个网站生效）或 location &#123;&#125; （对具体的一个网址生效）</span><br><span class="line">    # 此区域名称为 test，可根据需求自定义； 10m 表示此区域存储 key（$binary_remote_addr）使用的大小</span><br><span class="line">    # 存储大小，一般 1m 空间大约能保存 1.6 万条 IP 地址，空间满了新数据会覆盖旧数据</span><br><span class="line">    # rate=1r/m ，限制访问请求频率为每分钟 1 次，可根据需要自行设置，1r/s 是 1 秒 1 次，时间单位只能选择 s (秒)或 m (分)，最低频率限制是每分钟 1 次访问请求</span><br><span class="line">    # rate=10r/m，1分钟最多访问 10 次，同时不能超过 1r/6s，即 6s 内最多访问 1 次。超过 1r/6s 返回 503</span><br><span class="line">    limit_req_zone $binary_remote_addr zone=test:10m rate=1r/m;</span><br><span class="line">    </span><br><span class="line">    # 定义日志格式</span><br><span class="line">    log_format main &#x27;&#123; time: $time_iso8601|&#x27;</span><br><span class="line">                    &#x27;http_host:$http_host|&#x27;</span><br><span class="line">                    &#x27;cdn_ip:$remote_addr|&#x27;</span><br><span class="line">                    &#x27;request:$request|&#x27;</span><br><span class="line">                    &#x27;request_method:$request_method|&#x27;</span><br><span class="line">                    &#x27;http_user_agent:$http_user_agent|&#x27;</span><br><span class="line">                    &#x27;size:$body_bytes_sent|&#x27;</span><br><span class="line">                    &#x27;responsetime:$request_time|&#x27;</span><br><span class="line">                    &#x27;upstreamtime:$upstream_response_time|&#x27;</span><br><span class="line">                    &#x27;upstreamhost:$upstream_addr|&#x27;</span><br><span class="line">                    &#x27;upstreamstatus:$upstream_status|&#x27;</span><br><span class="line">                    &#x27;url:$http_host$uri|&#x27;</span><br><span class="line">                    &#x27;http_x_forwarded_for:$clientRealIp|&#x27;</span><br><span class="line">                    &#x27;status:$status&#125;&#x27;;</span><br><span class="line">    </span><br><span class="line">    # server 负责具体的 http 服务器实现</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80 [default_server]  [rcvbuf=SIZE]  [sndbuf=SIZE] [ssl];</span><br><span class="line">        </span><br><span class="line">        # 可使用通配符*或正则表达式(~开头)，多个域名先精确匹配，再通配，再正则,&#x27;_&#x27;表示空主机头</span><br><span class="line">        server_name  _  ;</span><br><span class="line">        </span><br><span class="line">        access_log logs/access.log main;</span><br><span class="line">        error_log logs/access.err.log;</span><br><span class="line">        </span><br><span class="line">        # 跨域配置</span><br><span class="line">        add_header Access-Control-Allow-Origin *;</span><br><span class="line">        add_header Access-Control-Allow-Headers &#x27;Origin, No-Cache, X-Requested-With, If-Modified-Since, Pragma, Last-Modified, Cache-Control, Expires, Content-Type, X-E4M-With&#x27;;</span><br><span class="line">        add_header Access-Control-Allow-Methods GET,POST,OPTIONS;</span><br><span class="line">        add_header Access-Control-Allow-Credentials: true;</span><br><span class="line">        </span><br><span class="line">        location / &#123;       </span><br><span class="line">            # web 资源路径             </span><br><span class="line">            root   html;          </span><br><span class="line">            </span><br><span class="line">            # 定义默认页面，从左往右匹配           </span><br><span class="line">            index  index.html index.htm;   </span><br><span class="line">            </span><br><span class="line">            # 自左向右读取指定路径，找到即停止，如果都不存在，返回一个错误码</span><br><span class="line">            try_files $uri $uri.html $uri/index.html =404;        </span><br><span class="line">            </span><br><span class="line">            # 自左向右读取指定路径，找到即停止，如果都不存在，返回一个 uri</span><br><span class="line">            try_files $uri $uri.html $uri/index.html /404.html; </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        location /i/ &#123; </span><br><span class="line">            # 路径别名，只能用于 location 中。</span><br><span class="line">            # 访问 http://a.com/i/a.html, 资源路径为：/data/www/html/a.html</span><br><span class="line">            # 若是root指令，访问 http://a.com/i/a.html，资源路径为：/data/www/html/i/a.html</span><br><span class="line">		    alias /data/www/html/;          </span><br><span class="line">	    &#125;</span><br><span class="line">	    </span><br><span class="line">	    # 对于某个请求发生错误，如果匹配到错误码，重定向到新的 url</span><br><span class="line">	    error_page  404              /404.html; </span><br><span class="line">	    error_page   500 502 503 504  /50x.html;</span><br><span class="line">	    </span><br><span class="line">	    # 对于某个请求发生错误，如果匹配到错误码，重定向到新的 url,同时可以更改返回码</span><br><span class="line">	    error_page 404 =200 /404.html;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    # 包含其他配置文件</span><br><span class="line">    include vhosts/*.conf;        </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="202207261420/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202306021537/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="202306021537/" class="post-title-link" itemprop="url">Linux 内存管理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-06-02 15:37:57" itemprop="dateCreated datePublished" datetime="2023-06-02T15:37:57+08:00">2023-06-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-04 14:02:00" itemprop="dateModified" datetime="2025-02-04T14:02:00+08:00">2025-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Memory-相关的术语说明"><a href="#Memory-相关的术语说明" class="headerlink" title="Memory 相关的术语说明"></a>Memory 相关的术语说明</h1><ul>
<li><code>Main Memory</code> - 也经常称为 <code>Physical Memory</code>，计算机上的 Fast Data Storage Area。</li>
<li><code>Virtual Memory</code> - Main Memory 的一个抽象层，他几乎有无限大的空间，Virtual Memory 不是 Main Memory</li>
<li><code>Resident Memory</code> - 驻留（Reside）在 Main Memory 中的内存，相当于实际使用的物理内存（Main Memory&#x2F;Physical Memory），如 <code>top</code> 命令中的 <code>RES</code>、<code>ps aux</code> 命令中的 <code>RSS</code> 就是指 Resident Memory.</li>
<li><code>Anonymous Memory</code> - 未关联文件系统位置和路径的内存，通常指 Process Address Space 中的程序运行过程中的数据（Working Data），通常被称为 <code>Heap</code></li>
<li><code>Address Space</code> - 内存地址空间，内存地址相关的上下文（Context），包含程序（Processes）和内核（Kernel）使用的 Virtual Address Space</li>
<li><code>Segment</code> - 用于标识 Virtual Memory 中的有特殊作用的一个区域，如可执行程序（Executable）或可写（Writable）的 Page</li>
<li><code>Instruction Text</code> - CPU 指令（Instructions） 在内存中的引用地址，通常位于 <code>Segment</code> 中</li>
<li><code>OOM</code> - Out Of Memory，当内核检测到系统可用内存不足时采取的动作</li>
<li><code>Page</code> - OS 和 CPU 使用和分配内存的单位，早期大小一般为 4 或 8 Kbytes，现代化的 CPU 和 OS 通常支持 Multi Page Sizes</li>
<li><code>Page Fault</code> - 通常在需要访问的内容不存在于 Virtual Memory 中时，系统产生一个中断，导致所需内容加载入内存</li>
<li><code>Paging</code> - 当内存中的内容不再使用或内存空间不足时进行的在内存和 Storage Devices 中的内容交换，主要是为了空出内存供需要内存的进程使用</li>
<li><code>Swapping</code> - Linux 中将不再使用或内存空间不足时，将部分内存中的内容 Paging 到 Swap Devices</li>
<li><code>Swap</code> - Linux 中 Swapping 时，将内容转移到的目标，可能是 Storage Devices 上的一个区域，被称为 Physical Swap Device，或者是一个文件系统文件，称为 Swap File。</li>
</ul>
<p><a href="https://csms.tech/202405311003/#Memory">Memory 部分概念详细说明参考</a></p>
<h1 id="MMU"><a href="#MMU" class="headerlink" title="MMU"></a>MMU</h1><p>Memory Management Unit（MMU） 负责虚拟内存地址（Virtual Memory Address）到物理内存地址（Physical Memory Address）的转换</p>
<p><img src="https://i.csms.tech/img_287.png"></p>
<h1 id="Freeing-Memory"><a href="#Freeing-Memory" class="headerlink" title="Freeing Memory"></a>Freeing Memory</h1><p>当系统上可用内存低或不足时，系统会采用一系列的手段释放内存。主要包括下图所示方式<br><img src="https://i.csms.tech/img_288.png"></p>
<ul>
<li><strong>Free List</strong><br>  不在使用中的 Pages 列表，也称为 Idle Memory，这部分内存可以被系统立即分配给需要的程序使用</li>
<li><strong>Page Cache</strong><br>  文件系统缓存（Filesystem Cache）。有个 <code>swappiness</code> 的参数可以配置系统是使用 <code>Page Cache</code> 还是 <code>Swapping</code> 来释放内存</li>
<li><strong>Swapping</strong><br>  通过内核进程 <code>kswapd</code> 实现 Paging Out 到 Swap Device 或者 File System-Based Swap File，这只有在系统上有 Swap 时才有用。</li>
<li><strong>Reaping</strong><br>  也被称为 <strong>Shrinking</strong> ，当系统可用内存小到一个临界值后，内核就会开始释放可以回收的内存</li>
<li><strong>OOM Killer</strong><br>  <strong>Out Of Memory Killer</strong> ，系统内存不足时，系统会使用 OOM Killer 机制来 kill 掉某个进程来释放内存。</li>
</ul>
<p>在 Linux 中，当系统可用内存低于阈值（<code>vm.min_free_kbytes</code>）时，Page Out Daemon（<code>kswapd</code>） 会启动 <strong>Page Scanning</strong> ，</p>
<h1 id="进程的内存分层结构"><a href="#进程的内存分层结构" class="headerlink" title="进程的内存分层结构"></a>进程的内存分层结构</h1><p>进程的内存结构一般被分成多个 <code>segment</code>，包括</p>
<ul>
<li><strong><code>Executable Text segment</code></strong> - 存放程序代码（the executable CPU Instructions）, 只读</li>
<li><strong><code>Executable Data section</code></strong> - 存放程序初始化全局变量（global variables），通常 <strong>可读写</strong> ，写权限用于程序运行期间更新变量值。</li>
<li><strong><code>Heap section</code></strong> - 程序运行过程中动态分配的内存，属于 Anonymous Memory</li>
<li><strong><code>Stack section</code></strong> - 调用程序功能时的临时数据存储，如函数参数、返回地址、本地变量等。</li>
</ul>
<p><img src="https://i.csms.tech/img_239.png"></p>
<p>下图展示了 C 程序（Program）在内存中的分层结构(layout of a C program in memory)<br><img src="https://i.csms.tech/img_238.png"></p>
<blockquote>
<ul>
<li>其中， <strong><code>Data section</code></strong>  被分成了 2 部分，包括 <code>(a) initialized data</code> 和 <code>(b) uninitialized data</code></li>
</ul>
</blockquote>
<p>使用 GNU 工具 <code>size</code> 可以检查 <strong>Projram</strong> 在磁盘上的 <strong>内存布局</strong>。这些值在程序编译时确定，并不会在程序运行时变化，因此它们是固定不变的。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">size /usr/sbin/sshd</span></span><br><span class="line">   text	   data	    bss	    dec	    hex	filename</span><br><span class="line"> 817397	  15460	  37664	 870521	  d4879	/usr/sbin/sshd</span><br></pre></td></tr></table></figure>
<p>输出信息中：</p>
<ul>
<li><code>text</code> : 代表 <code>Text section</code> 的大小</li>
<li><code>data</code> : 初始化数据段(<code>initialized data</code>)的大小，包含已初始化的全局和静态变量。</li>
<li><code>bss</code> : 未初始化数据段的大小，包含未初始化的全局和静态变量。</li>
<li><code>dec</code> : 上述所有部分的总大小，以十进制表示。</li>
<li><code>hex</code> : 上述所有部分的总大小，以十六进制表示。</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="202306021537/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/20250131111615/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="20250131111615/" class="post-title-link" itemprop="url">Linux File System 及存储系统简介</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-01-31 11:01:00" itemprop="dateCreated datePublished" datetime="2025-01-31T11:01:00+08:00">2025-01-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>Linux 中典型的文件系统模型（以接口形式）如下图： <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Systems Performance: Enterprise and the Cloud v2](https://s.csms.tech/file/Systems.Performance.Enterprise.and.the.Cloud.2nd.Edition.2020.12.pdf) #8.2.1 File System Interfaces">[1]</span></a></sup></p>
<p><img src="https://i.csms.tech/img_291.png"></p>
<h1 id="File-System-Cache"><a href="#File-System-Cache" class="headerlink" title="File System Cache"></a>File System Cache</h1><p>典型的 File System Cache 模型如下图:<br><img src="https://i.csms.tech/img_292.png"></p>
<p>因为文件系统缓存（File System Cache）的存在，在统计 Applications 的读写请求延迟（IO Latency）时，要注意区分分析的统计数据是 <strong>文件系统（File System）的延迟（Request Latency）</strong> 还是 <strong>物理存储设备（Physical Device）的延迟</strong> 。</p>
<p>OS 通常提供的 IO 统计数据是 <strong>存储设备级别（Disk Device-level）</strong> ，而不是 <strong>文件系统级别（File System Level）</strong> ，但是大多数情况下，影响 Application 性能的通常是 File System 级别的延迟（Latency），而不是物理存储设备（Physical Device）级别的延迟。比如 File System 对 Application 的写操作（Write Operations）会进行缓存（Buffers），缓存成功后立即向 Application 返回写成功的响应，文件系统会在后台定期的将 Buffer 里面的内容刷新（Write-back, 写回）回磁盘设备，这个写回操作会导致磁盘设备出现较高或者突发（Burstable）的 Disk IO Latency，从 Disk Device-level 统计数据来看，这可能是个问题，但是，Application 并不需要等待此时的写回操作，此时的 Disk Device-level IO Latency 对 Application 无任何的性能影响。</p>
<p><strong>File System 通常使用 Main Memory（RAM）作为缓存（Cache）介质来提高性能</strong> ，Cache 的处理过程对 Applications 来说是透明的。</p>
<p>OS 中 File System 涉及到的相关 Cache 如下表：</p>
<table>
<thead>
<tr>
<th>Cache</th>
<th>Example</th>
</tr>
</thead>
<tbody><tr>
<td><code>Page cache</code></td>
<td>Operating system page cache</td>
</tr>
<tr>
<td><code>File system primary cache</code></td>
<td>ZFS ARC</td>
</tr>
<tr>
<td><code>File system secondary cache</code></td>
<td>ZFS L2ARC</td>
</tr>
<tr>
<td><code>Directory cache</code></td>
<td><code>dentry cache</code></td>
</tr>
<tr>
<td><code>inode cache</code></td>
<td><code>inode cache</code></td>
</tr>
<tr>
<td><code>Device cache</code></td>
<td>ZFS vdev</td>
</tr>
<tr>
<td><code>Block device cache</code></td>
<td>Buffer cache</td>
</tr>
</tbody></table>
<h2 id="Prefetch"><a href="#Prefetch" class="headerlink" title="Prefetch"></a>Prefetch</h2><p><strong>文件系统预取（File System Prefetch）</strong> 是 Linux 内核的一种优化机制，用于 <strong>提前加载</strong> 可能会被访问的文件或数据到内存，以提高 <strong>读取性能</strong> 和 <strong>系统响应速度</strong> 。</p>
<p>当程序读取文件时，Linux 内核可能会：</p>
<ul>
<li><strong>提前读取相邻的数据块，即顺序预取（Read-Ahead）</strong> 。</li>
<li><strong>基于访问模式预测未来的数据请求，即智能预取（Adaptive Readahead）</strong> 。</li>
<li><strong>结合缓存管理（Page Cache）减少磁盘 I&#x2F;O，提高性能</strong></li>
</ul>
<p>Linux 文件系统预取主要依赖于以下几种机制：</p>
<ul>
<li><strong>Page Cache（页缓存）</strong> 。Linux 通过 Page Cache 缓存已经读取的数据，以 <strong>减少磁盘 I&#x2F;O，提高性能</strong> 。<ul>
<li>当进程请求读取文件时，内核会先检查 Page Cache，如果数据已存在，则直接返回，避免磁盘读取。</li>
<li>如果数据不在缓存中，Linux 会从磁盘加载数据，并存入 Page Cache，方便后续访问。</li>
</ul>
</li>
<li><strong>Read-Ahead（预读机制）</strong> 是 Linux 预取的核心机制之一，它会 <strong>提前加载文件数据，减少未来读取时的磁盘 I&#x2F;O</strong> 。<ul>
<li>当应用程序顺序读取文件时，Linux 会自动预取更多的数据，提高性能。</li>
<li>Linux 预取大小 <strong>动态调整</strong> ，如果发现访问是顺序的，会增加预取数据量。</li>
</ul>
</li>
<li><strong>Readahead 调优参数</strong> 。Linux 通过 <code>/sys/class/bdi/</code> 目录下的参数进行 Read-Ahead 调优<ul>
<li><code>/sys/class/bdi/default/read_ahead_kb</code> 这个值通常默认为 128 KB 或 256 KB，表示内核每次读取至少 128 KB 以优化性能。</li>
<li><code>echo 1024 &gt; /sys/class/bdi/default/read_ahead_kb</code> 设置为 <code>1024 KB（1MB）</code>，适用于 <strong>大文件顺序读取</strong> 。</li>
<li><strong>Fadvise 和 Madvise 提示</strong> 。Linux 提供了 <code>posix_fadvise()</code> 和 <code>madvise()</code> ，让应用程序 <strong>主动提示内核</strong> 预取策略<ul>
<li><code>posix_fadvise(fd, offset, len, POSIX_FADV_WILLNEED)</code> 提示内核： <strong>这个文件很快会被读取，可以提前加载进 Page Cache</strong> 。</li>
<li><code>posix_fadvise(fd, offset, len, POSIX_FADV_SEQUENTIAL)</code> 告诉内核： <strong>文件是顺序读取的，可以增大 Read-Ahead</strong> 。</li>
</ul>
</li>
</ul>
</li>
<li><strong>Prefetching Daemon（预取守护进程）</strong></li>
</ul>
<p><strong>查看和设置当前 Read-Ahead 的值，单位为 <code>Block</code>，一般为 512B</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lsblk</span> </span><br><span class="line">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0  9.1T  0 disk </span><br><span class="line">├─sda1   8:1    0    1M  0 part </span><br><span class="line">├─sda2   8:2    0    1G  0 part /boot</span><br><span class="line">├─sda3   8:3    0   32G  0 part [SWAP]</span><br><span class="line">└─sda4   8:4    0  9.1T  0 part /</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">blockdev --getra /dev/sda</span></span><br><span class="line">256</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">blockdev --setra 512 /dev/sda</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">blockdev --getra /dev/sda</span></span><br><span class="line">512</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Write-Back-Caching"><a href="#Write-Back-Caching" class="headerlink" title="Write-Back Caching"></a>Write-Back Caching</h2><p>Write-Back Caching 通常用于文件系统 <strong>写缓存（Write Cache、Buffer）</strong> ，在 Application 需要写入内容时，文件系统将数据写入 Main Memory 就算成功，文件系统随后再将内容（Dirty Data）异步（Asynchronous）写入（Flushing）磁盘（Disk），通过此过程来 <strong>提高文件系统写入性能</strong></p>
<p>在文件系统使用 <code>Write-Back Caching</code> 的情况下，假如应用程序发布（Issue）了写请求（Write Requests），Kernel 将内容写入 Main Memory 后便向 Application 返回了写入成功的响应，假设此时系统断电，因为缓存中的内容（Dirty Data）并未写入（Flushing）磁盘（Disk），会导致 RAM 中的内容丢失，出现文件不一致的情况，为了平衡 <strong>性能（Performance）和可靠性（Reliability），File System 会默认使用 Write-Back Caching，同时提供 <em>同步写（Synchronous Write）选项来跳过 Write-Back Caching，直接将数据写入磁盘（Disk&#x2F;Persistent Storage Device）</em></strong></p>
<h2 id="Synchronous-Write"><a href="#Synchronous-Write" class="headerlink" title="Synchronous Write"></a>Synchronous Write</h2><p><strong>Synchronous Write（同步写入）</strong> 只有当数据完全写入 Persistent Storage Device（持久化存储设备）后才算写入完成，包括任何的 File System Metadata 的变更。它比 Asynchronous Writes（Write-Back Caching） 慢，因为需要额外的 Disk Device IO Latency 以及 File System Metadata 变更导致的 IO，Synchronous Write 通常应用在对数据一致性要求较高的应用中，如 Database Log Writers.</p>
<h2 id="Raw-IO"><a href="#Raw-IO" class="headerlink" title="Raw IO"></a>Raw IO</h2><p><strong>Raw IO</strong> 直接向存储设备发送请求，完全绕过了文件系统，通常在 Database 场景中较为常见，因为数据库软件可以比文件系统更好的管理和缓存他们的数据，缺点是其增加了软件的复杂度和管理的复杂度。</p>
<h1 id="存储设备接口"><a href="#存储设备接口" class="headerlink" title="存储设备接口"></a>存储设备接口</h1><p>在计算机存储领域，SCSI、SAS、ATA、SATA、FC 和 NVMe 是常见的存储接口标准。以下是对这些接口的简要介绍和比较：</p>
<table>
<thead>
<tr>
<th>接口类型</th>
<th>传输方式</th>
<th>最大传输速率</th>
<th>特点说明</th>
<th>应用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>ATA（Advanced Technology Attachment）</code> <br/>也称为 <code>IDE</code>、<code>PATA</code></td>
<td>并行</td>
<td>133 MB&#x2F;s</td>
<td>是一种并行接口标准，主要用于连接存储设备。由于传输速度和性能的限制，ATA 已逐渐被 SATA 所取代。</td>
<td>个人电脑（已被淘汰）</td>
</tr>
<tr>
<td><code>SATA（Serial ATA）</code></td>
<td>串行</td>
<td>6 Gbps</td>
<td>SATA 是 ATA 的串行版本，旨在提高传输速度和效率。它采用串行通信方式，具有更高的传输速率和更长的电缆长度。<br/>传输速度高，支持热插拔，广泛应用于个人电脑和低端服务器。</td>
<td>个人电脑、低端服务器</td>
</tr>
<tr>
<td><code>SCSI（Small Computer System Interface）</code></td>
<td>并行</td>
<td>320 MB&#x2F;s</td>
<td>最初用于连接计算机与硬盘、光驱等外部设备。它支持多设备连接，具有较高的传输速度和可靠性。<br/>支持多任务处理，系统占用率低，适用于服务器等高端应用场景。</td>
<td>服务器、高端存储</td>
</tr>
<tr>
<td><code>SAS（Serial Attached SCSI）</code></td>
<td>串行</td>
<td>12 Gbps</td>
<td>SAS 是 SCSI 的串行版本，旨在提高传输速度和扩展性。它采用串行通信方式，支持更高的传输速率，并向下兼容 SATA 设备。<br/> <strong>传输速度高，支持热插拔，适用于企业级存储系统。SAS 控制器可以直接控制 SATA 硬盘，但 SATA 控制器无法控制 SAS 硬盘。</strong></td>
<td>企业级存储</td>
</tr>
<tr>
<td><code>FC（Fibre Channel）</code></td>
<td>串行</td>
<td>16 Gbps</td>
<td>FC 是一种高速网络技术，最初用于连接大型存储系统。它支持高带宽和低延迟，常用于存储区域网络（SAN）。传输速度高，可靠性强，适用于大型企业级存储环境。</td>
<td>存储区域网络</td>
</tr>
<tr>
<td><code>NVMe</code></td>
<td>串行</td>
<td>32 Gbps（PCIe 4.0 x4）</td>
<td>NVMe 是为固态硬盘（SSD）设计的高速接口协议，旨在充分利用 NAND 闪存的性能优势。它通过 PCIe 总线直接与 CPU 通信，提供低延迟和高并发性。<br/> <strong>传输速度极高，延迟低，适用于高性能存储需求。</strong></td>
<td>高性能存储</td>
</tr>
</tbody></table>
<h1 id="Observability-Tools"><a href="#Observability-Tools" class="headerlink" title="Observability Tools"></a>Observability Tools</h1><p>在基于 Linux 的系统中，可以使用以下工具来观察存储设备（磁盘）I&#x2F;O 的性能统计数据</p>
<table>
<thead>
<tr>
<th>Tool</th>
<th>Description</th>
<th>Examples</th>
</tr>
</thead>
<tbody><tr>
<td><code>iostat</code></td>
<td>存储设备（磁盘）上的 IO 统计数据及 CPU 使用率</td>
<td></td>
</tr>
<tr>
<td><code>sar -b</code></td>
<td>文件系统层（VFS）的 IO 统计数据</td>
<td><a target="_blank" rel="noopener" href="https://csms/tech%3C!--swig%EF%BF%BC2--%3E#sar-%E5%91%BD%E4%BB%A4%E7%94%A8%E6%B3%95%E5%8F%82%E8%80%83"><code>sar</code> 命令使用参考</a></td>
</tr>
<tr>
<td><code>sar -d</code></td>
<td>物理磁盘（存储设备）层上的 IO 统计数据</td>
<td><a target="_blank" rel="noopener" href="https://csms/tech%3C!--swig%EF%BF%BC3--%3E#sar-%E5%91%BD%E4%BB%A4%E7%94%A8%E6%B3%95%E5%8F%82%E8%80%83"><code>sar</code> 命令使用参考</a></td>
</tr>
</tbody></table>
<h2 id="iostat"><a href="#iostat" class="headerlink" title="iostat"></a>iostat</h2><p><code>iostat</code> 查看系统上的存储设备及分区的 IO 使用情况，常用选项及输出指标说明请参考 <code>man iostat</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">iostat -h -p -x 1</span> </span><br><span class="line">Linux 3.10.0-1160.36.2.el7.x86_64 (qz1-aws-flutter-api2) 	02/14/2025 	_x86_64_	(32 CPU)</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</span><br><span class="line">           9.36    0.00    3.15    0.00    0.03   87.46</span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">nvme0n1</span><br><span class="line">                  0.00     0.18    0.02    3.25     0.50   124.24    76.37     0.00    0.90    0.62    0.90   0.85   0.28</span><br><span class="line">nvme0n1p1</span><br><span class="line">                  0.00     0.18    0.02    3.25     0.50   124.24    76.37     0.00    0.90    0.62    0.90   0.85   0.28</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="参考链接-Bibliography"><a href="#参考链接-Bibliography" class="headerlink" title="参考链接|Bibliography"></a>参考链接|Bibliography</h1><p><a target="_blank" rel="noopener" href="https://s.csms.tech/file/Systems.Performance.Enterprise.and.the.Cloud.2nd.Edition.2020.12.pdf">Systems Performance: Enterprise and the Cloud v2</a></p>
<h1 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h1><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://s.csms.tech/file/Systems.Performance.Enterprise.and.the.Cloud.2nd.Edition.2020.12.pdf">Systems Performance: Enterprise and the Cloud v2</a> #8.2.1 File System Interfaces<a href="#fnref:1" rev="footnote"> ↩</a></span></li></ol></div></div>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/20250128162840/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="20250128162840/" class="post-title-link" itemprop="url">Linux 内存控制参数汇总</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-01-28 16:01:00" itemprop="dateCreated datePublished" datetime="2025-01-28T16:01:00+08:00">2025-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="sysctl-控制参数"><a href="#sysctl-控制参数" class="headerlink" title="sysctl 控制参数"></a>sysctl 控制参数</h1><p>下表列出一些常见的 Linux （Kernel 5.3）内存相关的调节参数，具体参数根据内核版本可能有所不同，其使用场景和含义需要查看对应内核版本的相关文档</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Default Value</th>
<th>Description</th>
<th>Examples</th>
</tr>
</thead>
<tbody><tr>
<td><code>vm.dirty_background_bytes</code><br/><code>/proc/sys/vm/dirty_background_bytes</code></td>
<td>0 bytes</td>
<td><code>0</code>  表示使用 <code>vm.dirty_background_ratio</code> 来决定将内存脏页(Memroy Dirty Pages)写回磁盘的阈值而不是使用 <code>vm.dirty_background_bytes</code> <br/>- <strong>设置为相对较高的值，会使内存中的数据延迟写入磁盘，产生较小的 IOPS，但是可能会导致数据不一致或丢失</strong> <br/>- <strong>设置为相对较低的值，会使内存数据及时写入磁盘，导致 IOPS 较高，数据丢失或不一致的风险较低</strong></td>
<td></td>
</tr>
<tr>
<td><code>vm.dirty_background_ratio</code><br/><code>/proc/sys/vm/dirty_background_ratio</code></td>
<td>10</td>
<td>默认当内存脏页数据达到内存大小的 10% 时，在后台触发 <code>per-bdi writeback</code>（Linux 早期（Linux 内核 3.0 之前）由 <code>pdflush</code> 负责处理脏页（dirty pages）写回磁盘的机制）将脏页数据写回磁盘。回写（Write-Back）操作由统一的内核线程 <code>kworker</code> 或 <code>flush-&lt;设备名&gt;</code> 处理</td>
<td></td>
</tr>
<tr>
<td><code>vm.dirty_bytes</code><br/><code>/proc/sys/vm/dirty_bytes</code></td>
<td>0 bytes</td>
<td>定义强制写回的脏页阈值（以字节为单位）。</td>
<td></td>
</tr>
<tr>
<td><code>vm.dirty_ratio</code><br/><code>/proc/sys/vm/dirty_ratio</code></td>
<td>20</td>
<td>定义强制写回的脏页阈值（以总内存的百分比表示）。</td>
<td></td>
</tr>
<tr>
<td><code>vm.dirty_writeback_centisecs</code><br/><code>/proc/sys/vm/dirty_writeback_centisecs</code></td>
<td>500</td>
<td>定义写回线程的执行间隔（以百分之一秒为单位）。</td>
<td></td>
</tr>
<tr>
<td><code>vm.dirty_expire_centisecs</code>      <br/><code>/proc/sys/vm/dirty_expire_centisecs</code></td>
<td>3000</td>
<td>定义脏页的最大“年龄”（超过这个时间的脏页会被优先写回）。<br/><strong>如需手动执行写回操作，可以使用命令 <code>sync</code></strong></td>
<td></td>
</tr>
<tr>
<td><code>vm.min_free_kbytes</code> <br/><code>/proc/sys/vm/min_free_kbytes</code></td>
<td>通常为 <code>min_free_kbytes = sqrt(总内存 * 16)</code></td>
<td><strong>控制系统保留的最小空闲内存量（以 KB 为单位），确保系统在内存压力下仍有足够的内存用于关键操作，如处理中断、内核操作等。</strong> <br/> <strong>如果设置过小</strong> <br/>- 系统可能在内存紧张时无法及时回收内存，导致性能下降。<br/>- 网络流量或 I&#x2F;O 密集型任务可能因内存分配失败而中断。<br/>- 可能增加系统触发 OOM（Out-Of-Memory）的风险。 <br/> <strong>如果设置过大</strong> ：<br/>- 系统可用内存减少，因为更多内存被预留。<br/>- 可能导致用户空间任务频繁触发内存回收，降低整体性能。</td>
<td></td>
</tr>
<tr>
<td><code>vm.watermark_scale_factor</code><br/><code>/proc/sys/vm/watermark_scale_factor</code></td>
<td>10</td>
<td>内核的内存水位标记（ <code>watermarks</code> ）机制</td>
<td></td>
</tr>
<tr>
<td><code>vm.watermark_boost_factor</code><br/><code>/proc/sys/vm/watermark_boost_factor</code></td>
<td>15000</td>
<td>在内存压力下临时提升水位，保证一定的空闲内存。</td>
<td></td>
</tr>
<tr>
<td><code>vm.percpu_pagelist_high_fraction</code><br/><code>/proc/sys/vm/percpu_pagelist_high_fraction</code></td>
<td>0</td>
<td><a href="#vm-percpu-pagelist-high-fraction">vm.percpu_pagelist_high_fraction</a></td>
<td></td>
</tr>
<tr>
<td><code>vm.overcommit_memory</code><br/><code>/proc/sys/vm/overcommit_memory</code><br/><code>vm.overcommit_ratio</code><br/><code>vm.overcommit_kbytes</code></td>
<td></td>
<td><a href="#Linux-%E5%86%85%E5%AD%98-Overcommit-%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3">Linux 内存 Overcommit 机制详解</a></td>
<td></td>
</tr>
<tr>
<td><code>vm.swappiness</code><br/><code>/proc/sys/vm/swappiness</code></td>
<td>60</td>
<td>控制 <strong>内核在内存不足前主动使用 Swap 的程度</strong> ，取值范围： <code>0 - 100</code> 。<br/>- <code>0</code> ： 尽可能 <strong>不使用 Swap</strong> ，只有在内存耗尽时才使用（适合数据库、低延迟应用）。<br/>- <code>100</code> ： 尽可能 <strong>频繁使用 Swap（适合桌面系统）</strong> 。</td>
<td></td>
</tr>
<tr>
<td><code>vm.vfs_cache_pressure</code></td>
<td>100</td>
<td><a href="#vfs-cache-pressure">vm.vfs_cache_pressure</a></td>
<td></td>
</tr>
<tr>
<td><code>vm.admin_reserve_kbytes</code><br/><code>/proc/sys/vm/admin_reserve_kbytes</code></td>
<td>3% Free Pages</td>
<td>为系统管理员保留一定量的内存，以防止在内存紧张时关键的管理任务（如登录、执行命令等）无法正常运行。这部分内存不会被普通用户进程占用，即使在系统内存紧张时也会保留。</td>
<td></td>
</tr>
<tr>
<td><code>memory_failure_early_kill</code><br/><code>/proc/sys/vm/memory_failure_early_kill</code></td>
<td>0</td>
<td>用于控制在发生内存故障时，系统是否立即将有问题的内存页标记为不可用，并杀死访问该内存的进程。<br/>- <strong>默认值是 0</strong> ，表示不立即杀死进程。 <br/>- <strong>启用后（值为 1）</strong> 当检测到内存错误时，系统会尽早杀死访问该内存的进程，以避免更多的系统崩溃或错误发生。</td>
<td></td>
</tr>
<tr>
<td><code>memory_failure_recovery</code><br/><code>/proc/sys/vm/memory_failure_recovery</code></td>
<td>1</td>
<td>当检测到内存故障时，系统可以尝试 <strong>恢复错误的内存页</strong> 。<br/>- <strong>默认值是 1</strong> ，表示启用内存恢复机制。<br/>- <strong>禁用后（值为 0）</strong> ： 系统不尝试恢复内存错误，可能会更直接地采取 <strong>杀死进程</strong> 或 <strong>标记内存为不可用</strong> 的操作。</td>
<td></td>
</tr>
<tr>
<td><code>/proc/sys/vm/drop_caches</code></td>
<td>默认值始终为 <code>0</code></td>
<td>允许管理员手动清理 Linux 内存缓存，包括： <br/>- <code>Page Cache（页面缓存）</code> ： 主要用于加速文件读取。<br/>- <code>Dentry Cache（目录项缓存）</code> ： 记录文件路径信息，加快目录访问。<br/>- <code>Inode Cache（索引节点缓存）</code> ： 记录文件元数据，如大小、权限等。<br/> <strong><code>drop_caches</code> 不会影响进程已使用的内存，只是释放 <em>内核缓存</em> 。</strong> 适用于 <em>测试、性能调优、观察内存使用情况</em> ，但不建议频繁使用。   <br/>可选值包括：<br/>- <code>1</code> ： 清理 <code>Page Cache</code> ，释放文件数据缓存<br/>- <code>2</code> ： 清理 <code>Dentry</code> 和 <code>Inode Cache</code>，释放目录路径和文件元数据缓存<br/>- <code>3</code> ： 清理 <code>Page Cache</code> 、 <code>Dentry</code> 和 <code>Inode Cache</code>（全部）</td>
<td><strong>建议同步数据到磁盘（<code>sync</code>）后清理，防止数据丢失</strong></td>
</tr>
<tr>
<td><code>/proc/sys/vm/compact_memory</code></td>
<td>默认值始终为 <code>0</code></td>
<td><a href="#compact-memory">compact_memory</a></td>
<td></td>
</tr>
</tbody></table>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="20250128162840/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202302230924/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="202302230924/" class="post-title-link" itemprop="url">aws 云平台常见操作</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-02-23 09:24:12" itemprop="dateCreated datePublished" datetime="2023-02-23T09:24:12+08:00">2023-02-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-01-18 11:01:00" itemprop="dateModified" datetime="2025-01-18T11:01:00+08:00">2025-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/%E4%BA%91%E5%B9%B3%E5%8F%B0/" itemprop="url" rel="index"><span itemprop="name">云平台</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/%E4%BA%91%E5%B9%B3%E5%8F%B0/Aws/" itemprop="url" rel="index"><span itemprop="name">Aws</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="S3"><a href="#S3" class="headerlink" title="S3"></a>S3</h1><h2 id="s3-配置跨域"><a href="#s3-配置跨域" class="headerlink" title="s3 配置跨域"></a>s3 配置跨域</h2><p>当使用 aws 的 cloudfront 或其他第三方 cdn （如 cdn77）为域名加速，资源是回源到 aws s3 的情况下，一般都需要配置 <strong>允许跨域</strong>，此种情况需要在 aws s3 存储桶中配置允许跨域 <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[CORS 配置](https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/userguide/ManageCorsUsing.html#cors-example-1)">[1]</span></a></sup></p>
<p>配置步骤如下：</p>
<ol>
<li><p>定位到目标 s3 桶，进入 <code>权限</code> 管理页面</p>
</li>
<li><p>找到 <code>CORS</code> 配置，配置以下 JSON 格式内容，允许所有源的跨域</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line"> &#123;</span><br><span class="line">     &quot;AllowedHeaders&quot;: [</span><br><span class="line">         &quot;*&quot;</span><br><span class="line">     ],</span><br><span class="line">     &quot;AllowedMethods&quot;: [</span><br><span class="line">         &quot;POST&quot;,</span><br><span class="line">         &quot;GET&quot;</span><br><span class="line">     ],</span><br><span class="line">     &quot;AllowedOrigins&quot;: [</span><br><span class="line">         &quot;*&quot;</span><br><span class="line">     ],</span><br><span class="line">     &quot;ExposeHeaders&quot;: []</span><br><span class="line"> &#125;</span><br><span class="line"> ]</span><br></pre></td></tr></table></figure>
<p> <img src="https://i.csms.tech/img_126.png"></p>
</li>
<li><p>Cloudfront 中，回源到此 S3 的加速域名配置中，<code>行为</code> 按照下图配置，主要为开启 <code>OPTIONS</code> 缓存，并在响应标头策略中选择： <code>CORS-with-preflight-and-SecurityHeadersPolicy</code> <sup id="fnref:2"><a href="#fn:2" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[将 CloudFront 配置为遵守 CORS 设置](https://docs.aws.amazon.com/zh_cn/AmazonCloudFront/latest/DeveloperGuide/header-caching.html#header-caching-web-cors)">[2]</span></a></sup><br><img src="https://i.csms.tech/img_127.png"><br>此配置为可选配置，可以解决客户端偶尔会遇到的因跨域问题而导致的资源获取失败问题。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="202302230924/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202301201542/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="202301201542/" class="post-title-link" itemprop="url">python 执行 shell 命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-01-20 15:43:01" itemprop="dateCreated datePublished" datetime="2023-01-20T15:43:01+08:00">2023-01-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-01-16 15:01:00" itemprop="dateModified" datetime="2025-01-16T15:01:00+08:00">2025-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Python3.10</li>
</ul>
<h1 id="Python-执行-shell-命令"><a href="#Python-执行-shell-命令" class="headerlink" title="Python 执行 shell 命令"></a>Python 执行 shell 命令</h1><h2 id="subprocess-模块"><a href="#subprocess-模块" class="headerlink" title="subprocess 模块"></a>subprocess 模块</h2><p><code>subprocess.check_output()</code> 执行一个外部命令并以Python字符串的形式获取执行结果 <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[执行外部命令并获取它的输出](https://python3-cookbook-personal.readthedocs.io/zh_CN/latest/c13/p06_executing_external_command_and_get_its_output.html#id1)">[1]</span></a></sup></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">import subprocess</span><br><span class="line">out_bytes = subprocess.check_output([&#x27;netstat&#x27;,&#x27;-a&#x27;])</span><br></pre></td></tr></table></figure>
<p>如果你需要文本形式返回，加一个解码步骤即可</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">out_text = out_bytes.decode(&#x27;utf-8&#x27;)</span><br></pre></td></tr></table></figure>
<p>如果被执行的命令以非零码返回，就会抛出异常。 下面的例子捕获到错误并获取返回码：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">try:</span><br><span class="line">    out_bytes = subprocess.check_output([&#x27;cmd&#x27;,&#x27;arg1&#x27;,&#x27;arg2&#x27;])</span><br><span class="line">except subprocess.CalledProcessError as e:</span><br><span class="line">    out_bytes = e.output       # Output generated before error</span><br><span class="line">    code      = e.returncode   # Return code</span><br></pre></td></tr></table></figure>

<p>默认情况下，<code>check_output()</code> 仅仅返回输入到标准输出的值。 如果你需要同时收集标准输出和错误输出，使用 <code>stderr</code> 参数：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">out_bytes = subprocess.check_output([&#x27;cmd&#x27;,&#x27;arg1&#x27;,&#x27;arg2&#x27;],</span><br><span class="line">                                    stderr=subprocess.STDOUT)</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="202301201542/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/20250115163437/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="20250115163437/" class="post-title-link" itemprop="url">Java jdk Docker 中运行脚本</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-01-15 16:01:00" itemprop="dateCreated datePublished" datetime="2025-01-15T16:01:00+08:00">2025-01-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-01-16 11:01:00" itemprop="dateModified" datetime="2025-01-16T11:01:00+08:00">2025-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Tools/" itemprop="url" rel="index"><span itemprop="name">Tools</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>环境信息说明</strong></p>
<ul>
<li>Docker 镜像 <code>majiajue/jdk1.8</code></li>
</ul>
<p>以下示例记录实现获取百度云账户余额演示简单 Java 脚本在 Docker 容器中运行的过程和错误</p>
<p>运行 docker 容器</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -it majiajue/jdk1.8 bash</span><br></pre></td></tr></table></figure>

<p>在容器中下载 SDK 并将其放在 <code>/app/</code> 目录下，如 <code>/app/bce-java-sdk-0.10.351/lib/bce-java-sdk-0.10.351.jar</code>，为了让 JAVA 能找到此 JAR 文件，在容器路径 <code>～/.bashrc</code> 中添加自定义的 Jar 文件路径</p>
<figure class="highlight shell"><figcaption><span>～/.bashrc</span></figcaption><table><tr><td class="code"><pre><span class="line">export CLASSPATH=$CLASSPATH:/app/bce-java-sdk-0.10.351/lib/bce-java-sdk-0.10.351.jar:/app/bce-java-sdk-0.10.351/lib/guava-33.4.0-jre.jar:/app/bce-java-sdk-0.10.351/third-party/*</span><br></pre></td></tr></table></figure>

<p><strong>获取余额的代码如下</strong>，容器中代码路径为 <code>/app/BalanceQuery.java</code></p>
<figure class="highlight java"><figcaption><span>/app/BalanceQuery.java</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.baidubce.auth.DefaultBceCredentials;</span><br><span class="line"><span class="keyword">import</span> com.baidubce.services.billing.BillingClient;</span><br><span class="line"><span class="keyword">import</span> com.baidubce.services.billing.BillingClientConfiguration;</span><br><span class="line"><span class="keyword">import</span> com.baidubce.services.billing.model.finance.SupervisorBalanceQueryRequest;</span><br><span class="line"><span class="keyword">import</span> com.baidubce.services.billing.model.finance.UserBalanceQueryRequest;</span><br><span class="line"><span class="keyword">import</span> com.baidubce.services.billing.model.finance.UserBalanceQueryResponse;</span><br><span class="line"><span class="keyword">import</span> com.baidubce.services.billing.model.finance.SupervisorBalanceResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BalanceQuery</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">accessKeyId</span> <span class="operator">=</span> <span class="string">&quot;ALTAKINjySCAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">secretAccessKey</span> <span class="operator">=</span> <span class="string">&quot;5290cfc18BBBBBBBBBBBBBBBBBBBBB&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">BillingClientConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BillingClientConfiguration</span>();</span><br><span class="line">        config.setCredentials(<span class="keyword">new</span> <span class="title class_">DefaultBceCredentials</span>(accessKeyId, secretAccessKey));</span><br><span class="line">        config.setEndpoint(<span class="string">&quot;https://billing.baidubce.com&quot;</span>);  </span><br><span class="line"></span><br><span class="line">        <span class="type">BillingClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BillingClient</span>(config);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">UserBalanceQueryResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.userBalanceQuery();</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;Balance: &quot;</span> + response.getCashBalance());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.err.println(<span class="string">&quot;Failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>在容器中（<code>/app/</code>）编译执行</strong></p>
<blockquote>
<p>如果未在容器环境变量中添加自定义的 JAR 路径（如 <code>/app/bce-java-sdk-0.10.351/lib/bce-java-sdk-0.10.351.jar:/app/bce-java-sdk-0.10.351/lib/guava-33.4.0-jre.jar:/app/bce-java-sdk-0.10.351/third-party/*</code>） 需要在编译(<code>javac</code>) 和执行 （<code>java</code>）时使用参数 <code>-cp &quot;/app/bce-java-sdk-0.10.351/lib/bce-java-sdk-0.10.351.jar:/app/bce-java-sdk-0.10.351/lib/guava-33.4.0-jre.jar:/app/bce-java-sdk-0.10.351/third-party/*:.&quot;</code> 指定自定义文件路径，否则会导致某些类找不到</p>
<p><strong>需要注意 <code>-cp</code> 选项中需要包含当前目录 <code>.</code></strong> ，否则会导致找不到编译后的脚本文件，报错： <code>Error: Could not find or load main class BalanceQuery</code></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> /app/</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">javac BalanceQuery.java</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">java BalanceQuery</span>     </span><br><span class="line">Balance: 1999.5100</span><br><span class="line"></span><br><span class="line">java -cp &quot;./bce-java-sdk-0.10.351/lib/bce-java-sdk-0.10.351.jar:./bce-java-sdk-0.10.351/third-party/*:.&quot; BalanceQuery</span><br><span class="line">Balance: 1999.5100</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如需在宿主机(容器外)执行脚本，参考以下命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker compose <span class="built_in">exec</span> -it java_jdk_1.8 sh -c <span class="string">&#x27;cd /app/;java -cp &quot;./bce-java-sdk-0.10.351/lib/bce-java-sdk-0.10.351.jar:./bce-java-sdk-0.10.351/third-party/*:.&quot; BalanceQuery&#x27;</span></span></span><br><span class="line"></span><br><span class="line">Balance: 1999.5100</span><br><span class="line"></span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="20250115163437/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202306081314/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="202306081314/" class="post-title-link" itemprop="url">Linux 常见错误集锦</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-06-08 13:08:43" itemprop="dateCreated datePublished" datetime="2023-06-08T13:08:43+08:00">2023-06-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-01-08 13:01:00" itemprop="dateModified" datetime="2025-01-08T13:01:00+08:00">2025-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文档中未明确指定 Linux 系统版本信息时，默认为 Centos 7.</p>
<h1 id="automake"><a href="#automake" class="headerlink" title="automake"></a>automake</h1><p>编译安装软件报错</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">error: require Automake 1.14, but have 1.13.4</span><br></pre></td></tr></table></figure>
<p>Automake 版本不匹配，需要安装 Automake 1.14</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rpm -qa | grep automake</span></span><br><span class="line">automake-1.13.4-3.el7.noarch</span><br></pre></td></tr></table></figure>

<p>以下步骤安装 <code>automake-1.14.1</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget http://ftp.gnu.org/gnu/automake/automake-1.14.1.tar.gz</span><br><span class="line">tar -xf automake-1.14.1.tar.gz</span><br><span class="line">cd automake-1.14.1</span><br><span class="line">./bootstrap.sh</span><br></pre></td></tr></table></figure>
<p>以上步骤执行完成后，会生成 <code>configure</code> 可执行文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>安装完成后，执行以下命令验证版本</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">automake --version</span></span><br><span class="line">automake (GNU automake) 1.14.1</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv2+: GNU GPL version 2 or later &lt;http://gnu.org/licenses/gpl-2.0.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"></span><br><span class="line">Written by Tom Tromey &lt;tromey@redhat.com&gt;</span><br><span class="line">       and Alexandre Duret-Lutz &lt;adl@gnu.org&gt;.</span><br></pre></td></tr></table></figure>

<h1 id="makeinfo"><a href="#makeinfo" class="headerlink" title="makeinfo"></a>makeinfo</h1><p>编译安装软件报错</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">makeinfo: command not found</span><br></pre></td></tr></table></figure>
<p><code>makeinfo</code> 命令不存在，执行以下命令安装</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install texinfo</span><br></pre></td></tr></table></figure>

<h1 id="gcc"><a href="#gcc" class="headerlink" title="gcc"></a>gcc</h1><h2 id="no-acceptable-C-compiler-found-in-PATH"><a href="#no-acceptable-C-compiler-found-in-PATH" class="headerlink" title="no acceptable C compiler found in $PATH"></a>no acceptable C compiler found in $PATH</h2><p>缺少 <code>gcc</code> 编译器，安装即可</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y gcc</span><br></pre></td></tr></table></figure>

<h2 id="A-compiler-with-support-for-C-11-language-features-is-required"><a href="#A-compiler-with-support-for-C-11-language-features-is-required" class="headerlink" title="A compiler with support for C++11 language features is required"></a>A compiler with support for C++11 language features is required</h2><p>编译安装软件时报错</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">configure: error: *** A compiler with support for C++11 language features is required.</span><br></pre></td></tr></table></figure>
<p>错误原因为 gcc 版本太低。查看当前 gcc 版本</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gcc -v</span></span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/usr/libexec/gcc/x86_64-redhat-linux/4.8.5/lto-wrapper</span><br><span class="line">Target: x86_64-redhat-linux</span><br><span class="line">Configured with: ../configure --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --with-bugurl=http://bugzilla.redhat.com/bugzilla --enable-bootstrap --enable-shared --enable-threads=posix --enable-checking=release --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-linker-hash-style=gnu --enable-languages=c,c++,objc,obj-c++,java,fortran,ada,go,lto --enable-plugin --enable-initfini-array --disable-libgcj --with-isl=/builddir/build/BUILD/gcc-4.8.5-20150702/obj-x86_64-redhat-linux/isl-install --with-cloog=/builddir/build/BUILD/gcc-4.8.5-20150702/obj-x86_64-redhat-linux/cloog-install --enable-gnu-indirect-function --with-tune=generic --with-arch_32=x86-64 --build=x86_64-redhat-linux</span><br><span class="line">Thread model: posix</span><br><span class="line">gcc version 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC)</span><br></pre></td></tr></table></figure>

<h3 id="安装-gcc-8-3-0"><a href="#安装-gcc-8-3-0" class="headerlink" title="安装 gcc-8.3.0"></a>安装 gcc-8.3.0</h3><p>以下步骤演示安装 gcc-8.3.0 <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[升级 GCC 支持C++11](https://www.cnblogs.com/gyfluck/p/10537383.html)
">[1]</span></a></sup></p>
<ol>
<li>下载安装包，<a target="_blank" rel="noopener" href="http://ftp.gnu.org/gnu/gcc/">官方下载地址</a> <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget ftp://ftp.irisa.fr/pub/mirrors/gcc.gnu.org/gcc/releases/gcc-8.3.0/gcc-8.3.0.tar.gz</span><br><span class="line">tar -xf gcc-8.3.0.tar.gz</span><br><span class="line">cd gcc-8.3.0</span><br></pre></td></tr></table></figure></li>
<li>编译安装。编译依赖 <code>GMP 4.2+</code>, <code>MPFR 2.4.0+</code> and <code>MPC 0.8.0+</code>，需要先按照顺序安装这 3 个依赖。依赖安装参考： <a href="#%E5%AE%89%E8%A3%85-GMP">安装 GMP</a>，<a href="#%E5%AE%89%E8%A3%85-MPFR">安装 MPFR</a>，<a href="%E5%AE%89%E8%A3%85-MPC">安装 MPC</a> <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./configure --prefix=/usr/local/gcc-8.3.0 --disable-multilib</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make install</span></span><br></pre></td></tr></table></figure></li>
<li>安装完成后，需要更新系统标准库 查看当前系统使用的 gcc 库文件，可以看到版本为 <code>libstdc++.so.6.0.19</code> <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> /usr/lib64/libstdc++.so.6</span></span><br><span class="line">libstdc++.so.6       libstdc++.so.6.0.19 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> /usr/lib64/libstdc++.so.6 -l</span></span><br><span class="line">lrwxrwxrwx 1 root root 19 May 30 08:05 /usr/lib64/libstdc++.so.6 -&gt; libstdc++.so.6.0.19</span><br></pre></td></tr></table></figure>
 执行以下操作，更新 <code>libstdc++.so.6</code> 到最新安装的版本 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">rm</span> -rf /usr/lib64/libstdc++.so.6</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ln</span> -s /usr/local/gcc-8.3.0/lib64/libstdc++.so.6.0.25 /usr/lib64/libstdc++.so.6</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> /usr/lib64/libstdc++.so.6 -l</span></span><br><span class="line">lrwxrwxrwx 1 root root 46 Jun  9 09:31 /usr/lib64/libstdc++.so.6 -&gt; /usr/local/gcc-8.3.0/lib64/libstdc++.so.6.0.25</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="安装-GMP"><a href="#安装-GMP" class="headerlink" title="安装 GMP"></a>安装 GMP</h2><p><a href="ftp://gcc.gnu.org/pub/gcc/infrastructure/">安装包下载地址</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget ftp://gcc.gnu.org/pub/gcc/infrastructure/gmp-6.1.0.tar.bz2</span><br><span class="line">tar -jxvf gmp-6.1.0.tar.bz2</span><br><span class="line">cd gmp-6.1.0</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<h2 id="安装-MPFR"><a href="#安装-MPFR" class="headerlink" title="安装 MPFR"></a>安装 MPFR</h2><p><a href="ftp://gcc.gnu.org/pub/gcc/infrastructure/">安装包下载地址</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget ftp://gcc.gnu.org/pub/gcc/infrastructure/mpfr-3.1.4.tar.bz2</span><br><span class="line">tar -jxvf mpfr-3.1.4.tar.bz2</span><br><span class="line">cd mpfr-3.1.4</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<h2 id="安装-MPC"><a href="#安装-MPC" class="headerlink" title="安装 MPC"></a>安装 MPC</h2><p><a href="ftp://gcc.gnu.org/pub/gcc/infrastructure/">安装包下载地址</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget ftp://gcc.gnu.org/pub/gcc/infrastructure/mpc-1.0.3.tar.gz</span><br><span class="line">tar -zxvf mpc-1.0.3.tar.gz</span><br><span class="line">cd mpc-1.0.3</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="202306081314/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/20241118103526/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="20241118103526/" class="post-title-link" itemprop="url">Linux BPF</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-11-18 10:11:00" itemprop="dateCreated datePublished" datetime="2024-11-18T10:11:00+08:00">2024-11-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-12-17 13:12:00" itemprop="dateModified" datetime="2024-12-17T13:12:00+08:00">2024-12-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Linux/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">性能分析</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><strong>BPF(Berkeley Packet Filter)</strong> 是由 Berkeley 学院于 1992 年开发的一款，主要用于提高抓包工具的性能。并于 2014 年被重写进 Linux 内核中，可以用于网络、性能观测、安全等方面。 <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Systems Performance: Enterprise and the Cloud v2](https://s.csms.tech/file/Systems.Performance.Enterprise.and.the.Cloud.2nd.Edition.2020.12.pdf) #3.4.4 Extended BPF">[1]</span></a></sup></p>
<p>BPF 是一种灵活且高效的技术实现，主要由 <strong>指令集（Instruction Set）</strong> 、 <strong>存储对象（Storage Objects maps）</strong> 和 <strong>帮助函数（Helper Functions）</strong> 构成。因为其 <em>虚拟指令集规范（Virtual Instruction Set Specification）</em> ，可以认为 BPF 是一个虚拟机，BPF 运行于 <em>内核模式（Kernel Mode）</em> 。BPF 基于事件（Events）运行： <code>Socket Events</code> 、 <code>Tracepoints</code> 、 <code>USDT Probes</code>、<code>kprobes</code>、<code>uprobes</code>、<code>perf_events</code>.<br><img src="https://i.csms.tech/img_274.png"></p>
<h1 id="bpftrace"><a href="#bpftrace" class="headerlink" title="bpftrace"></a>bpftrace</h1><p><code>bpftrace</code> 是一个基于 BPF 的追踪工具（Trace Tools），提供了高级别的编程能力，同时包含了命令行和脚本使用方式</p>
<h2 id="bpftrace-命令行"><a href="#bpftrace-命令行" class="headerlink" title="bpftrace 命令行"></a>bpftrace 命令行</h2><p><code>bpftrace</code> 命令详细帮助文档请查看 <code>man bpftrace</code>，下表列出常用选项和参数</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>-l [SEARCH]</code></td>
<td>列出匹配的事件（Event&#x2F;Probe），没有 <code>SEARCH</code> 表达式则列出所有的 Event。<code>SEARCH</code> 支持通配符</td>
<td></td>
</tr>
</tbody></table>
<p><strong>筛选指定的事件</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bpftrace -l <span class="string">&quot;tracepoint:*exec*&quot;</span></span></span><br><span class="line">tracepoint:libata:ata_exec_command</span><br><span class="line">tracepoint:sched:sched_kthread_work_execute_end</span><br><span class="line">tracepoint:sched:sched_kthread_work_execute_start</span><br><span class="line">tracepoint:sched:sched_process_exec</span><br><span class="line">tracepoint:syscalls:sys_enter_execve</span><br><span class="line">tracepoint:syscalls:sys_enter_execveat</span><br><span class="line">tracepoint:syscalls:sys_enter_kexec_file_load</span><br><span class="line">tracepoint:syscalls:sys_enter_kexec_load</span><br><span class="line">tracepoint:syscalls:sys_exit_execve</span><br><span class="line">tracepoint:syscalls:sys_exit_execveat</span><br><span class="line">tracepoint:syscalls:sys_exit_kexec_file_load</span><br><span class="line">tracepoint:syscalls:sys_exit_kexec_load</span><br><span class="line">tracepoint:workqueue:workqueue_execute_end</span><br><span class="line">tracepoint:workqueue:workqueue_execute_start</span><br><span class="line">tracepoint:writeback:writeback_exec</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="跟踪新启动的进程"><a href="#跟踪新启动的进程" class="headerlink" title="跟踪新启动的进程"></a>跟踪新启动的进程</h3><p>执行以下命令，可以追踪系统中新启动的进程及其参数</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bpftrace -e <span class="string">&#x27;tracepoint:syscalls:sys_enter_execve &#123; join(args-&gt;argv); &#125;&#x27;</span></span></span><br><span class="line">Attaching 1 probe...</span><br><span class="line">/home/oneuser/cwrsync_6.2.4_x64_free/data/ops/rsync2Server.sh</span><br><span class="line">/usr/bin/rsync --progress -a -c -u --timeout=300 -z --password-file /home/oneuser/cwrsync_6.2.4_x64_free/rsync.client.pswd --exclude .idea --exclude rsync2Server.sh /home/oneuser/cwrsync_6.2.4_x64_free/data/ops/ rsync@66.6.9.25::backup</span><br><span class="line">/home/oneuser/cwrsync_6.2.4_x64_free/data/ops/rsync2Server.sh</span><br><span class="line">/usr/bin/rsync --progress -a -c -u --timeout=300 -z --password-file /home/oneuser/cwrsync_6.2.4_x64_free/rsync.client.pswd --exclude .idea --exclude rsync2Server.sh /home/oneuser/cwrsync_6.2.4_x64_free/data/ops/ rsync@66.6.9.25::backup</span><br><span class="line">runc --root /var/run/docker/runtime-runc/moby --log /run/containerd/io.containerd.runtime.v2.task/moby/53daccf2e93fcf83831ce6773a495361afe9bb9694881269d1902f399f5c621c/log.json --log-format json --systemd-cgroup exec --process /tmp/runc-process3178774999 --detach --pid-file /run/containerd/io.containerd.runtime.v2.task/moby/53daccf2e93fcf83831ce6773a495361afe9bb9694881269d1902f399f5c621c/c73d8d4d46ac3995bdc1d7648a3562ddb4715a549a509f6125a7cfc4e88abe50.pid 53daccf2e93fcf83831ce6773a495361afe9bb9694881269d1902f399f5c621c</span><br><span class="line">runc init</span><br><span class="line">/watchtower --health-check</span><br><span class="line">/home/oneuser/cwrsync_6.2.4_x64_free/data/ops/rsync2Server.sh</span><br><span class="line">/usr/bin/rsync --progress -a -c -u --timeout=300 -z --password-file /home/oneuser/cwrsync_6.2.4_x64_free/rsync.client.pswd --exclude .idea --exclude rsync2Server.sh /home/oneuser/cwrsync_6.2.4_x64_free/data/ops/ rsync@66.6.9.25::backup</span><br><span class="line">/usr/lib/x86_64-linux-gnu/dcv/dcvpamhelper --stdout -s dcv</span><br><span class="line">/usr/libexec/sssd/krb5_child --debug-microseconds=0 --debug-timestamps=1 --debug-fd=28 --debug-level=0x0070 --chain-id=7187 --sss-creds-password --canonicalize --realm=OPSDEV666.COM --fast-ccache-gid=0 --fast-ccache-uid=0</span><br><span class="line">/home/oneuser/cwrsync_6.2.4_x64_free/data/ops/rsync2Server.sh</span><br><span class="line">/usr/bin/rsync --progress -a -c -u --timeout=300 -z --password-file /home/oneuser/cwrsync_6.2.4_x64_free/rsync.client.pswd --exclude .idea --exclude rsync2Server.sh /home/oneuser/cwrsync_6.2.4_x64_free/data/ops/ rsync@66.6.9.25::backup</span><br></pre></td></tr></table></figure>

<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a target="_blank" rel="noopener" href="https://s.csms.tech/file/Systems.Performance.Enterprise.and.the.Cloud.2nd.Edition.2020.12.pdf">Systems Performance: Enterprise and the Cloud v2</a></p>
<h1 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h1><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://s.csms.tech/file/Systems.Performance.Enterprise.and.the.Cloud.2nd.Edition.2020.12.pdf">Systems Performance: Enterprise and the Cloud v2</a> #3.4.4 Extended BPF<a href="#fnref:1" rev="footnote"> ↩</a></span></li></ol></div></div>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/20241127111451/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="20241127111451/" class="post-title-link" itemprop="url">Linux 性能分析工具 perf</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-11-27 11:11:00" itemprop="dateCreated datePublished" datetime="2024-11-27T11:11:00+08:00">2024-11-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-12-16 14:12:00" itemprop="dateModified" datetime="2024-12-16T14:12:00+08:00">2024-12-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Linux/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">性能分析</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><code>perf</code> 是 Linux 中标准的 Profiler，常用于 CPU Profiling、CPU flame Graphs、Syscall Tracing 等。</p>
<h1 id="perf-命令行操作"><a href="#perf-命令行操作" class="headerlink" title="perf 命令行操作"></a>perf 命令行操作</h1><p><code>perf</code> 常用子命令，命令帮助及选项参数帮助文档可查看 <code>man perf</code>、<code>man perf-record</code> 、<code>man perf-report</code> 等</p>
<table>
<thead>
<tr>
<th>子命令</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>record</code></td>
<td>进行 Profile 操作并将结果写入 <code>perf.data</code></td>
<td></td>
</tr>
<tr>
<td><code>report</code></td>
<td>读取 <code>perf.data</code> （created by <code>perf record</code>）并展示 Profile 内容</td>
<td></td>
</tr>
<tr>
<td><code>script</code></td>
<td>读取 <code>perf.data</code> （created by <code>perf record</code>）并展示堆栈内容</td>
<td></td>
</tr>
<tr>
<td><code>stat</code></td>
<td>显示 PMC（Performance Monitor Counter） 统计数据</td>
<td></td>
</tr>
<tr>
<td><code>list</code></td>
<td>列出系统支持的事件(Event）列表</td>
<td></td>
</tr>
</tbody></table>
<p><strong><code>perf record</code> 命令常用选项</strong></p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>-F, --freq=</code></td>
<td>指定 Profile 的频率，使用 <code>max</code> 以当前系统允许的最大频率（对应内核参数 <code>kernel.perf_event_max_sample_rate</code>）进行 Profile<br/>通常建议 <code>99 Hz</code></td>
<td></td>
</tr>
<tr>
<td><code>-a, --all-cpus</code></td>
<td>采集所有 CPU 的全局数据，默认操作</td>
<td></td>
</tr>
<tr>
<td><code>-g</code></td>
<td>Kernel Space 和 User Space Stack Traces</td>
<td></td>
</tr>
<tr>
<td><code>-p, --pid=</code></td>
<td>对指定 PIDs （comma separated list） 进行采样</td>
<td></td>
</tr>
<tr>
<td><code>-e, --event=</code></td>
<td>针对 Event 进行采样追踪</td>
<td><code>perf record -F 99 -a -e sched:sched_process_exec</code></td>
</tr>
</tbody></table>
<p><strong><code>perf report</code> 命令常用选项</strong></p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>-n, --show-nr-samples</code></td>
<td>显示每个 Symbol 采样的数量</td>
<td></td>
</tr>
<tr>
<td><code>-s, --sort=</code></td>
<td>按照指定的（CSV）字段排序</td>
<td></td>
</tr>
</tbody></table>
<h1 id="perf-使用示例"><a href="#perf-使用示例" class="headerlink" title="perf 使用示例"></a>perf 使用示例</h1><h2 id="记录使用-exec-启动的进程"><a href="#记录使用-exec-启动的进程" class="headerlink" title="记录使用 exec 启动的进程"></a>记录使用 exec 启动的进程</h2><p>通过监控系统调用事件，可以采样&#x2F;追踪系统上符合条件的行为，比如以下命令追踪使用 <code>exec</code> 系统调用启动的进程</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">perf record -F 99 -a -e <span class="built_in">sched</span>:sched_process_exec</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">perf report</span></span><br><span class="line">Overhead  Command          Shared Object      Symbol</span><br><span class="line">  40.48%  runc             [kernel.kallsyms]  [k] exec_binprm</span><br><span class="line">  34.86%  exe              [kernel.kallsyms]  [k] exec_binprm</span><br><span class="line">  24.57%  rsync            [kernel.kallsyms]  [k] exec_binprm</span><br><span class="line">   0.06%  rsync2Server.sh  [kernel.kallsyms]  [k] exec_binprm</span><br><span class="line">   0.03%  watchtower       [kernel.kallsyms]  [k] exec_binprm</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>添加 <code>-g</code> 选项追踪详细的堆栈信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">perf record -F 99 -a -e <span class="built_in">sched</span>:sched_process_exec -g</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">perf report</span></span><br><span class="line">  Children      Self  Command          Shared Object         Symbol</span><br><span class="line">+   59.92%    59.92%  rsync            [kernel.kallsyms]     [k] exec_binprm</span><br><span class="line">+   59.92%     0.00%  rsync            ld-linux-x86-64.so.2  [.] _start</span><br><span class="line">+   59.92%     0.00%  rsync            [kernel.kallsyms]     [k] entry_SYSCALL_64_after_hwframe</span><br><span class="line">+   59.92%     0.00%  rsync            [kernel.kallsyms]     [k] do_syscall_64</span><br><span class="line">+   59.92%     0.00%  rsync            [kernel.kallsyms]     [k] x64_sys_call</span><br><span class="line">+   59.92%     0.00%  rsync            [kernel.kallsyms]     [k] __x64_sys_execve</span><br><span class="line">+   59.92%     0.00%  rsync            [kernel.kallsyms]     [k] do_execveat_common.isra.0</span><br><span class="line">+   59.92%     0.00%  rsync            [kernel.kallsyms]     [k] bprm_execve</span><br><span class="line">+   59.92%     0.00%  rsync            [kernel.kallsyms]     [k] bprm_execve.part.0</span><br><span class="line">+   40.02%    40.02%  rsync2Server.sh  [kernel.kallsyms]     [k] exec_binprm</span><br><span class="line">+   40.02%     0.00%  rsync2Server.sh  ld-linux-x86-64.so.2  [.] _start</span><br><span class="line">+   40.02%     0.00%  rsync2Server.sh  [kernel.kallsyms]     [k] entry_SYSCALL_64_after_hwframe</span><br><span class="line">+   40.02%     0.00%  rsync2Server.sh  [kernel.kallsyms]     [k] do_syscall_64</span><br><span class="line">+   40.02%     0.00%  rsync2Server.sh  [kernel.kallsyms]     [k] x64_sys_call</span><br><span class="line">+   40.02%     0.00%  rsync2Server.sh  [kernel.kallsyms]     [k] __x64_sys_execve</span><br><span class="line">+   40.02%     0.00%  rsync2Server.sh  [kernel.kallsyms]     [k] do_execveat_common.isra.0</span><br><span class="line">+   40.02%     0.00%  rsync2Server.sh  [kernel.kallsyms]     [k] bprm_execve</span><br><span class="line">+   40.02%     0.00%  rsync2Server.sh  [kernel.kallsyms]     [k] bprm_execve.part.0</span><br><span class="line">     0.07%     0.07%  sleep            [kernel.kallsyms]     [k] exec_binprm</span><br><span class="line">     0.07%     0.00%  sleep            ld-linux-x86-64.so.2  [.] _start</span><br><span class="line">     0.07%     0.00%  sleep            [kernel.kallsyms]     [k] entry_SYSCALL_64_after_hwframe</span><br><span class="line">     0.07%     0.00%  sleep            [kernel.kallsyms]     [k] do_syscall_64</span><br><span class="line">     0.07%     0.00%  sleep            [kernel.kallsyms]     [k] x64_sys_call</span><br><span class="line">     0.07%     0.00%  sleep            [kernel.kallsyms]     [k] __x64_sys_execve</span><br><span class="line">     0.07%     0.00%  sleep            [kernel.kallsyms]     [k] do_execveat_common.isra.0</span><br><span class="line">     0.07%     0.00%  sleep            [kernel.kallsyms]     [k] bprm_execve</span><br><span class="line">     0.07%     0.00%  sleep            [kernel.kallsyms]     [k] bprm_execve.part.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="perf-读取-PMC-统计数据"><a href="#perf-读取-PMC-统计数据" class="headerlink" title="perf 读取 PMC 统计数据"></a>perf 读取 PMC 统计数据</h2><p>使用以下命令可以读取系统中的 PMC 统计数据，其中包含了 CPU 使用时钟、CPU Context Switch、CPU Migrations、Page-Faults 等统计信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">perf <span class="built_in">stat</span> -a -- <span class="built_in">sleep</span> 10</span></span><br><span class="line"></span><br><span class="line"> Performance counter stats for &#x27;system wide&#x27;:</span><br><span class="line"></span><br><span class="line">         40,019.66 msec cpu-clock                        #    4.000 CPUs utilized             </span><br><span class="line">            51,242      context-switches                 #    1.280 K/sec                     </span><br><span class="line">             4,912      cpu-migrations                   #  122.740 /sec                      </span><br><span class="line">             7,944      page-faults                      #  198.502 /sec                      </span><br><span class="line">   &lt;not supported&gt;      cycles                                                                </span><br><span class="line">   &lt;not supported&gt;      instructions                                                          </span><br><span class="line">   &lt;not supported&gt;      branches                                                              </span><br><span class="line">   &lt;not supported&gt;      branch-misses                                                         </span><br><span class="line"></span><br><span class="line">      10.004545496 seconds time elapsed</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>&lt;not supported&gt;</code> 可能包括以下原因:</p>
<ul>
<li><strong>缺乏硬件支持</strong><ul>
<li>某些处理器可能不支持所需的硬件性能计数器（如 <code>cycles</code> 或 <code>instructions</code>）</li>
<li>这可能出现在虚拟机环境中，尤其是未启用硬件性能监控功能的虚拟机。</li>
</ul>
</li>
<li><strong>权限不足</strong><ul>
<li>性能计数器访问可能需要更高权限，通常是 root 权限</li>
</ul>
</li>
<li><strong>内核配置问题</strong><ul>
<li><code>perf</code> 依赖于 Linux 内核的性能监控功能。如果内核未启用某些性能计数器，可能会导致 <code>&lt;not supported&gt;</code>。</li>
</ul>
</li>
<li><strong>禁用了特定的事件源</strong><ul>
<li>某些环境中，特定性能监控功能可能被内核禁用（例如为了安全性）。</li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="参考链接-Bibliography"><a href="#参考链接-Bibliography" class="headerlink" title="参考链接|Bibliography"></a>参考链接|Bibliography</h1><p><a target="_blank" rel="noopener" href="https://s.csms.tech/file/Systems.Performance.Enterprise.and.the.Cloud.2nd.Edition.2020.12.pdf">Systems Performance: Enterprise and the Cloud v2</a></p>
<h1 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h1><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://s.csms.tech/file/Systems.Performance.Enterprise.and.the.Cloud.2nd.Edition.2020.12.pdf">Systems Performance: Enterprise and the Cloud v2</a> #5.5.1 perf<a href="#fnref:1" rev="footnote"> ↩</a></span></li></ol></div></div>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202306051707/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="202306051707/" class="post-title-link" itemprop="url">Grafana 使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-06-05 17:07:23" itemprop="dateCreated datePublished" datetime="2023-06-05T17:07:23+08:00">2023-06-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-12-05 10:12:00" itemprop="dateModified" datetime="2024-12-05T10:12:00+08:00">2024-12-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Tools/" itemprop="url" rel="index"><span itemprop="name">Tools</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Grafana 是一款用 GO 语言开发的开源数据可视化工具，可以做数据监控和数据统计，带有告警功能。</p>
<h1 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h1><h2 id="组织-Organization-与用户-User"><a href="#组织-Organization-与用户-User" class="headerlink" title="组织(Organization) 与用户(User)"></a>组织(Organization) 与用户(User)</h2><p><strong>Organization</strong> 相当于一个 Namespace，一个 Organization 完全独立于另一个 Organization，包括 <code>datasource</code>、<code>dashboard</code> 等，创建一个 Organization 就相当于打开了一个全新的视图，所有的 <code>datasource</code>、<code>dashboard</code> 等都需要重新创建。一个用户(User) 可以属于多个 Organization。</p>
<p><strong>User</strong> 是 Grafana 里面的用户，用户可以有以下 <strong>角色</strong></p>
<ul>
<li><code>admin</code> - 管理员权限，可以执行任何操作。</li>
<li><code>editor</code> - <em>p</em>不可以创建用户<strong>、</strong>不可以新增 <code>Datasource</code><strong>、</strong>可以创建 Dashboard**</li>
<li><code>viewer</code> - 仅可以查看 Dashboard</li>
<li><code>read only editor</code> - 允许用户修改 Dashboard，但是 <strong>不允许保存</strong></li>
</ul>
<h2 id="数据源-Datasource"><a href="#数据源-Datasource" class="headerlink" title="数据源 Datasource"></a>数据源 Datasource</h2><p>Grafana 中操作的数据集、可视化数据的来源</p>
<h2 id="Dashboard"><a href="#Dashboard" class="headerlink" title="Dashboard"></a>Dashboard</h2><p>在 Dashboard 页面中，可以组织可视化数据图表。</p>
<ul>
<li><code>Panel</code> - 在一个 Dashboard 中，Panel 是最基本的可视化单元。通过 Panel 的 <code>Query Editor</code> 可以为每一个 Panel 添加查询的数据源以及数据查询方式。每一个 Panel 都是独立的，可以选择一种或者多种数据源进行查询。<strong>一个 Panel 中可以有多个 <code>Query Editor</code> 来汇聚多个可视化数据集</strong></li>
<li><code>Row</code> - 在 Dashboard 中，可以定义一个 <code>Row</code>，来组织和管理一组相关的 <code>Panel</code></li>
</ul>
<h3 id="Variables"><a href="#Variables" class="headerlink" title="Variables"></a>Variables</h3><p>在 Dashboard 的设置页面中，有 <code>Variables</code> 页面，在其中可以为 Dashboard 配置变量，之后可以在 Panel 的 <code>Query Editor</code> 中使用这些预定义的变量。<strong>变量的值也可以是通过表达式获取的值</strong>。也可以在 <strong>Panel 的标题中使用变量</strong></p>
<p>例如以下 Variables 配置</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Node    label_values(kubernetes_io_hostname)</span><br></pre></td></tr></table></figure>

<p><img src="https://i.csms.tech/img_169.png"></p>
<p><img src="https://i.csms.tech/img_168.png"></p>
<p>在 Dashboard 中定义了这些变量后，可以在 Panel 的 <code>Query Editor</code> 中使用，在 <code>Query Editor</code> 中使用了 Variables 中定义的变量后，在 Dashboard 的顶部下拉菜单中可以选择预定义的变量的值（<strong>需要在定义 Variables 时配置 <code>Show on dashboard</code> 为 <code>Label and Value</code> 以使在 Dashboard 顶部显示下拉菜单</strong>），Panel 中的 <code>Query</code> 表达式就会使用这些变量的值进行计算以及显示图表。<br><img src="https://i.csms.tech/img_170.png"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="202306051707/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/d5da7d5e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="d5da7d5e/" class="post-title-link" itemprop="url">Django 常见错误</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-12 13:55:03" itemprop="dateCreated datePublished" datetime="2022-07-12T13:55:03+08:00">2022-07-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-12-04 10:12:00" itemprop="dateModified" datetime="2024-12-04T10:12:00+08:00">2024-12-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Python/Django/" itemprop="url" rel="index"><span itemprop="name">Django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>centos7</li>
<li>python3</li>
<li>Django 4</li>
</ul>
<h2 id="ModuleNotFoundError-No-module-named-‘MySQLdb’"><a href="#ModuleNotFoundError-No-module-named-‘MySQLdb’" class="headerlink" title="ModuleNotFoundError: No module named ‘MySQLdb’"></a>ModuleNotFoundError: No module named ‘MySQLdb’</h2><blockquote>
<p>ModuleNotFoundError: No module named ‘MySQLdb’<br>…<br>django.core.exceptions.ImproperlyConfigured: Error loading MySQLdb module.</p>
</blockquote>
<p><strong>解决方法</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip3 install pymysql</span><br></pre></td></tr></table></figure>

<p>编辑文件<code>./python36/lib/python3.6/site-packages/django/db/backends/mysql/__init__.py</code>, 输入以下内容</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql </span><br><span class="line">pymysql.install_as_MySQLdb()</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="d5da7d5e/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/20241204092829/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="20241204092829/" class="post-title-link" itemprop="url">Python 代码集成 Prometheus Client 输出 Metrics 到 Prometheus</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-12-04 09:12:00" itemprop="dateCreated datePublished" datetime="2024-12-04T09:12:00+08:00">2024-12-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在 Python 中，可以使用 Prometheus Python Client Library 来输出 Metrics，供 Prometheus 采集。</p>
<p><strong>安装 Prometheus 客户端库</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install prometheus-client</span><br></pre></td></tr></table></figure>

<p>以下是一个完整的示例，展示如何设置和暴露 Metrics：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> start_http_server, Summary, Counter, Gauge, Histogram</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义 Metrics</span></span><br><span class="line">REQUEST_TIME = Summary(<span class="string">&#x27;request_processing_seconds&#x27;</span>, <span class="string">&#x27;Time spent processing request&#x27;</span>)</span><br><span class="line">REQUEST_COUNT = Counter(<span class="string">&#x27;request_count&#x27;</span>, <span class="string">&#x27;Total number of requests&#x27;</span>)</span><br><span class="line">IN_PROGRESS = Gauge(<span class="string">&#x27;in_progress_requests&#x27;</span>, <span class="string">&#x27;Number of requests in progress&#x27;</span>)</span><br><span class="line">REQUEST_LATENCY = Histogram(<span class="string">&#x27;request_latency_seconds&#x27;</span>, <span class="string">&#x27;Histogram of request latency&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟一个请求处理函数</span></span><br><span class="line"><span class="meta">@REQUEST_TIME.time()  </span><span class="comment"># 使用 Summary 记录函数运行时间</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_request</span>():</span><br><span class="line">    REQUEST_COUNT.inc()  <span class="comment"># 记录请求次数</span></span><br><span class="line">    IN_PROGRESS.inc()  <span class="comment"># 增加正在进行的请求数</span></span><br><span class="line"></span><br><span class="line">    latency = random.random()  <span class="comment"># 模拟随机延迟</span></span><br><span class="line">    REQUEST_LATENCY.observe(latency)  <span class="comment"># 记录延迟</span></span><br><span class="line">    time.sleep(latency)</span><br><span class="line"></span><br><span class="line">    IN_PROGRESS.dec()  <span class="comment"># 减少正在进行的请求数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 启动 HTTP Server，用于暴露 Metrics</span></span><br><span class="line">    start_http_server(<span class="number">8000</span>)  <span class="comment"># 默认端口 8000</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Prometheus metrics available at http://localhost:8000/metrics&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 模拟请求处理</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        process_request()</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><strong>Metrics 类型说明（对应 Prometheus 中相关的数据类型）</strong></p>
<ul>
<li><code>Summary</code> : 用于记录事件的持续时间或大小（例如请求处理时间）。</li>
<li><code>Counter</code> : 计数器，记录事件的总发生次数（例如请求总数）。</li>
<li><code>Gauge</code> : 测量当前值，可以增加或减少（例如当前活跃请求数）。</li>
<li><code>Histogram</code> : 创建直方图，记录数据分布（例如请求延迟分布）。</li>
</ul>
<p><strong>向 Prometheus 暴露 Metrics</strong></p>
<p><code>start_http_server(8000)</code> 会启动一个 HTTP 服务器，在 <code>/metrics</code> 路径下暴露指标数据。Prometheus 将通过该路径采集数据。</p>
<p><strong>装饰器</strong></p>
<p>使用 <code>@REQUEST_TIME.time()</code> 装饰器自动记录函数执行时间。</p>
<p><strong>标签</strong></p>
<p>可以在指标中添加 <strong>标签（Labels）</strong> 来提供多维度的指标。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">REQUEST_COUNT.labels(method=<span class="string">&#x27;GET&#x27;</span>).inc()</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="20241204092829/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202406260952/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="202406260952/" class="post-title-link" itemprop="url">Linux 进程管理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-06-26 09:52:30" itemprop="dateCreated datePublished" datetime="2024-06-26T09:52:30+08:00">2024-06-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-12-03 13:12:00" itemprop="dateModified" datetime="2024-12-03T13:12:00+08:00">2024-12-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><strong><code>Program</code></strong> 是一个静态实体，只是存储在操作系统中的文件（集合）</p>
<p><strong><code>Process</code></strong> 是操作系统上的活动（Active）实体，是 <strong><code>Program</code></strong> 由操作系统加载到内存并运行之后的实体。</p>
<p><strong><code>Process</code></strong> 运行过程中需要操作系统为其分配各种资源，如 CPU、Memory、Files、IO 等来完成其运行。</p>
<p>如果一个 <strong><code>Program</code></strong> 被操作系统运行（启动）了多次，那么其产生的多个 <strong><code>Process</code></strong>  属于分割（单独）的实体。</p>
<p>Linux 系统中调度的进程&#x2F;线程，通常被称为任务（Task）</p>
<p>Linux 中常见的进程状态如下表：</p>
<table>
<thead>
<tr>
<th>状态标识</th>
<th>状态名称</th>
<th>状态说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>R</code></td>
<td><code>task_running</code></td>
<td>进程处于运行或就绪状态</td>
<td></td>
</tr>
<tr>
<td><code>S</code></td>
<td><code>task_interruptible</code><br/> <code>sleeping</code></td>
<td>可中断的睡眠状态</td>
<td></td>
</tr>
<tr>
<td><code>D</code></td>
<td><code>task_uninterruptible</code></td>
<td>不可中断的睡眠状态<br/>1. 它是一种睡眠状态，意味着处于此状态的进程不会消耗 CPU<br/>2. 睡眠的原因是等待某些资源（比如锁或者磁盘 IO），这也是非常多 D 状态的进程都处在处理 IO 操作的原因<br/>3. 是它不能被中断，这个要区别于 <code>硬件中断</code> 的中断，是指不希望在其获取到资源或者超时前被终止。因此他不会被信号唤醒，也就不会响应 <code>kill -9</code> 这类信号。这也是它跟 <code>S（可中断睡眠）</code>状态的区别</td>
<td></td>
</tr>
<tr>
<td><code>T</code></td>
<td><code>task_stopped</code> <br/> <code>task_traced</code><br/><code>Traced</code></td>
<td>暂停状态或跟踪状态</td>
<td></td>
</tr>
<tr>
<td><code>Z</code></td>
<td><code>task_dead</code> <br/> <code>exit_zombie</code><br/><code>zombie</code></td>
<td>退出状态，进程成为僵尸进程</td>
<td></td>
</tr>
<tr>
<td><code>X</code></td>
<td><code>task_dead</code> <br/> <code>exit_dead</code></td>
<td>退出状态，进程即将被销毁</td>
<td></td>
</tr>
<tr>
<td><code>I</code></td>
<td><code>idle</code></td>
<td>空闲状态</td>
<td></td>
</tr>
<tr>
<td><code>+</code></td>
<td></td>
<td>表示关联了前台操作（Foreground Operation），比如前台运行的进程</td>
<td></td>
</tr>
</tbody></table>
<h1 id="进程调度"><a href="#进程调度" class="headerlink" title="进程调度"></a>进程调度</h1><p>Linux 中任务（Task）调度算法默认使用 CFS（Completely Fair Scheduler，内核版本 &gt;&#x3D; 2.6.23）.</p>
<p>CFS 调度算法没有使用固定的进程（此处的进程可能是进程或者线程，Linux 中统称为 Task）优先级（Priority），而是根据进程的 <code>nice value</code> 为进程分配一定比例的（Proportional） CPU 计算时间。 <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Operating System Concepts v10 Online](https://os.ecci.ucr.ac.cr/slides/Abraham-Silberschatz-Operating-System-Concepts-10th-2018.pdf)  5.7.1 Example: Linux Scheduling">[1]</span></a></sup></p>
<p><strong><code>nice</code> 的取值从 <code>-20</code> - <code>+19</code>，值越小，优先级越高，默认值为 <code>0</code></strong> 。优先级高的进程会被分配到更高比例的 CPU 处理时间。</p>
<p>在 Linux 内核中，优先级分为两种：静态优先级和动态优先级。CFS 使用的是动态优先级，它是根据 <code>nice</code> 值计算出来的。</p>
<p>CFS Scheduler 不会直接设定 Priorities，而是为每个 Task 维护变量 <code>vruntime（virtual runtime）</code>（可以检查系统 <code>/proc/&lt;PID&gt;/sched</code>），这个值记录了每个 task 使用了多少 CPU 时间。</p>
<p>CFS 通过将进程的虚拟运行时间（<code>vruntime</code>）与其他进程的虚拟运行时间进行比较来决定调度优先级。权重越大，<code>vruntime</code> 增长越慢，意味着进程的优先级越高，能够更频繁地被调度。</p>
<p>假入一个任务有默认的 Priority（<code>nice=0</code>），那么他的 <code>vruntime</code> 和实际使用的 CPU 时间相同。例如一个 <code>nice=0</code> 的进程使用了 CPU 200ms，那么他的 <code>vruntime=200ms</code>。<strong>低优先级（low priority，<code>nice&gt;0</code>）</strong> 的任务在 CPU 上运行了 200ms，那么他的 <code>vruntime&gt;200ms</code>，相反的，一个 <strong>高优先级（high priority,<code>nice&lt;0</code>）</strong> 的任务在 CPU 上运行了 200ms，那么他的 <code>vruntime&lt;200ms</code>。<strong>基于此，CFS Scheduler 在选择下一个要执行的任务时，会选择 <code>vruntime</code> 最小的任务来运行</strong>。如果有高优先级的任务就绪（可执行），它会抢占（preemptive）正在执行的低优先级的任务。</p>
<p>假如 Linux 中有 2 个优先级一样的任务（<code>nice=0</code>），一个进程为 I&#x2F;O-bound，另一个为 CPU-bound。通常情况下，在一个 CPU 周期内，I&#x2F;O-bound 的任务会使用很少的 CPU 时间就会因等待 IO 而中断在 CPU 上的执行并进入 CPU 的等待调度队列（schedule queue），而 CPU-bound 的任务会用尽分配给它的整个 CPU 周期。执行一段时间之后， I&#x2F;O-bound 的任务的 <code>vruntime</code> 的值会显著的小于 CPU-bound 的任务的 <code>vruntime</code>，导致 I&#x2F;O-bound 的任务拥有比 CPU-bound 的任务更高的优先级，当 I&#x2F;O-bound 的任务就绪（IO 返回数据）时，它会立即抢占 CPU 开始执行。</p>
<blockquote>
<p><code>nice</code> 只能针对单一的进程调整优先级，无法同时将优先级配置关联到相关进程，如 子进程或者同一个服务中的其他进程</p>
</blockquote>
<h2 id="修改-nice-的值"><a href="#修改-nice-的值" class="headerlink" title="修改 nice 的值"></a>修改 nice 的值</h2><p>在 Linux 中，<code>nice</code> 值用于调整进程的优先级，数值范围从 <code>-20</code>（ <strong>最高优先级</strong> ）到 <code>19</code>（ <strong>最低优先级</strong> ）。较低的 <code>nice</code> 值表示进程有更高的优先级，会更频繁地获得 CPU 时间，而较高的 <code>nice</code> 值表示进程有较低的优先级。</p>
<p>你可以使用 <code>nice</code> 和 <code>renice</code> 命令来修改进程的 <code>nice</code> 值</p>
<blockquote>
<p>普通用户（<code>root</code> 之外的用户）启动应用程序时默认只能配置初始 <code>nice</code> 值 <code>0-19</code></p>
<p>普通用户（<code>root</code> 之外的用户）修改正在运行的应用程序的 <code>nice</code> 值，只能改大，不能改小。比如进程启动时，其 <code>nice</code> 为 <code>10</code>，拥有权限的普通用户只能将其 <code>nice</code> 值改为大于 <code>10</code> 的值。 </p>
</blockquote>
<h3 id="nice-命令"><a href="#nice-命令" class="headerlink" title="nice 命令"></a>nice 命令</h3><p><strong><code>nice</code> 命令用于在启动进程时指定 <code>nice</code> 值</strong> 。如果不指定，默认 <code>nice</code> 值为 <code>0</code>。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nice -n 10 command</span><br></pre></td></tr></table></figure>

<h3 id="renice-命令"><a href="#renice-命令" class="headerlink" title="renice 命令"></a>renice 命令</h3><p><code>renice</code> 命令可以修改已经在运行的进程的 <code>nice</code> 值。需要提供进程 ID（ <strong>PID</strong> ）来指定要修改的进程。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">renice &lt;nice_value&gt; -p &lt;PID&gt;</span><br></pre></td></tr></table></figure>
<p>如果想要一次修改多个进程的 <code>nice</code> 值，可以传递多个 PID：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo renice 10 -p 1234 2345 3456</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Linux-进程资源控制-cgroups"><a href="#Linux-进程资源控制-cgroups" class="headerlink" title="Linux 进程资源控制 cgroups"></a>Linux 进程资源控制 cgroups</h1><p><code>cgroups</code> 可以将一个任务（<code>task</code>）标识（绑定）到一个特殊的 <strong>控制组（<code>Control Group</code>）</strong> ，此任务启动的子进程可以继承父进程的 <strong>控制组（<code>Control Group</code>）</strong> </p>
<p><strong>控制组（<code>Control Group</code>）</strong> 可以限制的资源类型如下：</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>blkio</code></td>
<td><strong>Storage</strong> <br/>限制到存储设备（如 Hard Disk、USB Drivers等）的请求</td>
</tr>
<tr>
<td><code>cpu</code></td>
<td><strong>CPU</strong> <br/>限制 CPU 调度</td>
</tr>
<tr>
<td><code>cpuacct</code></td>
<td><strong>Process Accounting</strong> <br/>上报 CPU 使用状态，可以用于统计客户端使用的处理量并进行收费</td>
</tr>
<tr>
<td><code>cpuset</code></td>
<td><strong>CPU Assignment</strong> <br/>在多处理器的系统上，将 Task 分配到特定的处理器以及关联的内存</td>
</tr>
<tr>
<td><code>devices</code></td>
<td><strong>Device Access</strong> <br/>限制 <strong>控制组（<code>Control Group</code>）</strong> 中的 Task 对目标设备类型的使用</td>
</tr>
<tr>
<td><code>freezer</code></td>
<td><strong>Suspend&#x2F;Resume</strong> <br/>暂停&#x2F;恢复  <strong>控制组（<code>Control Group</code>）</strong> 中的 Task</td>
</tr>
<tr>
<td><code>memory</code></td>
<td><strong>Memory Usage</strong>  <br/>限制并报告  <strong>控制组（<code>Control Group</code>）</strong> 中的 Task 使用的内存</td>
</tr>
<tr>
<td><code>net_cls</code></td>
<td><strong>Network Bandwidth</strong> <br/> 制并报告  <strong>控制组（<code>Control Group</code>）</strong> 中的 Task 使用的网络流量，主要通过对网络流量打上 <code>cgroups</code> 相关标签实现</td>
</tr>
<tr>
<td><code>net_prio</code></td>
<td><strong>Network Traffic</strong> <br/> 控制  <strong>控制组（<code>Control Group</code>）</strong> 中的网络流量的优先级</td>
</tr>
<tr>
<td><code>ns</code></td>
<td><strong>Namespaces</strong> <br/> 将 <code>cgroups</code> 分配到不同的 Namespaces，如此同一个 <code>cgroups</code> 中的进程只能看到本 Namespace 中的进程</td>
</tr>
</tbody></table>
<h1 id="Linux-进程管理"><a href="#Linux-进程管理" class="headerlink" title="Linux 进程管理"></a>Linux 进程管理</h1><h2 id="进程命令名和进程可执行文件名"><a href="#进程命令名和进程可执行文件名" class="headerlink" title="进程命令名和进程可执行文件名"></a>进程命令名和进程可执行文件名</h2><p>在系统中遇到以下进程：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ps -elf | grep 18686</span></span><br><span class="line">5 S root     18686  1239  0  80   0 - 46620 pipe_w 15:50 ?        00:00:00 /usr/sbin/CROND -n</span><br><span class="line">0 R root     18694 18686  7  80   0 - 610547 -     15:50 ?        00:00:02 /usr/local/php73/bin/php /home/www/admin/artisan PullData</span><br><span class="line">0 S root     18754 18686  0  80   0 - 22453 pipe_w 15:50 ?        00:00:00 /usr/sbin/sendmail -FCronDaemon -i -odi -oem -oi -t -f root</span><br></pre></td></tr></table></figure>
<p>其中 PID 为 <code>18686</code> 的进程名为 <code>/usr/sbin/CROND</code>，其启动了另外两个子进程。但是在系统中检查，并不存在路径 <code>/usr/sbin/CROND</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">ls</span> -l /usr/sbin/CROND</span></span><br><span class="line">ls: cannot access /usr/sbin/CROND: No such file or directory</span><br></pre></td></tr></table></figure>

<p>出现此种现象，主要是因为 <em><strong>在启动时，进程的命令名是根据路径传递给 <code>execve()</code> 函数的参数决定的，而不是直接与系统中的文件进行匹配</strong></em>。</p>
<p>在 Linux 系统中，<code>ps</code> 命令显示的进程信息是从 <code>/proc</code> 文件系统中获取的，而 <code>/proc</code> 文件系统包含有关正在运行的进程的信息，包括每个进程的命令名。因此，即使实际上系统中不存在 <code>/usr/sbin/CROND</code> 文件，但如果进程的命令名是 <code>/usr/sbin/CROND</code>，那么 <code>ps</code> 命令仍然会显示进程的命令名为 <code>/usr/sbin/CROND</code>。</p>
<p><em><strong>进程的命令名可以查看 <code>/proc/&lt;PID&gt;/cmdline</code> 文件</strong></em>，本示例中显示如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /proc/18686/cmdline</span> </span><br><span class="line">/usr/sbin/CROND-n</span><br></pre></td></tr></table></figure>

<p>对应的系统上的可执行文件的名称可以查看 <code>/proc/&lt;PID&gt;/stat</code>、<code>/proc/&lt;PID&gt;/comm</code>、<code>/proc/&lt;PID&gt;/status</code> 等文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /proc/900/comm</span> </span><br><span class="line">crond</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /proc/900/status</span> </span><br><span class="line">Name:	crond</span><br><span class="line">Umask:	0022</span><br><span class="line">State:	S (sleeping)</span><br><span class="line">Tgid:	900</span><br><span class="line">Ngid:	0</span><br><span class="line">Pid:	900</span><br><span class="line">PPid:	1239</span><br><span class="line">TracerPid:	0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /proc/900/stat</span></span><br><span class="line">900 (crond) S 1239 1239 1239 0 -1 4202816 1627 0 0 0 0 0 0 0 20 0 1 0 139129633 190955520 1478 18446744073709551615 94685936058368 94685936118156 140733000396032 140733000262488 140427856103840 0 0 4096 16387 18446744071797306256 0 0 17 3 0 0 0 0 0 94685938219080 94685938221648 94685948321792 140733000400770 140733000400789 140733000400789 140733000400872 0</span><br></pre></td></tr></table></figure>

<p>在本示例中，实际执行的命令为 <code>crond</code></p>
<h2 id="进程状态检查"><a href="#进程状态检查" class="headerlink" title="进程状态检查"></a>进程状态检查</h2><h3 id="top-命令"><a href="#top-命令" class="headerlink" title="top 命令"></a>top 命令</h3><p>使用 <code>top</code> 命令可以查看系统负载、CPU 和 内存使用情况。也可以查看单个进程的具体信息。</p>
<p><code>htop</code> 是 <code>top</code> 命令的一个变种，它提供了更多的交互性、定制性以及其他一些功能，但是它同时使用了相比 <code>top</code> 更多的资源（4 倍多的 <code>syscalls</code>）</p>
<p><strong><code>top</code> 命令常用选项</strong></p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>-H</code></td>
<td><code>Threads Mode</code>，线程模式。默认情况 <code>top</code> 展示进程的简要信息，使用此选项显示进程中的线程状态。<br/>对应交互式命令 <code>H</code></td>
<td></td>
</tr>
</tbody></table>
<p><strong><code>top</code> 常用交互命令</strong></p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>P</code></td>
<td>CPU Utilization 排序，默认排序方式</td>
</tr>
<tr>
<td><code>M</code></td>
<td>Memory Utilization 排序</td>
</tr>
<tr>
<td><code>I</code></td>
<td>Irix&#x2F;Solaris-Mode 切换。<br/>默认为 Itrix Mode,在这种模式下，如果某个进程使用了系统中的 2 个 CPU 的所有计算资源，则其 CPU 使用率展示为 200%，依此类推。<br/>在 Solaris Mode 下，进程的 CPU 使用率是整体 CPU 使用的资源除于 CPU 数。如在 4 CPU 的系统中，Itrix 模式下，进程 CPU 使用率为 200%，在 Solaris 模式下，则为 50%</td>
</tr>
</tbody></table>
<ul>
<li>显示单个进程的（线程）详细信息  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">top -H -p 1423</span></span><br><span class="line">top - 09:44:42 up 54 days, 23:53,  2 users,  load average: 8.82, 6.84, 7.21</span><br><span class="line">Threads:  15 total,   0 running,  15 sleeping,   0 stopped,   0 zombie</span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">Cpu(s): 40.9 us, 10.8 sy,  0.0 ni, 48.1 <span class="built_in">id</span>,  0.0 wa,  0.0 hi,  0.2 si,  0.0 st</span></span><br><span class="line">KiB Mem : 15790488 total,   466056 free,  7761544 used,  7562888 buff/cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used.  3895716 avail Mem </span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND                                                                                  </span><br><span class="line"> 1423 root      20   0 1477368 778788   4260 S 39.5  4.9  11999:41 [watchdog:1:6]                                                                           </span><br><span class="line"> 2572 root      20   0 1477368 778788   4260 S 37.9  4.9  11363:48 [watchdog:1:6]                                                                           </span><br><span class="line"> 1436 root      20   0 1477368 778788   4260 S 34.2  4.9  11286:08 [watchdog:1:6]                                                                           </span><br><span class="line"> 1435 root      20   0 1477368 778788   4260 S 33.9  4.9  12059:53 [watchdog:1:6]                                                                           </span><br><span class="line"> 1434 root      20   0 1477368 778788   4260 S 33.2  4.9  10249:00 [watchdog:1:6]                                                                           </span><br><span class="line"> 1437 root      20   0 1477368 778788   4260 S 30.6  4.9  11717:47 [watchdog:1:6]                                                                           </span><br><span class="line"> 1431 root      20   0 1477368 778788   4260 S 28.9  4.9  11222:06 [watchdog:1:6]                                                                           </span><br><span class="line">21378 root      20   0 1477368 778788   4260 S 27.6  4.9  12143:35 [watchdog:1:6]                                                                           </span><br><span class="line"> 1433 root      20   0 1477368 778788   4260 S 17.6  4.9   8738:21 [watchdog:1:6]                                                                           </span><br><span class="line"> 1428 root      20   0 1477368 778788   4260 S  8.0  4.9   7650:56 [watchdog:1:6]                                                                           </span><br><span class="line"> 1429 root      20   0 1477368 778788   4260 S  0.0  4.9   0:00.04 [watchdog:1:6]                                                                           </span><br><span class="line"> 1430 root      20   0 1477368 778788   4260 S  0.0  4.9   0:00.05 [watchdog:1:6]                                                                           </span><br><span class="line"> 1432 root      20   0 1477368 778788   4260 S  0.0  4.9   0:00.03 [watchdog:1:6]                                                                           </span><br><span class="line"> 1438 root      20   0 1477368 778788   4260 S  0.0  4.9  12260:30 [watchdog:1:6]                                                                           </span><br><span class="line"> 1529 root      20   0 1477368 778788   4260 S  0.0  4.9  11068:39 [watchdog:1:6]</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="pidstat"><a href="#pidstat" class="headerlink" title="pidstat"></a>pidstat</h3><p><code>pidstat</code> 命令用于检查 Linux 内核管理的进程的状态。帮助文档请查看 <code>man pidstat</code>。要查看特定的进程的信息，使用 <code>-p [PID|ALL]</code> 选项，查看子进程相关信息，参考 <code>-T [TASK | CHILD | ALL]</code> 选项</p>
<p>命令常用选项</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>-d</code></td>
<td>报告 I&#x2F;O statistics</td>
<td></td>
</tr>
<tr>
<td><code>-C comm</code></td>
<td>查看 <code>command name</code> 的详细信息， <code>comm</code> 可以是正则表达式</td>
<td><code>pidstat -C chrome -T CHILD 1 10</code></td>
</tr>
<tr>
<td><code>-p &#123; pid[,...]   / SELF / ALL &#125;</code></td>
<td>查看指定的 PID 或者所有（ALL） 进程的统计信息，不指定默认使用 <code>-p ALL</code></td>
<td></td>
</tr>
<tr>
<td><code>-e program args</code></td>
<td>使用指定的 <code>args</code> 运行 <code>program</code> 并使用 <code>pidstat</code> 监控其统计数据</td>
<td></td>
</tr>
<tr>
<td><code>-l</code></td>
<td>在统计输出中，包含详细的命令及其参数</td>
<td></td>
</tr>
<tr>
<td><code>-r</code></td>
<td>统计进程的 <code>faults</code> 和 Memory 使用情况</td>
<td></td>
</tr>
<tr>
<td><code>-T &#123; TASK  / CHILD / ALL &#125;</code> <br/><code>-t</code></td>
<td>查看子进程相关统计信息</td>
<td></td>
</tr>
<tr>
<td><code>-u</code></td>
<td>CPU 使用率</td>
<td></td>
</tr>
<tr>
<td><code>-w</code></td>
<td>统计进程上下文切换（Context Switch）信息</td>
<td></td>
</tr>
</tbody></table>
<p><strong>查看指定的 PID 以及关联的子进程的统计信息</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pidstat -t -p 22737 1 1</span></span><br><span class="line">Linux 3.10.0-1160.49.1.el7.x86_64 (ecs-34a8) 	11/26/2024 	_x86_64_	(2 CPU)</span><br><span class="line"></span><br><span class="line">04:04:52 PM   UID      TGID       TID    %usr %system  %guest    %CPU   CPU  Command</span><br><span class="line">04:04:53 PM     0     22737         -    0.00    0.00    0.00    0.00     0  python3</span><br><span class="line">04:04:53 PM     0         -     22737    0.00    0.00    0.00    0.00     0  |__python3</span><br><span class="line">04:04:53 PM     0         -     22805    0.00    0.00    0.00    0.00     1  |__python3</span><br><span class="line">04:04:53 PM     0         -     22806    0.00    0.00    0.00    0.00     0  |__python3</span><br><span class="line">04:04:53 PM     0         -     22807    0.00    0.00    0.00    0.00     1  |__python3</span><br><span class="line">04:04:53 PM     0         -     22808    0.00    0.00    0.00    0.00     0  |__python3</span><br><span class="line">04:04:53 PM     0         -     22809    0.00    0.00    0.00    0.00     0  |__python3</span><br><span class="line">04:04:53 PM     0         -     22810    0.00    0.00    0.00    0.00     1  |__python3</span><br><span class="line"></span><br><span class="line">Average:      UID      TGID       TID    %usr %system  %guest    %CPU   CPU  Command</span><br><span class="line">Average:        0     22737         -    0.00    0.00    0.00    0.00     -  python3</span><br><span class="line">Average:        0         -     22737    0.00    0.00    0.00    0.00     -  |__python3</span><br><span class="line">Average:        0         -     22759    0.00    0.00    0.00    0.00     -  |__python3</span><br><span class="line">Average:        0         -     22806    0.00    0.00    0.00    0.00     -  |__python3</span><br><span class="line">Average:        0         -     22807    0.00    0.00    0.00    0.00     -  |__python3</span><br><span class="line">Average:        0         -     22808    0.00    0.00    0.00    0.00     -  |__python3</span><br><span class="line">Average:        0         -     22809    0.00    0.00    0.00    0.00     -  |__python3</span><br><span class="line">Average:        0         -     22810    0.00    0.00    0.00    0.00     -  |__python3</span><br></pre></td></tr></table></figure>

<p><strong>查看进程使用的内存以及 <code>faults</code> 统计信息</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pidstat -r | more</span></span><br><span class="line">Linux 6.8.0-1017-aws (U-3TSDMAL9IVFAQ) 	11/26/2024 	_x86_64_	(4 CPU)</span><br><span class="line"></span><br><span class="line">03:17:25 PM   UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command</span><br><span class="line">03:17:25 PM     0         1      0.97      0.00  168668   13552   0.08  systemd</span><br><span class="line">03:17:25 PM     0       147      1.85      0.00  228472  158232   0.98  systemd-journal</span><br><span class="line">03:17:25 PM     0       189      0.00      0.00  289100   27392   0.17  multipathd</span><br><span class="line">03:17:25 PM     0       199      0.00      0.00   12160    6376   0.04  systemd-udevd</span><br><span class="line">03:17:25 PM   118       512      0.00      0.00   14624    6400   0.04  systemd-oomd</span><br><span class="line">03:17:25 PM   100       551      0.00      0.00   16044    7296   0.05  systemd-network</span><br><span class="line">03:17:25 PM   101       553      0.00      0.00   26512   10240   0.06  systemd-resolve</span><br><span class="line">03:17:25 PM     0       643      0.00      0.00    2816    1920   0.01  acpid</span><br><span class="line">03:17:25 PM   123       644      0.00      0.00   19088    3840   0.02  avahi-daemon</span><br><span class="line">03:17:25 PM   102       645      0.00      0.00   31628    7436   0.05  dbus-daemon</span><br><span class="line">03:17:25 PM     0       646      0.00      0.00  278416   14852   0.09  NetworkManager</span><br><span class="line">03:17:25 PM     0       649      0.01      0.00  757540   17788   0.11  euc-analytics-a</span><br><span class="line">03:17:25 PM     0       653      0.00      0.00   82768    3840   0.02  irqbalance</span><br><span class="line">03:17:25 PM     0       656      0.00      0.00   48880   10368   0.06  networkd-dispat</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>查看进程使用的 CPU 统计信息</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pidstat -u -l | more</span></span><br><span class="line">Linux 6.8.0-1017-aws (U-3TSDMAL9IVFAQ) 	11/26/2024 	_x86_64_	(4 CPU)</span><br><span class="line"></span><br><span class="line">04:08:08 PM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command</span><br><span class="line">04:08:08 PM     0         1    0.04    0.02    0.00    0.02    0.06     1  /sbin/init</span><br><span class="line">04:08:08 PM     0         2    0.00    0.00    0.00    0.00    0.00     0  kthreadd</span><br><span class="line">04:08:08 PM     0        15    0.00    0.00    0.00    0.01    0.00     0  ksoftirqd/0</span><br><span class="line">04:08:08 PM     0        49    0.00    0.00    0.00    0.00    0.00     2  khugepaged</span><br><span class="line">04:08:08 PM     0        63    0.00    0.00    0.00    0.00    0.00     3  kworker/3:1H-kblockd</span><br><span class="line">04:08:08 PM     0        64    0.00    0.00    0.00    0.00    0.00     3  kswapd0</span><br><span class="line">04:08:08 PM     0        75    0.00    0.00    0.00    0.00    0.00     2  kworker/2:1H-kblockd</span><br><span class="line">04:08:08 PM     0       100    0.00    0.00    0.00    0.00    0.00     0  jbd2/nvme0n1p1-8</span><br><span class="line">04:08:08 PM     0       102    0.00    0.00    0.00    0.00    0.00     1  kworker/1:1H-kblockd</span><br><span class="line">04:08:08 PM     0       129    0.00    0.00    0.00    0.00    0.00     0  kworker/0:1H-kblockd</span><br><span class="line">04:08:08 PM     0       147    0.00    0.00    0.00    0.00    0.01     3  /lib/systemd/systemd-journald</span><br><span class="line">04:08:08 PM     0       189    0.00    0.00    0.00    0.00    0.01     3  /sbin/multipathd -d -s</span><br><span class="line">04:08:08 PM     0       199    0.00    0.00    0.00    0.00    0.00     3  /lib/systemd/systemd-udevd</span><br><span class="line">04:08:08 PM     0       382    0.00    0.00    0.00    0.00    0.00     2  jbd2/nvme1n1p1-8</span><br><span class="line">04:08:08 PM   118       512    0.05    0.05    0.00    0.00    0.10     3  /lib/systemd/systemd-oom</span><br><span class="line">d</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在使用 <code>pidstat</code> 时如果未指定统计数据的采样间隔及采样次数，则 <strong>默认统计的是从系统启动以来的平均资源使用率，如果目标进程的运行时间相对于系统启动时间很短（例如仅几分钟），那么它的平均 CPU 使用率会趋近于 0</strong> 。比如以下示例：  </p>
<p><em>未指定采样间隔及采样次数</em> ，统计结果显示进程的 CPU 使用率为 <code>0</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pidstat  | grep gzip</span></span><br><span class="line">01:37:06 PM     0       784    0.00    0.00    0.00    0.00     4  gzip</span><br></pre></td></tr></table></figure>

<p><em>以下命令指定采样间隔和采样次数</em> ，统计结果显示 CPU 使用率较高</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pidstat 1 1 | grep gzip</span></span><br><span class="line">01:37:14 PM     0      1974   15.69    1.96    0.00   87.65     7  gzip</span><br><span class="line">Average:        0      1974   15.69    1.96    0.00   87.65     -  gzip</span><br></pre></td></tr></table></figure>

</blockquote>
<h1 id="参考链接-Bibliography"><a href="#参考链接-Bibliography" class="headerlink" title="参考链接|Bibliography"></a>参考链接|Bibliography</h1><p><a target="_blank" rel="noopener" href="https://os.ecci.ucr.ac.cr/slides/Abraham-Silberschatz-Operating-System-Concepts-10th-2018.pdf">Operating System Concepts v10 Online</a><br><a target="_blank" rel="noopener" href="http://lionheartwang.github.io/blog/2018/06/05/linuxjin-cheng-zhuang-tai-shuo-ming/">Linux进程状态说明</a></p>
<h1 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h1><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://os.ecci.ucr.ac.cr/slides/Abraham-Silberschatz-Operating-System-Concepts-10th-2018.pdf">Operating System Concepts v10 Online</a>  5.7.1 Example: Linux Scheduling<a href="#fnref:1" rev="footnote"> ↩</a></span></li></ol></div></div>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202311221348/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="202311221348/" class="post-title-link" itemprop="url">常用小脚本收集</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-11-22 13:48:41" itemprop="dateCreated datePublished" datetime="2023-11-22T13:48:41+08:00">2023-11-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-12-02 17:12:00" itemprop="dateModified" datetime="2024-12-02T17:12:00+08:00">2024-12-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Tools/" itemprop="url" rel="index"><span itemprop="name">Tools</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="批量下载"><a href="#批量下载" class="headerlink" title="批量下载"></a>批量下载</h1><h2 id="Python3-批量下载文件中给定的-urls"><a href="#Python3-批量下载文件中给定的-urls" class="headerlink" title="Python3 批量下载文件中给定的 urls"></a>Python3 批量下载文件中给定的 urls</h2><p>假如需要下载的 urls 存在于给定的文件中（每行一个 url），本示例演示批量并发下载，假设 urls 存在于文件 <code>urls.txt</code> 中</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个函数来下载图片</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_image</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.get(url)</span><br><span class="line">        response.raise_for_status()  <span class="comment"># 检查是否有 HTTP 错误</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;下载完成: <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;下载失败: <span class="subst">&#123;url&#125;</span>, 错误: <span class="subst">&#123;e&#125;</span>&quot;</span>) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从文件中读取图片链接</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;urls.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    img_urls = file.read().splitlines()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 ThreadPoolExecutor 来限制并发线程数量为 10</span></span><br><span class="line">max_concurrent_threads = <span class="number">10</span></span><br><span class="line"><span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_concurrent_threads) <span class="keyword">as</span> executor:</span><br><span class="line">    <span class="comment"># 提交任务并下载图片</span></span><br><span class="line">    executor.<span class="built_in">map</span>(download_image, img_urls)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;所有图片下载完成&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="shell-批量下载文件中给定的-urls"><a href="#shell-批量下载文件中给定的-urls" class="headerlink" title="shell 批量下载文件中给定的 urls"></a>shell 批量下载文件中给定的 urls</h2><p>假如需要下载的 urls 存在于给定的文件中（每行一个 url），本示例演示批量并发下载，假设 urls 存在于文件 <code>urls.txt</code> 中</p>
<p>本示例中的 <code>urls.txt</code> 内容示例如下：</p>
<figure class="highlight shell"><figcaption><span>urls.txt</span></figcaption><table><tr><td class="code"><pre><span class="line">http://cdn-log-customer-bj4.obs.cn-north-4.myhuaweicloud.com:80/oversea/20241202/09/2024120209-domain-ov.gz?AccessKeyId=WWHEIFLWKIMHHDKIPRWLJJ40CFS&amp;Expires=1733208754&amp;response-content-disposition=attachment%3Bfilename%3D%222024120209-domain-ov.gz%22&amp;Signature=bGHy1CPncaXJladgG9NdIRwASsdgSIvs%3D</span><br><span class="line">http://cdn-log-customer-bj4.obs.cn-north-4.myhuaweicloud.com:80/mainland/20241202/09/2024120209-domain-cn.gz?AccessKeyId=WWHEIFLWKIMHHDKIPRWLJJ40CFS&amp;Expires=1733208754&amp;response-content-disposition=attachment%3Bfilename%3D%222024120209-domain-cn.gz%22&amp;Signature=bGHy1CPncaXJladgG9NdIRwASsdgSIvs%3D</span><br><span class="line">http://cdn-log-customer-bj4.obs.cn-north-4.myhuaweicloud.com:80/oversea/20241202/08/2024120208-domain-ov.gz?AccessKeyId=WWHEIFLWKIMHHDKIPRWLJJ40CFS&amp;Expires=1733208754&amp;response-content-disposition=attachment%3Bfilename%3D%222024120208-domain-ov.gz%22&amp;Signature=ZT64%bGHy1CPncaXJladgG9NdIRwASsdgSIvs%3D</span><br><span class="line">http://cdn-log-customer-bj4.obs.cn-north-4.myhuaweicloud.com:80/mainland/20241202/08/2024120208-domain-cn.gz?AccessKeyId=WWHEIFLWKIMHHDKIPRWLJJ40CFS&amp;Expires=1733208754&amp;response-content-disposition=attachment%3Bfilename%3D%222024120208-domain-cn.gz%22&amp;Signature=bGHy1CPncaXJladgG9NdIRwASsdgSIvs%3D</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>简单的 <strong>串行下载命令</strong> 如下，从 url 中取出文件名作为下载文件名：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">for i in `cat urls.txt`; do fn=`echo $i | cut -d&#x27;?&#x27; -f1  | cut -d&#x27;/&#x27; -f7` ; curl -o $fn &quot;$i&quot;; done</span><br></pre></td></tr></table></figure>

<p>使用以上命令，如果下载内容太多，会比较慢，以下代码示例使用 <strong><code>xargs</code> 命令批量下载，<code>xargs</code> 会自动分配任务，确保多个下载任务同时运行</strong> 。：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat log-url | xargs -P 10 -I &#123;&#125; sh -c &#x27;fn=$(echo &quot;&#123;&#125;&quot; | cut -d&quot;?&quot; -f1 | cut -d&quot;/&quot; -f7);  curl -o $fn &quot;&#123;&#125;&quot;&#x27;</span><br></pre></td></tr></table></figure>
<p><code>xargs</code> 参数说明：</p>
<ul>
<li><code>-P 10</code> : 指定并发进程数为 10，可以根据系统资源调整。</li>
<li><code>-I &#123;&#125;</code> : 替换（Pipe）输入中的每行（URL） 为 <code>&#123;&#125;</code> 。</li>
</ul>
<p>如果无需提取文件名，可以 <strong>使用 <code>wget</code> 命令的并行下载功能</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget -i urls.txt -P output-dir -nc --max-threads=10</span><br></pre></td></tr></table></figure>
<p>参数说明如下：</p>
<ul>
<li><code>-i urls.txt</code> : 从文件中读取下载 URL。</li>
<li><code>-P output-dir</code> : 将下载文件存储到 <code>output-dir</code>。</li>
<li><code>--max-threads=10</code> : 设置并发线程数为 10。</li>
<li><code>-nc</code> : 跳过已下载的文件，避免重复下载。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/20241128094720/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="20241128094720/" class="post-title-link" itemprop="url">Linux CPUs</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-11-28 09:11:00" itemprop="dateCreated datePublished" datetime="2024-11-28T09:11:00+08:00">2024-11-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="categories/Linux/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">性能分析</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="CPU-Architecture-and-Common-Concepts"><a href="#CPU-Architecture-and-Common-Concepts" class="headerlink" title="CPU Architecture and Common Concepts"></a>CPU Architecture and Common Concepts</h1><h2 id="CPU-Architecture"><a href="#CPU-Architecture" class="headerlink" title="CPU Architecture"></a>CPU Architecture</h2><p>下图展示了一个简单的 CPU 架构图，有一个物理 CPU（Physical Processor），包含 4 个 CPU Cores，每个 CPU Core 包含 2 个 Hardware Threads，总计 8 个 CPUs。右侧的图是这 8 个 CPUs 在操作系统（Operating System）中的视图（也被称为 Logical CPU&#x2F;Virtual Processor&#x2F;Virtual Core） <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Systems Performance: Enterprise and the Cloud v2](https://s.csms.tech/file/Systems.Performance.Enterprise.and.the.Cloud.2nd.Edition.2020.12.pdf) #6.2.1 CPU Architecture">[1]</span></a></sup><br><img src="https://i.csms.tech/img_281.png"></p>
<p>Operating System 可能对于 CPU 的拓扑结构（Topology）有一定程度的了解，如知道哪些 Logical CPU 位于同一个 CPU Core 或者 CPU Cache 是如何被共享的（Shared），这有助于 CPU Scheduler 做出更优的调度决策。</p>
<p>下图展示了通用 2 Core 处理器的组成。具体的组成取决于具体的处理器。<br><img src="https://i.csms.tech/img_284.png"></p>
<ul>
<li><code>Control Unit</code> 是 CPU 处理器的核心组件，负责指令（Instruction）的 <code>Fetch</code>、<code>Decoding</code>、<code>Execution</code> 并负责保存执行结果（Storing Results）。</li>
<li><code>Shared Floating-Points Unit</code></li>
<li><code>Shared Level-3 Cache</code></li>
<li><code>MMU</code> Memory Management Unit，负责将虚拟内存地址转换为物理内存地址（Virtual-to-Physical Address Translation）</li>
<li><code>TLB</code> Translation Lookaside Buffer，用于 Cache 内存地址转换（Virtual-to-Physical Address Translation），未缓存的地址转换需要去 Main Memory 中的 Page Tables 中查询，MMU 的基本构成如下图<br><img src="https://i.csms.tech/img_286.png"></li>
</ul>
<h2 id="P-States-and-C-States"><a href="#P-States-and-C-States" class="headerlink" title="P-States and C-States"></a>P-States and C-States</h2><p>Intel 处理器的 ACPI（Advanced Configuration and Power Interface）标准定义了 <strong>P-States (Processor Performance States)</strong>  和 <strong>S-States (Processor Power States)</strong> 。 <sup id="fnref:4"><a href="#fn:4" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Systems Performance: Enterprise and the Cloud v2](https://s.csms.tech/file/Systems.Performance.Enterprise.and.the.Cloud.2nd.Edition.2020.12.pdf) #6.4.1 P-States and C-States">[4]</span></a></sup></p>
<ul>
<li><strong>P-States</strong> 通过在 Processor 运行过程中提供不同的 Clock Rate 提供不同的性能选择。 <strong>P0</strong> 提供最高级别的性能，<strong>P1</strong> 到 <strong>PN</strong> 提供较慢的 Clock Rate，这些级别通常可以被硬件（如依赖处理器温度）或者系统上的软件（如内核的节能策略）控制。</li>
<li><strong>C-States</strong> 提供当 CPU 处于 Idle 时，提供不同的 <code>idle states</code>，用于节省电力（节能），下图列出了常见的 C-States<br><img src="https://i.csms.tech/img_285.png"></li>
</ul>
<p>Linux 中可以配置和管理 CPU Status 的方式包括(是否支持取决于不同的 Processor、操作系统和内核版本)：</p>
<ul>
<li><code> /sys/devices/system/cpu/cpufreq/policy0/scaling_available_governors</code> 可以查看可用的 CPU Scaling Governors，一般包括 <code>performance</code>、 <code>powersave</code>，通过配置 <code>/sys/devices/system/cpu/cpufreq/policy0/scaling_governor</code> 为对应值。 <sup id="fnref:6"><a href="#fn:6" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Systems Performance: Enterprise and the Cloud v2](https://s.csms.tech/file/Systems.Performance.Enterprise.and.the.Cloud.2nd.Edition.2020.12.pdf) #6.9.4 Scaling Governors">[6]</span></a></sup></li>
<li><code>cpupower</code> 工具箱，其中包括 <code>cpupower frequency-info</code>、<code>cpupower frequency-set</code> 等一系列管理和查看 CPU 频率等信息的工具</li>
</ul>
<h2 id="CPU-Memory-Caches"><a href="#CPU-Memory-Caches" class="headerlink" title="CPU Memory Caches"></a>CPU Memory Caches</h2><p>Processors（物理 CPU 处理器）提供了各种个样的硬件缓存（Hardware Caches）用于提高 CPU 读写 Memory I&#x2F;O 的性能（CPU 的处理速度是 Memory I&#x2F;O 处理速度的多个量级），下图展示了 Processor Caches 在大小（Sizes）和响应速度之间的关系， <strong>离 Processor 越近，其响应速度越快，存储空间越小，成本越高（贵）</strong><br><img src="https://i.csms.tech/img_282.png"></p>
<h2 id="Clock-Rate"><a href="#Clock-Rate" class="headerlink" title="Clock Rate"></a>Clock Rate</h2><p><strong>CPU 时钟频率（Clock Rate）</strong> 是指 Processor 每秒跳动（转换）的次数，每一个 Processor 的时钟变化也称为一个 <strong>Clock Cycle</strong> 。 Processor 通常是以特定的时钟频率运行，比如 4GHz 的 CPU 每秒会进行 4 Billion Clock Cycles。每个 CPU 指令（Instruction）都需要通过一个或者多个 Clock Cycles 来完成。 <strong>现代 CPU 通常会变频，即调整 Processor 的 Clock Rate，如果提高 CLock Rate 以提升性能，降低 Clock Rate 以节能</strong> 。变频操作通常是通过 OS 请求 Processor 变频或者是 Processor 自动进行变频，比如内核中的 <code>idle</code> 线程通常会要求 CPU 降低其 Clock Rate 以节能。</p>
<p>Clock Rate 是衡量 Processor 能力（Capacity）的一个主要指标。通常来说，较高 Clock Rate 的 Processor 会有更高的性能，但是在性能分析的场景中，提高 CPU 的 Clock Rate 不一定会提高 CPU 性能，这主要取决于 CPU 的 Clock Cycles 到底是在忙于什么，如果 Clock Cycles 主要忙于等待 Memory Access，那么换成更高频率的处理器，并不会提高整个系统的性能。</p>
<h2 id="SMT"><a href="#SMT" class="headerlink" title="SMT"></a>SMT</h2><p>Simultaneous Multi-Threading(SMT) 是一种由 Processor 支持的硬件多线程（Hardware Multithreading）技术，用于实现同一个 Processor Core 上的并发（Parallelism），它允许一个 CPU Core 运行多个 Thread，每个 Hardware Thread 从 Operating System 层面来看都是一个 CPU。这种技术的典型应用包括 Intel 的 Hyper-Threading 技术，允许每个 Processor Core 运行 2 个 Threads，以及 POWER8，允许每个 Processor Core 运行 8 个 Threads。</p>
<p>SMT 的实现通常基于 Core 运行指令（Instructions）的过程中的 <code>Stall Cycles</code>，当某个指令处于 <code>Stall Cycles</code> 时，Core 会允许调度另一个指令来运行。基于 Hardware Thread 的 CPU，其性能和单独的 CPU Core 是有区别的，这个差别取决于其上的工作负载（Workload），<code>Stall Cycles</code> 严重的 Workloads 会比 <code>Instruction Cycles</code> 严重的 Workloads 性能更好，因为 <code>Stall Cycles</code> 会减少竞争（Core Contention）  </p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="20241128094720/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="page/13/">13</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">COSMOS</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="300" alpha="0.3" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="js/comments.js"></script><script src="js/utils.js"></script><script src="js/motion.js"></script><script src="js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="js/third-party/search/local-search.js"></script>




  <script src="js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"fl9999","repo":"fl9999.github.io","client_id":"a11bf6f7860762b725b5","client_secret":"a99046105f8bddc72ec718d54dc3fd7f22070821","admin_user":"fl9999","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"d41d8cd98f00b204e9800998ecf8427e"}</script>
<script src="js/third-party/comments/gitalk.js"></script>

</body>
</html>
