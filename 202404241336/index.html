<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16-next.png">
  <link rel="mask-icon" href="../images/logo.svg" color="#222">

<link rel="stylesheet" href="../css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"csms.tech","root":"/","images":"../images","scheme":"Gemini","darkmode":true,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeIn","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"../search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="../js/config.js"></script>

    <meta name="description" content="Certbot 是 Let’s Encrypt SSL 官方推荐的 ACME 协议客户端，它是一个 Python 程序，且包含模块化插件支持。Let’s Encrypt 的根证书浏览器支持广泛，且支持泛域名。但单个证书的有效期为 90 天，以防止滥用。 安装 Certbot官方安装步骤参考 以下步骤演示在 Python3 环境中安装 Certbot 及其相关依赖  安装 certbot pip i">
<meta property="og:type" content="article">
<meta property="og:title" content="SSL Certbot 使用方法汇总">
<meta property="og:url" content="http://csms.tech/202404241336/index.html">
<meta property="og:site_name" content="L B T">
<meta property="og:description" content="Certbot 是 Let’s Encrypt SSL 官方推荐的 ACME 协议客户端，它是一个 Python 程序，且包含模块化插件支持。Let’s Encrypt 的根证书浏览器支持广泛，且支持泛域名。但单个证书的有效期为 90 天，以防止滥用。 安装 Certbot官方安装步骤参考 以下步骤演示在 Python3 环境中安装 Certbot 及其相关依赖  安装 certbot pip i">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.csms.tech/img_262.png">
<meta property="article:published_time" content="2024-04-24T05:36:18.000Z">
<meta property="article:modified_time" content="2024-09-25T06:09:00.000Z">
<meta property="article:author" content="COSMOS">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.csms.tech/img_262.png">


<link rel="canonical" href="http://csms.tech/202404241336/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://csms.tech/202404241336/","path":"202404241336/","title":"SSL Certbot 使用方法汇总"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>SSL Certbot 使用方法汇总 | L B T</title>
  








  <noscript>
    <link rel="stylesheet" href="../css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">L B T</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记 录 过 去 的 经 验</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="../index.html" rel="section"><i class="fa fa-earth-americas fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="../categories/" rel="section"><i class="fa fa-folder-tree fa-fw"></i>总目录<span class="badge">51</span></a></li><li class="menu-item menu-item-linux"><a href="../categories/Linux" rel="section"><i class="fa fa-brands fa-linux fa-fw"></i>Linux</a></li><li class="menu-item menu-item-python"><a href="../categories/Python" rel="section"><i class="fa fa-brands fa-python fa-fw"></i>Python</a></li><li class="menu-item menu-item-docker"><a href="../categories/Docker" rel="section"><i class="fa fa-brands fa-docker fa-fw"></i>Docker</a></li><li class="menu-item menu-item-kubernetes"><a href="../categories/Kubernetes" rel="section"><i class="fa fa-dharmachakra fa-fw"></i>Kubernetes</a></li><li class="menu-item menu-item-tags"><a href="../tags/" rel="section"><i class="fa fa-tornado fa-fw"></i>标签<span class="badge">78</span></a></li><li class="menu-item menu-item-archives"><a href="../archives/" rel="section"><i class="fa fa-rectangle-list fa-fw"></i>列表<span class="badge">250</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章总目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Certbot"><span class="nav-number">1.</span> <span class="nav-text">安装 Certbot</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-Cloudflare-DNS-%E7%9A%84%E8%87%AA%E5%8A%A8%E9%AA%8C%E8%AF%81%E7%94%B3%E8%AF%B7%E5%9F%9F%E5%90%8D%E8%AF%81%E4%B9%A6"><span class="nav-number">2.</span> <span class="nav-text">基于 Cloudflare DNS 的自动验证申请域名证书</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#certbot-%E5%91%BD%E4%BB%A4%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C"><span class="nav-number">3.</span> <span class="nav-text">certbot 命令常用操作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%8B%E5%8A%A8%E6%B7%BB%E5%8A%A0-DNS-TXT-%E8%AE%B0%E5%BD%95%E9%AA%8C%E8%AF%81%E7%94%B3%E8%AF%B7%E5%9F%9F%E5%90%8D%E8%AF%81%E4%B9%A6"><span class="nav-number">3.1.</span> <span class="nav-text">手动添加 DNS TXT 记录验证申请域名证书</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF"><span class="nav-number">4.</span> <span class="nav-text">常见错误</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#DNSSEC-DNSKEY-Missing"><span class="nav-number">4.1.</span> <span class="nav-text">DNSSEC: DNSKEY Missing</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SERVFAIL-looking-up-CAA"><span class="nav-number">4.2.</span> <span class="nav-text">SERVFAIL looking up CAA</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="nav-number">5.</span> <span class="nav-text">参考文档</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%84%9A%E6%B3%A8"><span class="nav-number">6.</span> <span class="nav-text">脚注</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">COSMOS</p>
  <div class="site-description" itemprop="description">得 能 莫 忘</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="../archives/">
          <span class="site-state-item-count">250</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="../categories/">
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">目录</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="../tags/">
        <span class="site-state-item-count">78</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202404241336/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="SSL Certbot 使用方法汇总 | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SSL Certbot 使用方法汇总
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-04-24 13:36:18" itemprop="dateCreated datePublished" datetime="2024-04-24T13:36:18+08:00">2024-04-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-09-25 14:09:00" itemprop="dateModified" datetime="2024-09-25T14:09:00+08:00">2024-09-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Tools/" itemprop="url" rel="index"><span itemprop="name">Tools</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Tools/SSL/" itemprop="url" rel="index"><span itemprop="name">SSL</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>Certbot 是 Let’s Encrypt SSL 官方推荐的 ACME 协议客户端，它是一个 Python 程序，且包含模块化插件支持。Let’s Encrypt 的根证书浏览器支持广泛，且支持泛域名。但单个证书的有效期为 90 天，以防止滥用。</p>
<h1 id="安装-Certbot"><a href="#安装-Certbot" class="headerlink" title="安装 Certbot"></a>安装 Certbot</h1><p><a target="_blank" rel="noopener" href="https://eff-certbot.readthedocs.io/en/stable/install.html#installation">官方安装步骤参考</a></p>
<p>以下步骤演示在 Python3 环境中安装 Certbot 及其相关依赖</p>
<ol>
<li>安装 <code>certbot</code> <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install certbot</span><br></pre></td></tr></table></figure></li>
<li>申请证书时，要使用 DNS 方式验证域名所有权并且 DNS 使用 Cloudflare 的情况下，可以安装 <code>certbot-dns-cloudflare</code> 插件实现自动验证，参考以下命令安装 <code>certbot-dns-cloudflare</code>，此模块需要 <code>cloudflare</code> 模块的支持 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install cloudflare</span><br><span class="line">pip install certbot-dns-cloudflare</span><br></pre></td></tr></table></figure>
安装完成后检查相关模块和版本。其中 <code>cloudflare</code> 版本需要最低为 <code>2.3.1</code> <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[certbot-dns-cloudflare’s documentation](https://certbot-dns-cloudflare.readthedocs.io/en/stable/#welcome-to-certbot-dns-cloudflare-s-documentation)">[1]</span></a></sup> <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pip list</span></span><br><span class="line">certbot                2.10.0</span><br><span class="line">certbot-dns-cloudflare 2.10.0</span><br><span class="line">cloudflare             2.19.2</span><br></pre></td></tr></table></figure>
以上模块安装完成后，即可使用 <code>certbot</code> 申请域名证书，并支持 Cloudflare DNS 的自动验证。</li>
</ol>
<h1 id="基于-Cloudflare-DNS-的自动验证申请域名证书"><a href="#基于-Cloudflare-DNS-的自动验证申请域名证书" class="headerlink" title="基于 Cloudflare DNS 的自动验证申请域名证书"></a>基于 Cloudflare DNS 的自动验证申请域名证书</h1><p><a href="#%E5%AE%89%E8%A3%85-Certbot">参考步骤安装 <code>certbot</code> 及 Cloudflare DNS 插件后</a> 即可使用 <code>certbot</code> 自动请求 Cloudflare DNS 创建申请证书时需要的 DNS 记录自动完成域名归属权的验证过程。</p>
<p><code>certbot</code> 支持的 Cloudflare 相关的参数如下</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>--dns-cloudflare</code></td>
<td>使用 Cloudflare 的 DNS 插件自动验证域名归属权</td>
<td></td>
</tr>
<tr>
<td><code>--dns-cloudflare-credentials</code></td>
<td>请求 Cloudflare 的授权配置文件</td>
<td></td>
</tr>
<tr>
<td><code>--dns-cloudflare-propagation-seconds</code></td>
<td>请求 Cloudflare DNS 添加相关 DNS 记录后，让 ACME 服务等待多少秒再验证 DNS 记录。主要用来防止 DNS 记录添加后，缓存 DNS 服务器未来得及更新最新记录。 <br/>默认为 10</td>
<td></td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="https://certbot-dns-cloudflare.readthedocs.io/en/stable/#credentials">Cloudflare Credentials 说明</a></p>
<p>假设有 Cloudflare 账号的 Global API Key，则 Credentials 配置文件内容参考如下</p>
<figure class="highlight shell"><figcaption><span>cloudflare.ini</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Cloudflare API credentials used by Certbot</span></span><br><span class="line">dns_cloudflare_email = cloudflare@example.com</span><br><span class="line">dns_cloudflare_api_key = 0123456789abcdef0123456789abcdef01234</span><br></pre></td></tr></table></figure>

<p>申请证书的具体命令如下，如果是第一次申请，需要根据提示填写自己的邮箱信息并同意许可协议，邮箱用于接受之后系统发送的错误或者域名证书过期等信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">certbot certonly \</span><br><span class="line">  --dns-cloudflare \</span><br><span class="line">  --dns-cloudflare-credentials ~/.secrets/certbot/cloudflare.ini \</span><br><span class="line">  --dns-cloudflare-propagation-seconds 60 \</span><br><span class="line">  -d example.com \</span><br><span class="line">  -d www.example.com</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果是非交互式环境,可以使用参数 <code>--email your-email@example.com</code> 和 <code>--agree-tos</code> 自动绑定邮箱并同意许可</p>
</blockquote>
<span id="more"></span>

<p>其他常用参数</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>--cert-path</code></td>
<td>指定证书存放路径</td>
<td><code>--cert-path /path/to/certificate.pem</code></td>
</tr>
<tr>
<td><code>--key-path</code></td>
<td>密钥存放路径</td>
<td></td>
</tr>
<tr>
<td><code>--fullchain-path</code></td>
<td>full certificate chain 存放路径</td>
<td></td>
</tr>
<tr>
<td><code>--chain-path</code></td>
<td>证书链存放路径</td>
<td></td>
</tr>
<tr>
<td><code>--non-interactive</code></td>
<td>使用非交互模式。建议在自动化脚本中使用</td>
<td></td>
</tr>
<tr>
<td><code>--quiet</code></td>
<td>减少输出，只输出关键信息</td>
<td></td>
</tr>
</tbody></table>
<h1 id="certbot-命令常用操作"><a href="#certbot-命令常用操作" class="headerlink" title="certbot 命令常用操作"></a>certbot 命令常用操作</h1><h2 id="手动添加-DNS-TXT-记录验证申请域名证书"><a href="#手动添加-DNS-TXT-记录验证申请域名证书" class="headerlink" title="手动添加 DNS TXT 记录验证申请域名证书"></a>手动添加 DNS TXT 记录验证申请域名证书</h2><p>如果需要通过手动添加域名 DNS TXT 记录的方式验证域名归属来申请域名证书，可以参考以下命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">certbot certonly --manual --preferred-challenges dns -d test.domain.com</span></span><br><span class="line">Saving debug log to /var/log/letsencrypt/letsencrypt.log</span><br><span class="line">Requesting a certificate for test.domain.com</span><br><span class="line"></span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">Please deploy a DNS TXT record under the name:</span><br><span class="line"></span><br><span class="line">_acme-challenge.test.domain.com.</span><br><span class="line"></span><br><span class="line">with the following value:</span><br><span class="line"></span><br><span class="line">a1vi7KIPqDvMJtuJRThCD2n1nEnQF2TUc6hqJm-RLLI</span><br><span class="line"></span><br><span class="line">Before continuing, verify the TXT record has been deployed. Depending on the DNS</span><br><span class="line">provider, this may take some time, from a few seconds to multiple minutes. You can</span><br><span class="line">check if it has finished deploying with aid of online tools, such as the Google</span><br><span class="line">Admin Toolbox: https://toolbox.googleapps.com/apps/dig/#TXT/_acme-challenge.test.domain.com.</span><br><span class="line">Look for one or more bolded line(s) below the line &#x27;;ANSWER&#x27;. It should show the</span><br><span class="line">value(s) you&#x27;ve just added.</span><br><span class="line"></span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">Press Enter to Continue</span><br><span class="line"></span><br><span class="line">Successfully received certificate.</span><br><span class="line">Certificate is saved at: /etc/letsencrypt/live/test.domain.com/fullchain.pem</span><br><span class="line">Key is saved at:         /etc/letsencrypt/live/test.domain.com/privkey.pem</span><br><span class="line">This certificate expires on 2024-08-14.</span><br><span class="line">These files will be updated when the certificate renews.</span><br><span class="line"></span><br><span class="line">NEXT STEPS:</span><br><span class="line">- This certificate will not be renewed automatically. Autorenewal of --manual certificates requires the use of an authentication hook script (--manual-auth-hook) but one was not provided. To renew this certificate, repeat this same certbot command before the certificate&#x27;s expiry date.</span><br><span class="line"></span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">If you like Certbot, please consider supporting our work by:</span><br><span class="line"> * Donating to ISRG / Let&#x27;s Encrypt:   https://letsencrypt.org/donate</span><br><span class="line"> * Donating to EFF:                    https://eff.org/donate-le</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br></pre></td></tr></table></figure>



<p>相关参数使用说明</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>--manual</code></td>
<td>使用 <code>manual</code> 插件来验证域名归属权</td>
<td></td>
</tr>
<tr>
<td><code>--preferred-challenges</code></td>
<td><code>manual</code> 插件支持使用 <code>http</code> 或 <code>dns</code> 的方式来验证域名归属权。<br/>- <code>http</code> 需要根据提示在所申请域名的网站相关目录下（<code>/.well-known/acme-challenge/</code>）放置特定名称和内容的文件<br/>- <code>dns</code> 需要根据提示为域名添加相应的 TXT 记录</td>
<td></td>
</tr>
</tbody></table>
<p><em><strong>使用 <code>--manual</code> 插件申请的证书不支持到期前自动更新证书</strong></em>，除非使用 <code>--manual-auth-hook</code> 方式绑定了 <a target="_blank" rel="noopener" href="https://eff-certbot.readthedocs.io/en/stable/using.html#hooks">域名归属权验证脚本（hook）</a>来自动实现 <code>http</code> 或 <code>dns</code> 的验证过程。</p>
<p>使用 <code>--manual</code> 插件申请的证书在证书到期前要更新的话，将申请证书的过程重新执行一遍即可。</p>
<h1 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h1><h2 id="DNSSEC-DNSKEY-Missing"><a href="#DNSSEC-DNSKEY-Missing" class="headerlink" title="DNSSEC: DNSKEY Missing"></a>DNSSEC: DNSKEY Missing</h2><p><a href="#%E5%9F%BA%E4%BA%8E-Cloudflare-DNS-%E7%9A%84%E8%87%AA%E5%8A%A8%E9%AA%8C%E8%AF%81%E7%94%B3%E8%AF%B7%E5%9F%9F%E5%90%8D%E8%AF%81%E4%B9%A6">使用 Cloudflare 插件自动申请证书</a> ，有些域名可以正常申请，有些域名会申请证书失败，具体错误如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Certbot failed to authenticate some domains (authenticator: dns-cloudflare). The Certificate Authority reported these problems:</span><br><span class="line">  Domain: qq.test.top</span><br><span class="line">  Type:   dns</span><br><span class="line">  Detail: DNS problem: looking up TXT for _acme-challenge.qq.test.top: DNSSEC: DNSKEY Missing</span><br><span class="line"></span><br><span class="line">  Domain: qq.cesh.top</span><br><span class="line">  Type:   dns</span><br><span class="line">  Detail: DNS problem: looking up TXT for _acme-challenge.qq.cesh.top: DNSSEC: DNSKEY Missing</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Hint: The Certificate Authority failed to verify the DNS TXT records created by --dns-cloudflare. Ensure the above domains are hosted by this DNS provider, or try increasing --dns-cloudflare-propagation-seconds (currently 30 seconds).</span><br><span class="line"></span><br><span class="line">Some challenges have failed.</span><br><span class="line">Ask for help or search for solutions at https://community.letsencrypt.org. See the logfile /var/log/letsencrypt/letsencrypt.log or re-run Certbot with -v for more details.</span><br></pre></td></tr></table></figure>
<p>申请证书的过程中，检查 DNS 记录，成功创建了相关的 TXT 记录。</p>
<h2 id="SERVFAIL-looking-up-CAA"><a href="#SERVFAIL-looking-up-CAA" class="headerlink" title="SERVFAIL looking up CAA"></a>SERVFAIL looking up CAA</h2><p>使用以下命令申请域名证书失败，本示例 <a href="#%E5%9F%BA%E4%BA%8E-Cloudflare-DNS-%E7%9A%84%E8%87%AA%E5%8A%A8%E9%AA%8C%E8%AF%81%E7%94%B3%E8%AF%B7%E5%9F%9F%E5%90%8D%E8%AF%81%E4%B9%A6">使用 Cloudflare 插件自动进行 DNS 验证</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">certbot certonly --debug --manual --preferred-challenges dns -d a.test.com</span></span><br><span class="line">Saving debug log to /var/log/letsencrypt/letsencrypt.log</span><br><span class="line">Requesting a certificate for a.test.com</span><br><span class="line"></span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">Please deploy a DNS TXT record under the name:</span><br><span class="line"></span><br><span class="line">_acme-challenge.a.test.com.</span><br><span class="line"></span><br><span class="line">with the following value:</span><br><span class="line"></span><br><span class="line">kbLf6l1aKTPdLYwQJruY8-ajROrSinBlB1NDoJXHB1g</span><br><span class="line"></span><br><span class="line">Before continuing, verify the TXT record has been deployed. Depending on the DNS</span><br><span class="line">provider, this may take some time, from a few seconds to multiple minutes. You can</span><br><span class="line">check if it has finished deploying with aid of online tools, such as the Google</span><br><span class="line">Admin Toolbox: https://toolbox.googleapps.com/apps/dig/#TXT/_acme-challenge.a.test.com.</span><br><span class="line">Look for one or more bolded line(s) below the line &#x27;;ANSWER&#x27;. It should show the</span><br><span class="line">value(s) you&#x27;ve just added.</span><br><span class="line"></span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">Press Enter to Continue</span><br><span class="line"></span><br><span class="line">Certbot failed to authenticate some domains (authenticator: manual). The Certificate Authority reported these problems:</span><br><span class="line">  Domain: a.test.com</span><br><span class="line">  Type:   dns</span><br><span class="line">  Detail: DNS problem: SERVFAIL looking up CAA for a.test.com - the domain&#x27;s nameservers may be malfunctioning</span><br><span class="line"></span><br><span class="line">Hint: The Certificate Authority failed to verify the manually created DNS TXT records. Ensure that you created these in the correct location, or try waiting longer for DNS propagation on the next attempt.</span><br></pre></td></tr></table></figure>

<p>关键报错信息： <code>DNS problem: SERVFAIL looking up CAA for a.test.com - the domain&#39;s nameservers may be malfunctioning</code>。测试 TXT 记录已经添加成功</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">dig TXT _acme-challenge.a.test</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.15 &lt;&lt;&gt;&gt; TXT _acme-challenge.a.test</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 24295</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;_acme-challenge.a.test.	IN	TXT</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">_acme-challenge.a.test. 149 IN	TXT	&quot;kbLf6l1aKTPdLYwQJruY8-ajROrSinBlB1NDoJXHB1g&quot;</span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 172.31.0.2#53(172.31.0.2)</span><br><span class="line">;; WHEN: Wed Sep 25 14:26:35 CST 2024</span><br><span class="line">;; MSG SIZE  rcvd: 113</span><br></pre></td></tr></table></figure>

<p>参考有关 CAA 的说明： <a target="_blank" rel="noopener" href="https://www.namecheap.com/support/knowledgebase/article.aspx/9991/38/caa-record-and-why-it-is-needed-ssl-related/">CAA Record and why it is needed (SSL related)</a> </p>
<p><strong>解决方法是需要为每个需要申请证书的域名添加 CAA 记录，用来确保对指定的域名，只有 CAA 中指定的 CA 机构才能为此域名颁发证书</strong></p>
<p>根据此思路，为需要申请的域名（以 <code>a.aabbcc.com</code> 为例）添加 CAA 记录（<strong>支持通配符匹配多个值，<code>*</code> 匹配所有</strong>），Cloudflare 上为域名添加 CAA 示例如下<br><img src="https://i.csms.tech/img_262.png"></p>
<p>配置完成后进行 CAA 解析测试，可以看到已有 CAA 记录 <code>a.aabbcc.com.		300	IN	CAA	0 issuewild &quot;*&quot;</code>，再次申请证书后，可以正常申请证书</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">dig CAA a.aabbcc.com</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.15 &lt;&lt;&gt;&gt; CAA a.aabbcc.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 61363</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;a.aabbcc.com.			IN	CAA</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">a.aabbcc.com.		300	IN	CAA	0 issuewild &quot;*&quot;</span><br><span class="line"></span><br><span class="line">;; Query time: 3 msec</span><br><span class="line">;; SERVER: 172.31.0.2#53(172.31.0.2)</span><br><span class="line">;; WHEN: Wed Sep 25 14:25:07 CST 2024</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>CAA 主机部分使用通配符无效，如 <code>*.aabbcc.com.		300	IN	CAA	0 issuewild &quot;*&quot;</code></strong></p>
</blockquote>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a target="_blank" rel="noopener" href="https://eff-certbot.readthedocs.io/en/stable/using.html">User Guide</a><br><a target="_blank" rel="noopener" href="https://www.namecheap.com/support/knowledgebase/article.aspx/9991/38/caa-record-and-why-it-is-needed-ssl-related/">CAA Record and why it is needed (SSL related)</a></p>
<h1 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h1><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://certbot-dns-cloudflare.readthedocs.io/en/stable/#welcome-to-certbot-dns-cloudflare-s-documentation">certbot-dns-cloudflare’s documentation</a><a href="#fnref:1" rev="footnote"> ↩</a></span></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">2.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://eff-certbot.readthedocs.io/en/stable/using.html#manual">Manual</a><a href="#fnref:2" rev="footnote"> ↩</a></span></li></ol></div></div>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="../tags/Python/" rel="tag"><i class="fa fa-tag"></i> Python</a>
              <a href="../tags/Linux/" rel="tag"><i class="fa fa-tag"></i> Linux</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="../202403051140/" rel="prev" title="婚礼用品">
                  <i class="fa fa-chevron-left"></i> 婚礼用品
                </a>
            </div>
            <div class="post-nav-item">
                <a href="../202404301039/" rel="next" title="Prometheus Redis exporter 使用">
                  Prometheus Redis exporter 使用 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">COSMOS</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="300" alpha="0.3" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="../js/comments.js"></script><script src="../js/utils.js"></script><script src="../js/motion.js"></script><script src="../js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="../js/third-party/search/local-search.js"></script>




  <script src="../js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"fl9999","repo":"fl9999.github.io","client_id":"a11bf6f7860762b725b5","client_secret":"a99046105f8bddc72ec718d54dc3fd7f22070821","admin_user":"fl9999","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"d41d8cd98f00b204e9800998ecf8427e"}</script>
<script src="../js/third-party/comments/gitalk.js"></script>

</body>
</html>
