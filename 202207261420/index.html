<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16-next.png">
  <link rel="mask-icon" href="../images/logo.svg" color="#222">

<link rel="stylesheet" href="../css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"csms.tech","root":"/","images":"../images","scheme":"Gemini","darkmode":true,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeIn","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"../search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="../js/config.js"></script>

    <meta name="description" content="Nginx 服务配置全局通用配置nginx.confuser nginx nginx;    # 建议设置为 cpu 核心数或者 cpu 核心数的 2 倍，进程会包含一个 &#96;master process&#96;，多个 &#96;worker process&#96;  # master process 负责绑定端口、调度进程等，不负责业务的处理  # worker process 是业务进程，负责业务的处理worker">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx 服务常用配置说明">
<meta property="og:url" content="http://csms.tech/202207261420/index.html">
<meta property="og:site_name" content="L B T">
<meta property="og:description" content="Nginx 服务配置全局通用配置nginx.confuser nginx nginx;    # 建议设置为 cpu 核心数或者 cpu 核心数的 2 倍，进程会包含一个 &#96;master process&#96;，多个 &#96;worker process&#96;  # master process 负责绑定端口、调度进程等，不负责业务的处理  # worker process 是业务进程，负责业务的处理worker">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.csms.tech/img_95.png">
<meta property="og:image" content="https://i.csms.tech/img_231.png">
<meta property="og:image" content="https://i.csms.tech/img_124.png">
<meta property="og:image" content="https://i.csms.tech/img_125.png">
<meta property="og:image" content="https://i.csms.tech/img_129.png">
<meta property="article:published_time" content="2022-07-26T06:21:02.000Z">
<meta property="article:modified_time" content="2025-02-07T02:02:00.000Z">
<meta property="article:author" content="COSMOS">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.csms.tech/img_95.png">


<link rel="canonical" href="http://csms.tech/202207261420/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://csms.tech/202207261420/","path":"202207261420/","title":"Nginx 服务常用配置说明"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Nginx 服务常用配置说明 | L B T</title>
  








  <noscript>
    <link rel="stylesheet" href="../css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">L B T</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记 录 过 去 的 经 验</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="../index.html" rel="section"><i class="fa fa-earth-americas fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="../categories/" rel="section"><i class="fa fa-folder-tree fa-fw"></i>总目录<span class="badge">53</span></a></li><li class="menu-item menu-item-linux"><a href="../categories/Linux" rel="section"><i class="fa fa-brands fa-linux fa-fw"></i>Linux</a></li><li class="menu-item menu-item-python"><a href="../categories/Python" rel="section"><i class="fa fa-brands fa-python fa-fw"></i>Python</a></li><li class="menu-item menu-item-docker"><a href="../categories/Docker" rel="section"><i class="fa fa-brands fa-docker fa-fw"></i>Docker</a></li><li class="menu-item menu-item-kubernetes"><a href="../categories/Kubernetes" rel="section"><i class="fa fa-dharmachakra fa-fw"></i>Kubernetes</a></li><li class="menu-item menu-item-tags"><a href="../tags/" rel="section"><i class="fa fa-tornado fa-fw"></i>标签<span class="badge">78</span></a></li><li class="menu-item menu-item-archives"><a href="../archives/" rel="section"><i class="fa fa-rectangle-list fa-fw"></i>列表<span class="badge">285</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章总目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx-%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="nav-number">1.</span> <span class="nav-text">Nginx 服务配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">1.1.</span> <span class="nav-text">全局通用配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Server-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.</span> <span class="nav-text">Server 常用配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx-%E4%BB%A3%E7%90%86-php"><span class="nav-number">1.2.1.</span> <span class="nav-text">nginx 代理 php</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx-%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7"><span class="nav-number">1.2.2.</span> <span class="nav-text">nginx 状态监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ssl-%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.3.</span> <span class="nav-text">ssl 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-upstream-%E4%BB%A3%E7%90%86"><span class="nav-number">1.2.4.</span> <span class="nav-text">配置 upstream 代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ip-%E9%99%90%E5%88%B6"><span class="nav-number">1.2.5.</span> <span class="nav-text">ip 限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%B0%E5%8C%BA%E9%99%90%E5%88%B6"><span class="nav-number">1.2.6.</span> <span class="nav-text">地区限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#server-%E4%B8%AD-location-%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-number">1.2.7.</span> <span class="nav-text">server 中 location 优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#301-%E8%B7%B3%E8%BD%AC%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.8.</span> <span class="nav-text">301 跳转配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#url-%E8%AE%BF%E9%97%AE%E9%A2%91%E7%8E%87%E9%99%90%E5%88%B6"><span class="nav-number">1.2.9.</span> <span class="nav-text">url 访问频率限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#log-%E4%B8%AD%E8%AE%B0%E5%BD%95%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BC%A0%E5%85%A5%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89%E5%A4%B4%E9%83%A8"><span class="nav-number">1.2.10.</span> <span class="nav-text">log 中记录客户端传入的自定义头部</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#stream-%E9%85%8D%E7%BD%AE"><span class="nav-number">1.3.</span> <span class="nav-text">stream 配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF"><span class="nav-number">2.</span> <span class="nav-text">常见错误</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#worker-connections-exceed-open-file-resource-limit"><span class="nav-number">2.1.</span> <span class="nav-text">worker_connections exceed open file resource limit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CORS"><span class="nav-number">2.2.</span> <span class="nav-text">CORS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP-Preflight-Request-%E8%AF%B4%E6%98%8E"><span class="nav-number">2.2.1.</span> <span class="nav-text">HTTP Preflight Request  说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Response-to-preflight-request-doesn%E2%80%99t-pass-access-control-check-The-value-of-the-%E2%80%98Access-Control-Allow-Origin%E2%80%99-header-in-the-response-must-not-be-the-wildcard-%E2%80%98-%E2%80%99"><span class="nav-number">2.2.2.</span> <span class="nav-text">Response to preflight request doesn’t pass access control check: The value of the ‘Access-Control-Allow-Origin’ header in the response must not be the wildcard ‘*’</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#nginx-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">nginx 服务端解决方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#nginx-%E9%85%8D%E7%BD%AE%E5%85%81%E8%AE%B8%E5%8D%95%E4%B8%AA%E7%9B%AE%E6%A0%87%E8%B7%A8%E5%9F%9F"><span class="nav-number">2.2.2.1.1.</span> <span class="nav-text">nginx 配置允许单个目标跨域</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#nginx-%E9%85%8D%E7%BD%AE%E5%85%81%E8%AE%B8%E5%A4%9A%E4%B8%AA%E7%9B%AE%E6%A0%87%E8%B7%A8%E5%9F%9F"><span class="nav-number">2.2.2.1.2.</span> <span class="nav-text">nginx 配置允许多个目标跨域</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E9%85%8D%E7%BD%AE-ssl-%E6%97%B6%E6%9C%AA%E6%8C%87%E5%AE%9A-ssl"><span class="nav-number">2.3.</span> <span class="nav-text">Nginx 配置 ssl 时未指定 ssl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx-service-failed-to-run-%E2%80%98start-pre%E2%80%99-task-Permission-denied"><span class="nav-number">2.4.</span> <span class="nav-text">nginx.service failed to run ‘start-pre’ task: Permission denied</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%AD%A3%E5%B8%B8%EF%BC%8Cweb-%E9%A1%B5%E9%9D%A2%E6%9C%AA%E5%B1%95%E7%A4%BA%E6%A0%B7%E5%BC%8F"><span class="nav-number">2.5.</span> <span class="nav-text">静态文件加载正常，web 页面未展示样式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx-%E5%8F%8D%E4%BB%A3-wordpress-%E4%BD%BF%E7%94%A8-HTTPS-%E6%97%B6%E4%B8%80%E7%9B%B4%E9%87%8D%E5%A4%8D%E9%87%8D%E5%AE%9A%E5%90%91"><span class="nav-number">2.6.</span> <span class="nav-text">nginx 反代 wordpress 使用 HTTPS 时一直重复重定向</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx-%E6%9C%8D%E5%8A%A1-reload-%E5%A4%B1%E8%B4%A5"><span class="nav-number">2.7.</span> <span class="nav-text">nginx 服务 reload 失败</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx-%E5%B8%B8%E8%A7%81%E7%94%A8%E6%B3%95%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="nav-number">3.</span> <span class="nav-text">Nginx 常见用法配置示例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E5%8F%8D%E4%BB%A3-FTP-%E6%9C%8D%E5%8A%A1"><span class="nav-number">3.1.</span> <span class="nav-text">Nginx 反代 FTP 服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E5%8F%8D%E4%BB%A3-Rancher"><span class="nav-number">3.2.</span> <span class="nav-text">Nginx 反代 Rancher</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E5%8F%8D%E4%BB%A3-OpenVPN-%E6%9C%8D%E5%8A%A1"><span class="nav-number">3.3.</span> <span class="nav-text">Nginx 反代 OpenVPN 服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-if-%E5%AE%9E%E7%8E%B0%E4%B8%8E%E6%88%96%E6%93%8D%E4%BD%9C"><span class="nav-number">3.4.</span> <span class="nav-text">Nginx if 实现与或操作</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%84%9A%E6%B3%A8"><span class="nav-number">4.</span> <span class="nav-text">脚注</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">COSMOS</p>
  <div class="site-description" itemprop="description">得 能 莫 忘</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="../archives/">
          <span class="site-state-item-count">285</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="../categories/">
        <span class="site-state-item-count">53</span>
        <span class="site-state-item-name">目录</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="../tags/">
        <span class="site-state-item-count">78</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202207261420/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Nginx 服务常用配置说明 | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Nginx 服务常用配置说明
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-26 14:21:02" itemprop="dateCreated datePublished" datetime="2022-07-26T14:21:02+08:00">2022-07-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 10:02:00" itemprop="dateModified" datetime="2025-02-07T10:02:00+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Linux/%E5%B8%B8%E7%94%A8%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">常用服务</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="Nginx-服务配置"><a href="#Nginx-服务配置" class="headerlink" title="Nginx 服务配置"></a>Nginx 服务配置</h1><h2 id="全局通用配置"><a href="#全局通用配置" class="headerlink" title="全局通用配置"></a>全局通用配置</h2><figure class="highlight shell"><figcaption><span>nginx.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">user nginx nginx;    </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建议设置为 cpu 核心数或者 cpu 核心数的 2 倍，进程会包含一个 `master process`，多个 `worker process`</span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">master process 负责绑定端口、调度进程等，不负责业务的处理</span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">worker process 是业务进程，负责业务的处理</span></span><br><span class="line">worker_processes auto;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一个 worker 进程可以打开的最大的 fd 个数，受 Linux 内核限制</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">理论值应该是系统最多打开文件数（<span class="built_in">ulimit</span> -n）与 nginx 进程数相除</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可通过 <span class="built_in">ulimit</span> 设置或修改系统文件：`/etc/securit/limits.conf`</span></span><br><span class="line">worker_rlimit_nofile 1024；</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cpu 亲和性设置</span> </span><br><span class="line">worker_cpu_affinity    0001 0010 0100 1000;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">工作进程调度优先级，-20 到 19 之间的值，值越小越优先调用。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果系统同时运行多个任务，你可能需要提高 nginx 的工作进程的优先级</span> </span><br><span class="line">worker_priority 0；              </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ssl 硬件加速服务器，需要硬件支持</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ssl_engine ssl_engine device;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nginx 是否以守护进程运行，是否让 nignx 运行于后台；调试时可为 off，使得所有信息直接输出在控制台</span></span><br><span class="line">daemon      on | off;         </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">events 模块中包含 nginx 中所有处理连接的设置。</span></span><br><span class="line">events &#123;</span><br><span class="line">    # 每个 worker 进程允许的最多连接数, </span><br><span class="line">    # nginx 服务最大连接数：worker_processes * worker_connections (受 worker_rlimit_nofile 限制)</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">    use epoll;</span><br><span class="line">    </span><br><span class="line">    # 是否允许一次性地响应多个用户请求</span><br><span class="line">    multi_accept on;                    </span><br><span class="line"></span><br><span class="line">    # 是否打开 nginx 的 accept 锁；此锁能够让多个 worker 进行轮流地、序列化地与新的客户端建立连接；</span><br><span class="line">    # 而通常当一个 worker 进程的负载达到其上限的 7/8，master 就尽可能不将请求调度至 worker.</span><br><span class="line">	accept_mutex on | off;              </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">HTTP 模块控制着 nginx http 处理的所有核心特性</span></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    # 是否在错误页面中显示和响应头字段中发出 nginx 版本号。</span><br><span class="line">    # 安全考虑建议关闭</span><br><span class="line">    server_tokens on | off | string; </span><br><span class="line">    </span><br><span class="line">    # 是否启用 sendfile 内核复制模式功能。作为静态服务器可以提供最大的 IO 访问速度。</span><br><span class="line">    sendfile on | off; </span><br><span class="line">    </span><br><span class="line">    # 尽快发送数据，否则会在数据包达到一定大小后再发送数据。这样会减少网络通信次数，降低阻塞概率，但也会影响响应及时性。</span><br><span class="line">    # 比较适合于文件下载这类的大数据通信场景。</span><br><span class="line">    tcp_nodelay on|off; </span><br><span class="line">    </span><br><span class="line">    # 单位s，适当降低此值可以提高响应连接数量</span><br><span class="line">    keepalive_timeout  65; </span><br><span class="line">    </span><br><span class="line">    # 一次长连接上允许的最大请求数</span><br><span class="line">    keepalive_requests 100；       </span><br><span class="line">    </span><br><span class="line">    # 禁止指定浏览器使用 keepalive</span><br><span class="line">    keepalive_disable msie6|none；    </span><br><span class="line">    </span><br><span class="line">    # 读取 http 请求首部的超时时长。如果客户端在此时间内未传输整个头，则会向客户端返回 408（请求超时）错误</span><br><span class="line">    client_header_timeout 1;     </span><br><span class="line">    </span><br><span class="line">    # 读取 http 请求包体的超时时间。</span><br><span class="line">    client_body_timeout 2;</span><br><span class="line">    </span><br><span class="line">    # 发送响应的超时时长。超时后连接将关闭。</span><br><span class="line">    send_timeout 5;  </span><br><span class="line">    </span><br><span class="line">    # http 请求包体的最大值，常用于限定客户端所能够请求的最大包体，根据请求首部中的 Content-Length 来检查，以避免无用的传输。</span><br><span class="line">    client_max_body_size 1m;</span><br><span class="line">    </span><br><span class="line">    # 限制客户端每秒传输的字节数，默认为0，表示没有限制。单位 Byte/s</span><br><span class="line">    limit_rate 0;</span><br><span class="line">    </span><br><span class="line">    # nginx 向客户端发送响应报文时，如果大小超过了此处指定的值，则后续的发送过程开始限速，单位 Byte</span><br><span class="line">    limit_rate_after 0;</span><br><span class="line">    </span><br><span class="line">    # 是否忽略不合法的 http 首部，默认为 on，off 意味着请求首部中出现不合规的首部将拒绝响应。</span><br><span class="line">    ignore_invalid_headers on|off;</span><br><span class="line">    </span><br><span class="line">    # 用户访问的文件不存在时，是否将其记录到错误日志中。</span><br><span class="line">    log_not_found on|off;   </span><br><span class="line">    </span><br><span class="line">    # nginx 使用的 dns 地址，及缓存解析结果的时间               </span><br><span class="line">    resolver 8.8.8.8 [valid=time] [ipv6=on|off];</span><br><span class="line">    </span><br><span class="line">    # dns 解析超时时间 </span><br><span class="line">    resolver_timeout 2；     </span><br><span class="line">    </span><br><span class="line">    # 是否打开文件缓存功能，max：用于缓存条目的最大值，</span><br><span class="line">    # inactive：某缓存条目在指定时长内没有被访问过时，将自动被删除，即缓存有效期，通常默认为 60s。</span><br><span class="line">    open_file_cache off;  </span><br><span class="line">    open_file_cache max=N [inactive=time];    </span><br><span class="line">    </span><br><span class="line">    # 是否缓存文件找不到或没有权限访问等相关信息。</span><br><span class="line">    open_file_cache_errors on | off; </span><br><span class="line">    </span><br><span class="line">    # 多长时间检查一次缓存中的条目是否超出非活动时长。</span><br><span class="line">    # 建议值：小于等于 open_file_cache inactive</span><br><span class="line">    open_file_cache_valid 60;   </span><br><span class="line">    </span><br><span class="line">    # 在 open_file_cache inactive指 定的时长内被访问超过此处指定的次数时，才不会被删除（删除低命中率的缓存）。</span><br><span class="line">    open_file_cache_min_uses 2;     </span><br><span class="line">    </span><br><span class="line">    # 开启内容压缩，可以有效降低客户端的访问流量和网络带宽</span><br><span class="line">    gzip on | off;</span><br><span class="line">    </span><br><span class="line">    # 内容超过最少长度后才开启压缩，太短的内容压缩效果不佳，且会浪费系统资源。</span><br><span class="line">    # 压缩长度会作为 http 响应头 Content-Length 字段返回给客户端。 建议值：64</span><br><span class="line">    gzip_min_length length;</span><br><span class="line">    </span><br><span class="line">    # 压缩级别，默认值为 1。范围为1～9级，压缩级别越高压缩率越高，但对系统性能要求越高。建议值：4</span><br><span class="line">    gzip_comp_level 1~9;</span><br><span class="line">    </span><br><span class="line">    # 压缩内容类型，默认为 text/html;。只压缩 html 文本，一般我们都会压缩 js、css、json 之类的，可以把这些常见的文本数据都配上。</span><br><span class="line">    如：text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;</span><br><span class="line">    gzip_types mime-type …;     </span><br><span class="line">    </span><br><span class="line">    # 自动显示目录</span><br><span class="line">    autoindex on;</span><br><span class="line">    </span><br><span class="line">    # off ： 以人类易读的方式显示文件大小，on：以 bytes 显示文件大小</span><br><span class="line">    autoindex_exact_size off;</span><br><span class="line">    </span><br><span class="line">    # 定义限制区域，imit_req_zone 只能放在 http &#123;&#125; 内，使用此限制可以在 http &#123;&#125; （对服务器内所有的网站生效）、server &#123;&#125; （对具体的一个网站生效）或 location &#123;&#125; （对具体的一个网址生效）</span><br><span class="line">    # 此区域名称为 test，可根据需求自定义； 10m 表示此区域存储 key（$binary_remote_addr）使用的大小</span><br><span class="line">    # 存储大小，一般 1m 空间大约能保存 1.6 万条 IP 地址，空间满了新数据会覆盖旧数据</span><br><span class="line">    # rate=1r/m ，限制访问请求频率为每分钟 1 次，可根据需要自行设置，1r/s 是 1 秒 1 次，时间单位只能选择 s (秒)或 m (分)，最低频率限制是每分钟 1 次访问请求</span><br><span class="line">    # rate=10r/m，1分钟最多访问 10 次，同时不能超过 1r/6s，即 6s 内最多访问 1 次。超过 1r/6s 返回 503</span><br><span class="line">    limit_req_zone $binary_remote_addr zone=test:10m rate=1r/m;</span><br><span class="line">    </span><br><span class="line">    # 定义日志格式</span><br><span class="line">    log_format main &#x27;&#123; time: $time_iso8601|&#x27;</span><br><span class="line">                    &#x27;http_host:$http_host|&#x27;</span><br><span class="line">                    &#x27;cdn_ip:$remote_addr|&#x27;</span><br><span class="line">                    &#x27;request:$request|&#x27;</span><br><span class="line">                    &#x27;request_method:$request_method|&#x27;</span><br><span class="line">                    &#x27;http_user_agent:$http_user_agent|&#x27;</span><br><span class="line">                    &#x27;size:$body_bytes_sent|&#x27;</span><br><span class="line">                    &#x27;responsetime:$request_time|&#x27;</span><br><span class="line">                    &#x27;upstreamtime:$upstream_response_time|&#x27;</span><br><span class="line">                    &#x27;upstreamhost:$upstream_addr|&#x27;</span><br><span class="line">                    &#x27;upstreamstatus:$upstream_status|&#x27;</span><br><span class="line">                    &#x27;url:$http_host$uri|&#x27;</span><br><span class="line">                    &#x27;http_x_forwarded_for:$clientRealIp|&#x27;</span><br><span class="line">                    &#x27;status:$status&#125;&#x27;;</span><br><span class="line">    </span><br><span class="line">    # server 负责具体的 http 服务器实现</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80 [default_server]  [rcvbuf=SIZE]  [sndbuf=SIZE] [ssl];</span><br><span class="line">        </span><br><span class="line">        # 可使用通配符*或正则表达式(~开头)，多个域名先精确匹配，再通配，再正则,&#x27;_&#x27;表示空主机头</span><br><span class="line">        server_name  _  ;</span><br><span class="line">        </span><br><span class="line">        access_log logs/access.log main;</span><br><span class="line">        error_log logs/access.err.log;</span><br><span class="line">        </span><br><span class="line">        # 跨域配置</span><br><span class="line">        add_header Access-Control-Allow-Origin *;</span><br><span class="line">        add_header Access-Control-Allow-Headers &#x27;Origin, No-Cache, X-Requested-With, If-Modified-Since, Pragma, Last-Modified, Cache-Control, Expires, Content-Type, X-E4M-With&#x27;;</span><br><span class="line">        add_header Access-Control-Allow-Methods GET,POST,OPTIONS;</span><br><span class="line">        add_header Access-Control-Allow-Credentials: true;</span><br><span class="line">        </span><br><span class="line">        location / &#123;       </span><br><span class="line">            # web 资源路径             </span><br><span class="line">            root   html;          </span><br><span class="line">            </span><br><span class="line">            # 定义默认页面，从左往右匹配           </span><br><span class="line">            index  index.html index.htm;   </span><br><span class="line">            </span><br><span class="line">            # 自左向右读取指定路径，找到即停止，如果都不存在，返回一个错误码</span><br><span class="line">            try_files $uri $uri.html $uri/index.html =404;        </span><br><span class="line">            </span><br><span class="line">            # 自左向右读取指定路径，找到即停止，如果都不存在，返回一个 uri</span><br><span class="line">            try_files $uri $uri.html $uri/index.html /404.html; </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        location /i/ &#123; </span><br><span class="line">            # 路径别名，只能用于 location 中。</span><br><span class="line">            # 访问 http://a.com/i/a.html, 资源路径为：/data/www/html/a.html</span><br><span class="line">            # 若是root指令，访问 http://a.com/i/a.html，资源路径为：/data/www/html/i/a.html</span><br><span class="line">		    alias /data/www/html/;          </span><br><span class="line">	    &#125;</span><br><span class="line">	    </span><br><span class="line">	    # 对于某个请求发生错误，如果匹配到错误码，重定向到新的 url</span><br><span class="line">	    error_page  404              /404.html; </span><br><span class="line">	    error_page   500 502 503 504  /50x.html;</span><br><span class="line">	    </span><br><span class="line">	    # 对于某个请求发生错误，如果匹配到错误码，重定向到新的 url,同时可以更改返回码</span><br><span class="line">	    error_page 404 =200 /404.html;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    # 包含其他配置文件</span><br><span class="line">    include vhosts/*.conf;        </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<span id="more"></span>

<h2 id="Server-常用配置"><a href="#Server-常用配置" class="headerlink" title="Server 常用配置"></a>Server 常用配置</h2><h3 id="nginx-代理-php"><a href="#nginx-代理-php" class="headerlink" title="nginx 代理 php"></a>nginx 代理 php</h3><figure class="highlight shell"><figcaption><span>vhosts/web.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name  _  ;</span><br><span class="line">    root           html;</span><br><span class="line">    </span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;          ###fastcgi程序的页面文件位置，$document_root = 之前配置的root           html;</span><br><span class="line">        ##include        fastcgi_params;</span><br><span class="line">	    fastcgi_param  QUERY_STRING       $query_string;                  ###将请求中的参数透传</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="nginx-状态监控"><a href="#nginx-状态监控" class="headerlink" title="nginx 状态监控"></a>nginx 状态监控</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置访问路径，即 uri</span></span><br><span class="line">location = /nginx_status&#123;  </span><br><span class="line">  </span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">开启该模块</span></span><br><span class="line">  stub_status on;    </span><br><span class="line">  </span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">关闭日志</span>  </span><br><span class="line">  access_log off;   </span><br><span class="line">        </span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">允许访问的 ip，即白名单 ip</span> </span><br><span class="line">  allow 101.106.102.129;        </span><br><span class="line">  allow 127.0.0.1;</span><br><span class="line">  </span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">拒绝白名单 ip 以外的 ip 访问</span></span><br><span class="line">  deny all;               </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ssl-配置"><a href="#ssl-配置" class="headerlink" title="ssl 配置"></a>ssl 配置</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    server_name csms.tech;</span><br><span class="line">  </span><br><span class="line">    ssl_certificate /path/to/your_certificate.pem;</span><br><span class="line">    ssl_certificate_key /path/to/your_key.key;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">强制跳转 https</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name csms.tech;</span><br><span class="line">    rewrite ^(.*)$  https://$host$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用 pem 类型证书链：可将中间证书导入 pem 文件，再将私钥导入 pem 文件，<code>ssl_certificate</code> 和 <code>ssl_certificate_key</code> 都使用 pem 文件，可解决以下报错：<br>SSL_CTX_use_PrivateKey_file(“pri.key”) failed  (SSL: error:0906D06C:PEM routines:PEM_read_bio:no start line:Expecting: ANY PRIVATE KEY error:140B0009:SSL routines:SSL_CTX_use_PrivateKey_file:PEM lib</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat gd_bundle-g2-g1.crt &gt;&gt; f549150b196cd59e.pem</span><br><span class="line">cat f549150b196cd59e.key &gt;&gt; f549150b196cd59e.pem</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><figcaption><span>nginx.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">ssl_certificate f549150b196cd59e.pem;</span><br><span class="line">ssl_certificate_key  f549150b196cd59e.pem;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="配置-upstream-代理"><a href="#配置-upstream-代理" class="headerlink" title="配置 upstream 代理"></a>配置 upstream 代理</h3><figure class="highlight shell"><figcaption><span>upstream.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">upstream myserver &#123;</span><br><span class="line">    # 调度策略,默认为轮询</span><br><span class="line">    ip_hash | url_hash ...</span><br><span class="line">    </span><br><span class="line">    # 后端服务器列表</span><br><span class="line">    # backup: 其它所有的非 backup 机器 down 或者忙的时候，请求 backup 机器。所以这台机器压力会最轻。</span><br><span class="line">    # max_fails:允许请求失败的次数，默认为 1.当超过最大次数时，返回 proxy_next_upstream 模块定义的错误.</span><br><span class="line">    # fail_timeout : max_fails 次失败后，暂停的时间。 </span><br><span class="line">    server 10.0.0.1:8080 [weight=1] [backup] [down] [max_fails] [fail_timeout];</span><br><span class="line">    server 10.0.0.2:8080 [weight=1] [backup] [down] [max_fails] [fail_timeout];</span><br><span class="line"></span><br><span class="line">    keepalive 2000;</span><br><span class="line">    </span><br><span class="line">    # 后端健康检测，需要第三方插件 ngx_http_healthcheck_module</span><br><span class="line">    # healthcheck_enabled;         </span><br><span class="line">    # healthcheck_delay 3000;</span><br><span class="line">    # healthcheck_timeout 1000;</span><br><span class="line">    # healthcheck_failcount 2;</span><br><span class="line">    # healthcheck_send &#x27;GET /healthcheck.html HTTP/1.0&#x27; &#x27;Host: local.com&#x27; &#x27;Connection: close&#x27;;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;                                                         </span><br><span class="line">    server_name  csms.tech;                                               </span><br><span class="line">    client_max_body_size 1024M;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        # 指定协议、主机名、端口</span><br><span class="line">        proxy_pass http://myserver/uri;</span><br><span class="line">                     </span><br><span class="line">        [proxy_set_header Host $host:$server_port;]</span><br><span class="line">        [proxy_redirect     off;]</span><br><span class="line">        [proxy_set_header Host $host; ]</span><br><span class="line">        [proxy_set_header Host $proxy_host]</span><br><span class="line">        [proxy_set_header X-Real-IP $remote_addr;]</span><br><span class="line">        [proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;]</span><br><span class="line">        [proxy_set_header X-Forwarded-Proto https;]</span><br><span class="line">        [proxy_ignore_client_abort on;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>proxy_set_header Host $host</code> 和 <code>proxy_set_header Host $proxy_host</code> 的区别<ul>
<li><code>proxy_set_header Host $host</code> ： 将请求 Upstream 的 Host 头部设置为 <strong>客户端请求时使用的 Host</strong> ，会将客户端请求使用的域名传递给 Upstream.</li>
<li><code>proxy_set_header Host $proxy_host</code> ： 将请求 Upstream 的 Host 头部设置为 <strong><code>proxy_pass</code> 中的 Host</strong> ，如上面示例中的 <code>myserver</code>。（Client 请求域名和 Upstream 处理的域名不同）在 Upstream 只接受 Upstream 上配置的域名时，可以配置此头部。</li>
</ul>
</li>
</ul>
<h3 id="ip-限制"><a href="#ip-限制" class="headerlink" title="ip 限制"></a>ip 限制</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;                                                         </span><br><span class="line">    server_name  csms.tech;</span><br><span class="line">    </span><br><span class="line">    root html;</span><br><span class="line">    </span><br><span class="line">    if ($http_x_forwarded_for !~ (1.1.1.1|1.1.1.2)) &#123;</span><br><span class="line">        return 403;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="地区限制"><a href="#地区限制" class="headerlink" title="地区限制"></a>地区限制</h3><p>依赖 nginx 的 <code>http_geoip_module</code> 模块，检查 <code>GeoIP</code> 是否安装：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./sbin/nginx -V </span><br></pre></td></tr></table></figure>
<p>输出结果中如果不包含：<code>--with-http_geoip_module</code>，说明未安装，重新编译安装 nginx<br>安装 <code>http_geoip_module</code> 模块后使用以下配置</p>
<figure class="highlight shell"><figcaption><span>nginx.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    geoip_country /usr/share/GeoIP/GeoIP.dat;</span><br><span class="line">    </span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name csms.tech;</span><br><span class="line">        </span><br><span class="line">        location / &#123;</span><br><span class="line">            if ($geoip_country_code != CN) &#123;</span><br><span class="line">                root outChina;</span><br><span class="line">            &#125;</span><br><span class="line">            root China;</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="server-中-location-优先级"><a href="#server-中-location-优先级" class="headerlink" title="server 中 location 优先级"></a>server 中 <code>location</code> 优先级</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    # 精确匹配，最高优先级</span><br><span class="line">    location = /url  &#123;&#125;        </span><br><span class="line"></span><br><span class="line">    # 从前往后匹配，匹配到即停止继续匹配，不是正则匹配，第二优先级</span><br><span class="line">    location ^~ /uri  &#123;&#125;          </span><br><span class="line"></span><br><span class="line">    # 正则匹配，~ 区分大小写， ~* 不区分大小写，第三优先级</span><br><span class="line">    location ~ ^/url$ &#123;&#125;    </span><br><span class="line">    location ~* ^/url$ &#123;&#125;    </span><br><span class="line">	</span><br><span class="line">    # / 会匹配到所有未被匹配到的 url</span><br><span class="line">    location /documents/ &#123;&#125; </span><br><span class="line">    location / &#123;&#125; </span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="301-跳转配置"><a href="#301-跳转配置" class="headerlink" title="301 跳转配置"></a>301 跳转配置</h3><p>如下配置，使用 <code>rewrite</code> 或 <code>return</code> 指令，所有 <a href="https://csms.tech/"><code>csms.tech</code></a> 的请求都会 <code>301</code> 重定向到 <a href="https://csms.tech/"><code>www.csms.tech</code></a>，并携带原来的 <code>uri</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name csms.tech;</span><br><span class="line">    </span><br><span class="line">    rewrite ^/(.*)$ https://www.csms.tech$1 permanent;</span><br><span class="line">    </span><br><span class="line">    # return 301 https://www.csms.tech$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="url-访问频率限制"><a href="#url-访问频率限制" class="headerlink" title="url 访问频率限制"></a>url 访问频率限制</h3><p>要实现访问频率限制，需要先 <a href="#%E5%85%A8%E5%B1%80%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE">定义好限制区域</a>，如本文中在 http {} 中配置了以下限制区域</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义限制区域，imit_req_zone 只能放在 http &#123;&#125; 内，使用此限制可以在 http &#123;&#125; （对服务器内所有的网站生效）、server &#123;&#125; （对具体的一个网站生效）或 location &#123;&#125; （对具体的一个网址生效）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此区域名称为 <span class="built_in">test</span>，可根据需求自定义； 10m 表示此区域存储 key（<span class="variable">$binary_remote_addr</span>）使用的大小</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">存储大小，一般 1m 空间大约能保存 1.6 万条 IP 地址，空间满了新数据会覆盖旧数据</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rate=1r/m ，限制访问请求频率为每分钟 1 次，可根据需要自行设置，1r/s 是 1 秒 1 次，时间单位只能选择 s (秒)或 m (分)，最低频率限制是每分钟 1 次访问请求</span></span><br><span class="line">limit_req_zone $binary_remote_addr zone=test:10m rate=1r/m;</span><br></pre></td></tr></table></figure>
<p>在 server {} 中可以使用以下方式使用频率限制</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        # ...</span><br><span class="line">        # 对 /api/test/ 进行访问频率限制</span><br><span class="line">        location =/api/test/ &#123;</span><br><span class="line">            # 如果同 IP 一分钟内发起 10 并发请求，第 1 个请求立即处理，其余 9 个直接返回 503 错误</span><br><span class="line">            limit_req zone=test;</span><br><span class="line">            </span><br><span class="line">            # 如果同 IP 一分钟内发起 10 并发请求，第 1 个请求立即处理，第 2-6 个请求缓存后排队 1 分钟处理 1 个，第 7-10 个请求返回 503 错误</span><br><span class="line">            limit_req zone=test burst=5;</span><br><span class="line">            </span><br><span class="line">            # 如果同 IP 一分钟内发起 10 并发请求，第 1-5 个请求立即处理，剩下的 5 个直接返回 503 错误</span><br><span class="line">            # nodelay，如果不设置该选项，严格使用平均速率限制请求数</span><br><span class="line">            # burst=5，则 1m 内最多可请求 5 次。</span><br><span class="line">            # 假设 rate=10r/s，burst=5，只要第 1，2，3，4 秒都未超过 10 次，则第 5 秒可以最多请求 （50 减去第 1-4 秒请求次数的和）</span><br><span class="line">            limit_req zone=test burst=5 nodelay;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="log-中记录客户端传入的自定义头部"><a href="#log-中记录客户端传入的自定义头部" class="headerlink" title="log 中记录客户端传入的自定义头部"></a>log 中记录客户端传入的自定义头部</h3><p>假如客户端请求 Nginx 服务器时，添加了自定义头部 <code>name_id</code>，如果要在日志中引用此自定义头部，需要使用格式 <code>http_name_id</code>，如果直接使用 <code>name_id</code> 会报错： <code>unknown &quot;name_id&quot; variable</code></p>
<p>同时要在 <code>nginx.conf</code> 的 <code>http</code> 模块中配置 <code>underscores_in_headers on;</code> 允许处理带有下划线字符的头字段(如果设置为 <code>off</code>，Nginx 会拒绝包含下划线字符的头字段。日志中记录的字段值会为  <code>-</code>)</p>
<blockquote>
<p><strong>Nginx 使用 <code>$http_ 前缀加上请求头部名称的小写</code> 形式来引用请求头部。</strong></p>
<p><strong>Nginx 默认情况下只捕获小写的头部字段。如果客户端发送的是大写或大小写混合的头部字段，你需要使用 underscores_in_headers 指令来允许 Nginx 处理这类头部</strong></p>
</blockquote>
<h2 id="stream-配置"><a href="#stream-配置" class="headerlink" title="stream 配置"></a>stream 配置</h2><p>nginx 通过 stream 模块实现了 tcp 代理功能，无需其他软件配合即可实现四层代理和七层代理，即：访问该服务器的指定端口，nginx 就可以充当端口转发的作用将流量导向另一个服务器，同时获取目标服务器的返回数据并返回给请求者。这是一个非常实用的功能。</p>
<p>yum 安装的 nginx ，使用以下命令安装 <code>stream</code> 模块 <sup id="fnref:3"><a href="#fn:3" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Nginx Stream 配置](https://blog.junmoyu.com/posts/linux-nginx-install-stream/)">[3]</span></a></sup></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y nginx-mod-stream</span><br></pre></td></tr></table></figure>
<p><strong>请注意，stream 块和 http 块是两个不同的模块，stream 不属于 http 模块</strong>，即不能放到 <code>/etc/nginx/conf.d/</code>，stream 是通过 tcp 层转发，而不是 http 转发。</p>
<p>如配置在 http 内，启动 nginx 会报如下错误：<br><code>nginx: [emerg] &quot;server&quot; directive is not allowed here</code></p>
<p><code>stream</code> 需要配置在 <code>nginx.conf</code> 中和 <code>http</code> 命令同级的位置。</p>
<figure class="highlight shell"><figcaption><span>nginx.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">load_module /usr/lib64/nginx/modules/ngx_stream_module.so;</span><br><span class="line"></span><br><span class="line">user nginx nginx;</span><br><span class="line">worker_processes  auto;</span><br><span class="line">worker_rlimit_nofile 65535;</span><br><span class="line">pid     conf/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">        use     epoll;</span><br><span class="line">        worker_connections  309600;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">        include     mime.types;</span><br><span class="line">        default_type  application/octet-stream;</span><br><span class="line">        ...</span><br><span class="line">        include     vhosts.d/*.conf;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">stream config.</span></span><br><span class="line">stream &#123;</span><br><span class="line">    log_format proxy &#x27;&#123;time: $time_local|&#x27;</span><br><span class="line">                  &#x27;remote_addr: $remote_addr|&#x27;</span><br><span class="line">				  &#x27;protocol: $protocol|&#x27;</span><br><span class="line">				  &#x27;bytes_sent: $bytes_sent|&#x27;</span><br><span class="line">				  &#x27;bytes_received: $bytes_received|&#x27;</span><br><span class="line">				  &#x27;session_time: $session_time|&#x27;</span><br><span class="line">				  &#x27;upstream_addr: $upstream_addr|&#x27;</span><br><span class="line">				  &#x27;upstream_bytes_sent: $upstream_bytes_sent|&#x27;</span><br><span class="line">				  &#x27;upstream_bytes_received: $upstream_bytes_received|&#x27;</span><br><span class="line">				  &#x27;upstream_connect_time: $upstream_connect_time|&#x27;</span><br><span class="line">				  &#x27;status: $status&#125;&#x27;;</span><br><span class="line">    # tcp/ip proxy</span><br><span class="line">    include /etc/nginx/tcp.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>安装了 <code>nginx-mod-stream</code>，nginx 启动报错：<code>unknown directive &quot;stream&quot;</code>，需要在 <code>nginx.conf</code> 中手动加载模块：<code>load_module /usr/lib64/nginx/modules/ngx_stream_module.so;</code></p>
<p>stream 模块和 http 模块使用独立的日志格式配置，日志格式通过命令 <code>log_format</code> 配置。</p>
<h1 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h1><h2 id="worker-connections-exceed-open-file-resource-limit"><a href="#worker-connections-exceed-open-file-resource-limit" class="headerlink" title="worker_connections exceed open file resource limit"></a>worker_connections exceed open file resource limit</h2><p><strong>问题原因</strong>： <code>worker_rlimit_nofile</code> 的值小于 <code>worker_connections</code> 的值，参数说明可参考 <a href="#%E5%85%A8%E5%B1%80%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE">全局通用配置</a>  </p>
<h2 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h2><h3 id="HTTP-Preflight-Request-说明"><a href="#HTTP-Preflight-Request-说明" class="headerlink" title="HTTP Preflight Request  说明"></a>HTTP Preflight Request  说明</h3><p><strong>HTTP Preflight Request</strong> 是浏览器在发送跨域请求（Cross-Origin Request）时，出于安全考虑，先发送的一种特殊请求。它的目的是确保服务器允许实际的跨域请求。</p>
<p><strong>Preflight Request</strong> 是一个 <code>OPTIONS</code> 请求，由浏览器自动发起，用于检查服务器是否允许实际的跨域请求。它通常在以下情况下触发：</p>
<ul>
<li><p>请求方法不是 <code>GET</code> 、 <code>POST</code> 或 <code>HEAD</code> 。</p>
</li>
<li><p>请求包含自定义的 HTTP 头（如 <code>Authorization</code> 、 <code>Content-Type</code> 等）。</p>
</li>
<li><p>请求的 <code>Content-Type</code> 不是 <code>application/x-www-form-urlencoded</code> 、 <code>multipart/form-data</code>  或 <code>text/plain</code> 。</p>
</li>
</ul>
<p><strong>Preflight Request 的工作流程</strong></p>
<ol>
<li><p><strong>浏览器发送 Preflight Request</strong> ：</p>
<ul>
<li><p>浏览器自动发送一个 <code>OPTIONS</code> 请求到目标服务器。</p>
</li>
<li><p>请求中包含以下头信息：</p>
<ul>
<li><code>Access-Control-Request-Method</code> : 实际请求的 HTTP 方法（如 <code>POST</code> ）。</li>
<li><code>Access-Control-Request-Headers</code> : 实际请求中包含的自定义头（如 <code>d</code> ）。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>服务器响应 Preflight Request</strong> ：</p>
<p> 服务器需要返回以下头信息：  </p>
<ul>
<li><code>Access-Control-Allow-Origin</code> : 允许的源（如 <code>*</code> 或 <code>https://www.gfcat8.com</code> ）。</li>
<li><code>Access-Control-Allow-Methods</code> : 允许的 HTTP 方法（如 <code>GET</code> , <code>POST</code> , <code>OPTIONS</code> ）。</li>
<li><code>Access-Control-Allow-Headers</code> : 允许的自定义头（如 <code>Content-Type</code> , <code>d</code> ）。</li>
<li><code>Access-Control-Max-Age</code> : Preflight 响应的缓存时间（可选）。</li>
</ul>
</li>
<li><p><strong>浏览器检查响应</strong> ：</p>
<ul>
<li><p>如果服务器的响应允许实际请求，浏览器会继续发送实际的请求。</p>
</li>
<li><p>如果服务器的响应不允许实际请求，浏览器会阻止请求并抛出 CORS 错误。</p>
</li>
</ul>
</li>
</ol>
<p><strong>Preflight Request</strong> 配置示例如下：</p>
<figure class="highlight shell"><figcaption><span>nginx/1.24.0</span></figcaption><table><tr><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    if ($request_method = OPTIONS) &#123;</span><br><span class="line">        add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;</span><br><span class="line">        add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET, POST, OPTIONS&#x27;;</span><br><span class="line">        add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Content-Type, d&#x27;;</span><br><span class="line">        return 204;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="Response-to-preflight-request-doesn’t-pass-access-control-check-The-value-of-the-‘Access-Control-Allow-Origin’-header-in-the-response-must-not-be-the-wildcard-‘-’"><a href="#Response-to-preflight-request-doesn’t-pass-access-control-check-The-value-of-the-‘Access-Control-Allow-Origin’-header-in-the-response-must-not-be-the-wildcard-‘-’" class="headerlink" title="Response to preflight request doesn’t pass access control check: The value of the ‘Access-Control-Allow-Origin’ header in the response must not be the wildcard ‘*’"></a>Response to preflight request doesn’t pass access control check: The value of the ‘Access-Control-Allow-Origin’ header in the response must not be the wildcard ‘*’</h3><p><strong>错误场景</strong>：</p>
<p>浏览器访问报跨域错误，nginx 已配置了 <code>add_header Access-Control-Allow-Origin *;</code>，具体报错：<code>Access to XMLHttpRequest at &#39;http://spin-gate.test.com/webhooks/preconfigured&#39; from origin &#39;http://spinnaker.test.com&#39; has been blocked by CORS policy: Response to preflight request doesn&#39;t pass access control check: The value of the &#39;Access-Control-Allow-Origin&#39; header in the response must not be the wildcard &#39;*&#39; when the request&#39;s credentials mode is &#39;include&#39;. The credentials mode of requests initiated by the XMLHttpRequest is controlled by the withCredentials attribute.</code><br><img src="https://i.csms.tech/img_95.png"><br><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS/Errors/CORSNotSupportingCredentials">问题原因及客户端解决方法</a></p>
<h4 id="nginx-服务端解决方法"><a href="#nginx-服务端解决方法" class="headerlink" title="nginx 服务端解决方法"></a>nginx 服务端解决方法</h4><h5 id="nginx-配置允许单个目标跨域"><a href="#nginx-配置允许单个目标跨域" class="headerlink" title="nginx 配置允许单个目标跨域"></a>nginx 配置允许单个目标跨域</h5><p>nginx 配置 <code>add_header Access-Control-Allow-Origin </code> 可以配置允许跨域，此参数只允许配置单个域名或者 <code>*</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">add_header Access-Control-Allow-Origin *;</span></span><br><span class="line">add_header Access-Control-Allow-Origin http://127.0.0.1;</span><br><span class="line">add_header Access-Control-Allow-Methods &#x27;GET, POST, OPTIONS&#x27;;</span><br><span class="line">add_header Access-Control-Allow-Headers &#x27;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization,lang,access-token&#x27;;</span><br></pre></td></tr></table></figure>

<h5 id="nginx-配置允许多个目标跨域"><a href="#nginx-配置允许多个目标跨域" class="headerlink" title="nginx 配置允许多个目标跨域"></a>nginx 配置允许多个目标跨域</h5><p>nginx 配置 <code>add_header Access-Control-Allow-Origin</code> 只能配置一个目标，不能配置多个目标，要使用此指令配置多个目标允许跨域，可参考以下方法</p>
<ul>
<li><p>通过设置变量值解决指定多个域名白名单跨域请求配置</p>
<p>  通过在 nginx 配置中设置变量，来匹配允许跨域的目标，示例代码如下 <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[设置变量解决指定多个域名白名单跨域请求配置](https://www.yidude.com/nginx/100001.html)">[1]</span></a></sup></p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    set $cors_origin &quot;&quot;;</span><br><span class="line">    if ($http_origin ~* &quot;^http://127.0.0.1$&quot;) &#123;</span><br><span class="line">            set $cors_origin $http_origin;</span><br><span class="line">    &#125;</span><br><span class="line">    if ($http_origin ~* &quot;^http://localhost$&quot;) &#123;</span><br><span class="line">            set $cors_origin $http_origin;</span><br><span class="line">    &#125;</span><br><span class="line">    add_header Access-Control-Allow-Origin $cors_origin;</span><br><span class="line">    add_header Access-Control-Allow-Methods GET,POST,PUT,DELETE,OPTIONS;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>通过以上配置，可实现允许 <code>http://127.0.0.1</code>，<code>http://localhost</code> 跨域，如果需要允许其他目标跨域，以此添加配置即可。</p>
</li>
<li><p>使用 <code>map</code> 指令实现 Nginx 允许多个域名跨域</p>
<p>  在 Nginx 中可以使用 <code>map</code> 指令得到一个自定义变量，可以对请求中的 <code>origin</code> 做一个过滤处理，把符合要求的请求域名放到一个变量中，在设置 <code>Access-Control-Allow-Origin</code> 时使用该变量就能实现一个动态的、多个的允许跨域域名，示例配置如下 <sup id="fnref:2"><a href="#fn:2" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[使用 map 实现 Nginx 允许多个域名跨域](https://priesttomb.github.io/%E6%8A%80%E6%9C%AF/2020/10/24/using-map-to-set-multiple-allow-origins-in-nginx/)">[2]</span></a></sup></p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">map $http_origin $allow_origin &#123;</span><br><span class="line">    default &quot;&quot;;</span><br><span class="line">    &quot;~^(https?://localhost(:[0-9]+)?)$&quot; $1;</span><br><span class="line">    &quot;~^(https?://127.0.0.1(:[0-9]+)?)$&quot; $1;</span><br><span class="line">    &quot;~^(https?://172.10(.[\d]+)&#123;2&#125;(:[0-9]+)?)$&quot; $1;</span><br><span class="line">    &quot;~^(https?://192.168(.[\d]+)&#123;2&#125;(:[0-9]+)?)$&quot; $1;</span><br><span class="line">  </span><br><span class="line">    &quot;~http://www.123admin.com&quot; http://www.123admin.com;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       11111;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    location ~ /xxx/xx &#123;</span><br><span class="line">        if ($request_method = &#x27;OPTIONS&#x27;) &#123;</span><br><span class="line">            return 204;</span><br><span class="line">        &#125;</span><br><span class="line">        add_header Access-Control-Allow-Origin $allow_origin;</span><br><span class="line">        add_header Access-Control-Allow-Methods &#x27;GET, POST, OPTIONS&#x27;;</span><br><span class="line">        add_header Access-Control-Allow-Headers &#x27;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization&#x27;;</span><br><span class="line">        add_header Access-Control-Allow-Credentials &#x27;true&#x27;;</span><br><span class="line">        proxy_pass http://1.2.3.4:5678;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  解释说明：</p>
<ul>
<li><p><code>$http_origin</code> 是 Nginx 的内部变量，用于获取请求头中的 <code>origin</code></p>
</li>
<li><p><code>$allow_origin</code> 是可以自定义的变量名，用于接收 <code>map</code> 返回的值</p>
</li>
<li><p><code>$1</code> 是 Nginx 对 PCRE 中关于后向引用和子组的兼容，用于获取匹配字符串的整个部分，并返回给 <code>$allow_origin</code></p>
</li>
</ul>
</li>
</ul>
<h2 id="Nginx-配置-ssl-时未指定-ssl"><a href="#Nginx-配置-ssl-时未指定-ssl" class="headerlink" title="Nginx 配置 ssl 时未指定 ssl"></a>Nginx 配置 ssl 时未指定 ssl</h2><p>nginx 如下的 server 配置：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen 443;</span><br><span class="line">        server_name test.com;</span><br><span class="line">      </span><br><span class="line">        ssl_certificate test.com.pem;       </span><br><span class="line">        ssl_certificate_key test.com.pem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过浏览器访问 https 协议，报错： <code>This site can’t provide a secure connection</code> ，<code>ERR_SSL_PROTOCOL_ERROR</code></p>
<p>使用 <code>curl</code> 命令访问报错： </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">* NSS error -12263 (SSL_ERROR_RX_RECORD_TOO_LONG)</span><br><span class="line">* SSL received a record that exceeded the maximum permissible length.</span><br><span class="line">* Closing connection 0</span><br><span class="line">curl: (35) SSL received a record that exceeded the maximum permissible length.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改配置：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen 443 ssl;</span><br><span class="line">        server_name test.com;</span><br><span class="line">      </span><br><span class="line">        ssl_certificate test.com.pem;       </span><br><span class="line">        ssl_certificate_key test.com.pem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="nginx-service-failed-to-run-‘start-pre’-task-Permission-denied"><a href="#nginx-service-failed-to-run-‘start-pre’-task-Permission-denied" class="headerlink" title="nginx.service failed to run ‘start-pre’ task: Permission denied"></a>nginx.service failed to run ‘start-pre’ task: Permission denied</h2><p>Nginx 服务启动失败，启动报错输出及服务日志如下，启动错误关键信息 <code>because a configured resource limit was exceeded.</code>，<code>nginx.service failed to run &#39;start-pre&#39; task: Permission denied</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemctl start nginx</span></span><br><span class="line">Job for nginx.service failed because a configured resource limit was exceeded. See &quot;systemctl status nginx.service&quot; and &quot;journalctl -xe&quot; for details.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">journalctl -xe -u nginx</span></span><br><span class="line">-- Unit nginx.service has failed.</span><br><span class="line">-- </span><br><span class="line">-- The result is failed.</span><br><span class="line">systemd[1]: nginx.service failed.</span><br><span class="line">systemd[1]: nginx.service failed to run &#x27;start-pre&#x27; task: Permission denied</span><br><span class="line">systemd[1]: Failed to start nginx - high performance web server.</span><br><span class="line">-- Subject: Unit nginx.service has failed</span><br><span class="line">-- Defined-By: systemd</span><br><span class="line">-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel</span><br><span class="line">-- </span><br><span class="line">-- Unit nginx.service has failed.</span><br><span class="line">-- </span><br><span class="line">-- The result is failed.</span><br></pre></td></tr></table></figure>

<p>根据日志信息显示，主要问题出在 <code>Permission denied</code>，为定位到具体的权限被拒绝的文件路径，检查 Nginx 日志</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> nginx.conf</span> </span><br><span class="line"></span><br><span class="line">google_perftools_profiles /tmp/tcmalloc;</span><br><span class="line"></span><br><span class="line">error_log	/home/logs/nginx/error/error.log crit;</span><br></pre></td></tr></table></figure>
<p>查看日志 <code>/home/logs/nginx/error/error.log</code> 输出内容，显示 <code>/tmp/tcmalloc</code> 权限被拒绝。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">tail</span> /home/logs/nginx/error/error.log</span></span><br><span class="line">[crit] 12923#0: ProfilerStart(/tmp/tcmalloc.12923) failed (13: Permission denied)</span><br><span class="line">[crit] 12935#0: ProfilerStart(/tmp/tcmalloc.12935) failed (13: Permission denied)</span><br><span class="line">[crit] 12920#0: ProfilerStart(/tmp/tcmalloc.12920) failed (13: Permission denied)</span><br><span class="line">[crit] 12929#0: ProfilerStart(/tmp/tcmalloc.12929) failed (13: Permission denied)</span><br><span class="line">[crit] 12933#0: ProfilerStart(/tmp/tcmalloc.12933) failed (13: Permission denied)</span><br><span class="line">[crit] 12927#0: ProfilerStart(/tmp/tcmalloc.12927) failed (13: Permission denied)</span><br><span class="line">[crit] 12922#0: ProfilerStart(/tmp/tcmalloc.12922) failed (13: Permission denied)</span><br><span class="line">[crit] 12925#0: ProfilerStart(/tmp/tcmalloc.12925) failed (13: Permission denied)</span><br><span class="line">[crit] 12937#0: ProfilerStart(/tmp/tcmalloc.12937) failed (13: Permission denied)</span><br><span class="line">[crit] 12921#0: ProfilerStart(/tmp/tcmalloc.12921) failed (13: Permission denied)</span><br></pre></td></tr></table></figure>

<p>检查 <code>/tmp</code> 路径权限，结果为 <code>777</code>，再检查特殊权限，看到 <code>/tmp</code> 目录被加了 <code>i</code> 权限（<code>immutable</code>），表示此目录不可更改</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ll /</span></span><br><span class="line">...</span><br><span class="line">drwxrwxrwt.  20 root root  4096 Feb  1 13:18 tmp</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lsattr /</span></span><br><span class="line">...</span><br><span class="line">----i----------- /tmp</span><br><span class="line">---------------- /usr</span><br></pre></td></tr></table></figure>
<p>删除 <code>/tmp</code> 目录的 <code>i</code>(immutable) 特殊权限后重启 Nginx 服务正常</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">chattr -R -i /tmp/</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lsattr /</span></span><br><span class="line">...</span><br><span class="line">---------------- /var</span><br><span class="line">---------------- /tmp</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemctl start nginx</span></span><br></pre></td></tr></table></figure>

<h2 id="静态文件加载正常，web-页面未展示样式"><a href="#静态文件加载正常，web-页面未展示样式" class="headerlink" title="静态文件加载正常，web 页面未展示样式"></a>静态文件加载正常，web 页面未展示样式</h2><p>使用 Nginx 服务器作为 Web 服务器，浏览器请求 Web 页面后，所有的资源请求都正常，但是 Web 页面上的样式并未渲染，检查静态文件（CSS，JS 等）都正常加载<br><img src="https://i.csms.tech/img_231.png"></p>
<p>在浏览器上单独请求静态文件（如 js 文件）会直接下载静态文件，而不是展示静态文件内容。正常请求静态文件是要展示静态文件的内容。至此可以确定是 <em><strong>因为 Nginx 响应中未包含文件解析类型导致浏览器不知道文件扩展名和相应的 MIME 类型之间的映射关系</strong></em>。此功能主要由 MIME（Multipurpose Internet Mail Extensions）指示文件的内容类型。出现此问题主要就是因为 Nginx 未正确配置 <code>mime.types</code>.</p>
<p>检查 Nginx 配置文件，发现配置中未包含 <code>mime.types</code> 配置，因此在 Nginx 配置中添加以下配置来解决此问题</p>
<figure class="highlight shell"><figcaption><span>nginx.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">...</span><br><span class="line">include mime.types;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启 Nginx 服务，清空缓存后，再次请求，页面展示正常。</p>
<h2 id="nginx-反代-wordpress-使用-HTTPS-时一直重复重定向"><a href="#nginx-反代-wordpress-使用-HTTPS-时一直重复重定向" class="headerlink" title="nginx 反代 wordpress 使用 HTTPS 时一直重复重定向"></a>nginx 反代 wordpress 使用 HTTPS 时一直重复重定向</h2><p><strong>循环重定向，应该是因为 Wordpress 认为这个请求是来自 HTTP 的，所以尝试重定向到 HTTPS，导致了循环</strong> 。在 CDN 使用 HTTPS 加速并且回源使用 HTTP 协议，而服务器配置了后台站点为 HTTPS，此时会出现此问题。可以采用以下解决方法之一</p>
<ul>
<li>在 Nginx 反代服务器上添加配置 <code>fastcgi_param  HTTPS on;</code>  <sup id="fnref:5"><a href="#fn:5" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[nginx ssl 反向代理wordpress重定向错误](https://groups.google.com/g/ustc_lug/c/stdn8ootM0U?pli=1)">[5]</span></a></sup></li>
<li>Wordpress 后台站点配置使用 HTTP 协议。</li>
</ul>
<h2 id="nginx-服务-reload-失败"><a href="#nginx-服务-reload-失败" class="headerlink" title="nginx 服务 reload 失败"></a>nginx 服务 reload 失败</h2><p>执行 <code>systemctl restart nginx</code> 时执行成功，执行 <code>systemctl reload nginx</code> 报错：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemctl reload nginx</span></span><br><span class="line">Job for nginx.service failed because the control process exited with error code. See &quot;systemctl status nginx.service&quot; and &quot;journalctl -xe&quot; for details.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">journalctl -u nginx</span></span><br><span class="line">Feb 12 13:18:12 nginx systemd[1]: Reloading nginx - high performance web server.</span><br><span class="line">Feb 12 13:18:12 nginx nginx[4677]: nginx: [alert] kill(13084, 1) failed (3: No such process)</span><br><span class="line">Feb 12 13:18:12 nginx systemd[1]: nginx.service: control process exited, code=exited status=1</span><br><span class="line">Feb 12 13:18:12 nginx systemd[1]: Reload failed for nginx - high performance web server.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /usr/lib/systemd/system/nginx.service</span></span><br><span class="line">[Unit] </span><br><span class="line">Description=nginx - high performance web server </span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Service] </span><br><span class="line">Type=forking </span><br><span class="line">PIDFile=/usr/local/nginx-1.24.0/conf/nginx.pid </span><br><span class="line">ExecStartPre=/usr/local/nginx-1.24.0/sbin/nginx -t -c /usr/local/nginx-1.24.0/conf/nginx.conf </span><br><span class="line">ExecStart=/usr/local/nginx-1.24.0/sbin/nginx -c /usr/local/nginx-1.24.0/conf/nginx.conf </span><br><span class="line">ExecReload=/usr/local/nginx-1.24.0/sbin/nginx -s reload </span><br><span class="line">ExecStop=/usr/local/nginx-1.24.0/sbin/nginx -s stop </span><br><span class="line">ExecQuit=/usr/local/nginx-1.24.0/sbin/nginx -s quit </span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Install] </span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>根据报错日志信息： <code>nginx: [alert] kill(13084, 1) failed (3: No such process)</code> 可知，是由于 <code>reload</code> 时无法找到 <code>pid</code> 文件导致，需要检查 <code>pid</code> 文件是否存在</p>
<h1 id="Nginx-常见用法配置示例"><a href="#Nginx-常见用法配置示例" class="headerlink" title="Nginx 常见用法配置示例"></a>Nginx 常见用法配置示例</h1><h2 id="Nginx-反代-FTP-服务"><a href="#Nginx-反代-FTP-服务" class="headerlink" title="Nginx 反代 FTP 服务"></a>Nginx 反代 FTP 服务</h2><p>Nginx 代理 TCP 端口需要使用 <code>stream</code> 模块 <sup id="fnref:4"><a href="#fn:4" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[nginx 代理 ftp 端口，实现文件传输](https://blog.csdn.net/MarshalEagle/article/details/120334328)">[4]</span></a></sup></p>
<p>示例配置前提：</p>
<ul>
<li>FTP 服务器使用 <strong>被动模式</strong> (<a href="/202207231311/" title="vsftpd 服务常用配置说明">vsftpd 服务常用配置说明</a>)</li>
<li>FTP 命令传输端口为 21</li>
<li>FTP 数据传输端口范围为 11001 - 11004</li>
</ul>
<p>nginx 配置文件 <code>nginx.conf</code> 中和  <code>http</code> 模块同级的位置添加 <code>stream</code> 配置</p>
<figure class="highlight shell"><figcaption><span>nginx.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">FTP 的命令端口（21）代理配置</span></span><br><span class="line">  server &#123;</span><br><span class="line">          listen 21 ;</span><br><span class="line">          proxy_pass ftp_server;</span><br><span class="line">          proxy_connect_timeout 60s;</span><br><span class="line">          proxy_timeout 60m;</span><br><span class="line">      &#125;</span><br><span class="line">  upstream ftp_server&#123;</span><br><span class="line">         hash $remote_addr consistent;</span><br><span class="line">         server 192.168.1.2:21;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">FTP 的数据传输端口（11001 - 11004 ）代理配置</span></span><br><span class="line">  server &#123;</span><br><span class="line">      listen 11001;</span><br><span class="line">      proxy_pass ftp_trans_data_port1;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  upstream ftp_trans_data_port1 &#123;</span><br><span class="line">      hash $remote_addr consistent;</span><br><span class="line">      server 192.168.1.2:11001;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  server &#123;</span><br><span class="line">      listen 11002;</span><br><span class="line">      proxy_pass ftp_trans_data_port2;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  upstream ftp_trans_data_port2 &#123;</span><br><span class="line">      hash $remote_addr consistent;</span><br><span class="line">      server 192.168.1.2:11002;</span><br><span class="line">  &#125;</span><br><span class="line">  server &#123;</span><br><span class="line">      listen 11003;</span><br><span class="line">      proxy_pass ftp_trans_data_port3;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  upstream ftp_trans_data_port3 &#123;</span><br><span class="line">      hash $remote_addr consistent;</span><br><span class="line">      server 192.168.1.2:11003;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  server &#123;</span><br><span class="line">      listen 11004;</span><br><span class="line">      proxy_pass ftp_trans_data_port4;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  upstream ftp_trans_data_port4 &#123;</span><br><span class="line">      hash $remote_addr consistent;</span><br><span class="line">      server 192.168.1.2:11004;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>整个工作流程大体如下：<br><img src="https://i.csms.tech/img_124.png"></p>
<p><strong>特殊情况说明</strong></p>
<blockquote>
<p>因为 FTP 协议的原因，如果在同一个 Nginx 中要反代多台 FTP 服务器，那么 FTP 服务使用的数据传输端口（被动模式下）不能相同，因为 Nginx 不能重复监听相同的端口。</p>
<p>此种情况下（同一个 Nginx 要反代多台有相同数据传输端口的 FTP 服务），可以将后端 FTP 服务加到同一个 upstream 中，然后 nginx 监听数据传输端口，此时存在的问题是 <strong>如果后端的 2 台或多台 FTP 同时使用了相同的数据传输端口，可能会导致客户端的数据连接被反代到错误的 FTP 服务器</strong></p>
</blockquote>
<p>此种特殊情况下的具体工作流程：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line"></span><br><span class="line">      # ftp 命令(控制)端口</span><br><span class="line">      server &#123;</span><br><span class="line">          listen 21;                          </span><br><span class="line">          proxy_pass ftp1;</span><br><span class="line">      &#125;</span><br><span class="line">      upstream ftp1&#123;</span><br><span class="line">          hash $remote_addr consistent;</span><br><span class="line">          server 192.168.1.2:11000;</span><br><span class="line">          server 192.168.1.3:11000;</span><br><span class="line">      &#125;</span><br><span class="line">      # ftp 数据传输端口,ftp 服务配置为被动模式,数据传输端口 11001-11003</span><br><span class="line">      server &#123;</span><br><span class="line">          listen 11001;</span><br><span class="line">          proxy_pass ftp_data_port1;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      upstream ftp_data_port1 &#123;</span><br><span class="line">          hash $remote_addr consistent;</span><br><span class="line">          server 192.168.1.2:11001;</span><br><span class="line">          server 192.168.1.3:11001;</span><br><span class="line">      &#125;</span><br><span class="line">	  </span><br><span class="line">	  server &#123;</span><br><span class="line">          listen 11002;</span><br><span class="line">          proxy_pass ftp_data_port2;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      upstream ftp_data_port2 &#123;</span><br><span class="line">          hash $remote_addr consistent;</span><br><span class="line">          server 192.168.1.2:11002;</span><br><span class="line">          server 192.168.1.3:11002;</span><br><span class="line">      &#125;</span><br><span class="line">	  server &#123;</span><br><span class="line">          listen 11003;</span><br><span class="line">          proxy_pass ftp_data_port3;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      upstream ftp_data_port3 &#123;</span><br><span class="line">          hash $remote_addr consistent;</span><br><span class="line">          server 192.168.1.2:11003;</span><br><span class="line">          server 192.168.1.3:11003;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.csms.tech/img_125.png"></p>
<p> 此种配置下可能出现以下几种情况(假定后端 FTP 服务器分别为 A 和 B)：</p>
<ol>
<li><p>第 2 步中，假如 <strong>Nginx 选择了后端 FTP 服务器 A</strong>，并将控制请求转发到了 A.，ftp A 和客户端协商使用 11003 端口进行数据传输。</p>
<p> 客户端收到控制面的响应后，发起和 FTP 服务的 11003 的数据传输请求， 请求到了 Nginx 服务器，Nginx 通过 11003 端口的配置，在 upstream 中<strong>选择了后端的 A 服务器</strong>，并将请求转发到了服务器 A，A 已经监听了此端口，可以正常完成数据传输。</p>
</li>
<li><p>第 2 步中，假如 <strong>Nginx 选择了后端 FTP 服务器 A</strong>，并将控制请求转发到了 A.，ftp A 和客户端协商使用 11003 端口进行数据传输。</p>
<p>  客户端收到控制面的响应后，发起和 FTP 服务的 11003 的数据传输请求， 请求到了 Nginx 服务器，Nginx 通过 11003 端口的配置，在 upstream 中<strong>选择了后端的 B 服务器</strong>，并将请求转发到 B 服务器，<strong>假如 B 服务器未监听此端口（因为此次请求之前的控制面是由 A处理，B 并未参与），后端未响应</strong>，此时 Nginx 会将请求转发到 A 服务器，正常完成数据传输</p>
</li>
<li><p>第 2 步中，假如 <strong>Nginx 选择了后端 FTP 服务器 A</strong>，并将控制请求转发到了 A，ftp A 和客户端协商使用 11003 端口进行数据传输。</p>
<p> 客户端收到控制面的响应后，发起和 FTP 服务的 11003 的数据传输请求， 请求到了 Nginx 服务器，Nginx 通过 11003 端口的配置，在 upstream 中<strong>选择了后端的 B 服务器</strong>，并将请求转发到 B 服务器，<strong>假如 B 服务器也监听了此端口（例如代理到 B 服务器得 FTP 控制端响应中,也和客户端协商了使用 11003 端口进行数据传输），Nginx 和后端 FTP 的 11003 端口可以建立连接</strong>，但是因为鉴权等原因,FTP 服务器会返回传输失败信息给客户端.此时虽然完整的建立了整个流程中的连接,但是<strong>数据传输最终失败</strong>.</p>
</li>
</ol>
<h2 id="Nginx-反代-Rancher"><a href="#Nginx-反代-Rancher" class="headerlink" title="Nginx 反代 Rancher"></a>Nginx 反代 Rancher</h2><a href="/202210071716/" title="Rancher 安装及使用">Rancher 安装及使用</a>

<h2 id="Nginx-反代-OpenVPN-服务"><a href="#Nginx-反代-OpenVPN-服务" class="headerlink" title="Nginx 反代 OpenVPN 服务"></a>Nginx 反代 OpenVPN 服务</h2><p>使用 Nginx stream 模块可以实现 Nginx 反代 OpenVPN 的流量，但是连接 VPN 之后，客户端显示的 IP 依然为 OpenVPN 服务端 IP。</p>
<figure class="highlight python"><figcaption><span>nginx.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">    log_format proxy <span class="string">&#x27;&#123;time: $time_local|&#x27;</span></span><br><span class="line">                  <span class="string">&#x27;remote_addr: $remote_addr|&#x27;</span></span><br><span class="line">				  <span class="string">&#x27;protocol: $protocol|&#x27;</span></span><br><span class="line">				  <span class="string">&#x27;bytes_sent: $bytes_sent|&#x27;</span></span><br><span class="line">				  <span class="string">&#x27;bytes_received: $bytes_received|&#x27;</span></span><br><span class="line">				  <span class="string">&#x27;session_time: $session_time|&#x27;</span></span><br><span class="line">				  <span class="string">&#x27;upstream_addr: $upstream_addr|&#x27;</span></span><br><span class="line">				  <span class="string">&#x27;upstream_bytes_sent: $upstream_bytes_sent|&#x27;</span></span><br><span class="line">				  <span class="string">&#x27;upstream_bytes_received: $upstream_bytes_received|&#x27;</span></span><br><span class="line">				  <span class="string">&#x27;upstream_connect_time: $upstream_connect_time|&#x27;</span></span><br><span class="line">				  <span class="string">&#x27;status: $status&#x27;</span>;</span><br><span class="line">	access_log /home/logs/nginx/access/vpn_proxy.access proxy;</span><br><span class="line">	</span><br><span class="line">	server &#123;</span><br><span class="line">		listen <span class="number">1194</span>;</span><br><span class="line">		proxy_pass <span class="number">13.52</span><span class="number">.72</span><span class="number">.24</span>:<span class="number">1194</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://i.csms.tech/img_129.png"></p>
<h2 id="Nginx-if-实现与或操作"><a href="#Nginx-if-实现与或操作" class="headerlink" title="Nginx if 实现与或操作"></a>Nginx if 实现与或操作</h2><p>Nginx 不支持 <code>if</code> 语句中使用逻辑 <code>&amp;&amp;</code> <code>||</code> 运算，而且不支持 <code>if</code> 的嵌套语法。要实现 <code>if</code> 中的 <em>与</em> 和 <em>或</em> 操作，可以使用下面的方法实现</p>
<figure class="highlight shell"><figcaption><span>server.conf</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">set $flag 0;</span><br><span class="line"></span><br><span class="line">if ($host = &quot;test.domain.com&quot;)</span><br><span class="line">&#123;</span><br><span class="line">    set $flag &quot;$&#123;flag&#125;1&quot;;   </span><br><span class="line">&#125;</span><br><span class="line">if ($remote_addr = 1.1.1.1) </span><br><span class="line">&#123;</span><br><span class="line">    set $flag &quot;$&#123;flag&#125;1&quot;;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>经过以上条件判断：</p>
<ul>
<li>如果 <strong>既满足</strong> 第一个条件， <strong>又满足</strong> 第二个条件，则 <code>$flag = 011</code></li>
<li>如果 <strong>满足</strong> 第一个条件， <strong>不满足</strong> 第二个条件，则 <code>$flag = 01</code></li>
<li>如果 <strong>不满足</strong> 第一个条件， <strong>满足</strong> 第二个条件，则 <code>$flag = 01</code></li>
<li>如果 2 个条件都 <strong>不满足</strong> ，则 <code>$flag = 0</code></li>
</ul>
<p>在此基础上，要实现 <strong>与或</strong> 操作，示例如下</p>
<figure class="highlight shell"><figcaption><span>server.conf</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">与操作</span></span><br><span class="line">if ($flag = &quot;011&quot;) &#123;return 200;&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或操作</span></span><br><span class="line">if ($flag = &quot;01&quot;) &#123;return 200;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h1><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://www.yidude.com/nginx/100001.html">设置变量解决指定多个域名白名单跨域请求配置</a><a href="#fnref:1" rev="footnote"> ↩</a></span></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">2.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://priesttomb.github.io/%E6%8A%80%E6%9C%AF/2020/10/24/using-map-to-set-multiple-allow-origins-in-nginx/">使用 map 实现 Nginx 允许多个域名跨域</a><a href="#fnref:2" rev="footnote"> ↩</a></span></li><li id="fn:3"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">3.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://blog.junmoyu.com/posts/linux-nginx-install-stream/">Nginx Stream 配置</a><a href="#fnref:3" rev="footnote"> ↩</a></span></li><li id="fn:4"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">4.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://blog.csdn.net/MarshalEagle/article/details/120334328">nginx 代理 ftp 端口，实现文件传输</a><a href="#fnref:4" rev="footnote"> ↩</a></span></li><li id="fn:5"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">5.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://groups.google.com/g/ustc_lug/c/stdn8ootM0U?pli=1">nginx ssl 反向代理wordpress重定向错误</a><a href="#fnref:5" rev="footnote"> ↩</a></span></li></ol></div></div>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="../tags/Linux/" rel="tag"><i class="fa fa-tag"></i> Linux</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="../202207261304/" rel="prev" title="vsftpd 服务常见错误">
                  <i class="fa fa-chevron-left"></i> vsftpd 服务常见错误
                </a>
            </div>
            <div class="post-nav-item">
                <a href="../202207271506/" rel="next" title="predixy 安装配置">
                  predixy 安装配置 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">COSMOS</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="300" alpha="0.3" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="../js/comments.js"></script><script src="../js/utils.js"></script><script src="../js/motion.js"></script><script src="../js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="../js/third-party/search/local-search.js"></script>




  <script src="../js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"fl9999","repo":"fl9999.github.io","client_id":"a11bf6f7860762b725b5","client_secret":"a99046105f8bddc72ec718d54dc3fd7f22070821","admin_user":"fl9999","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"d41d8cd98f00b204e9800998ecf8427e"}</script>
<script src="../js/third-party/comments/gitalk.js"></script>

</body>
</html>
