<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16-next.png">
  <link rel="mask-icon" href="../images/logo.svg" color="#222">

<link rel="stylesheet" href="../css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"csms.tech","root":"/","images":"../images","scheme":"Gemini","darkmode":true,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeIn","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"../search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="../js/config.js"></script>

    <meta name="description" content="sysctl 控制参数下表列出一些常见的 Linux （Kernel 5.3）内存相关的调节参数，具体参数根据内核版本可能有所不同，其使用场景和含义需要查看对应内核版本的相关文档    Option Default Value Description Examples    vm.dirty_background_bytes&#x2F;proc&#x2F;sys&#x2F;vm&#x2F;dirty_background_bytes 0">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux 内存控制参数汇总">
<meta property="og:url" content="http://csms.tech/20250128162840/index.html">
<meta property="og:site_name" content="L B T">
<meta property="og:description" content="sysctl 控制参数下表列出一些常见的 Linux （Kernel 5.3）内存相关的调节参数，具体参数根据内核版本可能有所不同，其使用场景和含义需要查看对应内核版本的相关文档    Option Default Value Description Examples    vm.dirty_background_bytes&#x2F;proc&#x2F;sys&#x2F;vm&#x2F;dirty_background_bytes 0">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-01-28T08:01:00.000Z">
<meta property="article:modified_time" content="2025-01-28T08:01:00.000Z">
<meta property="article:author" content="COSMOS">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://csms.tech/20250128162840/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://csms.tech/20250128162840/","path":"20250128162840/","title":"Linux 内存控制参数汇总"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Linux 内存控制参数汇总 | L B T</title>
  








  <noscript>
    <link rel="stylesheet" href="../css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">L B T</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记 录 过 去 的 经 验</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="../index.html" rel="section"><i class="fa fa-earth-americas fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="../categories/" rel="section"><i class="fa fa-folder-tree fa-fw"></i>总目录<span class="badge">53</span></a></li><li class="menu-item menu-item-linux"><a href="../categories/Linux" rel="section"><i class="fa fa-brands fa-linux fa-fw"></i>Linux</a></li><li class="menu-item menu-item-python"><a href="../categories/Python" rel="section"><i class="fa fa-brands fa-python fa-fw"></i>Python</a></li><li class="menu-item menu-item-docker"><a href="../categories/Docker" rel="section"><i class="fa fa-brands fa-docker fa-fw"></i>Docker</a></li><li class="menu-item menu-item-kubernetes"><a href="../categories/Kubernetes" rel="section"><i class="fa fa-dharmachakra fa-fw"></i>Kubernetes</a></li><li class="menu-item menu-item-tags"><a href="../tags/" rel="section"><i class="fa fa-tornado fa-fw"></i>标签<span class="badge">78</span></a></li><li class="menu-item menu-item-archives"><a href="../archives/" rel="section"><i class="fa fa-rectangle-list fa-fw"></i>列表<span class="badge">270</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章总目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#sysctl-%E6%8E%A7%E5%88%B6%E5%8F%82%E6%95%B0"><span class="nav-number">1.</span> <span class="nav-text">sysctl 控制参数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#vm-watermark-scale-factor"><span class="nav-number">1.1.</span> <span class="nav-text">vm.watermark_scale_factor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vm-percpu-pagelist-high-fraction"><span class="nav-number">1.2.</span> <span class="nav-text">vm.percpu_pagelist_high_fraction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux-%E5%86%85%E5%AD%98-Overcommit-%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.3.</span> <span class="nav-text">Linux 内存 Overcommit 机制详解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vfs-cache-pressure"><span class="nav-number">1.4.</span> <span class="nav-text">vfs_cache_pressure</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#compact-memory"><span class="nav-number">1.5.</span> <span class="nav-text">compact_memory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OOM"><span class="nav-number">1.6.</span> <span class="nav-text">OOM</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">COSMOS</p>
  <div class="site-description" itemprop="description">得 能 莫 忘</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="../archives/">
          <span class="site-state-item-count">270</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="../categories/">
        <span class="site-state-item-count">53</span>
        <span class="site-state-item-name">目录</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="../tags/">
        <span class="site-state-item-count">78</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/20250128162840/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Linux 内存控制参数汇总 | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux 内存控制参数汇总
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-01-28 16:01:00" itemprop="dateCreated datePublished" datetime="2025-01-28T16:01:00+08:00">2025-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="sysctl-控制参数"><a href="#sysctl-控制参数" class="headerlink" title="sysctl 控制参数"></a>sysctl 控制参数</h1><p>下表列出一些常见的 Linux （Kernel 5.3）内存相关的调节参数，具体参数根据内核版本可能有所不同，其使用场景和含义需要查看对应内核版本的相关文档</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Default Value</th>
<th>Description</th>
<th>Examples</th>
</tr>
</thead>
<tbody><tr>
<td><code>vm.dirty_background_bytes</code><br/><code>/proc/sys/vm/dirty_background_bytes</code></td>
<td>0 bytes</td>
<td><code>0</code>  表示使用 <code>vm.dirty_background_ratio</code> 来决定将内存脏页(Memroy Dirty Pages)写回磁盘的阈值而不是使用 <code>vm.dirty_background_bytes</code> <br/>- <strong>设置为相对较高的值，会使内存中的数据延迟写入磁盘，产生较小的 IOPS，但是可能会导致数据不一致或丢失</strong> <br/>- <strong>设置为相对较低的值，会使内存数据及时写入磁盘，导致 IOPS 较高，数据丢失或不一致的风险较低</strong></td>
<td></td>
</tr>
<tr>
<td><code>vm.dirty_background_ratio</code><br/><code>/proc/sys/vm/dirty_background_ratio</code></td>
<td>10</td>
<td>默认当内存脏页数据达到内存大小的 10% 时，在后台触发 <code>per-bdi writeback</code>（Linux 早期（Linux 内核 3.0 之前）由 <code>pdflush</code> 负责处理脏页（dirty pages）写回磁盘的机制）将脏页数据写回磁盘。回写（Write-Back）操作由统一的内核线程 <code>kworker</code> 或 <code>flush-&lt;设备名&gt;</code> 处理</td>
<td></td>
</tr>
<tr>
<td><code>vm.dirty_bytes</code><br/><code>/proc/sys/vm/dirty_bytes</code></td>
<td>0 bytes</td>
<td>定义强制写回的脏页阈值（以字节为单位）。</td>
<td></td>
</tr>
<tr>
<td><code>vm.dirty_ratio</code><br/><code>/proc/sys/vm/dirty_ratio</code></td>
<td>20</td>
<td>定义强制写回的脏页阈值（以总内存的百分比表示）。</td>
<td></td>
</tr>
<tr>
<td><code>vm.dirty_writeback_centisecs</code><br/><code>/proc/sys/vm/dirty_writeback_centisecs</code></td>
<td>500</td>
<td>定义写回线程的执行间隔（以百分之一秒为单位）。</td>
<td></td>
</tr>
<tr>
<td><code>vm.dirty_expire_centisecs</code>      <br/><code>/proc/sys/vm/dirty_expire_centisecs</code></td>
<td>3000</td>
<td>定义脏页的最大“年龄”（超过这个时间的脏页会被优先写回）。<br/><strong>如需手动执行写回操作，可以使用命令 <code>sync</code></strong></td>
<td></td>
</tr>
<tr>
<td><code>vm.min_free_kbytes</code> <br/><code>/proc/sys/vm/min_free_kbytes</code></td>
<td>通常为 <code>min_free_kbytes = sqrt(总内存 * 16)</code></td>
<td><strong>控制系统保留的最小空闲内存量（以 KB 为单位），确保系统在内存压力下仍有足够的内存用于关键操作，如处理中断、内核操作等。</strong> <br/> <strong>如果设置过小</strong> <br/>- 系统可能在内存紧张时无法及时回收内存，导致性能下降。<br/>- 网络流量或 I&#x2F;O 密集型任务可能因内存分配失败而中断。<br/>- 可能增加系统触发 OOM（Out-Of-Memory）的风险。 <br/> <strong>如果设置过大</strong> ：<br/>- 系统可用内存减少，因为更多内存被预留。<br/>- 可能导致用户空间任务频繁触发内存回收，降低整体性能。</td>
<td></td>
</tr>
<tr>
<td><code>vm.watermark_scale_factor</code><br/><code>/proc/sys/vm/watermark_scale_factor</code></td>
<td>10</td>
<td>内核的内存水位标记（ <code>watermarks</code> ）机制</td>
<td></td>
</tr>
<tr>
<td><code>vm.watermark_boost_factor</code><br/><code>/proc/sys/vm/watermark_boost_factor</code></td>
<td>15000</td>
<td>在内存压力下临时提升水位，保证一定的空闲内存。</td>
<td></td>
</tr>
<tr>
<td><code>vm.percpu_pagelist_high_fraction</code><br/><code>/proc/sys/vm/percpu_pagelist_high_fraction</code></td>
<td>0</td>
<td><a href="#vm-percpu-pagelist-high-fraction">vm.percpu_pagelist_high_fraction</a></td>
<td></td>
</tr>
<tr>
<td><code>vm.overcommit_memory</code><br/><code>/proc/sys/vm/overcommit_memory</code><br/><code>vm.overcommit_ratio</code><br/><code>vm.overcommit_kbytes</code></td>
<td></td>
<td><a href="#Linux-%E5%86%85%E5%AD%98-Overcommit-%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3">Linux 内存 Overcommit 机制详解</a></td>
<td></td>
</tr>
<tr>
<td><code>vm.swappiness</code><br/><code>/proc/sys/vm/swappiness</code></td>
<td>60</td>
<td>控制 <strong>内核在内存不足前主动使用 Swap 的程度</strong> ，取值范围： <code>0 - 100</code> 。<br/>- <code>0</code> ： 尽可能 <strong>不使用 Swap</strong> ，只有在内存耗尽时才使用（适合数据库、低延迟应用）。<br/>- <code>100</code> ： 尽可能 <strong>频繁使用 Swap（适合桌面系统）</strong> 。</td>
<td></td>
</tr>
<tr>
<td><code>vm.vfs_cache_pressure</code></td>
<td>100</td>
<td><a href="#vfs-cache-pressure">vm.vfs_cache_pressure</a></td>
<td></td>
</tr>
<tr>
<td><code>vm.admin_reserve_kbytes</code><br/><code>/proc/sys/vm/admin_reserve_kbytes</code></td>
<td>3% Free Pages</td>
<td>为系统管理员保留一定量的内存，以防止在内存紧张时关键的管理任务（如登录、执行命令等）无法正常运行。这部分内存不会被普通用户进程占用，即使在系统内存紧张时也会保留。</td>
<td></td>
</tr>
<tr>
<td><code>memory_failure_early_kill</code><br/><code>/proc/sys/vm/memory_failure_early_kill</code></td>
<td>0</td>
<td>用于控制在发生内存故障时，系统是否立即将有问题的内存页标记为不可用，并杀死访问该内存的进程。<br/>- <strong>默认值是 0</strong> ，表示不立即杀死进程。 <br/>- <strong>启用后（值为 1）</strong> 当检测到内存错误时，系统会尽早杀死访问该内存的进程，以避免更多的系统崩溃或错误发生。</td>
<td></td>
</tr>
<tr>
<td><code>memory_failure_recovery</code><br/><code>/proc/sys/vm/memory_failure_recovery</code></td>
<td>1</td>
<td>当检测到内存故障时，系统可以尝试 <strong>恢复错误的内存页</strong> 。<br/>- <strong>默认值是 1</strong> ，表示启用内存恢复机制。<br/>- <strong>禁用后（值为 0）</strong> ： 系统不尝试恢复内存错误，可能会更直接地采取 <strong>杀死进程</strong> 或 <strong>标记内存为不可用</strong> 的操作。</td>
<td></td>
</tr>
<tr>
<td><code>/proc/sys/vm/drop_caches</code></td>
<td>默认值始终为 <code>0</code></td>
<td>允许管理员手动清理 Linux 内存缓存，包括： <br/>- <code>Page Cache（页面缓存）</code> ： 主要用于加速文件读取。<br/>- <code>Dentry Cache（目录项缓存）</code> ： 记录文件路径信息，加快目录访问。<br/>- <code>Inode Cache（索引节点缓存）</code> ： 记录文件元数据，如大小、权限等。<br/> <strong><code>drop_caches</code> 不会影响进程已使用的内存，只是释放 <em>内核缓存</em> 。</strong> 适用于 <em>测试、性能调优、观察内存使用情况</em> ，但不建议频繁使用。   <br/>可选值包括：<br/>- <code>1</code> ： 清理 <code>Page Cache</code> ，释放文件数据缓存<br/>- <code>2</code> ： 清理 <code>Dentry</code> 和 <code>Inode Cache</code>，释放目录路径和文件元数据缓存<br/>- <code>3</code> ： 清理 <code>Page Cache</code> 、 <code>Dentry</code> 和 <code>Inode Cache</code>（全部）</td>
<td><strong>建议同步数据到磁盘（<code>sync</code>）后清理，防止数据丢失</strong></td>
</tr>
<tr>
<td><code>/proc/sys/vm/compact_memory</code></td>
<td>默认值始终为 <code>0</code></td>
<td><a href="#compact-memory">compact_memory</a></td>
<td></td>
</tr>
</tbody></table>
<span id="more"></span>

<h2 id="vm-watermark-scale-factor"><a href="#vm-watermark-scale-factor" class="headerlink" title="vm.watermark_scale_factor"></a>vm.watermark_scale_factor</h2><p><code>vm.watermark_scale_factor</code> (<code>/proc/sys/vm/watermark_scale_factor</code>)是 Linux 内核中的一个虚拟内存管理参数，它影响内核的内存水位标记（ <code>watermarks</code> ）机制。内存水位标记用于决定何时触发内存回收（如回收页缓存或启动交换操作）。通过调整该参数，可以控制内核在内存压力下的行为和回收策略。</p>
<p>Linux 内核为每个内存区域（<code>zone</code>）定义了三个水位标记：</p>
<ol>
<li><p><strong>min（最低水位）</strong> ：</p>
<p> 当可用内存低于 <code>min</code> 时，内核强制触发回收机制，尽一切可能释放内存。</p>
</li>
<li><p><strong>low（低水位）</strong> ：</p>
<p> 内核尝试开始回收内存，但允许正常分配。</p>
</li>
<li><p><strong>high（高水位）</strong> ：</p>
<p> 可用内存高于 high 时，内核不会主动回收内存。</p>
</li>
</ol>
<p>这些水位标记在 <code>/proc/zoneinfo</code> 中可以查看：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /proc/zoneinfo | grep -E <span class="string">&quot;Node|min|low|high&quot;</span></span></span><br><span class="line">Node 0, zone      DMA</span><br><span class="line">        min      8</span><br><span class="line">        low      10</span><br><span class="line">        high     12</span><br><span class="line">Node 0, zone    DMA32</span><br><span class="line">        min      1532</span><br><span class="line">        low      1915</span><br><span class="line">        high     2298</span><br><span class="line">Node 0, zone   Normal</span><br><span class="line">        min      15355</span><br><span class="line">        low      19193</span><br><span class="line">        high     23032</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>vm.watermark_scale_factor</code> 是一个百分比值（默认值为 10，表示 <code>10%</code> ），用于调整内存水位的敏感度。具体来说：</p>
<ul>
<li><p><strong>它决定了内存水位的范围（<code>high</code> 和 <code>low</code> 之间的差距）。</strong></p>
</li>
<li><p><strong>值越大，水位范围越大，内核对内存压力的响应越迟钝。</strong></p>
</li>
<li><p><strong>值越小，水位范围越小，内核对内存压力的响应越敏感。</strong></p>
</li>
</ul>
<p>内存水位的计算方式如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">high = min_free_kbytes + (总内存 * watermark_scale_factor / 10000)</span><br><span class="line">low = high - (总内存 * watermark_scale_factor / 10000)</span><br><span class="line">min = low - (总内存 * watermark_scale_factor / 10000)</span><br></pre></td></tr></table></figure>

<p><strong>增大 <code>watermark_scale_factor</code></strong> ：</p>
<ul>
<li>内存水位范围变大，内核对内存压力的响应变慢。</li>
<li>适用于内存充足且希望减少内存回收频率的场景。</li>
<li><strong>过高值</strong> 可能导致系统在内存压力下响应过慢，增加 OOM（Out of Memory）风险。</li>
</ul>
<p><strong>减小 <code>watermark_scale_factor</code></strong> ：</p>
<ul>
<li><p>内存水位范围变小，内核对内存压力的响应变快。</p>
</li>
<li><p>适用于内存紧张且需要快速回收内存的场景。</p>
</li>
<li><p><strong>过低值</strong> 可能导致内核频繁回收内存，增加系统开销。</p>
</li>
</ul>
<h2 id="vm-percpu-pagelist-high-fraction"><a href="#vm-percpu-pagelist-high-fraction" class="headerlink" title="vm.percpu_pagelist_high_fraction"></a>vm.percpu_pagelist_high_fraction</h2><p>从 Linux 5.16 及以后，<code>vm.percpu_pagelist_fraction</code> 已被移除，取而代之的是 <code>vm.percpu_pagelist_high_fraction</code>，并且 PCP（Per-CPU Page List）大小的计算方式发生了变化。</p>
<p><strong>什么是 PCP（Per-CPU Page List）?</strong>  </p>
<p>Linux 内核的物理页框管理（Buddy System）采用 <strong>PCP（Per-CPU Page List，每 CPU 页列表）</strong>  机制，为每个 CPU 维护一个 <strong>独立的</strong> 页缓存，以减少多个 CPU 争夺全局锁，提高内存分配效率。</p>
<p><strong>PCP 的作用</strong> ：</p>
<ul>
<li>通过为每个 CPU 保留一定数量的空闲页，减少内存分配时对全局锁争用，加快小规模页分配，从而提高多核系统上的内存分配性能。</li>
<li>提高缓存命中率，避免频繁访问 Buddy System。每个 CPU 都有自己的空闲页列表，减少了多个 CPU 同时访问全局空闲列表时的锁争用。</li>
</ul>
<p><strong>PCP 主要参数</strong> ：</p>
<ul>
<li><code>low</code> ： 低水位，低于此值时，系统会回收页。</li>
<li><code>high</code> ： 高水位，达到此值时，释放多余页给 Buddy System。</li>
</ul>
<p><code>vm.percpu_pagelist_high_fraction</code> 控制 <strong>Per-CPU Page List(每 CPU 页列表)的上限（high limit）</strong> ，限制 PCP 过大导致的内存浪费。</p>
<h2 id="Linux-内存-Overcommit-机制详解"><a href="#Linux-内存-Overcommit-机制详解" class="headerlink" title="Linux 内存 Overcommit 机制详解"></a>Linux 内存 Overcommit 机制详解</h2><p>在 Linux 内核中，<strong>Overcommit</strong> 机制决定了系统如何管理 <strong>虚拟内存（Virtual Memory）</strong> 申请，特别是当进程申请的内存超过物理 RAM + Swap 时的处理策略。</p>
<p>Linux 内核的 Overcommit 机制允许系统分配比实际物理内存更多的虚拟内存。这种机制基于以下假设：</p>
<ul>
<li><p>并非所有分配的内存都会被实际使用。</p>
</li>
<li><p>应用程序可能会申请大量内存，但实际使用的只是其中一部分。</p>
</li>
</ul>
<p>相关参数：</p>
<ul>
<li><code>vm.overcommit_memory</code> —— 控制 Overcommit 策略（是否允许超额分配）。</li>
<li><code>vm.overcommit_ratio</code> —— 影响可分配内存的计算。</li>
<li><code>vm.overcommit_kbytes</code> —— 手动设置可 Overcommit 的最大内存（部分新内核支持）。</li>
</ul>
<p><strong>vm.overcommit_memory</strong> 是一个整数值，用于控制内核的内存分配策略。它有以下三种模式：</p>
<ul>
<li><p><strong>0（默认值）</strong> ： Heuristic Overcommit(启发式 Overcommit)。</p>
<ul>
<li><p>内核会根据当前系统的内存使用情况，使用启发式算法(<strong>基于历史数据</strong>)来决定是否允许内存分配。</p>
</li>
<li><p>允许进程请求比实际 RAM 多的内存</p>
</li>
<li><p>如果系统空闲内存较少，可能会拒绝内存分配请求。</p>
</li>
<li><p><strong>这是最常用的模式，适用于大多数场景</strong> 。</p>
</li>
</ul>
</li>
<li><p><strong>1</strong> ： Always Overcommit(总是允许 Overcommit)。</p>
<ul>
<li><p>内核总是允许内存分配请求，无论当前内存使用情况如何。程可以分配 <strong>任意大小</strong> 的虚拟内存，哪怕物理 RAM 和 Swap 不够。</p>
</li>
<li><p>这种模式下，系统可能会分配比实际物理内存更多的虚拟内存。</p>
</li>
<li><p>适用于内存密集型应用，但存在 OOM（Out-Of-Memory）风险。</p>
</li>
</ul>
</li>
<li><p><strong>2</strong> ： Strict Overcommit(禁止 Overcommit)。</p>
<ul>
<li><p>内核会严格限制内存分配，确保分配的内存不超过 <code>overcommit_ratio</code> 或 <code>overcommit_kbytes</code> 设置的限制。</p>
</li>
<li><p>进程申请超出 CommitLimit 直接 <strong>失败（返回 ENOMEM）</strong> 。</p>
</li>
<li><p>这种模式下，系统不会分配超过物理内存和交换空间总和的内存。</p>
</li>
<li><p>适用于对内存使用要求严格的场景。</p>
</li>
</ul>
</li>
</ul>
<p>当 <code>vm.overcommit_memory = 2</code> 时，<code>vm.overcommit_ratio</code> 决定 <strong>CommitLimit</strong> （可分配的最大虚拟内存） 。<code>overcommit_ratio</code> 是一个百分比值，用于在 <code>overcommit_memory=2</code> 模式下限制内存分配。它定义了系统可以分配的内存总量与物理内存的比例。 <strong>默认值</strong> ：通常为 <code>50</code>（即 <code>50%</code>）。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">允许分配的内存总量 = 物理内存 × (overcommit_ratio / 100) + 交换空间</span><br></pre></td></tr></table></figure>
<p>例如，如果物理内存为 16GB，<code>overcommit_ratio=50</code>，交换空间为 4GB，则允许分配的内存总量为：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">16GB × 0.5 + 4GB = 12GB</span><br></pre></td></tr></table></figure>
<p>查看 <code>CommitLimit</code> 的值： </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /proc/meminfo | grep -E <span class="string">&quot;MemTotal|SwapTotal|CommitLimit&quot;</span></span></span><br><span class="line">MemTotal:       32680152 kB</span><br><span class="line">SwapTotal:       8388604 kB</span><br><span class="line">CommitLimit:    24728680 kB</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>vm.overcommit_ratio</code> 仅在 <code>vm.overcommit_memory=2</code> 时生效。在其他模式下（<code>vm.overcommit_memory=0</code> 或 <code>1</code>），<code>vm.overcommit_ratio</code> 不会起作用。</p>
</blockquote>
<p><code>vm.overcommit_kbytes</code> 直接指定可 <strong>Overcommit 的最大内存大小</strong> （部分新内核支持）。</p>
<h2 id="vfs-cache-pressure"><a href="#vfs-cache-pressure" class="headerlink" title="vfs_cache_pressure"></a>vfs_cache_pressure</h2><p><strong>VFS（Virtual File System）</strong> 是 Linux 内核中的一个抽象层，用于支持多种文件系统（如 <code>ext4</code>、<code>XFS</code>、<code>NTFS</code> 等）。VFS 缓存主要包括：</p>
<ul>
<li><p><strong>目录项缓存（<code>dentry cache</code>）</strong> ： 缓存目录项（<code>dentry</code>），用于快速查找文件路径。</p>
</li>
<li><p><strong>inode 缓存</strong> ： 缓存文件的元数据（如权限、大小、时间戳等）。</p>
</li>
</ul>
<p>VFS 缓存可以显著提高文件系统的访问速度，因为访问缓存中的数据比从磁盘读取要快得多。</p>
<p><code>vm.vfs_cache_pressure</code> 控制 <strong>内核回收 VFS（Virtual File System）缓存的倾向</strong> 。取值范围包括：</p>
<table>
<thead>
<tr>
<th>值</th>
<th>行为</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>0-50</code></td>
<td>降低 VFS 缓存回收率，更倾向于保留 <code>dentry/inode</code> 缓存<br/>- <strong>更多 VFS 缓存，加速文件系统访问，但可能会导致 Swap 增加。</strong></td>
<td><strong>适合 大量文件操作（NFS 服务器、文件服务器）</strong></td>
</tr>
<tr>
<td><code>100</code></td>
<td>默认值，平衡回收 VFS 缓存与 Page Cache</td>
<td>适用于 <strong>通用服务器</strong></td>
</tr>
<tr>
<td><code>&gt;100</code></td>
<td>更积极回收 VFS 缓存，更快释放 <code>inode/dentry</code> 资源  <br/>- <strong>减少 VFS 缓存，腾出更多内存给其他任务，但可能会导致频繁的 I&#x2F;O 操作，降低文件访问效率。</strong></td>
<td>适合 <strong>低内存服务器</strong></td>
</tr>
</tbody></table>
<p>使用以下命令可以查看 VFS 缓存占用</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /proc/meminfo | grep -E <span class="string">&quot;Cached|Dirty|Writeback&quot;</span></span></span><br><span class="line">Cached:         23405312 kB</span><br><span class="line">SwapCached:        14760 kB</span><br><span class="line">Dirty:              3788 kB</span><br><span class="line">Writeback:             0 kB</span><br><span class="line">WritebackTmp:          0 kB</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="compact-memory"><a href="#compact-memory" class="headerlink" title="compact_memory"></a>compact_memory</h2><p><code>/proc/sys/vm/compact_memory</code> 是一个 Linux 内核的内存调优参数，用于 <strong>触发内存压缩操作</strong> 。在内存碎片化较严重的情况下，调用此参数可以 <strong>强制内核进行内存压缩</strong> ，使得内存中的空闲区域变得更加连续，从而提高系统的内存使用效率。</p>
<p>内存压缩是指将不再使用的内存区域合并或回收，目的是减少内存的碎片化，避免内存浪费，并且为系统中的其他进程提供更多可用的内存。</p>
<p>Linux 内核会自动处理内存碎片化问题，但在以下情况中，可以手动触发内存压缩：</p>
<ul>
<li><strong>内存碎片化严重</strong> ：系统在长期运行或高负载的情况下可能导致内存碎片化，手动触发内存压缩可以解决这个问题。</li>
<li><strong>内存紧张</strong> ：在内存不足或交换空间使用较多时，可以通过压缩内存来释放更多可用内存，减少对交换空间的依赖。</li>
</ul>
<p>若要触发内存压缩，可以写入 <code>1</code> 到 <code>/proc/sys/vm/compact_memory</code> ：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/vm/compact_memory</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这会触发内核进行内存压缩，尝试减少内存碎片化。系统会尝试将空闲内存区域合并，并释放不再使用的内存块。</p>
<h2 id="OOM"><a href="#OOM" class="headerlink" title="OOM"></a>OOM</h2><p>Linux OOM(Out Of Memory) 是指 <strong>Linux 内核检测到系统内存耗尽</strong> 时触发的机制。当可用内存不足且无法通过 <strong>回收缓存</strong> 或 <strong>交换内存</strong> 释放更多资源时，Linux 内核会启动 OOM-Killer（OOM 杀手），选择并杀死某些进程，以释放内存，使系统继续运行。</p>
<p>OOM 主要发生在以下情况下：</p>
<ul>
<li><strong>物理内存不足 且 swap（交换分区）空间也耗尽</strong> 。</li>
<li><strong>进程请求的内存超过系统可以提供的可用内存（例如 <code>malloc()</code> 失败）</strong> 。</li>
<li><strong>某个进程使用了过多内存，导致其他进程无法正常运行（通常称为 <code>内存泄漏</code>）</strong> 。</li>
</ul>
<p><strong>OOM-Killer 工作原理</strong></p>
<p>当系统内存不足时，<code>OOM-Killer</code> 需要决定 <strong>杀死哪个进程</strong> 以释放最多的内存，同时尽可能减少对系统稳定性的影响。它会根据 <strong>OOM 分数（oom_score）</strong> 来评估进程的优先级，选择合适的目标。</p>
<ul>
<li><p><strong>OOM Score 计算方式</strong></p>
<p>  Linux 通过 <code>/proc/[PID]/oom_score</code> 计算每个进程的 OOM 分数，决定哪个进程最适合被杀死。计算方式包括：</p>
<ul>
<li>进程的 <strong>实际内存使用量（包括 RSS 和 swap）</strong> 。</li>
<li>进程的 <strong>优先级（nice 值）</strong> 。</li>
<li>进程是否有 <strong>特殊权限（例如 root 用户的进程通常优先级较低，不会被轻易杀死）</strong> 。</li>
<li>进程是否 <strong>手动调整了 OOM 权重（ <code>oom_score_adj</code> ）</strong> 。</li>
</ul>
<p>  查看进程的 OOM Score：<br>  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat /proc/$(pgrep -f &lt;进程名&gt;)/oom_score</span><br></pre></td></tr></table></figure></p>
</li>
<li><p><strong>调整进程的 OOM Score</strong></p>
<p>  可以通过 <code>/proc/[PID]/oom_score_adj</code> 影响 OOM-Killer 的决策：</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo -1000 &gt; /proc/$(pgrep -f &lt;进程名&gt;)/oom_score_adj  # 降低 OOM 优先级</span><br><span class="line">echo 1000 &gt; /proc/$(pgrep -f &lt;进程名&gt;)/oom_score_adj  # 增加 OOM 优先级</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><code>-1000</code> ： 表示 <strong>永不杀死</strong> 该进程（适用于重要进程，如 <code>sshd</code>）。</li>
<li><code>1000</code> ： 表示 <strong>更容易被杀死</strong> 。</li>
</ul>
</li>
<li><p><strong><code>oom_dump_tasks</code> 参数</strong></p>
<p>  <code>/proc/sys/vm/oom_dump_tasks</code> 控制 当 OOM-Killer 触发时，是否记录被终止的进程信息。该参数的作用是 <strong>方便系统管理员分析 OOM 发生时的内存使用情况，帮助排查问题</strong> 。</p>
<ul>
<li><strong>默认值： 1（启用）</strong> 。当发生 OOM 时，内核会记录 <strong>所有进程的内存使用信息</strong> 到系统日志。</li>
<li><strong>禁用（0）</strong> ： 发生 OOM 时，不会记录进程信息，日志会更简洁，但不利于排查问题。</li>
</ul>
</li>
<li><p><strong><code>oom_kill_allocating_task</code> 参数</strong></p>
<p>  <code>/proc/sys/vm/oom_kill_allocating_task</code> 控制 <strong>OOM Killer 是否优先杀死正在申请内存的进程（即导致 OOM 的那个进程）</strong> 。</p>
<ul>
<li><code>0（默认值）</code> ：OOM Killer 按 OOM 评分选择要杀死的进程，不一定是触发 OOM 的进程。</li>
<li><code>1</code> ：直接杀死 <strong>触发 OOM 事件的进程（即当前正在申请内存但失败的进程）</strong> 。</li>
</ul>
</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="../tags/Linux/" rel="tag"><i class="fa fa-tag"></i> Linux</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="../20250115163437/" rel="prev" title="Java jdk Docker 中运行脚本">
                  <i class="fa fa-chevron-left"></i> Java jdk Docker 中运行脚本
                </a>
            </div>
            <div class="post-nav-item">
                <a href="../20250131111615/" rel="next" title="Linux File System 及存储系统简介">
                  Linux File System 及存储系统简介 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">COSMOS</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="300" alpha="0.3" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="../js/comments.js"></script><script src="../js/utils.js"></script><script src="../js/motion.js"></script><script src="../js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="../js/third-party/search/local-search.js"></script>




  <script src="../js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"fl9999","repo":"fl9999.github.io","client_id":"a11bf6f7860762b725b5","client_secret":"a99046105f8bddc72ec718d54dc3fd7f22070821","admin_user":"fl9999","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"d41d8cd98f00b204e9800998ecf8427e"}</script>
<script src="../js/third-party/comments/gitalk.js"></script>

</body>
</html>
