<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16-next.png">
  <link rel="mask-icon" href="../images/logo.svg" color="#222">

<link rel="stylesheet" href="../css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"csms.tech","root":"/","images":"../images","scheme":"Gemini","darkmode":true,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeIn","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"../search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="../js/config.js"></script>

    <meta name="description" content="环境信息 Centos7 3.10.0-1160 Docker Engine - Community 23.0.3 kubernetes 1.21.2-0 kubernetes-cni-0.8.7-0  Kubernetes 对任何网络实现都规定了以下要求： [1]  所有 Pod 都可以在不使用网络地址转换 (NAT) 的情况下与所有其他 Pod 通信。   容器之间直接通信，不需要额外的 NA">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes 网络">
<meta property="og:url" content="http://csms.tech/202212020941/index.html">
<meta property="og:site_name" content="L B T">
<meta property="og:description" content="环境信息 Centos7 3.10.0-1160 Docker Engine - Community 23.0.3 kubernetes 1.21.2-0 kubernetes-cni-0.8.7-0  Kubernetes 对任何网络实现都规定了以下要求： [1]  所有 Pod 都可以在不使用网络地址转换 (NAT) 的情况下与所有其他 Pod 通信。   容器之间直接通信，不需要额外的 NA">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.csms.tech/img_140.png">
<meta property="og:image" content="https://i.csms.tech/img_141.png">
<meta property="og:image" content="https://i.csms.tech/img_142.png">
<meta property="og:image" content="https://i.csms.tech/img_143.png">
<meta property="og:image" content="https://i.csms.tech/img_144.png">
<meta property="og:image" content="https://i.csms.tech/img_145.png">
<meta property="article:published_time" content="2022-12-02T01:41:16.000Z">
<meta property="article:modified_time" content="2023-04-27T05:50:01.000Z">
<meta property="article:author" content="COSMOS">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.csms.tech/img_140.png">


<link rel="canonical" href="http://csms.tech/202212020941/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://csms.tech/202212020941/","path":"202212020941/","title":"Kubernetes 网络"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Kubernetes 网络 | L B T</title>
  








  <noscript>
    <link rel="stylesheet" href="../css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">L B T</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记 录 过 去 的 经 验</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="../index.html" rel="section"><i class="fa fa-earth-americas fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="../categories/" rel="section"><i class="fa fa-folder-tree fa-fw"></i>总目录<span class="badge">49</span></a></li><li class="menu-item menu-item-linux"><a href="../categories/Linux" rel="section"><i class="fa fa-brands fa-linux fa-fw"></i>Linux</a></li><li class="menu-item menu-item-python"><a href="../categories/Python" rel="section"><i class="fa fa-brands fa-python fa-fw"></i>Python</a></li><li class="menu-item menu-item-docker"><a href="../categories/Docker" rel="section"><i class="fa fa-brands fa-docker fa-fw"></i>Docker</a></li><li class="menu-item menu-item-kubernetes"><a href="../categories/Kubernetes" rel="section"><i class="fa fa-dharmachakra fa-fw"></i>Kubernetes</a></li><li class="menu-item menu-item-tags"><a href="../tags/" rel="section"><i class="fa fa-tornado fa-fw"></i>标签<span class="badge">78</span></a></li><li class="menu-item menu-item-archives"><a href="../archives/" rel="section"><i class="fa fa-rectangle-list fa-fw"></i>列表<span class="badge">238</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章总目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E4%BF%A1%E6%81%AF"><span class="nav-number">1.</span> <span class="nav-text">环境信息</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CNI"><span class="nav-number">2.</span> <span class="nav-text">CNI</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-CNI"><span class="nav-number">2.1.</span> <span class="nav-text">安装 CNI</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#flannel"><span class="nav-number">3.</span> <span class="nav-text">flannel</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#flannel-backend-%E8%AF%A6%E8%A7%A3"><span class="nav-number">3.1.</span> <span class="nav-text">flannel backend 详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UDP"><span class="nav-number">3.1.1.</span> <span class="nav-text">UDP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#flannel-UDP-%E6%A8%A1%E5%BC%8F%E8%B7%A8%E4%B8%BB%E6%9C%BA%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">flannel UDP 模式跨主机通信流程详解</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VXLAN"><span class="nav-number">3.1.2.</span> <span class="nav-text">VXLAN</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#flannel-VXLAN-%E6%A8%A1%E5%BC%8F%E8%B7%A8%E4%B8%BB%E6%9C%BA%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">flannel VXLAN 模式跨主机通信流程详解</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#host-gw"><span class="nav-number">3.1.3.</span> <span class="nav-text">host-gw</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes-%E4%B8%AD-flannel-%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="nav-number">3.2.</span> <span class="nav-text">Kubernetes 中 flannel 相关配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%84%9A%E6%B3%A8"><span class="nav-number">4.</span> <span class="nav-text">脚注</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">COSMOS</p>
  <div class="site-description" itemprop="description">得 能 莫 忘</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="../archives/">
          <span class="site-state-item-count">238</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="../categories/">
        <span class="site-state-item-count">49</span>
        <span class="site-state-item-name">目录</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="../tags/">
        <span class="site-state-item-count">78</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202212020941/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Kubernetes 网络 | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kubernetes 网络
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-12-02 09:41:16" itemprop="dateCreated datePublished" datetime="2022-12-02T09:41:16+08:00">2022-12-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-04-27 13:50:01" itemprop="dateModified" datetime="2023-04-27T13:50:01+08:00">2023-04-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Centos7 3.10.0-1160</li>
<li>Docker Engine - Community 23.0.3</li>
<li>kubernetes 1.21.2-0</li>
<li>kubernetes-cni-0.8.7-0</li>
</ul>
<p>Kubernetes 对任何网络实现都规定了以下要求： <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[万字长文，带你搞懂 Kubernetes 网络模型](https://www.51cto.com/article/714336.html)">[1]</span></a></sup></p>
<ul>
<li><p><strong>所有 Pod 都可以在不使用网络地址转换 (NAT) 的情况下与所有其他 Pod 通信。</strong></p>
<p>  容器之间直接通信，不需要额外的 NAT，不存在源地址伪装的情况</p>
</li>
<li><p><strong>所有节点都可以在没有 NAT 的情况下与所有 Pod 通信。</strong></p>
<p>  Node 与容器直接通信，不需要额外的 NAT</p>
</li>
<li><p><strong>Pod 认为自己的 IP 与其他人认为的 IP 相同。</strong></p>
</li>
</ul>
<h1 id="CNI"><a href="#CNI" class="headerlink" title="CNI"></a>CNI</h1><p>CNI 是 Kubernetes 容器网络的标准，CNI 是 Kubernetes 和底层网络插件之间的一个抽象层，为 Kubernetes 屏蔽了底层网络实现的负责度，同时解耦了 Kubernetes 和具体的网络插件实现。</p>
<h2 id="安装-CNI"><a href="#安装-CNI" class="headerlink" title="安装 CNI"></a>安装 CNI</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">yum install kubernetes-cni</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rpm -qa | grep kube</span></span><br><span class="line">kubeadm-1.21.2-0.x86_64</span><br><span class="line">kubectl-1.21.2-0.x86_64</span><br><span class="line">kubelet-1.21.2-0.x86_64</span><br><span class="line">kubernetes-cni-0.8.7-0.x86_64</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rpm -ql kubernetes-cni-0.8.7-0</span></span><br><span class="line">/opt/cni</span><br><span class="line">/opt/cni/bin</span><br><span class="line">/opt/cni/bin/bandwidth</span><br><span class="line">/opt/cni/bin/bridge</span><br><span class="line">/opt/cni/bin/dhcp</span><br><span class="line">/opt/cni/bin/firewall</span><br><span class="line">/opt/cni/bin/flannel</span><br><span class="line">/opt/cni/bin/host-device</span><br><span class="line">/opt/cni/bin/host-local</span><br><span class="line">/opt/cni/bin/ipvlan</span><br><span class="line">/opt/cni/bin/loopback</span><br><span class="line">/opt/cni/bin/macvlan</span><br><span class="line">/opt/cni/bin/portmap</span><br><span class="line">/opt/cni/bin/ptp</span><br><span class="line">/opt/cni/bin/sbr</span><br><span class="line">/opt/cni/bin/static</span><br><span class="line">/opt/cni/bin/tuning</span><br><span class="line">/opt/cni/bin/vlan</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Kubernetes 要使用 CNI，需要在 kubelet 启动时配置启动参数 <code>--network-plugin=cni</code>（默认配置，可使用 <code>systemctl status kubelet -l</code> 查看启动参数）。</p>
<p>kubelet 从 <code>--cni-config-dir</code> （默认为 <code>/etc/cni/net.d/</code>）中读取网络插件的配置文件，并使用该文件中的 CNI 配置来配置每个 Pod 网络。如果该目录 （<code>/etc/cni/net.d/</code>）中有多个配置文件，则使用文件名字典序列中的第一个文件。</p>
<p>CNI 插件的二进制文件放置的目录是通过 kubelet 的 <code>--cni-bin-dir</code> 参数指定，默认为 <code>/opt/cni/bin/</code></p>
<span id="more"></span>

<h1 id="flannel"><a href="#flannel" class="headerlink" title="flannel"></a>flannel</h1><p>flannel 最早由 CoreOS 开发，它是容器编排系统中最成熟的网络插件之一。随着 CNI 概念的兴起，flannel 也是最早实现 CNI 标准的网络插件，CNI 标准也是由 CoreOS 提出的。flannel 的功能非常明确，主要解决以下容器跨接点访问的问题</p>
<ul>
<li><strong>容器 IP 地址的重复问题</strong>。由于 Docker 等容器管理工具只是利用 Linux 内核的 network namespace 实现了网络隔离，各个节点上的容器 IP 由各个节点自动分配，可能出现重复。为了解决这个问题，flannel 设计了一种全局的 IP 地址分配机制，即使用 etcd 存储网段和节点 IP 之间的映射关系，然后配置 docker 只在当前节点对应的网段里面为容器分配 IP。</li>
<li><strong>容器 IP 地址的路由问题</strong>。flannel 使用多种后端（底层）技术（如 overlay 网络、Host-Gateway 网络等）解决了容器跨节点的直接通信问题。</li>
</ul>
<p>flannel 在架构上分为<strong>管理面</strong>和<strong>数据面</strong>。</p>
<ul>
<li><strong>管理面</strong>主要是 <code>etcd</code>。用于存储各个节点的 IP 及其上容器应该分配的网段</li>
<li><strong>数据面</strong>是每个节点上运行一个 <code>flanneld</code> 进程，负责从管理面读取节点 IP 及对应的网段信息，并根据这些信息对容器跨接点通信的数据包进行路由转发。</li>
</ul>
<p>集群内所有的 flannel 节点共享一个大网段，比如 <code>10.0.0.0/16</code>，flanneld 启动后便会读取 etcd 中的信息，得知其他节点的 IP 及其使用的子网段，然后向 etcd 申请本节点可使用的子网段（在大网段中划分一个子网段），比如 10.0.0.1&#x2F;24，并将该信息上报记录到 etcd。</p>
<p>flannel 目前已经支持的底层网络实现（backend）包括：</p>
<ul>
<li><code>UDP</code></li>
<li><code>VXLAN</code></li>
<li><code>Host-Gateway</code></li>
<li><code>Alloc</code></li>
<li><code>AWS VPC</code></li>
<li><code>GCE 路由</code></li>
</ul>
<p>其中，性能最好的是 <code>Host-Gateway</code>。<code>AWS VPC</code> 和 <code>GCE 路由</code>都需要 L2 网络支持，并且最好是接入云服务。<code>Alloc</code> 只为本机创建子网，多个节点上的子网之间不能通信。</p>
<h2 id="flannel-backend-详解"><a href="#flannel-backend-详解" class="headerlink" title="flannel backend 详解"></a>flannel backend 详解</h2><p>flannel 通过在每个节点上启动 <code>flanneld</code> 进程，负责每个节点上的子网划分，并将相关配置（如节点的 IP，划分的子网网段等）上报保存到 etcd，而具体的网络报文转发交给具体的 backend 实现。</p>
<p><code>flanneld</code> 可以在启动时通过配置文件指定不同的 backend 进行跨节点的容器之间的网络报文的路由转发，目前比较成熟的 backend 有  <code>UDP</code>、 <code>VXLAN</code> 、<code>Host-Gateway</code>，也有 <code>AWS VPC</code>、<code>GCE 路由</code> 等专门针对云服务的 backend。目前 <code>VXLAN</code> 是官方最推崇的 backend 实现，<code>Host-Gateway</code> 是网络性能最好的 backend 实现，但是需要所有节点在同一个二层网络中互通。<code>UDP</code> 性能相对较差，建议用于测试及比较老的不支持 VXLAN 的 Linux 内核。</p>
<h3 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h3><p>UDP 模式基于 <a href="/202304241633/" title="Linux tun 设备">Linux tun 设备</a>。</p>
<p>当采用 UDP 模式时，<code>flanneld</code> 启动时会通过打开 <code>/dev/net/tun</code> 的方式生成一个 tun 设备。当 <code>flanneld</code> 进程运行之后，查看系统上的网卡信息，可以看到多了 <code>flannel0</code> 的网卡，通过命令 <code>ip -d link show flannel0</code>，可以看到其类型为 <code>tun</code> 设备。此模式下 <code>flanneld</code> 进程监听 8285 端口。</p>
<h4 id="flannel-UDP-模式跨主机通信流程详解"><a href="#flannel-UDP-模式跨主机通信流程详解" class="headerlink" title="flannel UDP 模式跨主机通信流程详解"></a>flannel UDP 模式跨主机通信流程详解</h4><p>本说明使用架构图形如下<br><img src="https://i.csms.tech/img_140.png"></p>
<p>以 ICMP 报文为例，<code>container A</code> 和 <code>container B</code> 的通信过程如下</p>
<ol>
<li><p><code>container A</code> 发起 ICMP 请求报文，根据 <code>container A</code> 中的路由信息，报文被发送到网关 <code>10.244.1.1</code>，对应设备为 <code>Host A</code> 主机上面的 <code>cni0</code> 网卡。此时报文内容如下<br>  <img src="https://i.csms.tech/img_141.png"></p>
</li>
<li><p>到达 cni0 的报文，目的 IP 为 <code>10.244.2.149</code>，内核根据 <code>host A</code> 上的路由信息（<code>10.244.0.0 0.0.0.0 255.255.0.0 U 0 0 0 flannel0</code>），应该将报文发送到 <code>flannel0</code> 网卡。</p>
</li>
<li><p><code>flannel0</code> 是个 tun  设备，数据会被 <code>flanneld</code> 接受，<code>flanneld</code> 会对数据包进行 UDP 封装。</p>
<ul>
<li>报文会被添加上 UDP 头部，其源端口为 <code>host A</code> 上的随机端口，目标端口为 8285</li>
<li>添加 IP 头部，源 IP 为本节点出口 IP （eth0：172.16.130.140），目标 IP 为目标容器所在节点的 IP（eth0：172.16.130.146）。<blockquote>
<p><code>flanneld</code> 进程是如何知道目标容器所在节点的 IP 地址？<strong>是通过 etcd 中的记录，<code>flanneld</code> 进程很容易根据目标容器的 IP 子网段，获取到对应节点的 IP</strong><br>  <img src="https://i.csms.tech/img_142.png"></p>
</blockquote>
</li>
</ul>
</li>
<li><p><code>flanneld</code> 进程封装后的报文重新进入内核协议栈，内核根据主机上的路由信息，从主机 eth0 网卡发送出去，到达了目标主机 <code>host B</code></p>
</li>
<li><p><code>host B</code> 主机内核接收到此网络数据报文，通过 UDP 端口号 8285 将数据包交给监听在此端口上的 <code>flanneld</code> 进程。</p>
</li>
<li><p><code>host B</code> 主机上的 <code>flanneld</code> 进程对数据报文解封，获取到下图所示的报文，在网络层，源 IP 为容器 A 的 IP：10.244.1.96，目标 IP 为容器 B 的 IP：10.244.2.194。解封后的数据报文重新进入内核路由，根据主机 B 的主机路由表（<code>10.244.2.0 0.0.0.0 255.255.255.0 U 0 0 0 cni0</code>），报文被路由到 cni0<br> <img src="https://i.csms.tech/img_143.png"></p>
</li>
<li><p>cni0 网桥将数据包根据 MAC 地址（可以 ARP 寻址得到）将报文转发到容 B。</p>
</li>
<li><p>回程报文将按照上面的数据流原路返回。</p>
</li>
</ol>
<p>纵观以上整个过程，<code>flanneld</code> 进程在其中主要有以下作用</p>
<ul>
<li>UDP 封包解封包，根据目标容器的 IP，将其转发到正确的主机节点（IP）</li>
<li>主机节点上动态更新路由表，根据 etcd 的数据刷新本节点路由表</li>
</ul>
<p>容器 A 和容器 B 虽然物理上网络未相连，但是逻辑上确是在一个三层网络，这种在物理网络之上构建的上层网络称之为 <strong>overlay 网络或者隧道网络</strong></p>
<p><strong>flannel UDP 模式的缺点</strong></p>
<ul>
<li>数据报文先通过 tun 设备从内核态复制到了用户态 <code>flanneld</code> 进行封装，然后再传输到了内核，仅一次网络传输就进行了 2 次用户态到内核态的切换，效率不高。</li>
<li>因为报文封装的关系，flannel0 网卡的 MTU 要比主机 eth0 网卡小 28 个字节。</li>
</ul>
<h3 id="VXLAN"><a href="#VXLAN" class="headerlink" title="VXLAN"></a>VXLAN</h3><p><code>flanneld</code> 进程配置为 <code>vxlan</code> 类型的 backend ，<code>flanneld</code> 进程启动时会在主机上创建名为 <code>flannel.1</code> 的网卡（VTEP），网卡命名格式遵循 <code>flannel.[VNI]</code>，VNI 默认为 1。</p>
<p>通过以下命令查看 VTEP 设备 <code>flannel.1</code> 的信息。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip -d <span class="built_in">link</span> show flannel.1</span></span><br><span class="line">6: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 8951 qdisc noqueue state UNKNOWN mode DEFAULT group default </span><br><span class="line">    link/ether 8a:32:fc:1d:b8:88 brd ff:ff:ff:ff:ff:ff promiscuity 0 </span><br><span class="line">    vxlan id 1 local 172.31.16.124 dev eth0 srcport 0 0 dstport 8472 nolearning ageing 300 udpcsum noudp6zerocsumtx noudp6zerocsumrx addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535</span><br><span class="line">    </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip -d add show flannel.1</span></span><br><span class="line">6: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 8951 qdisc noqueue state UNKNOWN group default </span><br><span class="line">    link/ether 8a:32:fc:1d:b8:88 brd ff:ff:ff:ff:ff:ff promiscuity 0 </span><br><span class="line">    vxlan id 1 local 172.31.16.124 dev eth0 srcport 0 0 dstport 8472 nolearning ageing 300 udpcsum noudp6zerocsumtx noudp6zerocsumrx numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 </span><br><span class="line">    inet 10.244.4.0/32 scope global flannel.1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::8832:fcff:fe1d:b888/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>从以上信息可以看到，<code>flannel.1</code> 类型为 <code>vxlan</code>，local IP 为 172.31.16.124，使用的是 UDP 端口 8472</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">netstat -anutp</span> </span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">udp        0      0 0.0.0.0:8472            0.0.0.0:*                           -</span><br></pre></td></tr></table></figure>
<p>以上使用 <code>netstat -anutp</code> 命令的输出中，<code>PID/Program name</code> 显示的是 <code>-</code>，说明 8472 这个 UDP 端口不是由用户态的程序监听，而是 <strong>flannel 的 VXLAN 模式工作在内核态</strong>。</p>
<p>Kubernetes 中，VXLAN 模式的 <code>flanneld</code> 的工作流程：</p>
<ol>
<li><p><code>flanneld</code> 启动时，先确保 <code>flannel.1</code> 存在，若已存在则跳过，并将 VTEP 设备的相关信息（ip，节点 IP，MAC 地址等）上报到 etcd 中</p>
</li>
<li><p>当 flannel 网络中的其他节点加入集群并向 etcd 上报注册时，各个节点的 <code>flanneld</code> 会从 etcd 得到通知，并依次执行下面的步骤</p>
</li>
<li><p>在本节点添加一条新网段的路由信息，主要是让 Pod 中的流量能路由到 <code>flannel.1</code></p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ route -n</span><br><span class="line"> Kernel IP routing table</span><br><span class="line"> Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line"> 0.0.0.0         172.31.16.1     0.0.0.0         UG    100    0        0 eth0</span><br><span class="line"> 10.244.0.0      10.244.0.0      255.255.255.0   UG    0      0        0 flannel.1</span><br><span class="line"> 10.244.1.0      10.244.1.0      255.255.255.0   UG    0      0        0 flannel.1</span><br><span class="line"> 10.244.2.0      10.244.2.0      255.255.255.0   UG    0      0        0 flannel.1</span><br><span class="line"> 10.244.3.0      10.244.3.0      255.255.255.0   UG    0      0        0 flannel.1</span><br><span class="line"> 10.244.4.0      0.0.0.0         255.255.255.0   U     0      0        0 cni0</span><br><span class="line"> 172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br><span class="line"> 172.31.16.0     0.0.0.0         255.255.240.0   U     100    0        0 eth0</span><br></pre></td></tr></table></figure>
</li>
<li><p>在本节点添加一条新增节点的 VTEP 设备的静态 ARP 缓存</p>
</li>
</ol>
<h4 id="flannel-VXLAN-模式跨主机通信流程详解"><a href="#flannel-VXLAN-模式跨主机通信流程详解" class="headerlink" title="flannel VXLAN 模式跨主机通信流程详解"></a>flannel VXLAN 模式跨主机通信流程详解</h4><p>flannel VXLAN 模式时容器跨节点网络通信实现流程<br><img src="https://i.csms.tech/img_144.png"></p>
<ol>
<li>同 UDP Backend 模式，容器 A 当中的 IP 包通过容器 A 内的路由表被发送到 cni0</li>
<li>到达 cni0 当中的 IP 包通过匹配 host A 当中的路由表发现通往 10.244.2.194 的 IP 包应该交给 flannel.1 接口</li>
<li>flannel.1 作为一个 VTEP 设备，收到报文后将按照 VTEP 的配置进行封包，首先通过 etcd 得知 10.244.2.194 属于节点 B，并得到节点 B 的 IP，通过节点 A 当中的转发表得到节点 B 对应的 VTEP 的 MAC，根据 flannel.1 设备创建时的设置的参数（VNI、local IP、Port）进行 VXLAN 封包</li>
<li>通过 host A 跟 host B 之间的网络连接，VXLAN 包到达 host B 的 eth1 接口</li>
<li>通过端口 8472，VXLAN 包被转发给 VTEP 设备 flannel.1 进行解包</li>
<li>解封装后的 IP 包匹配 host B 当中的路由表（10.244.2.0），内核将 IP 包转发给 cni0</li>
<li>cni0 将 IP 包转发给连接在 cni0 上的容器 B</li>
</ol>
<p>在 VXLAN 模式下，数据包的封装解封装及路由转发都是由内核完成，<code>flanneld</code> 不再进行数据包的封装和路由转发，仅动态设置主机的路由表项、ARP 表及 FDB 表项。其效率相比 UDP 模式高效。</p>
<h3 id="host-gw"><a href="#host-gw" class="headerlink" title="host-gw"></a>host-gw</h3><p>要配置使用 <code>host-gw</code> 模式，将 Backend 中的 <code>type</code> 改为 <code>host-gw</code> 即可。</p>
<p>使用 <code>host-gw</code> Backend 的 Flannel 网络的网络包传输过程如下图所示：<br><img src="https://i.csms.tech/img_145.png"></p>
<ol>
<li>同 UDP、VXLAN 模式一致，通过容器 A 的路由表， IP 包到达 cni0</li>
<li>到达 cni0 的 IP 包匹配到 host A 当中的路由规则（10.244.2.0），并且网关为 172.16.130.164，即 host B，所以内核将 IP 包发送给 host B（172.16.130.164）</li>
<li>IP 包通过物理网络到达 host B 的 eth1</li>
<li>到达 host B eth1 的 IP 包匹配到 host B 当中的路由表（10.244.2.0），IP 包被转发给 cni0</li>
<li>cni0 将 IP 包转发给连接在 cni0 上的容器 B</li>
</ol>
<p><code>host-gw</code> 模式其中一个局限性就是，由于是通过节点上的路由表来实现各个节点之间的跨节点网络通信，那么就得保证两个节点是可以直接路由过去的。按照内核当中的路由规则，网关必须在跟主机当中至少一个 IP 处于同一网段，故造成的结果就是采用 <code>host-gw</code> 这种 Backend 方式时集群中所有的节点必须处于同一个网络当中，这对于集群规模比较大时需要对节点进行网段划分的话会存在一定的局限性。另外一个则是随着集群当中节点规模的增大，<code>flanneld</code> 需要维护主机上成千上万条路由表的动态更新也是一个不小的压力。</p>
<p>采用 <code>host-gw</code> 模式后 <code>flanneld</code> 的唯一作用就是负责主机上路由表的动态更新。</p>
<h2 id="Kubernetes-中-flannel-相关配置"><a href="#Kubernetes-中-flannel-相关配置" class="headerlink" title="Kubernetes 中 flannel 相关配置"></a>Kubernetes 中 flannel 相关配置</h2><p>CNI 调用 flannel 插件是通过其配置文件 <code>/etc/cni/net.d/10-flannel.conflist</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /etc/cni/net.d/10-flannel.conflist</span> </span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;cbr0&quot;,</span><br><span class="line">  &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span><br><span class="line">  &quot;plugins&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;flannel&quot;,</span><br><span class="line">      &quot;delegate&quot;: &#123;</span><br><span class="line">        &quot;hairpinMode&quot;: true,</span><br><span class="line">        &quot;isDefaultGateway&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;portmap&quot;,</span><br><span class="line">      &quot;capabilities&quot;: &#123;</span><br><span class="line">        &quot;portMappings&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>flannel 安装好启动之后，查看 flannel 的配置，可以看到配置的网段信息。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /run/flannel/subnet.env</span> </span><br><span class="line">FLANNEL_NETWORK=10.244.0.0/16</span><br><span class="line">FLANNEL_SUBNET=10.244.0.1/24</span><br><span class="line">FLANNEL_MTU=8951</span><br><span class="line">FLANNEL_IPMASQ=true</span><br></pre></td></tr></table></figure>

<p>在 Kubernetes 中，要查看 flannel 详细的配置，可以查看以下 configmap</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl edit configmap -n kube-flannel kube-flannel-cfg</span></span><br><span class="line">data:</span><br><span class="line">  cni-conf.json: |</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;cbr0&quot;,</span><br><span class="line">      &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span><br><span class="line">      &quot;plugins&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;type&quot;: &quot;flannel&quot;,</span><br><span class="line">          &quot;delegate&quot;: &#123;</span><br><span class="line">            &quot;hairpinMode&quot;: true,</span><br><span class="line">            &quot;isDefaultGateway&quot;: true</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;type&quot;: &quot;portmap&quot;,</span><br><span class="line">          &quot;capabilities&quot;: &#123;</span><br><span class="line">            &quot;portMappings&quot;: true</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  net-conf.json: |</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span><br><span class="line">      &quot;Backend&quot;: &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;vxlan&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>从中可以看到 flannel 使用的大网段 <code>10.244.0.0/16</code>，以及其使用的底层（后端）网络通信的实现技术（<code>Backend</code>）</p>
<h1 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h1><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://www.51cto.com/article/714336.html">万字长文，带你搞懂 Kubernetes 网络模型</a><a href="#fnref:1" rev="footnote"> ↩</a></span></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">2.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/qduqfhrisblob7textxe">Kubernetes 网络模型进阶</a><a href="#fnref:2" rev="footnote"> ↩</a></span></li></ol></div></div>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="../tags/Kubernetes/" rel="tag"><i class="fa fa-tag"></i> Kubernetes</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="../202212011355/" rel="prev" title="containerd 使用方法">
                  <i class="fa fa-chevron-left"></i> containerd 使用方法
                </a>
            </div>
            <div class="post-nav-item">
                <a href="../202212071353/" rel="next" title="kubernetes ConfigMap 使用说明">
                  kubernetes ConfigMap 使用说明 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">COSMOS</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="300" alpha="0.3" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="../js/comments.js"></script><script src="../js/utils.js"></script><script src="../js/motion.js"></script><script src="../js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="../js/third-party/search/local-search.js"></script>




  <script src="../js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"fl9999","repo":"fl9999.github.io","client_id":"a11bf6f7860762b725b5","client_secret":"a99046105f8bddc72ec718d54dc3fd7f22070821","admin_user":"fl9999","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"d41d8cd98f00b204e9800998ecf8427e"}</script>
<script src="../js/third-party/comments/gitalk.js"></script>

</body>
</html>
