<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="../../images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../../images/favicon-16x16-next.png">
  <link rel="mask-icon" href="../../images/logo.svg" color="#222">

<link rel="stylesheet" href="../../css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"csms.tech","root":"/","images":"../../images","scheme":"Gemini","darkmode":true,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeIn","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"../../search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="../../js/config.js"></script>

    <meta name="description" content="得 能 莫 忘">
<meta property="og:type" content="website">
<meta property="og:title" content="L B T">
<meta property="og:url" content="http://csms.tech/page/8/index.html">
<meta property="og:site_name" content="L B T">
<meta property="og:description" content="得 能 莫 忘">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="COSMOS">
<meta property="article:tag" content="博客, 记录，技术">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://csms.tech/page/8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/8/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>L B T</title>
  








  <noscript>
    <link rel="stylesheet" href="../../css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">L B T</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记 录 过 去 的 经 验</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="../../index.html" rel="section"><i class="fa fa-earth-americas fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="../../categories/" rel="section"><i class="fa fa-folder-tree fa-fw"></i>总目录<span class="badge">49</span></a></li><li class="menu-item menu-item-linux"><a href="../../categories/Linux" rel="section"><i class="fa fa-brands fa-linux fa-fw"></i>Linux</a></li><li class="menu-item menu-item-python"><a href="../../categories/Python" rel="section"><i class="fa fa-brands fa-python fa-fw"></i>Python</a></li><li class="menu-item menu-item-docker"><a href="../../categories/Docker" rel="section"><i class="fa fa-brands fa-docker fa-fw"></i>Docker</a></li><li class="menu-item menu-item-kubernetes"><a href="../../categories/Kubernetes" rel="section"><i class="fa fa-dharmachakra fa-fw"></i>Kubernetes</a></li><li class="menu-item menu-item-tags"><a href="../../tags/" rel="section"><i class="fa fa-tornado fa-fw"></i>标签<span class="badge">78</span></a></li><li class="menu-item menu-item-archives"><a href="../../archives/" rel="section"><i class="fa fa-rectangle-list fa-fw"></i>列表<span class="badge">228</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章总目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">COSMOS</p>
  <div class="site-description" itemprop="description">得 能 莫 忘</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="../../archives/">
          <span class="site-state-item-count">228</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="../../categories/">
        <span class="site-state-item-count">49</span>
        <span class="site-state-item-name">目录</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="../../tags/">
        <span class="site-state-item-count">78</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202305161451/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202305161451/" class="post-title-link" itemprop="url">Kubernetes 权限控制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-05-16 14:51:47" itemprop="dateCreated datePublished" datetime="2023-05-16T14:51:47+08:00">2023-05-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-18 13:36:35" itemprop="dateModified" datetime="2023-05-18T13:36:35+08:00">2023-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Centos 7</li>
<li>Kubernetes 1.24</li>
</ul>
<h1 id="ServiceAccount"><a href="#ServiceAccount" class="headerlink" title="ServiceAccount"></a>ServiceAccount</h1><p>ServiceAccount 就像 Pod、Secret、ConfigMap 等一样，都是资源，属于 namespace 级别，作用在单独的命名空间。默认情况，每个 namespace 都有一个默认的 ServiceAccount。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get serviceaccount</span></span><br><span class="line">NAME      SECRETS   AGE</span><br><span class="line">default   0         160d</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl describe serviceaccount default</span></span><br><span class="line">Name:                default</span><br><span class="line">Namespace:           default</span><br><span class="line">Labels:              &lt;none&gt;</span><br><span class="line">Annotations:         &lt;none&gt;</span><br><span class="line">Image pull secrets:  &lt;none&gt;</span><br><span class="line">Mountable secrets:   &lt;none&gt;</span><br><span class="line">Tokens:              &lt;none&gt;</span><br><span class="line">Events:              &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>namespace 中的每个 Pod 都和一个 ServiceAccount 关联，它代表了运行在 Pod 中的应用程序的身份证明。<strong>Pod 中的每个容器都会挂载此 ServiceAccount token</strong></p>
<p>在 Pod 的 manifest 定义文件中，可以通过指定账户名称的方式将一个 ServiceAccount 关联到 Pod。如果不显示指定 ServiceAccount 的账户名称，Pod 会使用 namespace 中默认的 ServiceAccount。可以将不同的 ServiceAccount 关联给不同的 Pod 来控制每个 Pod 可以访问的资源。</p>
<p>当 API 服务接收到一个带有认证 token 的请求时， API 会用这个 token 来验证发送请求的客户端所关联的 ServiceAccount 是否允许执行请求的操作。</p>
<h2 id="查看-ServiceAccount"><a href="#查看-ServiceAccount" class="headerlink" title="查看 ServiceAccount"></a>查看 ServiceAccount</h2><p>以 rancher 相关的 ServiceAccount 为例，查看 ServiceAccount 信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get serviceaccount -n cattle-system</span></span><br><span class="line">NAME                      SECRETS   AGE</span><br><span class="line">default                   0         160d</span><br><span class="line">git-webhook-api-service   0         160d</span><br><span class="line">rancher                   0         160d</span><br><span class="line">rancher-webhook           0         160d</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl describe sa default -n cattle-system</span></span><br><span class="line">Name:                default</span><br><span class="line">Namespace:           cattle-system</span><br><span class="line">Labels:              &lt;none&gt;</span><br><span class="line">Annotations:         &lt;none&gt;</span><br><span class="line">Image pull secrets:  &lt;none&gt;</span><br><span class="line">Mountable secrets:   &lt;none&gt;</span><br><span class="line">Tokens:              &lt;none&gt;</span><br><span class="line">Events:              &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>以下输出名为 <code>rancher</code> 的 ServiceAccount 信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl describe sa rancher -n cattle-system</span></span><br><span class="line">Name:                rancher</span><br><span class="line">Namespace:           cattle-system</span><br><span class="line">Labels:              app=rancher</span><br><span class="line">                     app.kubernetes.io/managed-by=Helm</span><br><span class="line">                     chart=rancher-2.7.0</span><br><span class="line">                     heritage=Helm</span><br><span class="line">                     release=rancher</span><br><span class="line">Annotations:         meta.helm.sh/release-name: rancher</span><br><span class="line">                     meta.helm.sh/release-namespace: cattle-system</span><br><span class="line">Image pull secrets:  &lt;none&gt;</span><br><span class="line">Mountable secrets:   &lt;none&gt;</span><br><span class="line">Tokens:              rancher-token</span><br><span class="line">Events:              &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ServiceAccount 主要包含了密钥（token）信息，客户端 (Pod)请求 API Service 时使用的 token 文件（如 <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code>）持有 ServiceAccount 的 token 。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl describe secret rancher-token -n cattle-system</span></span><br><span class="line">Name:         rancher-token</span><br><span class="line">Namespace:    cattle-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  field.cattle.io/projectId: local:p-76mvn</span><br><span class="line">              kubernetes.io/service-account.name: rancher</span><br><span class="line">              kubernetes.io/service-account.uid: 1e80ce10-2ba3-4bc3-81d9-ccc72001431b</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1099 bytes</span><br><span class="line">namespace:  13 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6Ik51eFpuNU9MUlp2Qkxm</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://csms.tech/202209121102/#配置-Pod-拉取镜像的认证信息">通过 ServiceAccount 配置镜像拉取密钥</a></p>
</blockquote>
<p>在新建了 ServiceAccount 之后，若要将它赋值给 Pod，通过在 Pod 定义中的 <code>spec.serviceAccountName</code> 字段上配置 ServiceAccount 名称来分配。<strong>Pod 的 ServiceAccount 必须在 Pod 创建时进行配置，后续不能被修改</strong></p>
<h1 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h1><p>从 Kubernetes 1.8.0 开始，RBAC（基于角色的权限控制）授权插件升级为 GA（通用可用性），并在大多数集群上默认开启（比如通过 <code>kubeadm</code> 部署的集群）。<a href="https://csms.tech/202304271425/#在-Pod-中通过-curl-命令请求-Kubernetes-API">RBAC 会阻止未授权的用户查看和修改集群状态，默认的 ServiceAccount 不允许查看集群状态</a>。</p>
<p>RBAC 授权规则是通过四种资源对象来进行配置的，他们可以分为 2 个组 <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[使用 RBAC 鉴权](https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/#restrictions-on-role-creation-or-update)
">[1]</span></a></sup></p>
<ul>
<li><code>Role</code>、<code>ClusterRole</code> -  一组代表相关权限的规则，他们指定了在资源上可以执行哪些操作（动词）</li>
<li><code>RoleBinding</code>、<code>ClusterRoleBinding</code> - 将角色中定义的权限赋予一个或者一组用户。它包含若干主体（用户、组或者 ServiceAccount）的列表和对这些主体所获得的角色的引用。</li>
</ul>
<blockquote>
<p><code>Role</code> 和 <code>RoleBinding</code> 属于 namespace 范围的资源，必须在 namespace 中配置</p>
<p><code>ClusterRole</code> 和 <code>ClusterRoleBinding</code> 是集群作用域的资源</p>
<p><strong>一个 RoleBinding 可以引用某 ClusterRole 并将该 ClusterRole 绑定到 RoleBinding 所在的名字空间。但是，RoleBinding 不能授予主体集群级别的资源的访问权限，即使它引用了一个 ClusterRoleBinding</strong></p>
<hr>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="../../202305161451/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202302251333/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202302251333/" class="post-title-link" itemprop="url">Godaddy api 使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-02-25 13:33:40" itemprop="dateCreated datePublished" datetime="2023-02-25T13:33:40+08:00">2023-02-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-15 10:23:47" itemprop="dateModified" datetime="2023-05-15T10:23:47+08:00">2023-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/%E4%BA%91%E5%B9%B3%E5%8F%B0/" itemprop="url" rel="index"><span itemprop="name">云平台</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/%E4%BA%91%E5%B9%B3%E5%8F%B0/Godaddy/" itemprop="url" rel="index"><span itemprop="name">Godaddy</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://developer.godaddy.com/getstarted">Godaddy API 参考文档</a></p>
<p>根据参考文档说明，获取到 <code>key</code> 和 <code>secret</code></p>
<p>Python3 sdk 可以使用 <code>godaddypy</code></p>
<h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Python 3.11.2</li>
<li>godaddypy</li>
</ul>
<p><code>godaddypy</code> 主要提供了 2 个类，分别为</p>
<ul>
<li><code>account</code> - 使用 <code>key</code> 和 <code>secret</code> 为 <code>client</code> 生成鉴权头部</li>
<li><code>client</code> - 连接 Godaddy API 并执行相应的请求</li>
</ul>
<p>具体使用方法可以查看帮助信息，或者查看 Godaddy API 参考文档</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">help</span>(godaddypy)</span><br></pre></td></tr></table></figure>
<h1 id="godaddypy-常见用法示例"><a href="#godaddypy-常见用法示例" class="headerlink" title="godaddypy 常见用法示例"></a>godaddypy 常见用法示例</h1><h2 id="获取账号中的所有域名"><a href="#获取账号中的所有域名" class="headerlink" title="获取账号中的所有域名"></a>获取账号中的所有域名</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> godaddypy</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ak = <span class="string">&#x27;AAAAAAAAAAAAAA&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sk = <span class="string">&#x27;BBBBBBBBBBBBBBB&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>account = godaddypy.Account(ak, sk)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>client = godaddypy.Client(account)</span><br></pre></td></tr></table></figure>
<p>根据 Godaddy API 文档说明，获取域名，每次默认获取 500 个，最多可以一次性获取 1000 个。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 获取域名，默认 100 个。如果账户内的域名数量少于 100，则一次性可以获取完毕，多于 100，获取前 100 个</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>client.get_domains()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取前 1000 个，最多一次性获取 1000 个。如果账户内的域名数量少于 1000，则一次性可以获取完毕，多于 1000，获取前 1000 个</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>client.get_domains(limit=<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 超过 1000 会报错</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>client.get_domains(limit=<span class="number">1001</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/usr/local/lib/python3.11/site-packages/godaddypy/client.py&quot;</span>, line <span class="number">105</span>, <span class="keyword">in</span> _validate_response_success</span><br><span class="line">    response.raise_for_status()</span><br><span class="line">  File <span class="string">&quot;/usr/local/lib/python3.11/site-packages/requests/models.py&quot;</span>, line <span class="number">1021</span>, <span class="keyword">in</span> raise_for_status</span><br><span class="line">    <span class="keyword">raise</span> HTTPError(http_error_msg, response=self)</span><br><span class="line">requests.exceptions.HTTPError: <span class="number">422</span> Client Error: Unprocessable Entity <span class="keyword">for</span> url: https://api.godaddy.com/v1/domains?limit=<span class="number">1001</span></span><br><span class="line"></span><br><span class="line">During handling of the above exception, another exception occurred:</span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/usr/local/lib/python3.11/site-packages/godaddypy/client.py&quot;</span>, line <span class="number">149</span>, <span class="keyword">in</span> get_domains</span><br><span class="line">    data = self._get_json_from_response(url, params=params)</span><br><span class="line">           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">  File <span class="string">&quot;/usr/local/lib/python3.11/site-packages/godaddypy/client.py&quot;</span>, line <span class="number">75</span>, <span class="keyword">in</span> _get_json_from_response</span><br><span class="line">    <span class="keyword">return</span> self._request_submit(requests.get, url=url, json=json, **kwargs).json()</span><br><span class="line">           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">  File <span class="string">&quot;/usr/local/lib/python3.11/site-packages/godaddypy/client.py&quot;</span>, line <span class="number">97</span>, <span class="keyword">in</span> _request_submit</span><br><span class="line">    self._validate_response_success(resp)</span><br><span class="line">  File <span class="string">&quot;/usr/local/lib/python3.11/site-packages/godaddypy/client.py&quot;</span>, line <span class="number">107</span>, <span class="keyword">in</span> _validate_response_success</span><br><span class="line">    <span class="keyword">raise</span> BadResponse(response.json())</span><br><span class="line">godaddypy.client.BadResponse: Response Data: &#123;<span class="string">&#x27;code&#x27;</span>: <span class="string">&#x27;VALUE_OVER&#x27;</span>, <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;Limit must have a value no greater than 1000&#x27;</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="../../202302251333/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202211291450/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202211291450/" class="post-title-link" itemprop="url">Kubernetes Volume 使用方法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-11-29 14:50:11" itemprop="dateCreated datePublished" datetime="2022-11-29T14:50:11+08:00">2022-11-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-11 17:30:37" itemprop="dateModified" datetime="2023-05-11T17:30:37+08:00">2023-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="常用-Volume-类型"><a href="#常用-Volume-类型" class="headerlink" title="常用 Volume 类型"></a>常用 Volume 类型</h1><p>以下是几种可用卷类型：</p>
<ul>
<li><code>emptyDir</code> - 用于存储临时数据的简单空目录，生命周期和 Pod 一致。</li>
<li><code>hostPath</code> - 用于将宿主机中的文件系统挂载到 Pod 中，生命周期不与 Pod 绑定。</li>
<li><code>gitRepo</code> - 通过拉取 Git 仓库的内容来初始化的卷。<strong>已弃用</strong></li>
<li><code>nfs</code> - 挂载到 Pod 中的 NFS 共享文件系统。</li>
<li><code>configMap</code>、<code>secret</code> - 用于将 Kubernetes 中的部分资源和集群信息公开给 Pod 的特殊类型的卷</li>
<li><code>persistentVolumeClaim</code> - 简称 PVC，使用预置和动态配置的持久卷。</li>
<li><code>downwardAPI</code> - 在不使用 Kubernetes 客户端或 API 服务器的情况下获得自己或集群的信息 <sup id="fnref:5"><a href="#fn:5" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Downward API](https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/downward-api/)">[5]</span></a></sup></li>
</ul>
<h1 id="emptyDir-卷"><a href="#emptyDir-卷" class="headerlink" title="emptyDir 卷"></a>emptyDir 卷</h1><p><code>emptyDir</code> 表示与 Pod 生命周期相同的临时目录。<sup id="fnref:4"><a href="#fn:4" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[emptyDir](https://kubernetes.io/zh-cn/docs/concepts/storage/volumes/#emptydir)
">[4]</span></a></sup></p>
<p>emptyDir 配置示例</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: test-pd</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: registry.k8s.io/test-webserver</span><br><span class="line">    name: test-container</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: /cache</span><br><span class="line">      name: cache-volume</span><br><span class="line">  volumes:</span><br><span class="line">  - name: cache-volume</span><br><span class="line">    emptyDir:</span><br><span class="line">      sizeLimit: 500Mi</span><br><span class="line">      medium: Memory</span><br></pre></td></tr></table></figure>
<ul>
<li><code>emptyDir.medium</code> - 表示此目录应使用哪种类别的存储介质，默认为 <code>&quot;&quot;</code>，表示使用节点的默认介质（一般是节点的本地磁盘）。可选值必须为 <code>&quot;&quot;</code> 或者 <code>Memory</code>， <code>Memory</code> 表示使用 <code>tmfs</code> (存在内存而非硬盘)</li>
</ul>
<h1 id="PersistentVolume-和-PersistentVolumeClaim"><a href="#PersistentVolume-和-PersistentVolumeClaim" class="headerlink" title="PersistentVolume 和 PersistentVolumeClaim"></a>PersistentVolume 和 PersistentVolumeClaim</h1><p><code>PersistentVolume (PV)</code>（持久化卷），是对底层的共享存储的一种抽象，PV 由管理员进行创建和配置，它和具体的底层的共享存储技术的实现方式有关，比如 <code>Ceph</code>、<code>GlusterFS</code>、<code>NFS</code> 等，都是通过插件机制完成与共享存储的对接。<sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[使用 PersistentVolume 作为存储](https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-persistent-volume-storage/)">[1]</span></a></sup></p>
<p><code>PersistentVolumeClaim（PVC）</code>是由用户发起的对存储的请求。 它类似于 Pod。 Pod 消耗节点资源，PVC 消耗 PV 资源。Pod 可以请求特定级别的资源（CPU和内存）。PVC 可以请求特定的存储大小和访问模式（例如，可以一次读&#x2F;写或多次只读）匹配的 PV。</p>
<p><code>PVC</code> 和 <code>PV</code> 中的 <code>spec</code> 关键字段要匹配，比如存储（storage）大小、读写模式，才能申请到对应的 PV 中的资源。PV 和 PVC 处于一一对应的关系。 <sup id="fnref:2"><a href="#fn:2" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[k8s存储持久化（nfs用例）](https://blog.51cto.com/u_15064627/4251683)">[2]</span></a></sup></p>
<p><code>PV</code> 可以设置三种回收策略：</p>
<ul>
<li>保留（Retain） - 保留产生的数据，PV 不进行处理</li>
<li>回收（Recycle） - 将执行清除操作，之后可以被新的pvc使用，需要插件支持。NFS 支持全部 3 种。</li>
<li>删除（Delete） - 删除pv和外部关联的存储资源，需要插件支持。</li>
</ul>
<p>PV卷阶段状态</p>
<ul>
<li><code>Available</code> – 资源尚未被 claim 使用</li>
<li><code>Bound</code> – 卷已经被绑定到 claim 了</li>
<li><code>Released</code> – claim 被删除，卷处于释放状态，但未被集群回收。</li>
<li><code>Failed</code> – 卷自动回收失败</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="../../202211291450/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202305030923/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202305030923/" class="post-title-link" itemprop="url">kubernetes Service 详解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-05-03 09:23:41" itemprop="dateCreated datePublished" datetime="2023-05-03T09:23:41+08:00">2023-05-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-04 11:47:29" itemprop="dateModified" datetime="2023-05-04T11:47:29+08:00">2023-05-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>Kubernetes 的 Service 代表的是 Kubernetes 后端服务的入口，它主要包含服务的访问 IP（虚拟 IP）和端口，工作在 L4.</p>
<p>Service 只存储服务的入口信息（IP:PORT），不存储后端 Pod 信息，Service 是通过 <a href="https://csms.tech/202209241108/#标签和选择算符"><code>Label Selector</code></a> 选择与之匹配的后端 Pod。当被 Service 选择的后端 Pod 运行且能正常向外提供服务时，Kubernetes 的 <code>Endpoint Controller</code> 会生成一个新的 Endpoint 对象，指向此 Pod 的 IP:PORT。Service 接收到访问请求，会将请求转发到对应的 Endpoint。同时，Service 的访问 IP 和 Endpoint&#x2F;Pod 的 IP 都会在 Kubernetes 的 DNS 服务里面进行注册以记录域名和 IP 的对应关系，因此用户可以在集群中通过域名的方式访问 Service 和 Pod。</p>
<p>用户创建 Service 后，Kubernetes 会从集群的可用服务 IP 池中为 Service 分配一个稳定的集群内访问 IP，称为 <strong>Cluster IP</strong>。Kubernetes 还会通过注册 DNS 条目为 <strong>Cluster IP</strong> 分配 <strong>域名</strong>（主机名）。<strong>Cluster IP</strong> 和 <strong>域名</strong> 在集群内是独一无二的，并且在服务的整个生命周期中保持不变，直到将 Service 从集群中删除，Kubernetes 才会释放 <strong>Cluster IP</strong> 和 <strong>域名</strong> 。通过此方法，Service 作为代理，向客户端提供了稳定不变的访问后端服务的入口。</p>
<p>Service 除了作为 <strong>代理</strong> 功能，同时也提供了 <strong>负载均衡</strong> 和 <strong>高可用</strong>。当后端的 Pod 有多个时，默认会通过 <strong>轮询</strong> 将请求流量均匀分布到多个 Pod 上，当某个 Pod 不可用是，Service 不会将请求调度到问题节点。</p>
<p>Kubernetes 使用节点上运行的 <code>kube-proxy</code> 组件管理各 Service 和后端 Pod 的连接。<code>kube-proxy</code> 是一个基于出战流量的 <strong>负载均衡控制器</strong>，它监控 Kubernetes API Service 并持续将 Service IP （ClusterIP）映射到运行状况良好的后端 Pod，具体实现是通过主机上的 <code>iptables/IPVS</code> 的规则。访问 Service 的 IP 会被这些（路由）规则直接 DNAT 到后端 Pod 的 IP。</p>
<p><a href="https://csms.tech/202209241108/#Service">Service 配置语法参考</a></p>
<h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Centos 7 3.10.0-1160</li>
<li>Kubernetes v1.24.7</li>
</ul>
<h1 id="kube-proxy-iptables-模式下的规则解析"><a href="#kube-proxy-iptables-模式下的规则解析" class="headerlink" title="kube-proxy iptables 模式下的规则解析"></a>kube-proxy iptables 模式下的规则解析</h1><p>kube-proxy 默认使用 <code>iptables</code> 模式实现 Service 的代理转发和负载均衡。<a href="https://csms.tech/202209131536/#获取节点上的-kube-proxy-代理模式">检查 <code>kube-proxy</code> 使用的代理模式</a></p>
<p>本示例使用相关信息如下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get services</span> </span><br><span class="line">NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)     AGE</span><br><span class="line">api-service      ClusterIP   10.106.126.96    &lt;none&gt;        10302/TCP   145d</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get endpoints api-service</span></span><br><span class="line">NAME          ENDPOINTS                               AGE</span><br><span class="line">api-service   10.244.3.138:10302,10.244.4.120:10302   145d</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>针对 <code>api-service</code>，后端的 Pod 就绪后，生成了 ENDPOINTS，kube-proxy 会为该服务创建以下 iptables 规则</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-A PREROUTING -m comment --comment &quot;kubernetes service portals&quot; -j KUBE-SERVICES</span><br><span class="line"></span><br><span class="line">-A KUBE-SERVICES -d 10.106.126.96/32 -p tcp -m comment --comment &quot;default/api-service:api-pord cluster IP&quot; -m tcp --dport 10302 -j KUBE-SVC-DVTQLPR6DVOLBZS4</span><br><span class="line"></span><br><span class="line">-A KUBE-SVC-DVTQLPR6DVOLBZS4 ! -s 10.244.0.0/16 -d 10.106.126.96/32 -p tcp -m comment --comment &quot;default/api-service:api-pord cluster IP&quot; -m tcp --dport 10302 -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SVC-DVTQLPR6DVOLBZS4 -m comment --comment &quot;default/api-service:api-pord -&gt; 10.244.3.138:10302&quot; -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-JXBL7O23XHVFQV2I</span><br><span class="line">-A KUBE-SVC-DVTQLPR6DVOLBZS4 -m comment --comment &quot;default/api-service:api-pord -&gt; 10.244.4.120:10302&quot; -j KUBE-SEP-BBPDSOPRICLINLPY</span><br><span class="line"></span><br><span class="line">-A KUBE-SEP-JXBL7O23XHVFQV2I -s 10.244.3.138/32 -m comment --comment &quot;default/api-service:api-pord&quot; -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-JXBL7O23XHVFQV2I -p tcp -m comment --comment &quot;default/api-service:api-pord&quot; -m tcp -j DNAT --to-destination 10.244.3.138:10302</span><br><span class="line"></span><br><span class="line">-A KUBE-SEP-BBPDSOPRICLINLPY -s 10.244.4.120/32 -m comment --comment &quot;default/api-service:api-pord&quot; -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-BBPDSOPRICLINLPY -p tcp -m comment --comment &quot;default/api-service:api-pord&quot; -m tcp -j DNAT --to-destination 10.244.4.120:10302</span><br><span class="line"></span><br><span class="line">-A POSTROUTING -m comment --comment &quot;flanneld masq&quot; -j FLANNEL-POSTRTG</span><br><span class="line">-A POSTROUTING -m comment --comment &quot;kubernetes postrouting rules&quot; -j KUBE-POSTROUTING-A FLANNEL-POSTRTG -m mark --mark 0x4000/0x4000 -m comment --comment &quot;flanneld masq&quot; -j RETURN</span><br><span class="line">-A FLANNEL-POSTRTG -s 10.244.0.0/16 -d 10.244.0.0/16 -m comment --comment &quot;flanneld masq&quot; -j RETURN</span><br><span class="line">-A FLANNEL-POSTRTG -s 10.244.0.0/16 ! -d 224.0.0.0/4 -m comment --comment &quot;flanneld masq&quot; -j MASQUERADE</span><br><span class="line">-A FLANNEL-POSTRTG ! -s 10.244.0.0/16 -d 10.244.3.0/24 -m comment --comment &quot;flanneld masq&quot; -j RETURN</span><br><span class="line">-A FLANNEL-POSTRTG ! -s 10.244.0.0/16 -d 10.244.0.0/16 -m comment --comment &quot;flanneld masq&quot; -j MASQUERADE</span><br><span class="line"></span><br><span class="line">-A KUBE-POSTROUTING -m mark ! --mark 0x4000/0x4000 -j RETURN</span><br><span class="line">-A KUBE-POSTROUTING -j MARK --set-xmark 0x4000/0x0</span><br><span class="line">-A KUBE-POSTROUTING -m comment --comment &quot;kubernetes service traffic requiring SNAT&quot; -j MASQUERADE</span><br></pre></td></tr></table></figure>
<p>具体工作流程如下：</p>
<ol>
<li>所有进入 <code>PREROUTING</code> 链的流量会被跳转到 <code>KUBE-SERVICES</code> 自定义链</li>
<li>本示例中请求 <code>api-service</code> 的访问数据包（目的地址为 <code>10.106.126.96:10302</code>）在 <code>PREROUTING</code> 链中被 <code>-d 10.106.126.96/32 -p tcp -m comment --comment &quot;default/api-service:api-pord cluster IP&quot; -m tcp --dport 10302</code> 匹配到，根据规则跳转到自定义链 <code>KUBE-SVC-DVTQLPR6DVOLBZS4</code></li>
<li>在自定义链 <code>KUBE-SVC-DVTQLPR6DVOLBZS4</code> 中，实现了负载均衡，一半的流量会被跳转到链 <code>KUBE-SEP-JXBL7O23XHVFQV2I</code>，另一半的流量会被跳转到 <code>KUBE-SEP-BBPDSOPRICLINLPY</code></li>
<li>在自定义链 <code>KUBE-SEP-JXBL7O23XHVFQV2I</code> 和 <code>KUBE-SEP-BBPDSOPRICLINLPY</code> 中，流量分别被 DNAT 分配到了后端的 Pod（就绪的 Endpoints）。</li>
<li>Pod 处理完数据请求，向客户端返回请求结果时，在 <code>POSTROUTING</code> 链上要对数据包做 SNAT 处理，以确保客户端接收到的数据包的源地址是其发送请求时的目标地址。</li>
</ol>
<p>通过以上 kube-proxy 管理的规则，Service 实现了对后端 Pod 的服务代理及负载均衡功能。</p>
<p>综上所述，iptables 模式最主要的链是 <code>KUBE-SERVICES</code> 、<code>KUBE-SVC-*</code>、<code>KUBE-SEP-*</code></p>
<ul>
<li><code>KUBE-SERVICES</code> - 访问集群服务的数据包入口，它会根据匹配到的目标 IP:PORT 将数据包分发到相应的链 <code>KUBE-SVC-*</code></li>
<li><code>KUBE-SVC-*</code> - 相当于一个负载均衡器，它会将数据包平均分配到 <code>KUBE-SEP-*</code> 链。每个 <code>KUBE-SVC-*</code> 链后面的 <code>KUBE-SEP-*</code> 链的数量和 Service 后端就绪的 Pod 数量一致。</li>
<li><code>KUBE-SEP-*</code> - 通过 DNAT 将数据包的目的地址（IP:PORT）修改为后端就绪的 Pod 的 IP:PORT，从而将流量转发到相应的 Pod</li>
</ul>
<p><code>kube-proxy</code> 的 iptables 模式因为使用 DNAT 转发数据包，存在一定的性能损耗，另外，当集群中的 Service 数量上万时，节点上的 iptables rules 会非常庞大，对管理是个不小的负担，性能也会大打折扣。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202305031339/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202305031339/" class="post-title-link" itemprop="url">kubernetes dns</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-05-03 09:23:41 / 修改时间：09:23:47" itemprop="dateCreated datePublished" datetime="2023-05-03T09:23:41+08:00">2023-05-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Centos 7 5.4.225-1</li>
<li>Kubernetes v1.24.7</li>
</ul>
<p>Kubernetes DNS 服务的功能，是用来解析 Kubernetes 集群内的 Pod 和 Service 的域名，一般只供集群内部使用，不给外部使用。</p>
<p>默认情况下，Kubernetes DNS 应用部署后，会对外暴露一个 Service，集群内的容器通过访问该 Service 获得域名解析服务，这个 Service 的 ClusterIP 一般情况下都是固定的。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get services -n kube-system -o wide</span></span><br><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE    SELECTOR</span><br><span class="line">kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   147d   k8s-app=kube-dns</span><br></pre></td></tr></table></figure>

<p>当 Kubernetes DNS 服务获得 ClusterIP 后，系统会给 Kubelet 配置启动参数指定 DNS Service 的 ClusterIP，DNS Service 的 IP 会在容器启动时传入，并写入容器系统的 DNS 配置中（一般为 <code>/etc/resolv.conf</code> 文件）</p>
<p>根据 <code>kubelet</code> 服务的启动命令，配置参数可以写在以下相关配置文件中</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemctl status kubelet -l</span></span><br><span class="line">● kubelet.service - kubelet: The Kubernetes Node Agent</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled)</span><br><span class="line">  Drop-In: /usr/lib/systemd/system/kubelet.service.d</span><br><span class="line">           └─10-kubeadm.conf</span><br><span class="line">   Active: active (running) since Tue 2023-05-02 16:06:16 CST; 21h ago</span><br><span class="line">     Docs: https://kubernetes.io/docs/</span><br><span class="line"> Main PID: 1413 (kubelet)</span><br><span class="line">    Tasks: 29</span><br><span class="line">   Memory: 203.0M</span><br><span class="line">   CGroup: /system.slice/kubelet.service</span><br><span class="line">           └─1413 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf \</span><br><span class="line">                                   --kubeconfig=/etc/kubernetes/kubelet.conf \</span><br><span class="line">                                   --config=/var/lib/kubelet/config.yaml \</span><br><span class="line">                                   --container-runtime=remote \</span><br><span class="line">                                   --container-runtime-endpoint=unix:///var/run/cri-dockerd.sock \</span><br><span class="line">                                   --pod-infra-container-image=k8s.gcr.io/pause:3.7</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ps aux | grep kubelet</span></span><br><span class="line">/usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf 、</span><br><span class="line">                 --kubeconfig=/etc/kubernetes/kubelet.conf \</span><br><span class="line">                 --config=/var/lib/kubelet/config.yaml \</span><br><span class="line">                 --container-runtime=remote \</span><br><span class="line">                 --container-runtime-endpoint=unix:///var/run/cri-dockerd.sock \</span><br><span class="line">                 --pod-infra-container-image=k8s.gcr.io/pause:3.7</span><br></pre></td></tr></table></figure>
<p>DNS 的相关配置在文件 <code>/var/lib/kubelet/config.yaml</code> 中，主要选项为 <code>clusterDNS</code></p>
<figure class="highlight shell"><figcaption><span>/var/lib/kubelet/config.yaml</span></figcaption><table><tr><td class="code"><pre><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /etc/kubernetes/pki/ca.crt</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 0s</span><br><span class="line">    cacheUnauthorizedTTL: 0s</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">cpuManagerReconcilePeriod: 0s</span><br><span class="line">evictionPressureTransitionPeriod: 0s</span><br><span class="line">fileCheckFrequency: 0s</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">httpCheckFrequency: 0s</span><br><span class="line">imageMinimumGCAge: 0s</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">logging:</span><br><span class="line">  flushFrequency: 0</span><br><span class="line">  options:</span><br><span class="line">    json:</span><br><span class="line">      infoBufferSize: &quot;0&quot;</span><br><span class="line">  verbosity: 0</span><br><span class="line">memorySwap: &#123;&#125;</span><br><span class="line">nodeStatusReportFrequency: 0s</span><br><span class="line">nodeStatusUpdateFrequency: 0s</span><br><span class="line">rotateCertificates: true</span><br><span class="line">runtimeRequestTimeout: 0s</span><br><span class="line">shutdownGracePeriod: 0s</span><br><span class="line">shutdownGracePeriodCriticalPods: 0s</span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">streamingConnectionIdleTimeout: 0s</span><br><span class="line">syncFrequency: 0s</span><br><span class="line">volumeStatsAggPeriod: 0s</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="../../202305031339/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202208191637/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202208191637/" class="post-title-link" itemprop="url">Centos VNC server 配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-08-19 16:37:09" itemprop="dateCreated datePublished" datetime="2022-08-19T16:37:09+08:00">2022-08-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-02 13:36:44" itemprop="dateModified" datetime="2023-05-02T13:36:44+08:00">2023-05-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Centos 7</li>
</ul>
<p><code>VNC</code> 是一个图形桌面共享系统，可以通过远程连接的方式连接到服务器的图形系统以控制操作系统<br><code>VNC</code> 包括以下四个部分 ： <code>vncserver</code>，<code>vncviewer</code>，<code>vncpassword</code> 及 <code>vncconnect</code>。<br><code>VNC client</code> 端通过 <code>VNC</code> 协议远程连接到 <code>vnc server</code> 端，进行桌面共享及交互；  </p>
<h1 id="安装-tigervnc"><a href="#安装-tigervnc" class="headerlink" title="安装 tigervnc"></a>安装 tigervnc</h1><p>安装之前首先要确保系统已安装图形系统，本文以 <code>GNOME Desktop</code> 为图形桌面系统，执行以下命令检查是否已安装 <code>GNOME Desktop</code>，如果未安装，使用命令 <code>yum groupinstall &quot;GNOME Desktop&quot;</code> 安装</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">yum grouplist</span></span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">Installed Environment Groups:</span><br><span class="line">   GNOME Desktop</span><br><span class="line">Available Environment Groups:</span><br><span class="line">   Minimal Install</span><br><span class="line">   Compute Node</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>桌面系统安装后，使用以下命令，安装 <code>tigervnc</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y tigervnc-server</span><br></pre></td></tr></table></figure>

<p>可以参考 <code>/lib/systemd/system/vncserver@.service</code> 中的指示，生成服务配置文件：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cp /lib/systemd/system/vncserver@.service /etc/systemd/system/vncserver@:1.service</span><br><span class="line">vim /etc/systemd/system/vncserver@\:1.service</span><br></pre></td></tr></table></figure>
<p>修改以下行，将其中的 <code>&lt;USER&gt;</code> 改为要远程登录的用户名，例如 <code>root</code></p>
<figure class="highlight shell"><figcaption><span>/etc/systemd/system/vncserver@\:1.service</span></figcaption><table><tr><td class="code"><pre><span class="line">ExecStart=/usr/bin/vncserver_wrapper root %i</span><br></pre></td></tr></table></figure>

<p>如果有多个用户需要远程连接，可以重复以上步骤，建立多个配置文件，如 <code>/etc/systemd/system/vncserver@:2.service</code>，各个服务之间互不影响，关闭一个服务，不影响其他的 <code>vnc</code> 服务 (如关闭： <code>vncserver@:2.service</code>，<code>vncserver@:1.service</code>的 <code>vnc</code> 远程依旧可以使用)  </p>
<p>修改服务文件后，使用以下命令重新加载服务启动脚本：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>

<p>启动服务：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl start vncserver@:1.service</span><br></pre></td></tr></table></figure>
<p>服务启动后，会监听 5901 端口，如果有第二个服务，会监听在 5902 端口，以此类推，防火墙需要放通此端口<br><img src="https://i.csms.tech/img_41.png"></p>
<p>切换到需要 vnc 远程登录的用户，使用以下命令配置 <code>vnc</code> 远程登录用户的密码(只是 vnc 登录时使用的密码，非系统用户密码)</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# su - USER</span><br><span class="line">[USER@localhost ~]$ vncpasswd</span><br></pre></td></tr></table></figure>
<p>设置 <code>vncpasswd</code> 密码后，在账号的家目录里就会自动建立 .vnc 文件，其中包括对应用户的 <code>vnc</code> 相关的日志</p>
<p>配置完成后，<a target="_blank" rel="noopener" href="https://www.realvnc.com/en/connect/download/viewer/">下载客户端</a> 进行远程登录</p>
<h1 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h1><h2 id="getpassword-error-Inappropriate-ioctl-for-device"><a href="#getpassword-error-Inappropriate-ioctl-for-device" class="headerlink" title="getpassword error: Inappropriate ioctl for device"></a>getpassword error: Inappropriate ioctl for device</h2><p><code>vncserver@:1.service</code> 服务启动失败，端口未监听</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">netstat -anutp | grep LIST</span></span><br><span class="line">tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      735/rpcbind         </span><br><span class="line">tcp6       0      0 :::30000                :::*                    LISTEN      1251/sshd           </span><br><span class="line">tcp6       0      0 :::80                   :::*                    LISTEN      17064/nginx: master </span><br><span class="line">tcp6       0      0 :::8181                 :::*                    LISTEN      17064/nginx: master </span><br><span class="line">tcp6       0      0 :::8443                 :::*                    LISTEN      14032/nginx-ingress </span><br><span class="line">tcp6       0      0 :::443                  :::*                    LISTEN      17064/nginx: master </span><br><span class="line">tcp6       0      0 :::10254                :::*                    LISTEN      14032/nginx-ingress </span><br><span class="line">tcp6       0      0 :::111                  :::*                    LISTEN      735/rpcbind</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemctl status vncserver@:1.service</span></span><br><span class="line">● vncserver@:1.service - Remote desktop service (VNC)</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/vncserver@:1.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: failed (Result: exit-code) since Tue 2023-05-02 13:29:44 CST; 14s ago</span><br><span class="line">  Process: 28040 ExecStart=/usr/bin/vncserver_wrapper root %i (code=exited, status=2)</span><br><span class="line">  Process: 28037 ExecStartPre=/bin/sh -c /usr/bin/vncserver -kill %i &gt; /dev/null 2&gt;&amp;1 || : (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 28040 (code=exited, status=2)</span><br><span class="line"></span><br><span class="line">May 02 13:29:44 test systemd[1]: Starting Remote desktop service (VNC)...</span><br><span class="line">May 02 13:29:44 test systemd[1]: Started Remote desktop service (VNC).</span><br><span class="line">May 02 13:29:44 test vncserver_wrapper[28040]: You will require a password to access your desktops.</span><br><span class="line">May 02 13:29:44 test vncserver_wrapper[28040]: getpassword error: Inappropriate ioctl for device</span><br><span class="line">May 02 13:29:44 test vncserver_wrapper[28040]: Password:FATAL: &#x27;runuser -l root&#x27; failed!</span><br><span class="line">May 02 13:29:44 test systemd[1]: vncserver@:1.service: main process exited, code=exited, status=2/INVALIDARGUMENT</span><br><span class="line">May 02 13:29:44 test systemd[1]: Unit vncserver@:1.service entered failed state.</span><br><span class="line">May 02 13:29:44 test systemd[1]: vncserver@:1.service failed.    </span><br></pre></td></tr></table></figure>

<p><strong>解决方法</strong> 配置登陆用的 VNC 密码，重启服务</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">su - root</span><br><span class="line">vncpasswd</span><br><span class="line"></span><br><span class="line">systemctl start vncserver@:1.service</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202304031041/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202304031041/" class="post-title-link" itemprop="url">Vmware workstation 使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-03 10:41:48" itemprop="dateCreated datePublished" datetime="2023-04-03T10:41:48+08:00">2023-04-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-02 11:15:13" itemprop="dateModified" datetime="2023-05-02T11:15:13+08:00">2023-05-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Tools/" itemprop="url" rel="index"><span itemprop="name">Tools</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Vmware workstation 17</li>
</ul>
<p><a href="!--swig%EF%BF%BC3--">其他下载地址</a></p>
<p>激活密钥： NZ4RR-FTK5H-H81C1-Q30QH-1V2LA</p>
<h1 id="Centos7-server-中安装使用-Vmware-workstation"><a href="#Centos7-server-中安装使用-Vmware-workstation" class="headerlink" title="Centos7 server 中安装使用 Vmware workstation"></a>Centos7 server 中安装使用 Vmware workstation</h1><p><a target="_blank" rel="noopener" href="https://www.51ittech.com/knowledge-base/centos-7-install-vmware-workstation-15/">Centos 7 server版本（无图形界面）安装使用 Vmware workstation 参考链接</a></p>
<h1 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h1><h2 id="VMware-Workstation-and-Hyper-V-are-not-compatible-Remove-the-Hyper-V-role-from-the-system-before-running-VMware-Workstation"><a href="#VMware-Workstation-and-Hyper-V-are-not-compatible-Remove-the-Hyper-V-role-from-the-system-before-running-VMware-Workstation" class="headerlink" title="VMware Workstation and Hyper-V are not compatible. Remove the Hyper-V role from the system before running VMware Workstation."></a>VMware Workstation and Hyper-V are not compatible. Remove the Hyper-V role from the system before running VMware Workstation.</h2><p>aws workspace 中不兼容 Vmware workstation</p>
<h2 id="Failed-to-start-SYSV-This-service-starts-and-stops-VMware-services"><a href="#Failed-to-start-SYSV-This-service-starts-and-stops-VMware-services" class="headerlink" title="Failed to start SYSV: This service starts and stops VMware services."></a>Failed to start SYSV: This service starts and stops VMware services.</h2><p>参考 <a href="#Centos7-server-%E4%B8%AD%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8-Vmware-workstation">Centos7 server 中安装使用 Vmware workstation</a> ，安装后，vmware 无法启动</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etc/rc.d/init.d/vmware start</span></span><br><span class="line">Starting vmware (via systemctl):  Job for vmware.service failed because the control process exited with error code. See &quot;systemctl status vmware.service&quot; and &quot;journalctl -xe&quot; for details.</span><br><span class="line">                                                           [FAILED]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">journalctl -xe -u vmware</span></span><br><span class="line">-- </span><br><span class="line">-- Unit vmware.service has failed.</span><br><span class="line">-- </span><br><span class="line">-- The result is failed.</span><br><span class="line">May 02 11:13:39 k8s-uat-xhy-mysql-new systemd[1]: Unit vmware.service entered failed state.</span><br><span class="line">May 02 11:13:39 k8s-uat-xhy-mysql-new systemd[1]: vmware.service failed.</span><br><span class="line">May 02 11:19:37 k8s-uat-xhy-mysql-new systemd[1]: Starting SYSV: This service starts and stops VMware services...</span><br><span class="line">-- Subject: Unit vmware.service has begun start-up</span><br><span class="line">-- Defined-By: systemd</span><br><span class="line">-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel</span><br><span class="line">-- </span><br><span class="line">-- Unit vmware.service has begun starting up.</span><br><span class="line">May 02 11:19:37 k8s-uat-xhy-mysql-new vmware[22226]: Starting VMware services:</span><br><span class="line">May 02 11:19:37 k8s-uat-xhy-mysql-new vmware[22226]: Virtual machine monitor[FAILED]</span><br><span class="line">May 02 11:19:37 k8s-uat-xhy-mysql-new vmware[22226]: Virtual machine communication interface[  OK  ]</span><br><span class="line">May 02 11:19:37 k8s-uat-xhy-mysql-new vmware[22226]: VM communication interface socket family[  OK  ]</span><br><span class="line">May 02 11:19:37 k8s-uat-xhy-mysql-new vmware[22226]: Virtual ethernet[FAILED]</span><br><span class="line">May 02 11:19:37 k8s-uat-xhy-mysql-new vmware[22226]: VMware Authentication Daemon[  OK  ]</span><br><span class="line">May 02 11:19:37 k8s-uat-xhy-mysql-new systemd[1]: vmware.service: control process exited, code=exited status=1</span><br><span class="line">May 02 11:19:37 k8s-uat-xhy-mysql-new systemd[1]: Failed to start SYSV: This service starts and stops VMware services.</span><br><span class="line">-- Subject: Unit vmware.service has failed</span><br><span class="line">-- Defined-By: systemd</span><br><span class="line">-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel</span><br><span class="line">-- </span><br><span class="line">-- Unit vmware.service has failed.</span><br><span class="line">-- </span><br><span class="line">-- The result is failed.</span><br><span class="line">May 02 11:19:37 k8s-uat-xhy-mysql-new systemd[1]: Unit vmware.service entered failed state.</span><br><span class="line">May 02 11:19:37 k8s-uat-xhy-mysql-new systemd[1]: vmware.service failed.</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行以下命令 <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Failed to start SYSV: This service starts and stops VMware services.](https://communities.vmware.com/t5/VMware-Workstation-Pro/Failed-to-start-SYSV-This-service-starts-and-stops-VMware/td-p/2318180)">[1]</span></a></sup></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">vmware-modconfig --console --install-status</span></span><br><span class="line">[AppLoader] GLib does not have GSettings support.</span><br><span class="line">vmmon: unknown</span><br><span class="line">vmnet: unknown</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>查看内核版本</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">uname</span> -r</span></span><br><span class="line">3.10.0-1062.9.1.el7.x86_64</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h1><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://communities.vmware.com/t5/VMware-Workstation-Pro/Failed-to-start-SYSV-This-service-starts-and-stops-VMware/td-p/2318180">Failed to start SYSV: This service starts and stops VMware services.</a><a href="#fnref:1" rev="footnote"> ↩</a></span></li></ol></div></div>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202212020941/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202212020941/" class="post-title-link" itemprop="url">Kubernetes 网络</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-12-02 09:41:16" itemprop="dateCreated datePublished" datetime="2022-12-02T09:41:16+08:00">2022-12-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-04-27 13:50:01" itemprop="dateModified" datetime="2023-04-27T13:50:01+08:00">2023-04-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Centos7 3.10.0-1160</li>
<li>Docker Engine - Community 23.0.3</li>
<li>kubernetes 1.21.2-0</li>
<li>kubernetes-cni-0.8.7-0</li>
</ul>
<p>Kubernetes 对任何网络实现都规定了以下要求： <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[万字长文，带你搞懂 Kubernetes 网络模型](https://www.51cto.com/article/714336.html)">[1]</span></a></sup></p>
<ul>
<li><p><strong>所有 Pod 都可以在不使用网络地址转换 (NAT) 的情况下与所有其他 Pod 通信。</strong></p>
<p>  容器之间直接通信，不需要额外的 NAT，不存在源地址伪装的情况</p>
</li>
<li><p><strong>所有节点都可以在没有 NAT 的情况下与所有 Pod 通信。</strong></p>
<p>  Node 与容器直接通信，不需要额外的 NAT</p>
</li>
<li><p><strong>Pod 认为自己的 IP 与其他人认为的 IP 相同。</strong></p>
</li>
</ul>
<h1 id="CNI"><a href="#CNI" class="headerlink" title="CNI"></a>CNI</h1><p>CNI 是 Kubernetes 容器网络的标准，CNI 是 Kubernetes 和底层网络插件之间的一个抽象层，为 Kubernetes 屏蔽了底层网络实现的负责度，同时解耦了 Kubernetes 和具体的网络插件实现。</p>
<h2 id="安装-CNI"><a href="#安装-CNI" class="headerlink" title="安装 CNI"></a>安装 CNI</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">yum install kubernetes-cni</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rpm -qa | grep kube</span></span><br><span class="line">kubeadm-1.21.2-0.x86_64</span><br><span class="line">kubectl-1.21.2-0.x86_64</span><br><span class="line">kubelet-1.21.2-0.x86_64</span><br><span class="line">kubernetes-cni-0.8.7-0.x86_64</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rpm -ql kubernetes-cni-0.8.7-0</span></span><br><span class="line">/opt/cni</span><br><span class="line">/opt/cni/bin</span><br><span class="line">/opt/cni/bin/bandwidth</span><br><span class="line">/opt/cni/bin/bridge</span><br><span class="line">/opt/cni/bin/dhcp</span><br><span class="line">/opt/cni/bin/firewall</span><br><span class="line">/opt/cni/bin/flannel</span><br><span class="line">/opt/cni/bin/host-device</span><br><span class="line">/opt/cni/bin/host-local</span><br><span class="line">/opt/cni/bin/ipvlan</span><br><span class="line">/opt/cni/bin/loopback</span><br><span class="line">/opt/cni/bin/macvlan</span><br><span class="line">/opt/cni/bin/portmap</span><br><span class="line">/opt/cni/bin/ptp</span><br><span class="line">/opt/cni/bin/sbr</span><br><span class="line">/opt/cni/bin/static</span><br><span class="line">/opt/cni/bin/tuning</span><br><span class="line">/opt/cni/bin/vlan</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Kubernetes 要使用 CNI，需要在 kubelet 启动时配置启动参数 <code>--network-plugin=cni</code>（默认配置，可使用 <code>systemctl status kubelet -l</code> 查看启动参数）。</p>
<p>kubelet 从 <code>--cni-config-dir</code> （默认为 <code>/etc/cni/net.d/</code>）中读取网络插件的配置文件，并使用该文件中的 CNI 配置来配置每个 Pod 网络。如果该目录 （<code>/etc/cni/net.d/</code>）中有多个配置文件，则使用文件名字典序列中的第一个文件。</p>
<p>CNI 插件的二进制文件放置的目录是通过 kubelet 的 <code>--cni-bin-dir</code> 参数指定，默认为 <code>/opt/cni/bin/</code></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="../../202212020941/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202304261014/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202304261014/" class="post-title-link" itemprop="url">linux rabbitmq</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-04-26 10:14:17 / 修改时间：10:14:22" itemprop="dateCreated datePublished" datetime="2023-04-26T10:14:17+08:00">2023-04-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Centos7 3.10.0-1160.45.1.el7</li>
<li>RabbitMQ 3.9.10</li>
</ul>
<h1 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h1><h2 id="RabbitMQ-启动失败"><a href="#RabbitMQ-启动失败" class="headerlink" title="RabbitMQ 启动失败"></a>RabbitMQ 启动失败</h2><p>使用命令启动，报错</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/sbin/rabbitmq-server -v</span></span><br><span class="line">2023-04-26 10:02:47.621248+08:00 [noti] &lt;0.146.0&gt; Protocol &#x27;inet_tcp&#x27;: register/listen error: ehostunreach</span><br><span class="line">2023-04-26 10:02:47.621248+08:00 [noti] &lt;0.146.0&gt; </span><br><span class="line">2023-04-26 10:02:47.626643+08:00 [erro] &lt;0.143.0&gt;     supervisor: &#123;local,net_sup&#125;</span><br><span class="line">2023-04-26 10:02:47.626643+08:00 [erro] &lt;0.143.0&gt;     errorContext: start_error</span><br><span class="line">2023-04-26 10:02:47.626643+08:00 [erro] &lt;0.143.0&gt;     reason: &#123;&#x27;EXIT&#x27;,nodistribution&#125;</span><br><span class="line">2023-04-26 10:02:47.626643+08:00 [erro] &lt;0.143.0&gt;     offender: [&#123;pid,undefined&#125;,</span><br><span class="line">2023-04-26 10:02:47.626643+08:00 [erro] &lt;0.143.0&gt;                &#123;id,net_kernel&#125;,</span><br><span class="line">2023-04-26 10:02:47.626643+08:00 [erro] &lt;0.143.0&gt;                &#123;mfargs,&#123;net_kernel,start_link,</span><br><span class="line">2023-04-26 10:02:47.626643+08:00 [erro] &lt;0.143.0&gt;                                    [[rabbit_prelaunch_21812@localhost,</span><br><span class="line">2023-04-26 10:02:47.626643+08:00 [erro] &lt;0.143.0&gt;                                      shortnames],</span><br><span class="line">2023-04-26 10:02:47.626643+08:00 [erro] &lt;0.143.0&gt;                                     false,net_sup_dynamic]&#125;&#125;,</span><br><span class="line">2023-04-26 10:02:47.626643+08:00 [erro] &lt;0.143.0&gt;                &#123;restart_type,permanent&#125;,</span><br><span class="line">2023-04-26 10:02:47.626643+08:00 [erro] &lt;0.143.0&gt;                &#123;shutdown,2000&#125;,</span><br><span class="line">2023-04-26 10:02:47.626643+08:00 [erro] &lt;0.143.0&gt;                &#123;child_type,worker&#125;]</span><br></pre></td></tr></table></figure>

<p>关键错误信息 <code>Protocol &#39;inet_tcp&#39;: register/listen error: ehostunreach</code>，根据提示，可能是某个地址不可达，rabbitmq 启动时需要连接 epmd ，默认端口为 4369，在本地测试连接此端口，发现不通 <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Protocol 'inet_tcp': register/listen error: econnrefused](https://stackoverflow.com/questions/51616600/ssh-rabbitmq-protocol-inet-tcp-register-listen-error-econnrefused)">[1]</span></a></sup></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -v 127.0.0.1:4369</span></span><br><span class="line">* About to connect() to 127.0.0.1 port 4369 (#0)</span><br><span class="line">*   Trying 127.0.0.1...</span><br><span class="line">* No route to host</span><br><span class="line">* Failed connect to 127.0.0.1:4369; No route to host</span><br><span class="line">* Closing connection 0</span><br><span class="line">curl: (7) Failed connect to 127.0.0.1:4369; No route to host</span><br></pre></td></tr></table></figure>
<p>根据输出的错误可知，是因为 <code>127.0.0.1</code> 无法连接，检查 iptables 防火墙策略，发现未允许回环网卡访问，在 iptables 中添加以下规则允许回环网卡访问</p>
<figure class="highlight shell"><figcaption><span>/etc/sysconfig/iptables</span></figcaption><table><tr><td class="code"><pre><span class="line">*filter</span><br><span class="line">:INPUT DROP [0:0]</span><br><span class="line">:FORWARD DROP [0:0]</span><br><span class="line">:OUTPUT ACCEPT [9020367577:7010759848370]</span><br><span class="line">-A INPUT -i lo -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>允许回环网卡访问后，重新测试连接 epmd ，可以正常连接，重新启动 rabbitmq-server 正常。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -v 127.0.0.1:4369</span></span><br><span class="line">* About to connect() to 127.0.0.1 port 4369 (#0)</span><br><span class="line">*   Trying 127.0.0.1...</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 4369 (#0)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">GET / HTTP/1.1</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">User-Agent: curl/7.29.0</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Host: 127.0.0.1:4369</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Accept: */*</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">* Empty reply from server</span></span><br><span class="line">* Connection #0 to host 127.0.0.1 left intact</span><br><span class="line">curl: (52) Empty reply from server</span><br></pre></td></tr></table></figure>

<h1 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h1><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/51616600/ssh-rabbitmq-protocol-inet-tcp-register-listen-error-econnrefused">Protocol 'inet_tcp': register/listen error: econnrefused</a><a href="#fnref:1" rev="footnote"> ↩</a></span></li></ol></div></div>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202304031317/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202304031317/" class="post-title-link" itemprop="url">linux network namespace 使用说明</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-03 10:41:48" itemprop="dateCreated datePublished" datetime="2023-04-03T10:41:48+08:00">2023-04-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-04-25 10:32:11" itemprop="dateModified" datetime="2023-04-25T10:32:11+08:00">2023-04-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Linux/network/" itemprop="url" rel="index"><span itemprop="name">network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Centos 7 5.4.239-1</li>
</ul>
<p>Linux 的 namespace 的作用是 <code>隔离内核资源</code>，目前主要实现了以下 namespace</p>
<ul>
<li><code>mount namespace</code> - 文件系统挂载点</li>
<li><code>UTS namespace</code> - 主机名</li>
<li><code>IPC namespace</code> - POSIX 进程间通信消息队列</li>
<li><code>PID namespace</code> - 进程 pid 数字空间</li>
<li><code>network namespace</code> - network</li>
<li><code>user namespace</code> - user ID 数字空间</li>
</ul>
<p>其中，除了 <code>network namespace</code>，其他 namespace 的操作需要使用 C 语言调用系统 API 实现。<code>network namespace</code> 的增删改查功能已经集成到了 Linux 的 <code>ip</code> 工具集的 <code>netns</code> 子命令中</p>
<p>Linux 里面的 namespace 给处在其中的进程造成 2 个错觉：</p>
<ol>
<li>它是系统里面唯一的进程</li>
<li>它独享系统的所有资源</li>
</ol>
<p>默认情况下，Linux 里面的所有进程处在和宿主机相同的 namespace ，即初始 namespace 里，默认享有全局系统资源。</p>
<h1 id="network-namespace-常用操作"><a href="#network-namespace-常用操作" class="headerlink" title="network namespace 常用操作"></a>network namespace 常用操作</h1><p>network namespace 的增删改查功能已经集成到了 Linux 的 <code>ip</code> 工具集的 <code>netns</code> 子命令中，因此在 Linux 系统中，对 network namespace 的操作主要使用 <code>ip netns</code> 命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">help</span></span></span><br><span class="line">Usage: ip netns list</span><br><span class="line">       ip netns add NAME</span><br><span class="line">       ip netns set NAME NETNSID</span><br><span class="line">       ip [-all] netns delete [NAME]</span><br><span class="line">       ip netns identify [PID]</span><br><span class="line">       ip netns pids NAME</span><br><span class="line">       ip [-all] netns exec [NAME] cmd ...</span><br><span class="line">       ip netns monitor</span><br><span class="line">       ip netns list-id</span><br></pre></td></tr></table></figure>
<h2 id="创建并查看-network-namespace"><a href="#创建并查看-network-namespace" class="headerlink" title="创建并查看 network namespace"></a>创建并查看 network namespace</h2><p>使用以下命令创建名为 <code>netns1</code> 的 <code>network namespace</code> </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ip netns add netns1</span><br></pre></td></tr></table></figure>

<p>以下命令查看系统中的 <code>network namespace</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns list</span></span><br><span class="line">netns1</span><br></pre></td></tr></table></figure>
<p>新的 <code>network namespace</code> 创建后，系统会在 <code>/var/run/netns/</code> 下面生成一个同名的挂载点</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -l /var/run/netns/</span></span><br><span class="line">total 0</span><br><span class="line">-r--r--r-- 1 root root 0 Apr  3 13:33 netns1</span><br></pre></td></tr></table></figure>

<p>此挂载点的主要作用一方面是方便对 namespace 的管理，一方面是使 namespace 即使没有进程运行也能继续存在。</p>
<p>新的 <code>network namespace</code> 创建后，可以使用 <code>ip netns exec</code> 命令进入 namespace，做网络配置或者查询的工作。</p>
<blockquote>
<p><code>ip netns exec</code> 命令只能根据 network namespace 的名称进入 namespace</p>
</blockquote>
<p>以下命令查询 <code>netns1</code> 的 <code>network namespace</code> 的 IP 地址信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">exec</span> netns1 ip add</span></span><br><span class="line">1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br></pre></td></tr></table></figure>
<p>默认的 <code>network namespace</code> 除了附带一个 <code>lo</code> 网卡外，没有任何其他网络设备，并且此 <code>lo</code> 接口还处于 <code>DOWN</code> 的状态，因此此回环网卡也是不可访问的。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">exec</span> netns1 ping 127.0.0.1</span></span><br><span class="line">connect: Network is unreachable</span><br></pre></td></tr></table></figure>

<p>在此示例中，如果想启用本地回环地址，首先需要进入 namespace，将本地回环网卡的状态修改为 <code>UP</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">exec</span> netns1 ip <span class="built_in">link</span> <span class="built_in">set</span> dev lo up</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">exec</span> netns1 ip add</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">exec</span> netns1 ping 127.0.0.1</span></span><br><span class="line">PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.021 ms</span><br><span class="line">^C</span><br><span class="line">--- 127.0.0.1 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.021/0.021/0.021/0.000 ms</span><br></pre></td></tr></table></figure>

<p>此时，namespace 中的 <code>lo</code> 网卡可以正常使用，但是因为 namespace 中没有其他网络设备，此 <code>network namespace</code> 无法和其他网络通信，要和其他网络通信，需要用到其他的网络技术，例如 <a href="#veth-pair"><code>veth pair</code></a></p>
<h2 id="删除-network-namespace"><a href="#删除-network-namespace" class="headerlink" title="删除 network namespace"></a>删除 network namespace</h2><p>要删除 <code>network namespace</code>，可以使用以下命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ip netns delete netns1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面这条命令并没有实际删除 <code>netns1</code> 这个 <code>network namespace</code>，它只是移除了这个 namespace 对应的挂载点(<code>/var/run/netns/netns1</code>)，只要里面的进程还运行着，<code>network namespace</code> 就会一直存在 </p>
</blockquote>
<h1 id="veth-pair"><a href="#veth-pair" class="headerlink" title="veth pair"></a>veth pair</h1><p>veth 是虚拟以太网（Virtual Ethernet）的缩写。veth 设备总是成对出现的，因此我们称之为 <code>veth pair</code>，<code>veth pair</code> 的一端发送的数据会在另外一端接收。根据这一特性，<code>veth pair</code> 常被用于跨 <code>network namespace</code> 的通信，即分别将 <code>veth pair</code> 的 2 端放在不同的 <code>network namespace</code>。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="../../202304031317/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202304251611/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202304251611/" class="post-title-link" itemprop="url">linux macvlan 网卡虚拟化技术</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-04-25 16:11:22 / 修改时间：10:32:11" itemprop="dateCreated datePublished" datetime="2023-04-25T16:11:22+08:00">2023-04-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Linux/network/" itemprop="url" rel="index"><span itemprop="name">network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Macvlan"><a href="#Macvlan" class="headerlink" title="Macvlan"></a>Macvlan</h1><p>Macvlan 本身是 linxu kernel 模块</p>
<p>Macvlan 接口是物理以太网接口的虚拟子接口，Macvlan 允许用户在一个物理网络接口上面配置多个虚拟的网络接口，每个 Macvlan 接口都有自己的区别与父接口的 MAC 地址，并且可以像普通的物理网络接口一样分配 IP 地址。使用 Macvlan 技术实现的效果是一块物理网卡可以绑定多个 IP 地址，并且每个 IP 地址有自己独立的 MAC 地址。</p>
<p>Macvlan 虚拟出来的虚拟网卡，在逻辑上和物理网卡是对等的。使用 Macvlan 的虚拟网卡要和父接口在同一个网段。</p>
<p>Macvlan 的最大优点是性能极好，相比其他方式，macvlan 不需要创建 Linux bridge，而是直接通过interface 连接到物理网络。</p>
<p>为保证父接口能接收多个不同 MAC 地址的网络包，需要开启网卡的 <a href="/202304041014/" title="混杂模式">混杂模式</a></p>
<h2 id="docker-中使用-Macvlan-虚拟网卡"><a href="#docker-中使用-Macvlan-虚拟网卡" class="headerlink" title="docker 中使用 Macvlan 虚拟网卡"></a>docker 中使用 Macvlan 虚拟网卡</h2><p>本示例演示 docker 环境中使用 macvlan。首先创建使用 macvlan 驱动的 network，Docker 中 macvlan 只支持 bridge 模式 <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[Docker跨主机通信之macvlan](http://dockeradv.baoshu.red/advanced_network/macvlan.html)">[1]</span></a></sup></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker network create -d macvlan --subnet=192.168.142.0/24 \</span></span><br><span class="line"><span class="language-bash">                                   --gateway=192.168.142.2 \</span></span><br><span class="line"><span class="language-bash">                                   -o parent=ens33 \</span></span><br><span class="line"><span class="language-bash">                                   macvlan1</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker network <span class="built_in">ls</span></span></span><br><span class="line">NETWORK ID     NAME       DRIVER    SCOPE</span><br><span class="line">69324d203c35   bridge     bridge    local</span><br><span class="line">f8943f720d73   host       host      local</span><br><span class="line">0aa95ac8c0f4   macvlan1   macvlan   local</span><br><span class="line">d400c40efdc5   none       null      local</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 docker 环境中，创建网络时，会自动将宿主机网卡设置为混杂模式，此时查看网卡信息，未显示混杂模式，但是查看 <code>dmesg</code> 日志，会看到网卡进入了混杂模式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ dmesg</span><br><span class="line">[93203.228311] device ens33 entered promiscuous mode</span><br></pre></td></tr></table></figure>
</blockquote>
<p>运行容器并连接到新建的 macvlan 网络 <code>macvlan1</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -itd --name test01 \</span><br><span class="line">                --ip=192.168.142.12 \</span><br><span class="line">                --network macvlan1 centos:centos7.9.2009</span><br></pre></td></tr></table></figure>
<p>使用命令 <code>docker exec -it test01 bash</code> 进入容器查看容器的 IP 地址信息，可以看到容器中的网卡类型为 <code>macvlan</code>，模式为 <code>bridge</code>，网关为 docker 网络 <code>macvlan1</code> 中配置的网关。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip -d add</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 promiscuity 0 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 </span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: eth0@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default </span><br><span class="line">    link/ether 02:42:c0:a8:8e:0c brd ff:ff:ff:ff:ff:ff link-netnsid 0 promiscuity 0 </span><br><span class="line">    macvlan mode bridge numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 </span><br><span class="line">    inet 192.168.142.12/24 brd 192.168.142.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.142.2   0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">192.168.142.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0</span><br></pre></td></tr></table></figure>
<p>测试容器可以和宿主机网络一样访问外网。</p>
<p>此时检查宿主机网卡信息，系统上只有 <code>lo</code>，<code>ens33</code>，<code>docker0</code>，未出现其他网卡。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip -d <span class="built_in">link</span></span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 promiscuity 0 addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 </span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:90:51:eb brd ff:ff:ff:ff:ff:ff promiscuity 1 addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 </span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN mode DEFAULT group default </span><br><span class="line">    link/ether 02:42:e9:a6:76:56 brd ff:ff:ff:ff:ff:ff promiscuity 0 </span><br><span class="line">    bridge forward_delay 1500 hello_time 200 max_age 2000 ageing_time 30000 stp_state 0 priority 32768 vlan_filtering 0 vlan_protocol 802.1Q bridge_id 8000.2:42:e9:a6:76:56 designated_root 8000.2:42:e9:a6:76:56 root_port 0 root_path_cost 0 topology_change 0 topology_change_detected 0 hello_timer    0.00 tcn_timer    0.00 topology_change_timer    0.00 gc_timer  265.03 vlan_default_pvid 1 vlan_stats_enabled 0 group_fwd_mask 0 group_address 01:80:c2:00:00:00 mcast_snooping 1 mcast_router 1 mcast_query_use_ifaddr 0 mcast_querier 0 mcast_hash_elasticity 16 mcast_hash_max 4096 mcast_last_member_count 2 mcast_startup_query_count 2 mcast_last_member_interval 100 mcast_membership_interval 26000 mcast_querier_interval 25500 mcast_query_interval 12500 mcast_query_response_interval 1000 mcast_startup_query_interval 3125 mcast_stats_enabled 0 mcast_igmp_version 2 mcast_mld_version 1 nf_call_iptables 0 nf_call_ip6tables 0 nf_call_arptables 0 addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535</span><br></pre></td></tr></table></figure>

<p>在另一个 docker 节点上同样配置 docker 网络和容器</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker network create -d macvlan --subnet=192.168.142.0/24 \</span></span><br><span class="line"><span class="language-bash">                                   --gateway=192.168.142.2 \</span></span><br><span class="line"><span class="language-bash">                                   -o parent=ens33 \</span></span><br><span class="line"><span class="language-bash">                                   macvlan1</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run -itd --name test01 \</span></span><br><span class="line"><span class="language-bash">                --ip=192.168.142.13 \</span></span><br><span class="line"><span class="language-bash">                --network macvlan1 centos:centos7.9.2009</span>                                   </span><br></pre></td></tr></table></figure>
<p>进入容器 <code>test01</code> ，访问到另一个节点上的容器的连通性</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ping 192.168.142.12</span></span><br><span class="line">PING 192.168.142.12 (192.168.142.12) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.142.12: icmp_seq=1 ttl=64 time=0.871 ms</span><br><span class="line">64 bytes from 192.168.142.12: icmp_seq=2 ttl=64 time=0.403 ms</span><br><span class="line">64 bytes from 192.168.142.12: icmp_seq=3 ttl=64 time=0.568 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.142.12 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2047ms</span><br><span class="line">rtt min/avg/max/mdev = 0.403/0.614/0.871/0.193 ms</span><br></pre></td></tr></table></figure>
<p>进入容器 <code>test01</code> ，测试和宿主机 ip 的连通性，结果发现不通，原因为：在 macvlan 虚拟网络中，父接口（物理网卡）相当于一个交换机，对于其子 macvlan 网卡的数据包，只进行转发而不处理，于是造成了使用本机 macvlan 网卡的虚拟 IP 无法和本机物理网卡的 IP 通信。 </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ping 192.168.142.10</span></span><br><span class="line">PING 192.168.142.10 (192.168.142.10) 56(84) bytes of data.</span><br><span class="line">From 192.168.142.13 icmp_seq=1 Destination Host Unreachable</span><br><span class="line">From 192.168.142.13 icmp_seq=2 Destination Host Unreachable</span><br><span class="line">From 192.168.142.13 icmp_seq=3 Destination Host Unreachable</span><br><span class="line">^C</span><br><span class="line">--- 192.168.142.10 ping statistics ---</span><br><span class="line">5 packets transmitted, 0 received, +3 errors, 100% packet loss, time 4073ms</span><br><span class="line">pipe 4</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="../../202304251611/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202304241633/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202304241633/" class="post-title-link" itemprop="url">linux tun/tap 设备的工作原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-04-24 16:33:50 / 修改时间：16:33:57" itemprop="dateCreated datePublished" datetime="2023-04-24T16:33:50+08:00">2023-04-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Linux/network/" itemprop="url" rel="index"><span itemprop="name">network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>从 Linux 文件系统的角度看，tun&#x2F;tap 设备是用户可以使用文件句柄操作的字符设备</p>
<p>从 Linux 网络虚拟化的角度看，tun&#x2F;tap 设备是虚拟网卡，一端连接内核网络协议栈，一端连接用户态的程序。</p>
<p>tun&#x2F;tap 设备主要的作用是可以将 TCP&#x2F;IP 协议栈处理好的数据包发送给任何一个使用 tun&#x2F;tap 设备驱动的程序，由用户态程序重新处理数据包后重新发送到 TCP&#x2F;IP 协议栈。</p>
<p>tun&#x2F;tap 设备的工作原理完全相同，主要区别在于：</p>
<ul>
<li>tun 设备的 &#x2F;dev&#x2F;tunX 文件收发的是 IP 包，因此只能工作在网络层（L3），无法与物理网卡做桥接，可以通过三层交换(如 ip_forward) 与物理网卡交互</li>
<li>tap 设备的 &#x2F;dev&#x2F;tapX 文件收发的是数据链路层报文，可以与物理网卡做桥接。</li>
</ul>
<h1 id="tun-x2F-tap-设备的工作原理"><a href="#tun-x2F-tap-设备的工作原理" class="headerlink" title="tun&#x2F;tap 设备的工作原理"></a>tun&#x2F;tap 设备的工作原理</h1><p><img src="https://i.csms.tech/img_135.png"></p>
<p>上图展示了物理设备上的数据是如何通过 Linux 内核网络协议栈发送到用户态程序的。</p>
<p>物理网卡的数据送达网络协议栈，进程通过 Socket 创建特殊套接字，从网络协议栈接收数据。</p>
<p>从网络协议栈的角度看，tun&#x2F;tap 设备这类虚拟网卡与物理网卡并无区别。对 tun&#x2F;tap 设备而言，他与物理网卡的不同表现在它的数据源不是物理链路，而是来自用户态。</p>
<p><img src="https://i.csms.tech/img_136.png"></p>
<p>普通的物理网卡通过网线收发数据包，而 tun&#x2F;tap 设备通过一个设备文件 （<code>/dev/tunX</code>，<code>/dev/tapX</code>）收发数据包，所有对这个文件的写操作会通过 tun&#x2F;tap 设备转换成一个网络数据包传送给内核的网络协议栈。当内核网络协议栈发送一个包给 tun&#x2F;tap 设备时，用户态的进程通过读取设备文件，就可以拿到报的内容。用户态的程序也可以通过写入这个设备文件向 tun&#x2F;tap 设备发送数据。</p>
<h1 id="VPN-原理简述"><a href="#VPN-原理简述" class="headerlink" title="VPN 原理简述"></a>VPN 原理简述</h1><p><img src="https://i.csms.tech/img_137.png"></p>
<p>如上图所示，整个数据包的流程包括</p>
<ol>
<li>App1 通过 Socket API 发送了一个数据包，假设这个数据包的目的 IP 地址是 192.168.1.3，和 tun0 位于同一个网段</li>
<li>数据包到达网络协议栈后，协议栈根据数据包的目的 IP 地址进行路由，匹配到数据包应该发送给 tun0 网卡，于是将数据包发送给 tun0 网卡</li>
<li>tun0 网卡收到数据包，将数据包写入 &#x2F;dev&#x2F;tun0，&#x2F;dev&#x2F;tun0 由 App2 打开，于是 App2 获得了数据包</li>
<li>App2 获得数据包后，通过报文封装，将原来的目的 IP 为 192.168.1.3 的报文封装在源 IP 为 eth0 的 IP，目的 IP 为 VPN 对端 IP 地址的报文中，构造出新的报文，并通过   Socket API 发送给内核网络协议栈</li>
<li>内核网络协议栈根据路由，发现数据包应该由 eth0 发送出去，于是将数据包发给 eth0，最终通过 eth0 将数据包发送到 VPN 的对端。</li>
</ol>
<p>综上所述，发到 192.168.1.0&#x2F;24 的数据包，首先通过监听在 tun0 设备上的 App2 （VPN 客户端）进行封包，再利用物理网卡 eth0 发送到远端网络的物理网卡上，从而实现 VPN。</p>
<p>VPN 网络报文真正从物理网卡出去需要经过 2 次内核网络协议栈，因此会有一定的性能损耗。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202304191340/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202304191340/" class="post-title-link" itemprop="url">linux namespace 简介</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-04-19 13:41:02 / 修改时间：13:41:10" itemprop="dateCreated datePublished" datetime="2023-04-19T13:41:02+08:00">2023-04-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Centos 7 5.4.239-1</li>
</ul>
<p>Linux 的 namespace 的作用是 ”隔离内核资源“，目前主要实现了以下 namespace</p>
<ul>
<li><code>mount namespace</code> - 文件系统挂载点</li>
<li><code>UTS namespace</code> - 主机名</li>
<li><code>IPC namespace</code> - POSIX 进程间通信消息队列</li>
<li><code>PID namespace</code> - 进程 pid 数字空间</li>
<li><code>network namespace</code> - network</li>
<li><code>user namespace</code> - user ID 数字空间</li>
<li><code>cgroup</code> - 资源使用控制</li>
</ul>
<p>其中，除了 <code>network namespace</code>，其他 namespace 的操作需要使用 C 语言调用系统 API 实现。<code>network namespace</code> 的增删改查功能已经集成到了 Linux 的 <code>ip</code> 工具集的 <code>netns</code> 子命令中</p>
<p>Linux 里面的 namespace 给处在其中的进程造成 2 个错觉：</p>
<ol>
<li>它是系统里面唯一的进程</li>
<li>它独享系统的所有资源</li>
</ol>
<p>默认情况下，Linux 里面的所有进程处在和宿主机相同的 namespace ，即初始 namespace 里，默认享有全局系统资源。</p>
<p>想要查看某个进程都在哪些 namespace 中，可以找到进程 ID （PID），通过查看以下内容或者 namespace 信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ps -elf | grep nginx</span></span><br><span class="line">4 S root     32679 32659  0  80   0 -  2248 sigsus Apr07 ?        00:00:00 nginx: master process nginx -g daemon off;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ll /proc/32679/ns/</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:51 cgroup -&gt; cgroup:[4026531835]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:51 ipc -&gt; ipc:[4026534784]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:51 mnt -&gt; mnt:[4026534583]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:51 net -&gt; net:[4026534787]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:51 pid -&gt; pid:[4026534878]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:51 pid_for_children -&gt; pid:[4026534878]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:51 user -&gt; user:[4026531837]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:51 uts -&gt; uts:[4026534877]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过以上命令，可以看到 <code>nginx</code> 进程所属的 namespace，要查看系统初始 namespace ，可以查看 PID 为 1 的进程的 namespace 信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ll /proc/1/ns/</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:53 cgroup -&gt; cgroup:[4026531835]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:53 ipc -&gt; ipc:[4026531839]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:53 mnt -&gt; mnt:[4026531840]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:53 net -&gt; net:[4026531992]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:53 pid -&gt; pid:[4026531836]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:53 pid_for_children -&gt; pid:[4026531836]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:53 user -&gt; user:[4026531837]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 19 13:53 uts -&gt; uts:[4026531838]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>链接文件的内容的格式为 ns 类型: [inode number]。这里的 <code>inode number</code> 则用来标识一个 namespace，我们也可以把它理解为 namespace 的 ID。如果两个进程的某个 namespace 文件指向同一个链接文件，说明其相关资源在同一个 namespace 中。 <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[不能不知道的三个docker容器隔离核心技术：namespace、cgroups、rootfs](https://zhuanlan.zhihu.com/p/374503196)">[1]</span></a></sup></p>
</blockquote>
<h1 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h1><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;"><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/374503196">不能不知道的三个docker容器隔离核心技术：namespace、cgroups、rootfs</a><a href="#fnref:1" rev="footnote"> ↩</a></span></li></ol></div></div>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202302131009/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202302131009/" class="post-title-link" itemprop="url">Linux 常用内核参数说明</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-02-13 10:09:15" itemprop="dateCreated datePublished" datetime="2023-02-13T10:09:15+08:00">2023-02-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-04-19 11:00:44" itemprop="dateModified" datetime="2023-04-19T11:00:44+08:00">2023-04-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><code>sysctl</code> 命令被用于在内核运行时动态地修改内核的运行参数，可用的内核参数在目录 <code>/proc/sys</code> 中。</p>
<p><code>sysctl</code> 命令对内核参数的修改仅在当前生效，重启系统后参数丢失。如果希望参数永久生效可以修改配置文件 <code>/etc/sysctl.conf</code>。</p>
<h1 id="常用内核参数说明"><a href="#常用内核参数说明" class="headerlink" title="常用内核参数说明"></a>常用内核参数说明</h1><table>
<thead>
<tr>
<th>内核参数</th>
<th>取值范围</th>
<th>含义</th>
<th>使用说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>kernel.hung_task_timeout_secs = 120</code></td>
<td>int</td>
<td>设置系统检测到进程阻塞(如 <a href="/202304181637/" title="&#96;D&#96; 状态">&#96;D&#96; 状态</a>)后，等待进程结束的时常。<br/>如果进程未在规定时间内结束，系统认为该进程无响应，则自动杀死以避免系统奔溃</td>
<td></td>
</tr>
</tbody></table>
<h2 id="mem"><a href="#mem" class="headerlink" title="mem"></a>mem</h2><table>
<thead>
<tr>
<th>内核参数</th>
<th>取值范围</th>
<th>含义</th>
<th>使用说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>vm.min_free_kbytes = 2097152</code></td>
<td>单位 <code>KB</code></td>
<td>设置系统最小剩余内存，以避免缓存不释放导致的死机</td>
<td></td>
</tr>
<tr>
<td><code>vm.oom-kill = 0</code></td>
<td>0,1<br/>默认值为 1，开启</td>
<td>是否启用 OOM-killer。<br/>特定情况下，可能不希望核心执行 OOM killer 的工作,关闭 OOM killer。 例如，排错时<br/><code>echo 0 &gt; /proc/sys/vm/oom-kill</code> 临时关闭 <sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="[OOM](http://33f.net/linux/linux-Out-of-Memory-Killer.html)">[1]</span></a></sup></td>
<td></td>
</tr>
<tr>
<td><code>vm.overcommit_memory = 0</code></td>
<td>0,1,2</td>
<td>内存分配策略<br/><code>/proc/sys/vm/overcommit_memory</code></td>
<td><a href="#vm-overcommit-memory">vm.overcommit_memory 详细说明</a></td>
</tr>
<tr>
<td><code>vm.overcommit_ratio = 50</code></td>
<td>int  <br/>default &#x3D; 50</td>
<td><code>vm.overcommit_memory = 2</code> 时才生效，配置允许 <code>overcommit</code> 的百分比</td>
<td><a href="#vm-overcommit-memory">vm.overcommit_memory 详细说明</a></td>
</tr>
<tr>
<td><code>vm.panic_on_oom = 0</code></td>
<td>0,1<br/>默认为 0 ，开启</td>
<td>表示当内存耗尽时，内核会触发 OOM killer 杀掉最耗内存的进程</td>
<td></td>
</tr>
<tr>
<td><code>vm.oom_kill_allocating_task = 0</code></td>
<td>0,1<br/>默认为 0 ，不启用</td>
<td>OOM-Killer 时，是否选择当前正在申请内存的进程进行 kill</td>
<td></td>
</tr>
</tbody></table>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="../../202302131009/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202304191031/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202304191031/" class="post-title-link" itemprop="url">Linux 系统崩溃问题分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-04-19 10:31:27 / 修改时间：10:31:32" itemprop="dateCreated datePublished" datetime="2023-04-19T10:31:27+08:00">2023-04-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Centos7 5.4.221-1.el7</li>
<li>Docker Engine - Community 20.10.9</li>
</ul>
<p>本文档中的日志分析主要依赖于 <code>journald</code> 服务记录的日志，因此首先需要对 <a href="/202211211437/" title="&#96;journald&#96; 服务记录的日志进行持久化配置">&#96;journald&#96; 服务记录的日志进行持久化配置</a></p>
<h1 id="场景分析"><a href="#场景分析" class="headerlink" title="场景分析"></a>场景分析</h1><h2 id="k8s-worker-节点经常死机-奔溃"><a href="#k8s-worker-节点经常死机-奔溃" class="headerlink" title="k8s worker 节点经常死机(奔溃)"></a>k8s worker 节点经常死机(奔溃)</h2><h3 id="环境信息-1"><a href="#环境信息-1" class="headerlink" title="环境信息"></a>环境信息</h3><ul>
<li>Centos7 5.4.221-1.el7</li>
<li>Docker Engine - Community 20.10.9 </li>
<li>Kubernetes v1.24.7</li>
</ul>
<p>k8s 节点经常出现无响应(死机)，重启才能恢复正常。重启恢复后，检查系统 <code>messages</code> 日志。</p>
<figure class="highlight shell"><figcaption><span>/var/log/messages</span></figcaption><table><tr><td class="code"><pre><span class="line">Feb 10 12:21:40 k8s-work1 kernel: INFO: task dockerd:1443 blocked for more than 368 seconds.</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel:      Tainted: G            E     5.4.221-1.el7.elrepo.x86_64 #1</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: &quot;echo 0 &gt; /proc/sys/kernel/hung_task_timeout_secs&quot; disables this message.</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: dockerd         D    0  1443      1 0x00004080</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: Call Trace:</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: __schedule+0x2d2/0x730</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: schedule+0x42/0xb0</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: wb_wait_for_completion+0x56/0x90</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: ? finish_wait+0x80/0x80</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: sync_inodes_sb+0xd4/0x2c0</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: ? __filemap_fdatawrite_range+0xf1/0x110</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: sync_filesystem+0x5f/0xa0</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: ovl_sync_fs+0x39/0x60 [overlay]</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: sync_filesystem+0x79/0xa0</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: generic_shutdown_super+0x27/0x110</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: kill_anon_super+0x18/0x30</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: deactivate_locked_super+0x3b/0x80</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: deactivate_super+0x3e/0x50</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: cleanup_mnt+0x109/0x160</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: __cleanup_mnt+0x12/0x20</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: task_work_run+0x8f/0xb0</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: exit_to_usermode_loop+0x10c/0x130</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: do_syscall_64+0x170/0x1b0</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: entry_SYSCALL_64_after_hwframe+0x5c/0xc1</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: RIP: 0033:0x55cf9a53e13b</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: Code: Bad RIP value.</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: RSP: 002b:000000c252fea778 EFLAGS: 00000212 ORIG_RAX: 00000000000000a6</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: RAX: 0000000000000000 RBX: 000000c000070800 RCX: 000055cf9a53e13b</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: RDX: 0000000000000000 RSI: 0000000000000002 RDI: 000000c2d000c3f0</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: RBP: 000000c252fea7d0 R08: 0000000000000000 R09: 0000000000000000</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: R10: 0000000000000000 R11: 0000000000000212 R12: 0000000000000000</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: R13: 0000000000000001 R14: 000000000000000a R15: ffffffffffffffff</span><br></pre></td></tr></table></figure>
<p>从日志中可看出，<code>dockerd</code> 进程处于 <a href="/202304181637/" title="&#96;D&#96; 状态">&#96;D&#96; 状态</a>，说明 <code>dockerd</code> 在等待 IO 操作，根据进程调用的栈信息，显示存在对 <code>overlay</code> 文件系统的同步操作，初步猜测，可能是因为 <code>overlay</code> 文件系统中的某些操作未能及时完成，导致了 <code>dockerd</code> 进程的阻塞。</p>
<p>继续检查日志，看到系统连接 NFS 服务超时，怀疑可能是因为 NFS 异常导致。</p>
<figure class="highlight shell"><figcaption><span>/var/log/messages</span></figcaption><table><tr><td class="code"><pre><span class="line">Feb 10 12:21:40 k8s-work1 kernel: nfs: server 172.31.88.9 not responding, timed out</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: nfs: server 172.31.88.9 not responding, still trying</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: nfs: server 172.31.88.9 not responding, timed out</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: nfs: server 172.31.88.9 not responding, still trying</span><br><span class="line">Feb 10 12:21:40 k8s-work1 kernel: nfs: server 172.31.88.9 not responding, timed out</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202304041014/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202304041014/" class="post-title-link" itemprop="url">linux 网络接口的混杂模式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-04-04 10:14:21 / 修改时间：10:14:26" itemprop="dateCreated datePublished" datetime="2023-04-04T10:14:21+08:00">2023-04-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Linux/network/" itemprop="url" rel="index"><span itemprop="name">network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Linux 网卡的混杂模式（Promiscuous mode），简称 Promisc mode，俗称 <code>监听模式</code>。在非混杂模式下，网卡只会接受目的 MAC 地址是它自己的单播帧，以及多播帧；在混杂模式下，网卡会接受经过它的所有帧。</p>
<p>查看网卡是否处于 <code>Promiscuous mode</code>，可以使用 <code>ifconfig</code> 或者 <code>netstat -i</code> 命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ifconfig ens33</span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.142.10  netmask 255.255.255.0  broadcast 192.168.142.255</span><br><span class="line">        inet6 fe80::20c:29ff:fee7:c027  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:e7:c0:27  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 194243  bytes 257521006 (245.5 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 92488  bytes 6051258 (5.7 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>
<p>当输出包含 <code>PROMISC</code> 时，表明该网络接口处于 <code>Promiscuous mode</code>，否则表明未处于 <code>Promiscuous mode</code>。要开启网卡的 <code>Promiscuous mode</code> ，可以使用以下命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ifconfig ens33 promisc</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ifconfig ens33</span></span><br><span class="line">ens33: flags=4419&lt;UP,BROADCAST,RUNNING,PROMISC,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.142.10  netmask 255.255.255.0  broadcast 192.168.142.255</span><br><span class="line">        inet6 fe80::20c:29ff:fee7:c027  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:e7:c0:27  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 194383  bytes 257531059 (245.6 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 92561  bytes 6058652 (5.7 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>
<p>以下命令使网卡退出 <code>Promiscuous mode</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ifconfig ens33 -promisc</span><br></pre></td></tr></table></figure>

<p>将网络设备加入 Linux bridge 后，网络设备会自动进入混杂模式，此种情况使用 <code>ifconfig</code> 或者 <code>netstat -i</code> 命令查看网卡，未显示 <code>PROMISC</code>，但是查看内核日志，显示网卡已进入混杂模式，并且无法退出，直到将 veth 从Linux bridge 中移除。网络设备移除网桥后，会自动退出混杂模式。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip <span class="built_in">link</span> add veth0 <span class="built_in">type</span> veth peer name veth1</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">brctl show</span></span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br><span class="line">br0		8000.000000000000	no		</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">brctl addif br0 veth0</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ifconfig veth0</span></span><br><span class="line">veth0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.10.1  netmask 255.255.255.0  broadcast 192.168.10.255</span><br><span class="line">        ether b6:b3:aa:ae:61:05  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">netstat -i</span></span><br><span class="line">Kernel Interface table</span><br><span class="line">Iface             MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg</span><br><span class="line">br0              1500        0      0      0 0            34      0      0      0 BMU</span><br><span class="line">ens33            1500   195528      0      1 0         93168      0      0      0 BMPRU</span><br><span class="line">veth0            1500        0      0      0 0             0      0      0      0 BMU</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">dmesg | grep promisc</span></span><br><span class="line">[75099.376421] device veth2d80973 entered promiscuous mode</span><br><span class="line">[77630.104784] device ens33 entered promiscuous mode</span><br><span class="line">[77719.626596] device ens33 left promiscuous mode</span><br><span class="line">[77877.905587] device ens33 entered promiscuous mode</span><br><span class="line">[78153.928533] device veth0 entered promiscuous mode</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="../../202304041014/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202209021312/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202209021312/" class="post-title-link" itemprop="url">Django admin 配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-03 13:12:04" itemprop="dateCreated datePublished" datetime="2022-09-03T13:12:04+08:00">2022-09-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-04-02 16:39:37" itemprop="dateModified" datetime="2023-04-02T16:39:37+08:00">2023-04-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Python/Django/" itemprop="url" rel="index"><span itemprop="name">Django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Django 自带的 <code>Admin Site</code> 管理页面可以方便用户快速构建一个简单的后台管理系统，少量代码即可快速实现对数据库中的数据进行展示、修改、保存的可视化页面和功能。当需要对后台展示的数据进行配置时，只需要在 <code>app</code> 的代码文件 <code>admin.py</code> 中进行相应配置即可。</p>
<h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>centos 7</li>
<li>python 3.10</li>
<li>django 4.0</li>
</ul>
<h1 id="为-model-配置-admin-管理页面"><a href="#为-model-配置-admin-管理页面" class="headerlink" title="为 model 配置 admin 管理页面"></a>为 model 配置 admin 管理页面</h1><p>要为 model 启用 admin 管理接口，<a href="https://csms.tech/202301191014/#model-注册到后台">参考配置</a></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="../../202209021312/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202303311747/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202303311747/" class="post-title-link" itemprop="url">mongodb 配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-03-31 17:47:44 / 修改时间：17:47:49" itemprop="dateCreated datePublished" datetime="2023-03-31T17:47:44+08:00">2023-03-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Centos 7 </li>
<li>mongodb 4.0.26</li>
</ul>
<h1 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h1><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/try/download/community">官方社区版下载页面</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget https://repo.mongodb.org/yum/redhat/7/mongodb-org/4.0/x86_64/RPMS/mongodb-org-shell-4.0.28-1.el7.x86_64.rpm</span><br><span class="line">wget https://repo.mongodb.org/yum/redhat/7/mongodb-org/4.0/x86_64/RPMS/mongodb-org-mongos-4.0.28-1.el7.x86_64.rpm</span><br><span class="line">wget https://repo.mongodb.org/yum/redhat/7/mongodb-org/4.0/x86_64/RPMS/mongodb-org-server-4.0.28-1.el7.x86_64.rpm</span><br><span class="line">wget https://repo.mongodb.org/yum/redhat/7/mongodb-org/4.0/x86_64/RPMS/mongodb-org-tools-4.0.28-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">yum localinstall mongodb-org-mongos-4.0.28-1.el7.x86_64.rpm mongodb-org-tools-4.0.28-1.el7.x86_64.rpm mongodb-org-server-4.0.28-1.el7.x86_64.rpm mongodb-org-shell-4.0.28-1.el7.x86_64.rpm</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202303241020/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202303241020/" class="post-title-link" itemprop="url">Django admin 模板分析及使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-03-24 10:20:42 / 修改时间：10:20:49" itemprop="dateCreated datePublished" datetime="2023-03-24T10:20:42+08:00">2023-03-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Python/Django/" itemprop="url" rel="index"><span itemprop="name">Django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Python 3.11</li>
<li>Django 4.1</li>
</ul>
<h1 id="admin-模板解析"><a href="#admin-模板解析" class="headerlink" title="admin 模板解析"></a>admin 模板解析</h1><p>Django 模板之间存在各种复杂的继承关系，最基础的模板为 <code>base.html</code>，文件位于 <code>python3.11/site-packages/django/contrib/admin/templates/admin/base.html</code>。下面以 Admin 页面中的各个模块来解析实现对应模块的模板及代码。</p>
<h2 id="title"><a href="#title" class="headerlink" title="title"></a>title</h2><p><code>title</code> 指网页标题，以 Admin 站点的首页为例，首页的模板文件 <code>index.html</code> 中未定义 <code>title</code> 信息，而是继承自 <code>base_site.html</code></p>
<figure class="highlight python"><figcaption><span>base_site.html</span></figcaption><table><tr><td class="code"><pre><span class="line">&#123;% extends <span class="string">&quot;admin/base.html&quot;</span> %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;&#123;% <span class="keyword">if</span> subtitle %&#125;&#123;&#123; subtitle &#125;&#125; | &#123;% endif %&#125;&#123;&#123; title &#125;&#125; | &#123;&#123; site_title|default:_(<span class="string">&#x27;Django site admin&#x27;</span>) &#125;&#125;&#123;% endblock </span><br><span class="line">%&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>base_site.html</code> 模板继承了模板 <code>base.html</code>，并使用 <code>&#123;% block title %&#125;</code> 标签复写了继承自 <code>base.html</code> 模板的 <code>title</code> 信息。默认显示 <code>Django site admin</code>，如果应用的 <code>admin.py</code> 中定义了 <code>admin.site.site_title</code>，则显示其内容</p>
<figure class="highlight python"><figcaption><span>base.html</span></figcaption><table><tr><td class="code"><pre><span class="line">&#123;% load i18n static %&#125;&lt;!DOCTYPE html&gt;</span><br><span class="line">&#123;% get_current_language <span class="keyword">as</span> LANGUAGE_CODE %&#125;&#123;% get_current_language_bidi <span class="keyword">as</span> LANGUAGE_BIDI %&#125;</span><br><span class="line">&lt;html lang=<span class="string">&quot;&#123;&#123; LANGUAGE_CODE|default:&quot;</span>en-us<span class="string">&quot; &#125;&#125;&quot;</span> <span class="built_in">dir</span>=<span class="string">&quot;&#123;&#123; LANGUAGE_BIDI|yesno:&#x27;rtl,ltr,auto&#x27; &#125;&#125;&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;&#123;% block title %&#125;&#123;% endblock %&#125;&lt;/title&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>基础模板 <code>base.html</code> 中 <code>title</code> 信息默认为空。</p>
<h2 id="Django-管理或站点标题"><a href="#Django-管理或站点标题" class="headerlink" title="Django 管理或站点标题"></a>Django 管理或站点标题</h2><p>Admin 管理页面最顶部左上角会展示默认的 <code>Django 管理</code> 或者站点标题，如果应用的 <code>admin.py</code> 中配置了 <code>admin.site.site_header</code>，则显示站点标题，这是一个链接，点击后会跳转首页。<br><img src="https://i.csms.tech/img_130.png"></p>
<p>这部分的实现是通过继承 <code>base_site.html</code> 实现，其中的 <code>&#123;% block branding %&#125;</code> 定义了这部分内容。</p>
<figure class="highlight python"><figcaption><span>base_site.html</span></figcaption><table><tr><td class="code"><pre><span class="line">&#123;% extends <span class="string">&quot;admin/base.html&quot;</span> %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;&#123;% <span class="keyword">if</span> subtitle %&#125;&#123;&#123; subtitle &#125;&#125; | &#123;% endif %&#125;&#123;&#123; title &#125;&#125; | &#123;&#123; site_title|default:_(<span class="string">&#x27;Django site admin&#x27;</span>) &#125;&#125;&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block branding %&#125;</span><br><span class="line">&lt;h1 <span class="built_in">id</span>=<span class="string">&quot;site-name&quot;</span>&gt;&lt;a href=<span class="string">&quot;&#123;% url &#x27;admin:index&#x27; %&#125;&quot;</span>&gt;&#123;&#123; site_header|default:_(<span class="string">&#x27;Django administration&#x27;</span>) &#125;&#125;&lt;/a&gt;&lt;/h1&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block nav-<span class="keyword">global</span> %&#125;&#123;% endblock %&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="用户欢迎信息"><a href="#用户欢迎信息" class="headerlink" title="用户欢迎信息"></a>用户欢迎信息</h2><p>Django admin 站点默认会显示如下的欢饮信息及修改密码、注销等链接<br><img src="https://i.csms.tech/img_131.png"><br>此处的配置位于 <code>base.html</code> 中的 <code>&#123;% block usertools %&#125;</code> 块内，<code>&#123;% block usertools %&#125;</code> 块位于 <code> &#123;% block header %&#125;</code> 块内。</p>
<figure class="highlight python"><figcaption><span>base.html</span></figcaption><table><tr><td class="code"><pre><span class="line">&#123;% block header %&#125;</span><br><span class="line">&lt;div <span class="built_in">id</span>=<span class="string">&quot;header&quot;</span>&gt;</span><br><span class="line">    &lt;div <span class="built_in">id</span>=<span class="string">&quot;branding&quot;</span>&gt;</span><br><span class="line">    &#123;% block branding %&#125;&#123;% endblock %&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &#123;% block usertools %&#125;</span><br><span class="line"> &#123;% <span class="keyword">if</span> has_permission %&#125;</span><br><span class="line">    &lt;div <span class="built_in">id</span>=<span class="string">&quot;user-tools&quot;</span>&gt;</span><br><span class="line">        &#123;% block welcome-msg %&#125;</span><br><span class="line">            &#123;% translate <span class="string">&#x27;Welcome,&#x27;</span> %&#125;</span><br><span class="line">            &lt;strong&gt;&#123;% firstof user.get_short_name user.get_username %&#125;&lt;/strong&gt;.</span><br><span class="line">        &#123;% endblock %&#125;</span><br><span class="line">        &#123;% block userlinks %&#125;</span><br><span class="line">            &#123;% <span class="keyword">if</span> site_url %&#125;</span><br><span class="line">                &lt;a href=<span class="string">&quot;&#123;&#123; site_url &#125;&#125;&quot;</span>&gt;&#123;% translate <span class="string">&#x27;View site&#x27;</span> %&#125;&lt;/a&gt; /</span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">            &#123;% <span class="keyword">if</span> user.is_active <span class="keyword">and</span> user.is_staff %&#125;</span><br><span class="line">                &#123;% url <span class="string">&#x27;django-admindocs-docroot&#x27;</span> <span class="keyword">as</span> docsroot %&#125;</span><br><span class="line">                &#123;% <span class="keyword">if</span> docsroot %&#125;</span><br><span class="line">                    &lt;a href=<span class="string">&quot;&#123;&#123; docsroot &#125;&#125;&quot;</span>&gt;&#123;% translate <span class="string">&#x27;Documentation&#x27;</span> %&#125;&lt;/a&gt; /</span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">            &#123;% <span class="keyword">if</span> user.has_usable_password %&#125;</span><br><span class="line">            &lt;a href=<span class="string">&quot;&#123;% url &#x27;admin:password_change&#x27; %&#125;&quot;</span>&gt;&#123;% translate <span class="string">&#x27;Change password&#x27;</span> %&#125;&lt;/a&gt; /</span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">            &lt;a href=<span class="string">&quot;&#123;% url &#x27;admin:logout&#x27; %&#125;&quot;</span>&gt;&#123;% translate <span class="string">&#x27;Log out&#x27;</span> %&#125;&lt;/a&gt;</span><br><span class="line">        &#123;% endblock %&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"> &#123;% endif %&#125; </span><br><span class="line">    &#123;% endblock %&#125;</span><br><span class="line">    &#123;% block nav-<span class="keyword">global</span> %&#125;&#123;% endblock %&#125;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<h1 id="自定义页面"><a href="#自定义页面" class="headerlink" title="自定义页面"></a>自定义页面</h1><h2 id="自定义和-Django-admin-风格一样的页面"><a href="#自定义和-Django-admin-风格一样的页面" class="headerlink" title="自定义和 Django admin 风格一样的页面"></a>自定义和 Django admin 风格一样的页面</h2><p>如果要自定义自己的页面，并实现和 Django admin 一致的风格，比如一样的 branding 和用户欢迎信息，可以使用如下代码实现</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123;% extends &quot;admin/base_site.html&quot; %&#125;</span><br><span class="line">&#123;% load i18n static %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;</span><br><span class="line">My Customize Site</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block extrastyle %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block branding %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">id</span>=<span class="string">&quot;site-name&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;% url &#x27;admin:index&#x27; %&#125;&quot;</span>&gt;</span>My Customize Site<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block usertools %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;user-tools&quot;</span>&gt;</span></span><br><span class="line">            &#123;% block welcome-msg %&#125;</span><br><span class="line">                &#123;% translate &#x27;Welcome,&#x27; %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">strong</span>&gt;</span>&#123;% firstof user.get_short_name user.get_username %&#125;<span class="tag">&lt;/<span class="name">strong</span>&gt;</span>.</span><br><span class="line">            &#123;% endblock %&#125;</span><br><span class="line">            &#123;% block userlinks %&#125;</span><br><span class="line">                &#123;% if site_url %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; site_url &#125;&#125;&quot;</span>&gt;</span>&#123;% translate &#x27;View site&#x27; %&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span> /</span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">                &#123;% if user.is_active and user.is_staff %&#125;</span><br><span class="line">                    &#123;% url &#x27;django-admindocs-docroot&#x27; as docsroot %&#125;</span><br><span class="line">                    &#123;% if docsroot %&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; docsroot &#125;&#125;&quot;</span>&gt;</span>&#123;% translate &#x27;Documentation&#x27; %&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span> /</span><br><span class="line">                    &#123;% endif %&#125;</span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">                &#123;% if user.has_usable_password %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;% url &#x27;admin:password_change&#x27; %&#125;&quot;</span>&gt;</span>&#123;% translate &#x27;Change password&#x27; %&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span> /</span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;% url &#x27;admin:logout&#x27; %&#125;&quot;</span>&gt;</span>&#123;% translate &#x27;Log out&#x27; %&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            &#123;% endblock %&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block breadcrumbs %&#125;&#123;% endblock %&#125;</span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">hello world</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/202303221624/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="../../202303221624/" class="post-title-link" itemprop="url">django-bootstrap5 使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-03-22 16:24:34 / 修改时间：16:24:40" itemprop="dateCreated datePublished" datetime="2023-03-22T16:24:34+08:00">2023-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../../categories/Python/Django/" itemprop="url" rel="index"><span itemprop="name">Django</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>Python3.11</li>
<li>Django4</li>
</ul>
<h1 id="django-bootstrap5-安装配置"><a href="#django-bootstrap5-安装配置" class="headerlink" title="django-bootstrap5 安装配置"></a>django-bootstrap5 安装配置</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install django-bootstrap5</span><br></pre></td></tr></table></figure>

<p>在项目配置文件 <code>settings.py</code> 中添加应用名</p>
<figure class="highlight shell"><figcaption><span>settings.py</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">INSTALLED_APPS = [</span><br><span class="line">    ...</span><br><span class="line">    &#x27;django_bootstrap5&#x27;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h1 id="bootstrap5-使用"><a href="#bootstrap5-使用" class="headerlink" title="bootstrap5 使用"></a>bootstrap5 使用</h1>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="../7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="../../">1</a><span class="space">&hellip;</span><a class="page-number" href="../7/">7</a><span class="page-number current">8</span><a class="page-number" href="../9/">9</a><span class="space">&hellip;</span><a class="page-number" href="../12/">12</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="../9/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">COSMOS</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="300" alpha="0.3" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="../../js/comments.js"></script><script src="../../js/utils.js"></script><script src="../../js/motion.js"></script><script src="../../js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="../../js/third-party/search/local-search.js"></script>




  <script src="../../js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"fl9999","repo":"fl9999.github.io","client_id":"a11bf6f7860762b725b5","client_secret":"a99046105f8bddc72ec718d54dc3fd7f22070821","admin_user":"fl9999","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"d41d8cd98f00b204e9800998ecf8427e"}</script>
<script src="../../js/third-party/comments/gitalk.js"></script>

</body>
</html>
