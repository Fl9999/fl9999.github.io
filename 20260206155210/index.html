<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16-next.png">
  <link rel="mask-icon" href="../images/logo.svg" color="#222">

<link rel="stylesheet" href="../css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"csms.tech","root":"/","images":"../images","scheme":"Gemini","darkmode":true,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeIn","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"../search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="../js/config.js"></script>

    <meta name="description" content="EKS 集群特性总结  节点的 IP 地址（EXTERNAL-IP 和 INTERNAL-IP）不固定，会变化。特别是在自治模式中，节点被视为 临时资源（Ephemeral） ，可能会频繁地进行节点池优化。 如果集群需要固定的出口 IP，最推荐，最标准的做法是 使用 NAT 网关 ，将 EKS 节点部署在私有子网中，所有访问外部网络的流量都会经过 NAT 网关    通过 AWS 管理控制台部署">
<meta property="og:type" content="article">
<meta property="og:title" content="aws EKS 配置及相关操作">
<meta property="og:url" content="http://csms.tech/20260206155210/index.html">
<meta property="og:site_name" content="L B T">
<meta property="og:description" content="EKS 集群特性总结  节点的 IP 地址（EXTERNAL-IP 和 INTERNAL-IP）不固定，会变化。特别是在自治模式中，节点被视为 临时资源（Ephemeral） ，可能会频繁地进行节点池优化。 如果集群需要固定的出口 IP，最推荐，最标准的做法是 使用 NAT 网关 ，将 EKS 节点部署在私有子网中，所有访问外部网络的流量都会经过 NAT 网关    通过 AWS 管理控制台部署">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.csms.tech/img_401.png">
<meta property="og:image" content="https://i.csms.tech/img_409.png">
<meta property="og:image" content="https://i.csms.tech/img_398.png">
<meta property="og:image" content="https://i.csms.tech/img_407.png">
<meta property="og:image" content="https://i.csms.tech/img_400.png">
<meta property="og:image" content="https://i.csms.tech/img_420.png">
<meta property="og:image" content="https://i.csms.tech/img_414.png">
<meta property="og:image" content="https://i.csms.tech/img_415.png">
<meta property="og:image" content="https://i.csms.tech/img_416.png">
<meta property="og:image" content="https://i.csms.tech/img_417.png">
<meta property="og:image" content="https://i.csms.tech/img_418.png">
<meta property="article:published_time" content="2026-02-06T03:37:49.000Z">
<meta property="article:modified_time" content="2026-02-13T09:40:36.000Z">
<meta property="article:author" content="COSMOS">
<meta property="article:tag" content="Aws">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.csms.tech/img_401.png">


<link rel="canonical" href="http://csms.tech/20260206155210/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://csms.tech/20260206155210/","path":"20260206155210/","title":"aws EKS 配置及相关操作"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>aws EKS 配置及相关操作 | L B T</title>
  








  <noscript>
    <link rel="stylesheet" href="../css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">L B T</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记 录 过 去 的 经 验</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="../index.html" rel="section"><i class="fa fa-earth-americas fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="../categories/" rel="section"><i class="fa fa-folder-tree fa-fw"></i>总目录<span class="badge">54</span></a></li><li class="menu-item menu-item-linux"><a href="../categories/Linux" rel="section"><i class="fa fa-brands fa-linux fa-fw"></i>Linux</a></li><li class="menu-item menu-item-python"><a href="../categories/Python" rel="section"><i class="fa fa-brands fa-python fa-fw"></i>Python</a></li><li class="menu-item menu-item-docker"><a href="../categories/Docker" rel="section"><i class="fa fa-brands fa-docker fa-fw"></i>Docker</a></li><li class="menu-item menu-item-kubernetes"><a href="../categories/Kubernetes" rel="section"><i class="fa fa-dharmachakra fa-fw"></i>Kubernetes</a></li><li class="menu-item menu-item-tags"><a href="../tags/" rel="section"><i class="fa fa-tornado fa-fw"></i>标签<span class="badge">79</span></a></li><li class="menu-item menu-item-archives"><a href="../archives/" rel="section"><i class="fa fa-rectangle-list fa-fw"></i>列表<span class="badge">312</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章总目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-AWS-%E7%AE%A1%E7%90%86%E6%8E%A7%E5%88%B6%E5%8F%B0%E9%83%A8%E7%BD%B2-EKS-%E9%9B%86%E7%BE%A4"><span class="nav-number">1.</span> <span class="nav-text">通过 AWS 管理控制台部署 EKS 集群</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#aws-eks-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">1.1.</span> <span class="nav-text">aws eks 常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%97%E5%87%BA%E9%9B%86%E7%BE%A4"><span class="nav-number">1.1.1.</span> <span class="nav-text">列出集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E9%9B%86%E7%BE%A4%E5%88%9B%E5%BB%BA%E6%88%96%E6%9B%B4%E6%96%B0-kubeconfig-%E6%96%87%E4%BB%B6%E7%94%A8%E4%BA%8E%E5%92%8C%E9%9B%86%E7%BE%A4%E9%80%9A%E4%BF%A1"><span class="nav-number">1.1.2.</span> <span class="nav-text">为集群创建或更新 kubeconfig 文件用于和集群通信</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF"><span class="nav-number">1.2.</span> <span class="nav-text">常见错误</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2%E7%BC%BA%E5%B0%91%E5%BB%BA%E8%AE%AE%E7%9A%84%E6%89%98%E7%AE%A1%E7%AD%96%E7%95%A5"><span class="nav-number">1.2.1.</span> <span class="nav-text">集群角色缺少建议的托管策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2%E4%BF%A1%E4%BB%BB%E7%AD%96%E7%95%A5%E7%BC%BA%E5%B0%91%E5%BF%85%E9%9C%80%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="nav-number">1.2.2.</span> <span class="nav-text">集群角色信任策略缺少必需的操作</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#EKS-%E9%9B%86%E7%BE%A4%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%E5%8F%8A%E6%93%8D%E4%BD%9C"><span class="nav-number">2.</span> <span class="nav-text">EKS 集群相关配置及操作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9-EKS-%E9%9B%86%E7%BE%A4-API-server-endpoint-%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90"><span class="nav-number">2.1.</span> <span class="nav-text">修改 EKS 集群 API server endpoint 访问权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA-EKS-%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85-AWS-Loadbalancer-Controller"><span class="nav-number">2.2.</span> <span class="nav-text">为 EKS 集群安装 AWS Loadbalancer Controller</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AWS-Load-Balancer-controller-%E7%9B%B8%E5%85%B3%E9%94%99%E8%AF%AF"><span class="nav-number">2.2.1.</span> <span class="nav-text">AWS Load Balancer controller 相关错误</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AWS-Load-Balancer-controller-%E9%83%A8%E7%BD%B2%E5%90%8E-Pod-%E7%8A%B6%E6%80%81%E4%B8%BA-CrashLoopBackOff"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">AWS Load Balancer controller 部署后 Pod 状态为 CrashLoopBackOff</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8-EKS-%E8%87%AA%E5%8A%A8%E6%A8%A1%E5%BC%8F%E9%9B%86%E7%BE%A4%E4%B8%AD%E6%A3%80%E6%9F%A5-Amazon-EBS-CSI-%E6%8E%A7%E5%88%B6%E5%99%A8%E7%8A%B6%E6%80%81"><span class="nav-number">2.3.</span> <span class="nav-text">在 EKS 自动模式集群中检查 Amazon EBS CSI 控制器状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E9%9B%86%E7%BE%A4%E5%88%86%E9%85%8D%E5%8F%AA%E8%AF%BB%E6%9D%83%E9%99%90%E7%9A%84%E8%B4%A6%E6%88%B7"><span class="nav-number">2.4.</span> <span class="nav-text">为集群分配只读权限的账户</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E7%94%A8-EKS-%E4%B8%AD%E7%9A%84-Ingress-%E7%9A%84-Access-Log-%E8%AE%B0%E5%BD%95"><span class="nav-number">2.5.</span> <span class="nav-text">启用 EKS 中的 Ingress 的 Access Log 记录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EKS-%E9%83%A8%E7%BD%B2-Prometheus-%E7%9B%91%E6%8E%A7"><span class="nav-number">2.6.</span> <span class="nav-text">EKS 部署 Prometheus 监控</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E6%A1%88%E4%BE%8B%E6%88%96%E9%94%99%E8%AF%AF%E6%8E%92%E6%9F%A5"><span class="nav-number">2.7.</span> <span class="nav-text">相关案例或错误排查</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E6%B2%BB%E6%A8%A1%E5%BC%8F%E5%88%9B%E5%BB%BA%E7%9A%84%E9%9B%86%E7%BE%A4%E6%97%A0%E6%B3%95%E9%83%A8%E7%BD%B2-Pod-%E4%B8%8A%E5%8E%BB"><span class="nav-number">2.7.1.</span> <span class="nav-text">自治模式创建的集群无法部署 Pod 上去</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EKS-%E9%83%A8%E7%BD%B2-Nginx-%E6%9C%8D%E5%8A%A1%E5%B9%B6%E5%9C%A8%E4%BA%92%E8%81%94%E7%BD%91%E4%B8%8A%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE"><span class="nav-number">2.7.2.</span> <span class="nav-text">EKS 部署 Nginx 服务并在互联网上可以访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ALB-%E5%9F%9F%E5%90%8D%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E6%8E%92%E6%9F%A5%E6%AD%A5%E9%AA%A4"><span class="nav-number">2.7.3.</span> <span class="nav-text">ALB 域名无法访问排查步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pod-%E6%8C%82%E8%BD%BD-EBS-PV-%E5%A4%B1%E8%B4%A5"><span class="nav-number">2.7.4.</span> <span class="nav-text">Pod 挂载 EBS PV 失败</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">COSMOS</p>
  <div class="site-description" itemprop="description">得 能 莫 忘</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="../archives/">
          <span class="site-state-item-count">312</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="../categories/">
        <span class="site-state-item-count">54</span>
        <span class="site-state-item-name">目录</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="../tags/">
        <span class="site-state-item-count">79</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://csms.tech/20260206155210/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../images/avatar.gif">
      <meta itemprop="name" content="COSMOS">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L B T">
      <meta itemprop="description" content="得 能 莫 忘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="aws EKS 配置及相关操作 | L B T">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          aws EKS 配置及相关操作
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-02-06 11:37:49" itemprop="dateCreated datePublished" datetime="2026-02-06T11:37:49+08:00">2026-02-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-02-13 17:40:36" itemprop="dateModified" datetime="2026-02-13T17:40:36+08:00">2026-02-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">上层目录</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/%E4%BA%91%E5%B9%B3%E5%8F%B0/" itemprop="url" rel="index"><span itemprop="name">云平台</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/%E4%BA%91%E5%B9%B3%E5%8F%B0/Aws/" itemprop="url" rel="index"><span itemprop="name">Aws</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>EKS 集群特性总结</p>
<ul>
<li>节点的 IP 地址（EXTERNAL-IP 和 INTERNAL-IP）不固定，会变化。特别是在自治模式中，节点被视为 <strong>临时资源（Ephemeral）</strong> ，可能会频繁地进行节点池优化。<blockquote>
<p>如果集群需要固定的出口 IP，最推荐，最标准的做法是 <strong>使用 NAT 网关</strong> ，将 EKS 节点部署在私有子网中，所有访问外部网络的流量都会经过 <strong>NAT 网关</strong></p>
</blockquote>
</li>
</ul>
<h1 id="通过-AWS-管理控制台部署-EKS-集群"><a href="#通过-AWS-管理控制台部署-EKS-集群" class="headerlink" title="通过 AWS 管理控制台部署 EKS 集群"></a>通过 AWS 管理控制台部署 EKS 集群</h1><ul>
<li>Kubernetes 版本： v1.35</li>
</ul>
<p>本示例中使用 <strong>EKS 自治模式（EKS Auto Mode）</strong></p>
<blockquote>
<p><strong>EKS 自治模式</strong> 接管了原本需要手动管理的节点、存储和网络配置，因此它需要一组非常具体且强大的权限</p>
<p><strong>EKS 自治模式</strong> 有额外的费用，大概比 EC2 价格高 12%</p>
<p><strong>EKS 自治模式</strong> 在集群创建完成后可修改（编辑）为非自治模式</p>
<p><strong>EKS 自治模式</strong> 中的 Worker Nodes 配置 <strong>不能在控制台修改参数、不能自定义</strong> ，具体的配置可以通过 API 接口查看 <code>nodepool</code> 资源</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># kubectl describe nodepool general-purpose</span><br><span class="line">Name:         general-purpose</span><br><span class="line">Namespace:    </span><br><span class="line">Labels:       app.kubernetes.io/managed-by=eks</span><br><span class="line">Annotations:  karpenter.sh/nodepool-hash: 4012513481623584108</span><br><span class="line">              karpenter.sh/nodepool-hash-version: v3</span><br><span class="line">API Version:  karpenter.sh/v1</span><br><span class="line">Kind:         NodePool</span><br><span class="line">Metadata:</span><br><span class="line">  Creation Timestamp:  2026-02-06T09:38:18Z</span><br><span class="line">  Generation:          1</span><br><span class="line">  Resource Version:    784637</span><br><span class="line">  UID:                 e85261b9-3a4b-41b0-ac5...</span><br><span class="line">Spec:</span><br><span class="line">  Disruption:</span><br><span class="line">    Budgets:</span><br><span class="line">      Nodes:               10%      # 这是一个安全阀。在同一时间内，由于缩容或更新导致的节点离线比例不能超过 10%。这保证了你的集群不会因为自动优化而导致业务大面积中断。</span><br><span class="line">    Consolidate After:     30s      # 节点达到上述状态 30 秒后，EKS 就会考虑将其关闭，并把上面的 Pod 迁移到更划算的节点上。</span><br><span class="line">    Consolidation Policy:  WhenEmptyOrUnderutilized    # 当节点变为空闲（没有 Pod）或者利用率较低（比如一个大节点只跑了一个小 Pod）时，EKS 会自动触发节点合并。</span><br><span class="line">  limits:      # 资源限制</span><br><span class="line">    cpu: &quot;1000&quot;</span><br><span class="line">    memory: 1000Gi</span><br><span class="line">  Template:</span><br><span class="line">    Metadata:</span><br><span class="line">    Spec:</span><br><span class="line">      Expire After:  336h   # 节点的最大“寿命”是 14 天（336 小时），强制节点定期更换，以确保所有节点都运行在最新的安全补丁和 Bottlerocket 镜像上，防止出现长期未重启的“僵尸节点”。</span><br><span class="line">      Node Class Ref:     # nodeclass 信息，可通过 kubectl get nodeclass 查看</span><br><span class="line">        Group:  eks.amazonaws.com</span><br><span class="line">        Kind:   NodeClass</span><br><span class="line">        Name:   default</span><br><span class="line">      Requirements:        # 节点选择标准 (Requirements)</span><br><span class="line">        Key:       karpenter.sh/capacity-type     # 实例类型，on-demand 为 按需实例</span><br><span class="line">        Operator:  In</span><br><span class="line">        Values:</span><br><span class="line">          on-demand</span><br><span class="line">        Key:       eks.amazonaws.com/instance-category     # 限定了实例系列   c: 计算优化型（适合高并发）； m: 通用型（平衡 CPU 和内存）； r: 内存优化型（适合数据库或缓存）。   </span><br><span class="line">        Operator:  In</span><br><span class="line">        Values:</span><br><span class="line">          c</span><br><span class="line">          m</span><br><span class="line">          r</span><br><span class="line">        Key:       eks.amazonaws.com/instance-generation     # 只使用 4 代以后的机型（如 c5, m6i 等）。这确保了节点拥有较新的硬件特性和性能。</span><br><span class="line">        Operator:  Gt</span><br><span class="line">        Values:</span><br><span class="line">          4</span><br><span class="line">        Key:       kubernetes.io/arch    # CPU 架构。如果你想尝试性价比更高的 ARM 架构（Graviton），需要在这里添加 arm64</span><br><span class="line">        Operator:  In</span><br><span class="line">        Values:</span><br><span class="line">          amd64</span><br><span class="line">        Key:       kubernetes.io/os   # 节点操作系统（OS）类型</span><br><span class="line">        Operator:  In</span><br><span class="line">        Values:</span><br><span class="line">          linux</span><br><span class="line">      Termination Grace Period:  24h0m0s</span><br></pre></td></tr></table></figure>
<p><strong>EKS 自治模式限制资源上限</strong> 编辑 NodePool，修改 <code>spec.limits.cpu</code> 和 <code>spec.limits.memory</code> 。这决定了该池子最多能“烧”掉多少 EC2 资源。</p>
<p><strong>强制回收节点</strong> ： 如果你想让 EKS 重新平衡节点（例如你更改了实例限制），可以手动删除节点，Auto Mode 会自动根据 Pod 需求拉起符合新规的新节点</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl delete node &lt;node-name&gt;</span><br></pre></td></tr></table></figure>

<p>同时要关注 <code>nodeclass</code> 资源，其中定义了 <strong>子网（Subnet）和安全组（Security Group）等信息</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get nodeclass</span></span><br><span class="line">NAME      ROLE          READY   AGE</span><br><span class="line">default   eksNodeRole   True    44h</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl  describe nodeclass default</span></span><br><span class="line">Name:         default</span><br><span class="line">Namespace:    </span><br><span class="line">Labels:       app.kubernetes.io/managed-by=eks</span><br><span class="line">Annotations:  eks.amazonaws.com/nodeclass-hash: 13740036326424352917</span><br><span class="line">              eks.amazonaws.com/nodeclass-hash-version: v2</span><br><span class="line">API Version:  eks.amazonaws.com/v1</span><br><span class="line">Kind:         NodeClass</span><br><span class="line">Metadata:</span><br><span class="line">  Creation Timestamp:  2026-02-06T09:38:18Z</span><br><span class="line">  Finalizers:</span><br><span class="line">    eks.amazonaws.com/termination</span><br><span class="line">  Generation:        2</span><br><span class="line">  Resource Version:  827607</span><br><span class="line">  UID:               5065b0f3-3795-4347-893a-338ae6fa882d</span><br><span class="line">Spec:</span><br><span class="line">  Ephemeral Storage:</span><br><span class="line">    Iops:                     3000</span><br><span class="line">    Size:                     80Gi</span><br><span class="line">    Throughput:               125</span><br><span class="line">  Network Policy:             DefaultAllow</span><br><span class="line">  Network Policy Event Logs:  Disabled</span><br><span class="line">  Role:                       eksNodeRole</span><br><span class="line">  Security Group Selector Terms:</span><br><span class="line">    Id:         sg-058bd1ef...</span><br><span class="line">  Snat Policy:  Random</span><br><span class="line">  Subnet Selector Terms:</span><br><span class="line">    Id:  subnet-07963d9b...</span><br><span class="line">    Id:  subnet-0e359aac...</span><br><span class="line">    Id:  subnet-0e76c601...</span><br></pre></td></tr></table></figure>
</blockquote>
<span id="more"></span>

<ol>
<li><p><strong>创建 EKS 集群 IAM 角色</strong></p>
<blockquote>
<p>每个集群都需要一个 Amazon EKS 集群 IAM 角色。由 Amazon EKS 管理的 Kubernetes 集群会使用此角色来管理节点<br>AWS 官方参考文档： <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/cluster-iam-role.html#create-service-role">https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/cluster-iam-role.html#create-service-role</a></p>
</blockquote>
<ol>
<li><p>进入 IAM 控制台 -&gt; 角色 -&gt; 创建角色。</p>
</li>
<li><p>选择 AWS 服务，找到 EKS。</p>
</li>
<li><p>选择 EKS - Cluster 用例。</p>
</li>
<li><p>确保关联了以下权限策略。</p>
<ul>
<li><code>AmazonEKSClusterPolicy</code></li>
<li><code>AmazonEKSComputePolicy</code></li>
<li><code>AmazonEKSBlockStoragePolicy</code></li>
<li><code>AmazonEKSNetworkingPolicy</code></li>
<li><code>AmazonEKSLoadBalancingPolicy</code></li>
</ul>
</li>
<li><p>修改角色 <strong>信任关系 (Trust relationships)</strong> ，在 <code>Action</code> 列表中添加 <code>sts:TagSession</code></p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br><span class="line">    &quot;Statement&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Effect&quot;: &quot;Allow&quot;,</span><br><span class="line">            &quot;Principal&quot;: &#123;</span><br><span class="line">                &quot;Service&quot;: &quot;eks.amazonaws.com&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Action&quot;: [&quot;sts:AssumeRole&quot;,</span><br><span class="line">            &quot;sts:TagSession&quot;</span><br><span class="line">        ]&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>命名为 <code>eksClusterRole</code> 并保存。</p>
</li>
</ol>
</li>
<li><p><strong>创建 EKS 节点 IAM 角色</strong></p>
<blockquote>
<p>Amazon EKS 节点 kubelet 守护进程代表您调用 AWS API。节点通过 IAM 实例配置文件和关联的策略获得这些 API 调用的权限。您必须先为节点创建 IAM 角色以在启动它们时使用，然后才能启动这些节点并在集群中注册它们。<br>AWS 官方参考文档： <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/create-node-role.html">https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/create-node-role.html</a></p>
</blockquote>
<ol>
<li><p>通过 <a target="_blank" rel="noopener" href="https://console.aws.amazon.com/iam/">https://console.aws.amazon.com/iam/</a> 打开 IAM 控制台。</p>
</li>
<li><p>在左侧导航窗格中，选择 <strong>Roles（角色）</strong> 。</p>
</li>
<li><p>在 Roles（角色）页面上，选择 <code>Create role（创建角色）</code> 。</p>
</li>
<li><p>在 <code>Select trusted entity（选择受信任的实体）</code> 页面上，请执行以下操作：</p>
<ol>
<li>在可信实体类型部分中，选择 AWS 服务。</li>
<li>在 Use case（使用案例）下，选择 EC2。</li>
<li>选择下一步。</li>
</ol>
</li>
<li><p>在添加权限页面上，附加自定义策略或执行以下操作：</p>
<ol>
<li>在 <code>Filter policies (筛选器策略) </code> 框中，输入 <code>AmazonEKSWorkerNodePolicy</code> 。</li>
<li>选中搜索结果中的 <code>AmazonEKSWorkerNodePolicy</code> 左侧的复选框。</li>
<li>请选择 <strong>Clear filters（清除筛选条件）</strong> 。</li>
<li>在 <strong>Filter policies (筛选器策略)</strong> 框中，输入 <code>AmazonEC2ContainerRegistryPullOnly</code> 。</li>
<li>选中搜索结果中的 <code>AmazonEC2ContainerRegistryPullOnly</code> 左侧的复选框。</li>
<li>选择下一步。</li>
</ol>
</li>
<li><p>在 <strong>Name, review, and create（命名、查看和创建）页面中</strong> ，对角色（Role）命名，本示例使用 <code>eksNodeRole</code>。</p>
</li>
<li><p>选择 <strong>创建角色</strong> 。</p>
</li>
</ol>
</li>
<li><p>可以根据需求为 EKS 集群中的工作节点（Nodes）新建 <strong>私有子网 (Private Subnet)</strong> 并配置 NAT Gateway 以使集群 Nodes 的出口 IP 固定。</p>
<blockquote>
<p>EKS 允许你动态更新集群关联的子网。这一步会告诉 EKS 控制平面以后在新的 Subnets 中工作。</p>
<p><a href="https://csms.tech/20260207135211/#部署-NAT-Gateway-网关并关联子网">新建 <strong>私有子网 (Private Subnet)</strong> 并配置 NAT Gateway 操作参考文档</a></p>
</blockquote>
</li>
<li><p><strong>创建集群控制平面</strong></p>
<ol>
<li>进入 EKS 控制台 -&gt; 集群 -&gt; 添加集群 -&gt; 创建。</li>
<li>配置集群：输入名称，选择 Kubernetes 版本，并选择已经创建的 <strong>集群 IAM 角色</strong> <code>eksClusterRole</code> 和 <strong>节点 IAM 角色</strong> <code>eksNodeRole</code></li>
<li>其他配置使用默认即可。</li>
</ol>
</li>
<li><p>若要通过命令行来管理 Amazon EKS 集群，参考 <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/setting-up.html">官方文档安装 <code>aws cli</code> 、 <code>kubectl</code> 和 <code>eksctl</code></a></p>
</li>
</ol>
<p>AWS EKS 控制台基本不提供 Deployment &#x2F; Pod 的创建、编辑、删除能力。只具备集群可视化、运维辅助的功能。对集群的变更操作主要通过 <code>通过 API / kubectl</code> ，集群管理可通过接入 Rancher ，它提供多集群管理、 RBAC 权限控制、审计等诸多方便 。</p>
<h2 id="aws-eks-常用命令"><a href="#aws-eks-常用命令" class="headerlink" title="aws eks 常用命令"></a>aws eks 常用命令</h2><h3 id="列出集群"><a href="#列出集群" class="headerlink" title="列出集群"></a>列出集群</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">aws eks list-clusters</span></span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusters&quot;: [</span><br><span class="line">        &quot;my_eks_cluster&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="为集群创建或更新-kubeconfig-文件用于和集群通信"><a href="#为集群创建或更新-kubeconfig-文件用于和集群通信" class="headerlink" title="为集群创建或更新 kubeconfig 文件用于和集群通信"></a>为集群创建或更新 kubeconfig 文件用于和集群通信</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">aws eks update-kubeconfig --region region-code --name my-cluster</span></span><br><span class="line">Added new context arn:aws:eks:ap-east-1:252345564999:cluster/my-cluster to /root/.kube/config</span><br></pre></td></tr></table></figure>

<p>更新 <code>kubeconfig</code> 文件成功后，会创建 <code>~/.kube/config</code> 文件，里面包含集群的 API 信息和认证信息，凭此可以和 Kubernetes 集群进行通信</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get nodes -o wide</span></span><br><span class="line">NAME                  STATUS   ROLES    AGE   VERSION               INTERNAL-IP     EXTERNAL-IP      OS-IMAGE                                                              KERNEL-VERSION   CONTAINER-RUNTIME</span><br><span class="line">i-08430a2c906bc4c67   Ready    &lt;none&gt;   16h   v1.35.0-eks-ac2d5a0   172.31.45.250   18.166.67.169    Bottlerocket (EKS Auto, Standard) 2026.1.28 (aws-k8s-1.35-standard)   6.12.64          containerd://2.1.6+bottlerocket</span><br><span class="line">i-0da674836789d8862   Ready    &lt;none&gt;   16h   v1.35.0-eks-ac2d5a0   172.31.29.11    43.198.109.233   Bottlerocket (EKS Auto, Standard) 2026.1.28 (aws-k8s-1.35-standard)   6.12.64          containerd://2.1.6+bottlerocket</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h2><h3 id="集群角色缺少建议的托管策略"><a href="#集群角色缺少建议的托管策略" class="headerlink" title="集群角色缺少建议的托管策略"></a>集群角色缺少建议的托管策略</h3><p><strong>EKS 自治模式</strong> 的集群创建过程中缺少必要的权限</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">集群角色缺少建议的托管策略</span><br><span class="line">集群角色必须具有以下托管策略或等效权限才能使用 EKS 自治模式：</span><br><span class="line">    - AmazonEKSBlockStoragePolicy</span><br><span class="line">    - AmazonEKSComputePolicy</span><br><span class="line">    - AmazonEKSLoadBalancingPolicy</span><br><span class="line">    - AmazonEKSNetworkingPolicy</span><br></pre></td></tr></table></figure>
<p><strong>EKS 自治模式</strong> 接管了原本需要手动管理的节点、存储和网络配置，因此它需要一组非常具体且强大的权限. 解决方法如下</p>
<ol>
<li><p>登录 IAM 控制台，找到“角色 (Roles)”。</p>
</li>
<li><p>搜索并点击你为 EKS 集群创建的角色名称，本示例中为 <code>eksClusterRole</code>。</p>
</li>
<li><p>在 <strong>权限 (Permissions)</strong> 选项卡下，点击 <code>添加权限 (Add permissions) -&gt; 附加策略 (Attach policies)</code> 。</p>
</li>
<li><p>在搜索框中分别搜索并勾选上述四个策略：</p>
<ul>
<li><code>AmazonEKSComputePolicy</code></li>
<li><code>AmazonEKSBlockStoragePolicy</code></li>
<li><code>AmazonEKSNetworkingPolicy</code></li>
<li><code>AmazonEKSLoadBalancingPolicy</code></li>
</ul>
</li>
</ol>
<p>最终的 <strong>权限策略</strong> 如下图所示：<br><img src="https://i.csms.tech/img_401.png"></p>
<h3 id="集群角色信任策略缺少必需的操作"><a href="#集群角色信任策略缺少必需的操作" class="headerlink" title="集群角色信任策略缺少必需的操作"></a>集群角色信任策略缺少必需的操作</h3><p><strong>EKS 自治模式</strong> 的集群创建过程中缺少必要的权限</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">集群角色信任策略缺少必需的操作</span><br><span class="line">集群角色必须具有其信任策略中指定的以下操作才能使用 EKS 自治模式：</span><br><span class="line">    - sts:TagSession</span><br></pre></td></tr></table></figure>

<p>在 EKS 自治模式下，EKS 需要使用 <code>sts:TagSession</code> 来为它替你创建的资源（如自动生成的节点）进行身份标识和追踪。</p>
<p>修改 IAM 角色的 <strong>信任关系 (Trust relationships)</strong> ，将 <code>sts:TagSession</code> 操作添加到允许列表中。</p>
<ol>
<li>进入 IAM 控制台 -&gt; 角色 (Roles)。</li>
<li>搜索并点击你的 EKS 集群角色,本示例中为 <code>eksClusterRole</code>。</li>
<li>点击 <strong>信任关系 (Trust relationships)</strong> 选项卡。</li>
<li>点击 <strong>编辑信任策略 (Edit trust policy)</strong> 。默认内容如下 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br><span class="line">    &quot;Statement&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Effect&quot;: &quot;Allow&quot;,</span><br><span class="line">            &quot;Principal&quot;: &#123;</span><br><span class="line">                &quot;Service&quot;: &quot;eks.amazonaws.com&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Action&quot;: &quot;sts:AssumeRole&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
修改为以下内容，在 <code>Action</code> 列表中添加 <code>sts:TagSession</code> <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br><span class="line">    &quot;Statement&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Effect&quot;: &quot;Allow&quot;,</span><br><span class="line">            &quot;Principal&quot;: &#123;</span><br><span class="line">                &quot;Service&quot;: &quot;eks.amazonaws.com&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Action&quot;: [&quot;sts:AssumeRole&quot;,</span><br><span class="line">            &quot;sts:TagSession&quot;</span><br><span class="line">        ]&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>修改完成后，点击 <strong>更新策略 (Update policy)</strong></li>
</ol>
<h1 id="EKS-集群相关配置及操作"><a href="#EKS-集群相关配置及操作" class="headerlink" title="EKS 集群相关配置及操作"></a>EKS 集群相关配置及操作</h1><h2 id="修改-EKS-集群-API-server-endpoint-访问权限"><a href="#修改-EKS-集群-API-server-endpoint-访问权限" class="headerlink" title="修改 EKS 集群 API server endpoint 访问权限"></a>修改 EKS 集群 API server endpoint 访问权限</h2><p>默认 EKS 集群部署后，API server endpoint access 模式提供了三种：</p>
<ul>
<li><strong>Public Only</strong> ：API Server endpoint 仅通过公网访问。</li>
<li><strong>Public and Private</strong> ：同时开启。VPC 内流量走私有 Endpoint，外部走公网。</li>
<li><strong>Private Only</strong> ：彻底关闭公网入口。这是安全性最高但也最复杂的模式。</li>
</ul>
<p>默认为 <code>Public and private</code><br><img src="https://i.csms.tech/img_409.png"></p>
<p>因此 API server endpoint 可以公网和 VPC 私网中访问。</p>
<p>要修改，可以在控制台 <strong>Cluster –&gt; Networking: Manage –&gt; endpoint access</strong> 进行修改，如果配置为 <strong>Public</strong> 或者 <strong>Public and Private</strong> ，可以通过修改 <code>Add/edit sources to public access endpoint.</code> 为公网访问添加白名单，提高安全性。</p>
<p>也可通过 AWS CLI 修改</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">aws eks update-cluster-config \</span><br><span class="line">    --name &lt;cluster-name&gt; \</span><br><span class="line">    --resources-vpc-config endpointPublicAccess=false,endpointPrivateAccess=true</span><br></pre></td></tr></table></figure>

<p>如果开启了 <strong>仅限私有访问</strong> ，你必须确保 VPC 满足以下条件，否则集群将无法正常工作：</p>
<ul>
<li><p><strong>启用私有 DNS 支持</strong> ：</p>
<p>  VPC 必须开启 <code>enableDnsHostnames</code> 和 <code>enableDnsSupport</code> 。这样 EKS 才能在私有网络内解析 API Server 的域名。</p>
</li>
<li><p><strong>VPC 端点 (Interface VPC Endpoints)</strong> ：</p>
<p>  由于 Node 无法访问公网，它们必须通过 VPC Endpoints 连接 AWS 服务。你通常需要为以下服务创建 Interface Endpoint：</p>
<ul>
<li><p><strong>ec2</strong> （用于挂载卷&#x2F;管理网卡）</p>
</li>
<li><p><strong>ecr.api</strong> 和 <strong>ecr.dkr</strong>（用于拉取镜像）</p>
</li>
<li><p><strong>s3 (Gateway Endpoint)</strong></p>
</li>
<li><p><strong>logs</strong> (CloudWatch 日志)</p>
</li>
</ul>
</li>
<li><p><strong>管理通道</strong> ：</p>
<p>  你必须拥有一个进入 VPC 的手段（如 AWS Client VPN 或 堡垒机 (Bastion Host)），否则你将无法运行任何 <code>kubectl</code> 命令。</p>
</li>
</ul>
<h2 id="为-EKS-集群安装-AWS-Loadbalancer-Controller"><a href="#为-EKS-集群安装-AWS-Loadbalancer-Controller" class="headerlink" title="为 EKS 集群安装 AWS Loadbalancer Controller"></a>为 EKS 集群安装 AWS Loadbalancer Controller</h2><p>在集群中使用 AWS LoadBalance 向互联网提供 EKS 集群中的服务，需要在集群中安装 <strong>AWS Load Balancer Controller (LBC)</strong> ，类似要使用 Ingress Nginx 则需要在集群中安装 Ingress Nginx Controller 一样。</p>
<p><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/aws-load-balancer-controller.html">AWS 负载均衡器控制器（AWS Load Balancer Controller）官方文档</a></p>
<p>LBC 会在您创建 Kubernetes Ingress 时创建 AWS 应用程序负载均衡器（ALB）。</p>
<p><strong>若集群所在 VPC 中存在公有子网和私有子网，为了让 EKS 自动识别哪些子网用于存放负载均衡器，哪些用于存放 Pod，你需要确保子网拥有正确的标签（只有共有子网可忽略此配置）：</strong></p>
<ul>
<li><p><strong>公有子网 (NAT Gateway 所在的子网)</strong> ：</p>
<ul>
<li>标签： <code>kubernetes.io/role/elb = 1</code></li>
</ul>
</li>
<li><p><strong>私有子网 (EKS 节点所在的子网)</strong> ：</p>
<ul>
<li>标签：<code>kubernetes.io/role/internal-elb = 1</code></li>
</ul>
</li>
</ul>
<p>检查集群中是否安装了 AWS Load Balancer Controller</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl get pods -n kube-system | grep -i controller</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/lbc-helm.html">使用 Helm 和 eksctl 安装 AWS Load Balancer Controller（负载均衡器控制器）</a></p>
<p><a target="_blank" rel="noopener" href="https://helm.sh/docs/intro/install">安装 Helm</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-4</span><br><span class="line">chmod 700 get_helm.sh</span><br><span class="line">./get_helm.sh</span><br></pre></td></tr></table></figure>

<p>参考以下步骤安装 AWS Load Balancer Controller，本示例版本 v3.0.0</p>
<ol>
<li><p>下载 AWS 负载均衡器控制器（Load Balancer Controller）的 IAM 策略，该策略允许负载均衡器代表您调用 AWS API。</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl -o iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v3.0.0/docs/install/iam_policy.json</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用上一步中下载的策略创建一个 IAM 策略。</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 检查是否已存在策略 AWSLoadBalancerControllerIAMPolicy</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">aws iam list-policies | grep -i AWSLoadBalancerControllerIAMPolicy</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 使用下载的策略文件创建新策略 AWSLoadBalancerControllerIAMPolicy</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">aws iam create-policy \</span></span><br><span class="line"><span class="language-bash">    --policy-name AWSLoadBalancerControllerIAMPolicy \</span></span><br><span class="line"><span class="language-bash">    --policy-document file://iam_policy.json</span></span><br><span class="line">    </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">aws iam list-policies | grep -B 1 -A 10 -i AWSLoadBalancerControllerIAMPolicy</span></span><br><span class="line">        &#123;</span><br><span class="line">            &quot;PolicyName&quot;: &quot;AWSLoadBalancerControllerIAMPolicy&quot;,</span><br><span class="line">            &quot;PolicyId&quot;: &quot;ANPATVYVE6LERMKGVRCSF&quot;,</span><br><span class="line">            &quot;Arn&quot;: &quot;arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:policy/AWSLoadBalancerControllerIAMPolicy&quot;,</span><br><span class="line">            &quot;Path&quot;: &quot;/&quot;,</span><br><span class="line">            &quot;DefaultVersionId&quot;: &quot;v1&quot;,</span><br><span class="line">            &quot;AttachmentCount&quot;: 0,</span><br><span class="line">            &quot;PermissionsBoundaryUsageCount&quot;: 0,</span><br><span class="line">            &quot;IsAttachable&quot;: true,</span><br><span class="line">            &quot;CreateDate&quot;: &quot;2026-02-09T12:44:19+00:00&quot;,</span><br><span class="line">            &quot;UpdateDate&quot;: &quot;2026-02-09T12:44:19+00:00&quot;</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 EKS 集群中创建 <code>iamserviceaccount</code> ，替换命令中集群名称、区域代码和账户 ID 的值。</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">eksctl create iamserviceaccount \</span></span><br><span class="line"><span class="language-bash">    --cluster=&lt;cluster-name&gt; \</span></span><br><span class="line"><span class="language-bash">    --namespace=kube-system \</span></span><br><span class="line"><span class="language-bash">    --name=aws-load-balancer-controller \</span></span><br><span class="line"><span class="language-bash">    --attach-policy-arn=arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:policy/AWSLoadBalancerControllerIAMPolicy \</span></span><br><span class="line"><span class="language-bash">    --override-existing-serviceaccounts \</span></span><br><span class="line"><span class="language-bash">    --region &lt;aws-region-code&gt; \</span></span><br><span class="line"><span class="language-bash">    --approve</span></span><br><span class="line">   </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 检查 EKS 系统中的 iamserviceaccount</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">eksctl get iamserviceaccount --cluster &lt;cluster-name&gt;</span> </span><br><span class="line">NAMESPACE	NAME				ROLE ARN</span><br><span class="line">kube-system	aws-load-balancer-controller	arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/eksctl-&lt;cluster-name&gt;-addon-iamserviceaccount-kube-syst-Role1-dUL3ua7Mv2Gv</span><br></pre></td></tr></table></figure>
<p> 如果创建报错： <code>no IAM OIDC provider associated with cluster, try &#39;eksctl utils associate-iam-oidc-provider --region=ap-east-1 --cluster=&lt;cluster-name&gt;&#39;</code> ，先执行下面的命令 <strong>为 EKS 集群关联 OIDC Provider</strong> 然后在创建 <code>iamserviceaccount</code></p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">eksctl utils associate-iam-oidc-provider \</span><br><span class="line">  --region &lt;aws-region-code&gt; \</span><br><span class="line">  --cluster &lt;cluster-name&gt; \</span><br><span class="line">  --approve</span><br></pre></td></tr></table></figure>

</li>
<li><p>安装 AWS 负载均衡器控制器(AWS Load Balancer Controller)</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">helm repo add eks https://aws.github.io/eks-charts</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">helm repo list</span></span><br><span class="line">NAME	URL                             </span><br><span class="line">eks 	https://aws.github.io/eks-charts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">helm repo update eks</span></span><br><span class="line">Hang tight while we grab the latest from your chart repositories...</span><br><span class="line">...Successfully got an update from the &quot;eks&quot; chart repository</span><br><span class="line">Update Complete. ⎈Happy Helming!⎈</span><br><span class="line">   </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 获取集群使用的 VPC ID，安装 aws-load-balancer-controller 时需要显式指定</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">aws eks describe-cluster --name &lt;cluster-name&gt; --query <span class="string">&quot;cluster.resourcesVpcConfig.vpcId&quot;</span> --output text</span></span><br><span class="line">vpc-05840086... </span><br><span class="line">   </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">helm install aws-load-balancer-controller eks/aws-load-balancer-controller \</span></span><br><span class="line"><span class="language-bash">  -n kube-system \</span></span><br><span class="line"><span class="language-bash">  --<span class="built_in">set</span> clusterName=&lt;cluster-name&gt; \</span></span><br><span class="line"><span class="language-bash">  --<span class="built_in">set</span> serviceAccount.create=<span class="literal">false</span> \</span></span><br><span class="line"><span class="language-bash">  --<span class="built_in">set</span> serviceAccount.name=aws-load-balancer-controller \</span></span><br><span class="line"><span class="language-bash"> --<span class="built_in">set</span> vpcId=&lt;VPC_ID&gt; \</span></span><br><span class="line"><span class="language-bash">  --version 3.0.0</span></span><br><span class="line"></span><br><span class="line">NAME: aws-load-balancer-controller</span><br><span class="line">LAST DEPLOYED: Mon Feb  9 13:11:30 2026</span><br><span class="line">NAMESPACE: kube-system</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">DESCRIPTION: Install complete</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">AWS Load Balancer controller installed!</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>验证控制器是否已安装成功，最主要是要有 <code>ingressClass alb</code> </p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pod -A</span></span><br><span class="line">NAMESPACE     NAME                                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   aws-load-balancer-controller-949f9d848-4qtlz   1/1     Running   0          41s</span><br><span class="line">kube-system   aws-load-balancer-controller-949f9d848-ww5jv   1/1     Running   0          23s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get deployment -n kube-system aws-load-balancer-controller</span></span><br><span class="line">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">aws-load-balancer-controller   2/2     2            2           41m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get ingressclass -A</span></span><br><span class="line">NAME   CONTROLLER            PARAMETERS   AGE</span><br><span class="line">alb    ingress.k8s.aws/alb   &lt;none&gt;       43m</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="AWS-Load-Balancer-controller-相关错误"><a href="#AWS-Load-Balancer-controller-相关错误" class="headerlink" title="AWS Load Balancer controller 相关错误"></a>AWS Load Balancer controller 相关错误</h3><h4 id="AWS-Load-Balancer-controller-部署后-Pod-状态为-CrashLoopBackOff"><a href="#AWS-Load-Balancer-controller-部署后-Pod-状态为-CrashLoopBackOff" class="headerlink" title="AWS Load Balancer controller 部署后 Pod 状态为 CrashLoopBackOff"></a>AWS Load Balancer controller 部署后 Pod 状态为 CrashLoopBackOff</h4><p>AWS Load Balancer controller 版本： v3.0.0</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pod -A</span></span><br><span class="line">NAMESPACE     NAME                                           READY   STATUS             RESTARTS      AGE</span><br><span class="line">kube-system   aws-load-balancer-controller-bd997488d-gwc7q   0/1     CrashLoopBackOff   5 (95s ago)   5m19s</span><br><span class="line">kube-system   aws-load-balancer-controller-bd997488d-mknn4   0/1     CrashLoopBackOff   5 (93s ago)   5m19s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl describe pod -n kube-system   aws-load-balancer-controller-bd997488d-gwc7q</span></span><br><span class="line">...</span><br><span class="line">  Warning  BackOff           31s (x21 over 14m)   kubelet                Back-off restarting failed container aws-load-balancer-controller in pod aws-load-balancer-controller-bd997488d-gwc7q_kube-system(a66700e5-c2b8-40d6-ad88-c277551a6626)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl logs -f -n kube-system   aws-load-balancer-controller-bd997488d-gwc7q</span></span><br><span class="line">&#123;&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:&quot;2026-02-09T13:15:42Z&quot;,&quot;msg&quot;:&quot;version&quot;,&quot;GitVersion&quot;:&quot;v2.14.0&quot;,&quot;GitCommit&quot;:&quot;d847890e67b4c3a78f230bd7f7caf2bfcab01df1&quot;,&quot;BuildDate&quot;:&quot;2025-10-02T19:02:22+0000&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;:&quot;error&quot;,&quot;ts&quot;:&quot;2026-02-09T13:15:47Z&quot;,&quot;logger&quot;:&quot;setup&quot;,&quot;msg&quot;:&quot;unable to initialize AWS cloud&quot;,&quot;error&quot;:&quot;failed to get VPC ID: failed to fetch VPC ID from instance metadata: error in fetching vpc id through ec2 metadata: get mac metadata: operation error ec2imds: GetMetadata, canceled, context deadline exceeded&quot;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>关键报错信息 <code>failed to get VPC ID: failed to fetch VPC ID from instance metadata: error in fetching vpc id through ec2 metadata: get mac metadata: operation error ec2imds: GetMetadata, canceled, context deadline exceeded</code> </p>
<p><strong>ALB Controller 启动时必须知道自己在哪个 VPC</strong> ，此报错说明控制器无法从 EC2 元数据服务 (IMDS) 获取 VPC ID。可以为控制器显式指定 VPC ID</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">aws eks describe-cluster --name &lt;CLUSTER_NAME&gt; --query <span class="string">&quot;cluster.resourcesVpcConfig.vpcId&quot;</span> --output text</span></span><br><span class="line">vpc-05840086...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 使用 upgrade 更新配置</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">helm upgrade aws-load-balancer-controller eks/aws-load-balancer-controller \</span></span><br><span class="line"><span class="language-bash">  -n kube-system \</span></span><br><span class="line"><span class="language-bash">  --<span class="built_in">set</span> clusterName=&lt;cluster-name&gt; \</span></span><br><span class="line"><span class="language-bash">  --<span class="built_in">set</span> serviceAccount.create=<span class="literal">false</span> \</span></span><br><span class="line"><span class="language-bash">  --<span class="built_in">set</span> serviceAccount.name=aws-load-balancer-controller \</span></span><br><span class="line"><span class="language-bash">  --<span class="built_in">set</span> vpcId=&lt;VPC_ID&gt; \</span></span><br><span class="line"><span class="language-bash">  --version 3.0.0</span></span><br><span class="line">Release &quot;aws-load-balancer-controller&quot; has been upgraded. Happy Helming!</span><br><span class="line">NAME: aws-load-balancer-controller</span><br><span class="line">LAST DEPLOYED: Mon Feb  9 13:49:09 2026</span><br><span class="line">NAMESPACE: kube-system</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 3</span><br><span class="line">DESCRIPTION: Upgrade complete</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">AWS Load Balancer controller installed!</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 更新 VPC ID 后 ALB Controller 正常启动</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pod -A</span></span><br><span class="line">NAMESPACE     NAME                                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   aws-load-balancer-controller-949f9d848-4qtlz   1/1     Running   0          41s</span><br><span class="line">kube-system   aws-load-balancer-controller-949f9d848-ww5jv   1/1     Running   0          23s</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="在-EKS-自动模式集群中检查-Amazon-EBS-CSI-控制器状态"><a href="#在-EKS-自动模式集群中检查-Amazon-EBS-CSI-控制器状态" class="headerlink" title="在 EKS 自动模式集群中检查 Amazon EBS CSI 控制器状态"></a>在 EKS 自动模式集群中检查 Amazon EBS CSI 控制器状态</h2><p>EKS 自动模式（EKS Auto Mode）默认无需在集群上安装 Amazon EBS CSI 控制器。<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/eks/latest/userguide/ebs-csi.html">官方文档说明</a></p>
<p><strong>查看集群中已经安装的 CSI Driver</strong> 。EKS 自动模式（EKS Auto Mode）默认安装了 <code>ebs.csi.eks.amazonaws.com </code> 和 <code>efs.csi.aws.com</code> 两个 SCI Driver 用于创建 EBS 和 EFS 类型的 StorageClass</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get csidrivers</span></span><br><span class="line">NAME                        ATTACHREQUIRED   PODINFOONMOUNT   STORAGECAPACITY   TOKENREQUESTS   REQUIRESREPUBLISH   MODES        AGE</span><br><span class="line">ebs.csi.eks.amazonaws.com   true             false            false             &lt;unset&gt;         false               Persistent   7d16h</span><br><span class="line">efs.csi.aws.com             false            false            false             &lt;unset&gt;         false               Persistent   7d16h</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>查看 StorageClass</strong> 信息，EKS 自动模式（EKS Auto Mode）使用 <code>provisioner: ebs.csi.eks.amazonaws.com</code> ，普通 EKS 集群安装的 AWS EBS SCSI Drive 使用 <code>provisioner: ebs.csi.aws.com</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get storageclasses</span></span><br><span class="line">NAME   PROVISIONER                 RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">gp3    ebs.csi.eks.amazonaws.com   Delete          WaitForFirstConsumer   true                   10s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl describe storageclass gp3</span></span><br><span class="line">Name:            gp3</span><br><span class="line">IsDefaultClass:  No</span><br><span class="line">Annotations:     kubectl.kubernetes.io/last-applied-configuration=&#123;&quot;allowVolumeExpansion&quot;:true,&quot;apiVersion&quot;:&quot;storage.k8s.io/v1&quot;,&quot;kind&quot;:&quot;StorageClass&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;gp3&quot;&#125;,&quot;parameters&quot;:&#123;&quot;fsType&quot;:&quot;ext4&quot;,&quot;type&quot;:&quot;gp3&quot;&#125;,&quot;provisioner&quot;:&quot;ebs.csi.eks.amazonaws.com&quot;,&quot;reclaimPolicy&quot;:&quot;Delete&quot;,&quot;volumeBindingMode&quot;:&quot;WaitForFirstConsumer&quot;&#125;</span><br><span class="line"></span><br><span class="line">Provisioner:           ebs.csi.eks.amazonaws.com</span><br><span class="line">Parameters:            fsType=ext4,type=gp3</span><br><span class="line">AllowVolumeExpansion:  True</span><br><span class="line">MountOptions:          &lt;none&gt;</span><br><span class="line">ReclaimPolicy:         Delete</span><br><span class="line">VolumeBindingMode:     WaitForFirstConsumer</span><br><span class="line">Events:                &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>此 Storageclass <code>gp3</code> 对应的 YAML 配置文件如下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: gp3</span><br><span class="line">provisioner: ebs.csi.eks.amazonaws.com</span><br><span class="line">parameters:</span><br><span class="line">  type: gp3</span><br><span class="line">  fsType: ext4</span><br><span class="line">volumeBindingMode: WaitForFirstConsumer</span><br><span class="line">reclaimPolicy: Delete</span><br><span class="line">allowVolumeExpansion: true</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="为集群分配只读权限的账户"><a href="#为集群分配只读权限的账户" class="headerlink" title="为集群分配只读权限的账户"></a>为集群分配只读权限的账户</h2><p>EKS 账户权限是 <strong>AWS IAM 权限 + Kubernetes RBAC</strong> 两层权限一起管。</p>
<p>本示例目标是：用户能看集群资源（ <code>kubectl get/describe</code> ），但不能改（ <code>create/update/delete</code> ）。</p>
<ol>
<li><p>在 AWS IAM 中创建用户如 <code>EKSReadOnlyUSER</code> ，确保该 IAM 用户或角色在 AWS 层面能够“看到”集群。创建一个名为 <code>EKSReadOnlyPolicy</code> 的策略并关联给该用户</p>
 <figure class="highlight json"><figcaption><span>EKSReadOnlyPolicy</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;eks:DescribeCluster&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;eks:ListClusters&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li><p>使用 EKS 的 <strong>Access Entries (访问条目)</strong> 机制为集群访问创建 <strong>访问条目 (Access Entry)</strong> </p>
<blockquote>
<p>新版本的 EKS 集群启用了 <strong>API 身份验证模式 (API Authentication Mode)</strong> 。可以直观的通过 <strong>访问条目 (Access Entry)</strong> 控制对集群的访问<br><img src="https://i.csms.tech/img_398.png"></p>
<p>AWS Console（控制台）查看 Access Entry<br><img src="https://i.csms.tech/img_407.png"></p>
<p><code>aws</code> 命令查看 Access Entry</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">aws eks list-access-entries --cluster-name MY_CLUSTER</span></span><br><span class="line">&#123;</span><br><span class="line">    &quot;accessEntries&quot;: [</span><br><span class="line">        &quot;arn:aws:iam::25291...:role/aws-service-role/eks.amazonaws.com/AWSServiceRoleForAmazonEKS&quot;,</span><br><span class="line">        &quot;arn:aws:iam::25291...:role/eksNodeRole&quot;,</span><br><span class="line">        &quot;arn:aws:iam::252910...:user/CLUSTER_USER&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<p> EKS 的 Access Policies 中有个内置的策略 <code>AmazonEKSViewPolicy</code> ，已经实现了只读效果（能 <code>get / list / watch</code> 不能 <code>create / update / delete</code> ），因此只需要创建新的 <strong>IAM access entry</strong> 并将 <code>AmazonEKSViewPolicy</code> 策略附加其上即可。</p>
<p> <img src="https://i.csms.tech/img_400.png"></p>
</li>
<li><p>在客户端使用 IAM 用户 <code>EKSReadOnlyUSER</code> 的身份凭证登陆即可进行验证</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get nodes</span></span><br><span class="line">Error from server (Forbidden): nodes is forbidden: User &quot;arn:aws:iam::25....:user/EKSReadOnlyUSER&quot; cannot list resource &quot;nodes&quot; in API group &quot;&quot; at the cluster scope</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pods</span></span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">netshoot-daemonset-s5sbr            1/1     Running   0          6h42m</span><br><span class="line">nginx-deployment-5746cdf7c8-9vw9w   1/1     Running   0          4h49m</span><br><span class="line">nginx-deployment-5746cdf7c8-j772t   1/1     Running   0          4h49m</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>如果 EKS 集群接入 Rancher 进行管理，可以直接通过 Rancher 的 RBAC 机制进行用户权限分配，会比 EKS 和原生 K8S 更加的直观方便。</strong></p>
<h2 id="启用-EKS-中的-Ingress-的-Access-Log-记录"><a href="#启用-EKS-中的-Ingress-的-Access-Log-记录" class="headerlink" title="启用 EKS 中的 Ingress 的 Access Log 记录"></a>启用 EKS 中的 Ingress 的 Access Log 记录</h2><p>EKS 中创建的 Ingress 的 IngressClass 为 <code>alb</code> 时，AWS Load Balancer Controller 会为 Ingress 创建对应的 ALB（AWS Load Balancer），ALB 默认的访问日志（Access Logs）是关闭的。要 <strong>开启访问日志（Access Logs），需要通过修改 Kubernetes Ingress 资源的 Annotation（注解） 来实现</strong> 。</p>
<p><strong>在 AWS 的架构设计中，S3 是 ALB 访问日志的法定落脚点。目前 ALB 的访问日志（七层请求详情）在 AWS 控制台或 API 配置中，仅支持写入 S3。它不支持直接推送至 CloudWatch Logs 或 Kinesis</strong> 。</p>
<p>因此要开启 ALB 的访问日志（七层请求详情），要首先准备好 S3 桶和权限。S3 要注意以下事项：</p>
<blockquote>
<ul>
<li>S3 Bucket 必须与 ALB 处于同一个 AWS 区域（例如都在 ap-southeast-1 新加坡）。</li>
<li>如果 S3 配置不正确，日志投递会失败，但这绝不会影响 ALB 的正常流量转发。</li>
<li>ALB 将日志发送到同一个区域的 S3 是免收流量费的</li>
<li>记得给 S3 设置 生命周期规则（Lifecycle Policy），比如 30 天后自动删除或转入冷存储，否则长期积累会导致存储费上涨。</li>
</ul>
</blockquote>
<p>参考以下步骤配置 S3，<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/zh_cn/elasticloadbalancing/latest/application/enable-access-logging.html">为 Application Load Balancer 启用访问日志官方文档</a></p>
<ol>
<li><p>创建 S3 存储桶（Bucket）， <strong>桶的区域 (Region) 必须和 ALB 一致，该存储桶和负载均衡器可由不同的账户拥有</strong> 。</p>
</li>
<li><p><strong>配置 Bucket Policy（存储桶策略），S3 存储桶必须具有为 Elastic Load Balancing 授予将访问日志写入存储桶的权限的存储桶策略</strong> 。</p>
<p> 在 Permissions (权限) 选项卡中，编辑 Bucket Policy。</p>
 <figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span><span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span>		 	 	 </span><br><span class="line">  <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Service&quot;</span><span class="punctuation">:</span> <span class="string">&quot;logdelivery.elasticloadbalancing.amazonaws.com&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s3:PutObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:s3:::&lt;BUCKET NAME&gt;/*&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<p>然后修改 Ingress 配置。在 Ingress 中添加 Annotation</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># 开启访问日志</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/load-balancer-attributes:</span> <span class="string">access_logs.s3.enabled=true,access_logs.s3.bucket=&lt;你的-s3-bucket-名字&gt;,access_logs.s3.prefix=&lt;logs-prefix&gt;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># ... 其他配置</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>alb.ingress.kubernetes.io/load-balancer-attributes: access_logs.s3.enabled=true,access_logs.s3.bucket=&lt;你的-s3-bucket-名字&gt;,access_logs.s3.prefix=&lt;logs-prefix&gt;</code>  配置指定启用 Access Logs 写入 S3，<logs-prefix> 指定日志写入 S3 中的路径，多项目多集群可以按照项目或集群多目录分割，如 <code>access_logs.s3.prefix=EKS_CLUSTER_A/PROJECT_A</code></li>
</ul>
</blockquote>
<p>部署 ALB 后，可在 AWS Console 中查看 ALB 中是否有日志传送相关配置， <strong>AWS Console -&gt; EC2 -&gt; Load balancers -&gt; Attributes: Monitoring</strong><br><img src="https://i.csms.tech/img_420.png"></p>
<p><strong>当你修改了 EKS 的 Ingress Annotation 开启日志后，可以去 S3 桶里看看</strong></p>
<ul>
<li><strong>测试文件</strong> ： ALB 开启成功后的几分钟内，通常会先往桶里写入一个名为 <code>ELBAccessLogTestFile</code> 的文件。</li>
<li><strong>看到这个文件，就说明权限配置完全正确。</strong></li>
</ul>
<p>需要分析时可下载日志解压查看内容</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">http 2026-02-13T05:22:42.367084Z app/k8s-argocd-argocd-8e8cb645d5/026e67072db1ff28 54.254.220.119:57674 172.31.68.217:8080 0.000 -1 -1 460 - 1537 0 &quot;GET http://k8s-argocd-argocd-8e8cb645d5-1951055800.ap-east-1.elb.amazonaws.com:80/api/v1/stream/applications?resourceVersion=3228300&amp;fields=result.type%2Cresult.application.metadata.name%2Cresult.application.metadata.namespace%2Cresult.application.metadata.annotations%2Cresult.application.metadata.labels%2Cresult.application.metadata.creationTimestamp%2Cresult.application.metadata.deletionTimestamp%2Cresult.application.spec%2Cresult.application.operation.sync%2Cresult.application.status.sourceHydrator%2Cresult.application.status.sync.status%2Cresult.application.status.sync.revision%2Cresult.application.status.health%2Cresult.application.status.operationState.phase%2Cresult.application.status.operationState.finishedAt%2Cresult.application.status.operationState.operation.sync%2Cresult.application.status.summary%2Cresult.application.status.resources&amp;selector=&amp;appNamespace= HTTP/1.1&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.0.0 Safari/537.36&quot; - - arn:aws:elasticloadbalancing:ap-east-1:252910564041:targetgroup/k8s-argocd-argocdse-b493e951a4/7f99bffde71cf22d &quot;Root=1-698eb521-7f4353266a582d904a42b4a2&quot; &quot;-&quot; &quot;-&quot; 1 2026-02-13T05:22:41.230000Z &quot;forward&quot; &quot;-&quot; &quot;-&quot; &quot;172.31.68.217:8080&quot; &quot;-&quot; &quot;-&quot; &quot;-&quot; TID_2642ce98c4c35148ad54404d5523a955 &quot;-&quot; &quot;-&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure>
<p><strong>ALB 日志字段参考</strong> :</p>
<ul>
<li><code>type</code> : 协议类型（ <code>http, https, h2, ws, wss</code> ）。</li>
<li><code>timestamp</code> : ALB 收到请求并完成响应的时间。</li>
<li><code>elb</code> : ALB 名称&#x2F;资源 ID（<code>app/k8s-argocd-argocd-8e8cb645d5/026e67072db1ff28</code>）</li>
<li><code>client:port</code> : 发起请求的客户端 IP 和端口。</li>
<li><code>target:port</code> : 后端 Target（Pod） 的私网 IP 和端口。 如果为 <code>-</code> 表示请求未到达后端。</li>
<li><code>request_processing_time</code> : 请求处理时间</li>
<li><code>target_processing_time</code> : 后端 Target(Pod) 的处理时间</li>
<li><code>response_processing_time</code> : 响应处理时间</li>
<li><code>elb_status_code</code> : ALB 返回给客户端的状态码。</li>
<li><code>target_status_code</code> : 后端 Pod 返回的状态码。 如果是 <code>-</code> 说明 ALB 自己挂了或主动拦截了。</li>
<li><code>request_bytes</code> : ALB 收到的字节数</li>
<li><code>response_bytes</code> : ALB 发送给客户端的字节数。</li>
<li><code>request</code> : 完整的 HTTP 请求行。</li>
<li><code>user_agent</code> : 客户端浏览器信息。</li>
<li><code>ssl_cipher</code> : SSL 加密套件和协议（非 HTTPS 请求则为 <code>-</code> ）。</li>
<li><code>ssl_protocol</code> : SSL 加密套件和协议（非 HTTPS 请求则为 <code>-</code> ）。</li>
<li><code>target_group_arn</code> : 处理该请求的 Target Group 的 ARN。</li>
<li><code>trace_id</code> : X-Amzn-Trace-Id，可用于全链路追踪。</li>
<li><code>domain_name</code> : 请求匹配的 <code>Host</code> 头部，如果没有 <code>Host</code> 匹配规则则为 <code>-</code></li>
<li><code>chosen_cert_arn</code> : 匹配到的 ACM 证书 ARN（HTTPS Listener）</li>
<li><code>matched_rule_priority</code> : 匹配到的 Listener Rule 优先级</li>
<li><code>request_creation_time</code> : ALB 接收到请求的时间</li>
<li><code>actions_executed</code> : 执行的动作，可能值： <code>forward, redirect, fixed-response, authenticate, waf</code></li>
<li><code>redirect_url</code> : 如果执行 <code>redirect</code> ，显示重定向 URL</li>
<li><code>error_reason</code> ： 错误原因（当发生错误时），如 <code>Target.ResponseCodeMismatch</code> , <code>Target.Timeout</code> , <code>ELB.5XX</code></li>
<li><code>target:port_list</code> : 如果多个目标，列出所有目标</li>
<li><code>target_status_code_list</code> : 多个目标返回状态码</li>
<li><code>classification</code> : 请求分类，如 <code>waf</code> , <code>monitoring</code> , <code>health-check</code></li>
<li><code>classification_reason</code> : 分类原因说明</li>
</ul>
<h2 id="EKS-部署-Prometheus-监控"><a href="#EKS-部署-Prometheus-监控" class="headerlink" title="EKS 部署 Prometheus 监控"></a>EKS 部署 Prometheus 监控</h2><p>最标准的部署方式是使用 <code>kube-prometheus-stack</code> 。这套方案不仅包含 Prometheus 本身，还集成了 Operator、Grafana、告警管理以及预设的 K8s 监控面板。</p>
<p>如果不想部署 Grafana，只部署 Prometheus，可以使用以下配置文件 <code>values.yaml</code></p>
<figure class="highlight yaml"><figcaption><span>values.yaml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">## 1. 禁用不需要的组件</span></span><br><span class="line"><span class="attr">grafana:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">alertmanager:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 2. 启用核心指标采集组件</span></span><br><span class="line"><span class="attr">prometheusOperator:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 收集 K8s 对象指标 (Deployment, Pod 状态等)</span></span><br><span class="line"><span class="attr">kube-state-metrics:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 收集物理节点指标 (CPU, Mem, Disk)</span></span><br><span class="line"><span class="attr">prometheus-node-exporter:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 收集 Kubelet 指标 (基础容器监控)</span></span><br><span class="line"><span class="attr">kubelet:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 3. Prometheus 实例配置</span></span><br><span class="line"><span class="attr">prometheus:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">prometheusSpec:</span></span><br><span class="line">    <span class="comment"># 自动发现 ServiceMonitor</span></span><br><span class="line">    <span class="attr">serviceMonitorSelectorNilUsesHelmValues:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 数据保留时长</span></span><br><span class="line">    <span class="attr">retention:</span> <span class="string">7d</span></span><br><span class="line">    <span class="comment"># 存储配置 (根据需要修改，这里使用 gp3)</span></span><br><span class="line">    <span class="attr">storageSpec:</span></span><br><span class="line">      <span class="attr">volumeClaimTemplate:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">storageClassName:</span> <span class="string">gp3</span></span><br><span class="line">          <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">storage:</span> <span class="string">20Gi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 4. 暴露 Prometheus 给外部 Grafana 访问</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ClusterIP</span>  <span class="comment"># 配合 Ingress 对外暴露服务</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9090</span></span><br></pre></td></tr></table></figure>

<p>执行部署</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加仓库</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">helm repo add prometheus-community https://prometheus-community.github.io/helm-charts</span></span><br><span class="line">&quot;prometheus-community&quot; has been added to your repositories</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">helm repo update</span></span><br><span class="line">Hang tight while we grab the latest from your chart repositories...</span><br><span class="line">...Successfully got an update from the &quot;prometheus-community&quot; chart repository</span><br><span class="line">Update Complete. ⎈Happy Helming!⎈</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建命名空间</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl create namespace monitoring</span></span><br><span class="line">namespace/monitoring created</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">部署</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">helm install eks-monitor prometheus-community/kube-prometheus-stack   --namespace monitoring   -f eks-monitor-kube-prometheus-stack-values.yaml</span> </span><br><span class="line">NAME: eks-monitor</span><br><span class="line">LAST DEPLOYED: Fri Feb 13 16:53:08 2026</span><br><span class="line">NAMESPACE: monitoring</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">DESCRIPTION: Install complete</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">kube-prometheus-stack has been installed. Check its status by running:</span><br><span class="line">  kubectl --namespace monitoring get pods -l &quot;release=eks-monitor&quot;</span><br><span class="line"></span><br><span class="line">Get Grafana &#x27;admin&#x27; user password by running:</span><br><span class="line"></span><br><span class="line">  kubectl --namespace monitoring get secrets eks-monitor-grafana -o jsonpath=&quot;&#123;.data.admin-password&#125;&quot; | base64 -d ; echo</span><br><span class="line"></span><br><span class="line">Access Grafana local instance:</span><br><span class="line"></span><br><span class="line">  export POD_NAME=$(kubectl --namespace monitoring get pod -l &quot;app.kubernetes.io/name=grafana,app.kubernetes.io/instance=eks-monitor&quot; -oname)</span><br><span class="line">  kubectl --namespace monitoring port-forward $POD_NAME 3000</span><br><span class="line"></span><br><span class="line">Get your grafana admin user password by running:</span><br><span class="line"></span><br><span class="line">  kubectl get secret --namespace monitoring -l app.kubernetes.io/component=admin-secret -o jsonpath=&quot;&#123;.items[0].data.admin-password&#125;&quot; | base64 --decode ; echo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Visit https://github.com/prometheus-operator/kube-prometheus for instructions on how to create &amp; configure Alertmanager and Prometheus instances using the Operator.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>使用以下配置部署 ALB</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># 指定使用 ALB</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/scheme:</span> <span class="string">internet-facing</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/target-type:</span> <span class="string">ip</span></span><br><span class="line">    <span class="comment"># 如果需要 HTTPS，取消下面注释并配置证书 ARN</span></span><br><span class="line">    <span class="comment"># alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:region:<span class="doctag">xxx:</span>certificate/xxx</span></span><br><span class="line">    <span class="comment"># alb.ingress.kubernetes.io/listen-ports: &#x27;[&#123;&quot;HTTP&quot;: 80&#125;, &#123;&quot;HTTPS&quot;:443&#125;]&#x27;</span></span><br><span class="line">    <span class="comment"># 指定 alb 健康检查的路径，否则默认检查 / 会返回 302 导致检查失败，alb异常</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/healthcheck-path:</span> <span class="string">/-/healthy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">alb</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">eks-monitor-kube-prometheu-prometheus</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">9090</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>检查相关资源</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pods,svc,ingresses -n monitoring</span></span><br><span class="line">NAME                                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/eks-monitor-kube-prometheu-operator-7c44f5855b-bshnl   1/1     Running   0          17m</span><br><span class="line">pod/eks-monitor-kube-state-metrics-f85cbcc45-9d5kj         1/1     Running   0          17m</span><br><span class="line">pod/eks-monitor-prometheus-node-exporter-fdr48             1/1     Running   0          17m</span><br><span class="line">pod/eks-monitor-prometheus-node-exporter-h8cf7             1/1     Running   0          17m</span><br><span class="line">pod/eks-monitor-prometheus-node-exporter-vclx7             1/1     Running   0          17m</span><br><span class="line"></span><br><span class="line">NAME                                            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line">service/eks-monitor-kube-prometheu-operator     ClusterIP   10.100.10.252    &lt;none&gt;        443/TCP             17m</span><br><span class="line">service/eks-monitor-kube-prometheu-prometheus   ClusterIP   10.100.170.77    &lt;none&gt;        9090/TCP,8080/TCP   17m</span><br><span class="line">service/eks-monitor-kube-state-metrics          ClusterIP   10.100.148.216   &lt;none&gt;        8080/TCP            17m</span><br><span class="line">service/eks-monitor-prometheus-node-exporter    ClusterIP   10.100.82.224    &lt;none&gt;        9100/TCP            17m</span><br><span class="line"></span><br><span class="line">NAME                                           CLASS   HOSTS   ADDRESS                                                                  PORTS   AGE</span><br><span class="line">ingress.networking.k8s.io/prometheus-ingress   alb     *       k8s-monitori-promethe-36bab4990d-682688554.ap-east-1.elb.amazonaws.com   80      3m58s</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="相关案例或错误排查"><a href="#相关案例或错误排查" class="headerlink" title="相关案例或错误排查"></a>相关案例或错误排查</h2><h3 id="自治模式创建的集群无法部署-Pod-上去"><a href="#自治模式创建的集群无法部署-Pod-上去" class="headerlink" title="自治模式创建的集群无法部署 Pod 上去"></a>自治模式创建的集群无法部署 Pod 上去</h3><p>自治模式（EKS Auto Mode）的集群节点上，默认会为节点配置特定的 <strong>污点（Taints）</strong> ，如果 Pod 配置中没有设置对应的 Tolerations（容忍度），Pod 会无法调度到对应的节点上去。</p>
<p>比如以下 DaemonSet 配置，在 EKS 集群上可能无法成功部署</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">netshoot-daemonset</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">netshoot</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">netshoot</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">netshoot</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># 如果你需要调试节点主机的网络（如查看 NAT 路由），开启下面这行</span></span><br><span class="line">      <span class="comment"># hostNetwork: true </span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">netshoot</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nicolaka/netshoot</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;/bin/bash&quot;</span>]</span><br><span class="line">        <span class="attr">args:</span> [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do sleep 30; done&quot;</span>]</span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">64Mi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看 DaemonSet 状态</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl describe daemonset netshoot-daemonset</span></span><br><span class="line">Name:           netshoot-daemonset</span><br><span class="line">Namespace:      default</span><br><span class="line">Selector:       name=netshoot</span><br><span class="line">Node-Selector:  &lt;none&gt;</span><br><span class="line">Labels:         app=netshoot</span><br><span class="line">Annotations:    deprecated.daemonset.template.generation: 1</span><br><span class="line">Desired Number of Nodes Scheduled: 0</span><br><span class="line">Current Number of Nodes Scheduled: 0</span><br><span class="line">Number of Nodes Scheduled with Up-to-date Pods: 0</span><br><span class="line">Number of Nodes Scheduled with Available Pods: 0</span><br><span class="line">Number of Nodes Misscheduled: 0</span><br><span class="line">Pods Status:  0 Running / 0 Waiting / 0 Succeeded / 0 Failed</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  name=netshoot</span><br><span class="line">  Containers:</span><br><span class="line">   netshoot:</span><br><span class="line">    Image:      nicolaka/netshoot</span><br><span class="line">    Port:       &lt;none&gt;</span><br><span class="line">    Host Port:  &lt;none&gt;</span><br><span class="line">    Command:</span><br><span class="line">      /bin/bash</span><br><span class="line">    Args:</span><br><span class="line">      -c</span><br><span class="line">      while true; do sleep 30; done</span><br><span class="line">    Limits:</span><br><span class="line">      cpu:     100m</span><br><span class="line">      memory:  128Mi</span><br><span class="line">    Requests:</span><br><span class="line">      cpu:         10m</span><br><span class="line">      memory:      64Mi</span><br><span class="line">    Environment:   &lt;none&gt;</span><br><span class="line">    Mounts:        &lt;none&gt;</span><br><span class="line">  Volumes:         &lt;none&gt;</span><br><span class="line">  Node-Selectors:  &lt;none&gt;</span><br><span class="line">  Tolerations:     &lt;none&gt;</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中没有可调度的节点</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Desired Number of Nodes Scheduled: 0</span><br><span class="line">Current Number of Nodes Scheduled: 0</span><br></pre></td></tr></table></figure>

<p>检查节点的 Taints 信息，可以看到节点配置了 Taints <code>effect:NoSchedule key:CriticalAddonsOnly</code> </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get nodes -o custom-columns=NAME:.metadata.name,TAINTS:.spec.taints</span></span><br><span class="line">NAME                  TAINTS</span><br><span class="line">i-008751c   [map[effect:NoSchedule key:CriticalAddonsOnly]]</span><br><span class="line">i-0256d1d   [map[effect:NoSchedule key:CriticalAddonsOnly]]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>为了让 Pod 能调度到此节点上去，可以为 DaemonSet 配置添加 Tolerations</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">netshoot-daemonset</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">netshoot</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">netshoot</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># --- 添加以下容忍度以匹配你的节点污点 ---</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;CriticalAddonsOnly&quot;</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">      <span class="comment"># 如果你希望它更“强悍”，能上任何节点，也可以用下面这个全能配置：</span></span><br><span class="line">      <span class="comment"># - operator: &quot;Exists&quot; </span></span><br><span class="line">      <span class="comment"># ---------------------------------------</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">netshoot</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nicolaka/netshoot</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;/bin/bash&quot;</span>]</span><br><span class="line">        <span class="attr">args:</span> [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do sleep 30; done&quot;</span>]</span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">64Mi</span></span><br></pre></td></tr></table></figure>

<h3 id="EKS-部署-Nginx-服务并在互联网上可以访问"><a href="#EKS-部署-Nginx-服务并在互联网上可以访问" class="headerlink" title="EKS 部署 Nginx 服务并在互联网上可以访问"></a>EKS 部署 Nginx 服务并在互联网上可以访问</h3><p>本示例中的 Worker Nodes 和 Pod 子网为 <strong>私有子网 (Private Subnet)，通过 NAT Gateway 访问互联网</strong> 。</p>
<p>首先要确保 EKS 集群的 AWS Load Balancer Controller 正常安装，才能通过 ALB 对外提供服务。</p>
<p>参考以下配置文件，部署 Nginx 服务相关资源</p>
<figure class="highlight yaml"><figcaption><span>nginx.yaml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># 容忍度配置：确保 Pod 能调度到带有 CriticalAddonsOnly 污点的节点上</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># 负载均衡器是面向互联网的</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/scheme:</span> <span class="string">internet-facing</span></span><br><span class="line">    <span class="comment"># 目标类型：在 Auto Mode 下推荐使用 ip 模式，直接转发给 Pod</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/target-type:</span> <span class="string">ip</span></span><br><span class="line">    <span class="comment"># 自动关联你之前规划的子网（可选，通常通过标签 kubernetes.io/role/internal-elb = 1 自动发现）</span></span><br><span class="line">    <span class="comment"># alb.ingress.kubernetes.io/subnets: subnet-xxxx, subnet-yyyy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 指定使用 aws ALB</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">alb</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用以下命令部署服务</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl apply -f nginx.yaml</span><br></pre></td></tr></table></figure>

<p>部署后检查服务相关服务状态</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pods -o wide</span></span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE   IP              NODE                  NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-deployment-5746cdf7c8-9vw9w   1/1     Running   0          41h   172.31.129.84   i-02d6d78308d456d1d   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-deployment-5746cdf7c8-j772t   1/1     Running   0          41h   172.31.129.83   i-02d6d78308d456d1d   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get services -o wide</span></span><br><span class="line">NAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE     SELECTOR</span><br><span class="line">kubernetes      ClusterIP   10.100.0.1       &lt;none&gt;        443/TCP   3d15h   &lt;none&gt;</span><br><span class="line">nginx-service   ClusterIP   10.100.197.117   &lt;none&gt;        80/TCP    41h     app=nginx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get endpointslice -o wide</span></span><br><span class="line">NAME                  ADDRESSTYPE   PORTS   ENDPOINTS                      AGE</span><br><span class="line">kubernetes            IPv4          443     172.31.138.166,172.31.78.162   3d15h</span><br><span class="line">nginx-service-dnckv   IPv4          80      172.31.129.83,172.31.129.84    41h</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get ingress -o wide</span></span><br><span class="line">NAME            CLASS   HOSTS   ADDRESS                                                                  PORTS   AGE</span><br><span class="line">nginx-ingress   alb     *       k8s-default-nginxing-f6eb483edf-2017046049.ap-east-1.elb.amazonaws.com   80      41h</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>部署成功后，AWS Load Balancer Controller（LBC） 会为服务生成 ALB（AWS Load Balancer）地址，通过此地址（<code>k8s-default-nginxing-f6eb483edf-2017046049.ap-east-1.elb.amazonaws.com</code>） 即可在互联网上访问此服务。</p>
<p>如果需要绑定自己的域名，参考以下步骤：</p>
<ul>
<li><p>如果域名 NS 指向 AWS Route 53（域名解析在 AWS Route 53），在 Route 53 选择自有域名，添加&#x2F;修改解析</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Record Type: A</span><br><span class="line">Alias：✅ 打开</span><br><span class="line">Alias target： ALB DNS(`k8s-default-nginxing-f6eb483edf-2017046049.ap-east-1.elb.amazonaws.com`)</span><br><span class="line">Routing policy：Simple</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果域名 NS 不是指向 AWS Route 53（域名解析未在 AWS Route 53），就用 CNAME</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Record Type: CNAME</span><br><span class="line">CNAME Value： ALB DNS(`k8s-default-nginxing-f6eb483edf-2017046049.ap-east-1.elb.amazonaws.com`)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>本示例中的 Ingress 未指定域名(<code>HOSTS: *</code>)，任意域名解析到此 ALB 都会命中 <code>nginx</code> 服务</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"> kubectl get ingress -o wide</span><br><span class="line">NAME            CLASS   HOSTS   ADDRESS                                                                  PORTS   AGE</span><br><span class="line">nginx-ingress   alb     *       k8s-default-nginxing-f6eb483edf-2017046049.ap-east-1.elb.amazonaws.com   80      41h</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果需要为 Ingress 绑定特定域名，使用 <code>host</code> 参数，如 <code>host: www.example.com</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># 负载均衡器是面向互联网的</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/scheme:</span> <span class="string">internet-facing</span></span><br><span class="line">    <span class="comment"># 目标类型：在 Auto Mode 下推荐使用 ip 模式，直接转发给 Pod</span></span><br><span class="line">    <span class="attr">alb.ingress.kubernetes.io/target-type:</span> <span class="string">ip</span></span><br><span class="line">    <span class="comment"># 自动关联你之前规划的子网（可选，通常通过标签 kubernetes.io/role/internal-elb = 1 自动发现）</span></span><br><span class="line">    <span class="comment"># alb.ingress.kubernetes.io/subnets: subnet-xxxx, subnet-yyyy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 指定使用 aws ALB</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">alb</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">www.example.com</span></span><br></pre></td></tr></table></figure>

<p>绑定特定域名后查看 Ingress</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get ingress</span></span><br><span class="line">NAME            CLASS   HOSTS           ADDRESS</span><br><span class="line">nginx-ingress   alb     www.example.com k8s-default-nginxing-xxx.elb.amazonaws.com</span><br></pre></td></tr></table></figure>
<p>此时，只有 <code>www.example.com</code> 可以访问，其他域名访问会返回 404.</p>
<h3 id="ALB-域名无法访问排查步骤"><a href="#ALB-域名无法访问排查步骤" class="headerlink" title="ALB 域名无法访问排查步骤"></a>ALB 域名无法访问排查步骤</h3><p>部署了 <code>IngressClassName: alb</code> 类型的 Ingress 后，无法正常访问</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectget ingress -A -o wide</span></span><br><span class="line">NAMESPACE   NAME     CLASS   HOSTS   ADDRESS                                                               PORTS   AGE</span><br><span class="line">argocd      argocd   alb     *       k8s-argocd-argocd-8e8cb645d5-1951055800.ap-east-1.elb.amazonaws.com   80      122m</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时可以先检查 AWS Load Balancer 中对应自由的状态，登录 <strong>AWS 控制台 -&gt; EC2 -&gt; Load Balancers</strong> ，检查对应的 ALB 状态： </p>
<ul>
<li>ALB 的 State 是否为 <code>Active</code> ，如果是 <code>Provisioning</code> 或 <code>Failed</code> ，说明还在创建中或配置有误。<br>  <img src="https://i.csms.tech/img_414.png"></li>
<li>检查监听器 (Listeners) 是否监听了对应的端口<br>  <img src="https://i.csms.tech/img_415.png"></li>
<li>检查安全组 (Security Groups) 是否放通了相关端口</li>
<li>检查 <strong>Resource Map</strong> ，看后端 Targets 是否检测正常<br>  <img src="https://i.csms.tech/img_416.png"></li>
<li>在 <strong>AWS 控制台 -&gt; EC2 -&gt; Target Groups</strong> 中检查相关的后端 Target （Pod）是否正常<br>  <img src="https://i.csms.tech/img_417.png"><br>  <img src="https://i.csms.tech/img_418.png"></li>
</ul>
<h3 id="Pod-挂载-EBS-PV-失败"><a href="#Pod-挂载-EBS-PV-失败" class="headerlink" title="Pod 挂载 EBS PV 失败"></a>Pod 挂载 EBS PV 失败</h3><p>Pod 状态不正常</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get PODS -n monitoring</span></span><br><span class="line">NAME                                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">prometheus-eks-monitor-kube-prometheu-prometheus-0     0/2     Pending   0          13m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl describe pod -n monitoring prometheus-eks-monitor-kube-prometheu-prometheus-0</span></span><br><span class="line">Name:               prometheus-eks-monitor-kube-prometheu-prometheus-0</span><br><span class="line">Namespace:          monitoring</span><br><span class="line">Priority:           0</span><br><span class="line">Service Account:    eks-monitor-kube-prometheu-prometheus</span><br><span class="line">Node:               &lt;none&gt;</span><br><span class="line">Labels:             app.kubernetes.io/instance=eks-monitor-kube-prometheu-prometheus</span><br><span class="line">                    app.kubernetes.io/managed-by=prometheus-operator</span><br><span class="line">                    app.kubernetes.io/name=prometheus</span><br><span class="line">                    app.kubernetes.io/version=3.9.1</span><br><span class="line">                    apps.kubernetes.io/pod-index=0</span><br><span class="line">                    controller-revision-hash=prometheus-eks-monitor-kube-prometheu-prometheus-569cf67d6d</span><br><span class="line">                    operator.prometheus.io/name=eks-monitor-kube-prometheu-prometheus</span><br><span class="line">                    operator.prometheus.io/shard=0</span><br><span class="line">                    prometheus=eks-monitor-kube-prometheu-prometheus</span><br><span class="line">                    statefulset.kubernetes.io/pod-name=prometheus-eks-monitor-kube-prometheu-prometheus-0</span><br><span class="line">Annotations:        kubectl.kubernetes.io/default-container: prometheus</span><br><span class="line">Status:             Pending</span><br><span class="line">...</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age   From               Message</span><br><span class="line">  ----     ------            ----  ----               -------</span><br><span class="line">  Warning  FailedScheduling  4m    default-scheduler  running PreBind plugin &quot;VolumeBinding&quot;: binding volumes: context deadline exceeded</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Pod 状态 <code>Pending</code> ，报错 <code>running PreBind plugin &quot;VolumeBinding&quot;: binding volumes: context deadline exceeded</code></p>
<p>错误指向 <strong>存储绑定失败</strong> ，接着检查存储相关</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get STORAGECLASS</span></span><br><span class="line">NAME   PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">gp2    kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   false                  7d</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pvc -n monitoring</span></span><br><span class="line">NAME                                                                                                     STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE</span><br><span class="line">prometheus-eks-monitor-kube-prometheu-prometheus-db-prometheus-eks-monitor-kube-prometheu-prometheus-0   Pending                                      gp2            &lt;unset&gt;                 16m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl describe pvc -n monitoring prometheus-eks-monitor-kube-prometheu-prometheus-db-prometheus-eks-monitor-kube-prometheu-prometheus-0</span></span><br><span class="line">Name:          prometheus-eks-monitor-kube-prometheu-prometheus-db-prometheus-eks-monitor-kube-prometheu-prometheus-0</span><br><span class="line">Namespace:     monitoring</span><br><span class="line">StorageClass:  gp2</span><br><span class="line">Status:        Pending</span><br><span class="line">Volume:        </span><br><span class="line">Labels:        app.kubernetes.io/instance=eks-monitor-kube-prometheu-prometheus</span><br><span class="line">               app.kubernetes.io/managed-by=prometheus-operator</span><br><span class="line">               app.kubernetes.io/name=prometheus</span><br><span class="line">               operator.prometheus.io/name=eks-monitor-kube-prometheu-prometheus</span><br><span class="line">               operator.prometheus.io/shard=0</span><br><span class="line">               prometheus=eks-monitor-kube-prometheu-prometheus</span><br><span class="line">Annotations:   volume.beta.kubernetes.io/storage-provisioner: ebs.csi.aws.com</span><br><span class="line">               volume.kubernetes.io/selected-node: i-088a321d769903fec</span><br><span class="line">               volume.kubernetes.io/storage-provisioner: ebs.csi.aws.com</span><br><span class="line">Finalizers:    [kubernetes.io/pvc-protection]</span><br><span class="line">Capacity:      </span><br><span class="line">Access Modes:  </span><br><span class="line">VolumeMode:    Filesystem</span><br><span class="line">Used By:       prometheus-eks-monitor-kube-prometheu-prometheus-0</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason                Age                 From                         Message</span><br><span class="line">  ----    ------                ----                ----                         -------</span><br><span class="line">  Normal  WaitForFirstConsumer  16m                 persistentvolume-controller  waiting for first consumer to be created before binding</span><br><span class="line">  Normal  ExternalProvisioning  84s (x63 over 16m)  persistentvolume-controller  Waiting for a volume to be created either by the external provisioner &#x27;ebs.csi.aws.com&#x27; or manually by the system administrator. If volume creation is delayed, please verify that the provisioner is running and correctly registered.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>EKS 默认不包含 EBS 驱动。如果没有驱动，Kubernetes 无法调用 AWS API 去创建 EBS 磁盘。 <strong>检查 AWS EBS CSI 驱动是否运行</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pods -n kube-system -l app.kubernetes.io/name=aws-ebs-csi-driver</span></span><br><span class="line">No resources found in kube-system namespace.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>以上结果说明 EKS 中未安装 EBS CSI 驱动，需要为 EKS 安装这个 Add-on</p>
<p>加入 PVC 报错信息如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Events:</span><br><span class="line">  Type     Reason                Age                     From                                                                                      Message</span><br><span class="line">  ----     ------                ----                    ----                                                                                      -------</span><br><span class="line">  Normal   ExternalProvisioning  3m52s (x463 over 119m)  persistentvolume-controller                                                               Waiting for a volume to be created either by the external provisioner &#x27;ebs.csi.aws.com&#x27; or manually by the system administrator. If volume creation is delayed, please verify that the provisioner is running and correctly registered.</span><br><span class="line">  Normal   Provisioning          2m34s (x15 over 49m)    ebs.csi.aws.com_ebs-csi-controller-6849f9b895-84wdt_d7687021-7146-4198-ba00-c42d48ee814b  External provisioner is provisioning volume for claim &quot;monitoring/prometheus-eks-monitor-kube-prometheu-prometheus-db-prometheus-eks-monitor-kube-prometheu-prometheus-0&quot;</span><br><span class="line">  Warning  ProvisioningFailed    2m34s (x15 over 49m)    ebs.csi.aws.com_ebs-csi-controller-6849f9b895-84wdt_d7687021-7146-4198-ba00-c42d48ee814b  error generating accessibility requirements: no topology key found for node i-088a321d769903fec</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>说明 AWS EBS CSI 驱动工作正常，但是 EBS CSI 驱动想要创建磁盘，但它 <strong>不知道这个节点到底在哪个可用区 (Availability Zone)</strong> 。EBS 磁盘是不能跨可用区挂载的。正常情况下，节点应该带有 <code>topology.ebs.csi.aws.com/zone</code> 标签，驱动靠这个标签来决定在哪个 AZ 创建磁盘。</p>
<p>这种情况在 <strong>手动创建节点</strong> 或 <strong>EBS CSI 驱动在节点加入集群后才安装</strong> 时经常发生。节点上的 CSI 插件没有正确上报拓扑信息。</p>
<p>检查 <code>StorageClass</code> 配置</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get storageclass gp2 -o yaml</span></span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubectl.kubernetes.io/last-applied-configuration: |</span><br><span class="line">      &#123;&quot;apiVersion&quot;:&quot;storage.k8s.io/v1&quot;,&quot;kind&quot;:&quot;StorageClass&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;gp2&quot;&#125;,&quot;parameters&quot;:&#123;&quot;fsType&quot;:&quot;ext4&quot;,&quot;type&quot;:&quot;gp2&quot;&#125;,&quot;provisioner&quot;:&quot;kubernetes.io/aws-ebs&quot;,&quot;volumeBindingMode&quot;:&quot;WaitForFirstConsumer&quot;&#125;</span><br><span class="line">  creationTimestamp: &quot;2026-02-06T09:35:14Z&quot;</span><br><span class="line">  name: gp2</span><br><span class="line">  resourceVersion: &quot;258&quot;</span><br><span class="line">  uid: 4cde6368-d05a-44da-addc-9fca4d7c6fb0</span><br><span class="line">parameters:</span><br><span class="line">  fsType: ext4</span><br><span class="line">  type: gp2</span><br><span class="line">provisioner: kubernetes.io/aws-ebs</span><br><span class="line">reclaimPolicy: Delete</span><br><span class="line">volumeBindingMode: WaitForFirstConsumer</span><br></pre></td></tr></table></figure>

<p>其中的 <code>provisioner: kubernetes.io/aws-ebs</code> ，这是过时的旧的内建驱动，已被废弃，且无法识别 CSI 驱动特有的拓扑标签（即报错中的 <code>topology.ebs.csi.eks.amazonaws.com/zone</code> ）。它在较新的 K8s 版本中兼容性较差。 <strong>使用新的 EBS CSI 驱动 ( <code>ebs.csi.aws.com</code> )</strong></p>
<p><strong>删除旧的 storageclass gp2</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl delete storageclass gp2</span></span><br><span class="line">storageclass.storage.k8s.io &quot;gp2&quot; deleted</span><br></pre></td></tr></table></figure>
<p><strong>创建正确的 CSI StorageClass</strong> ，使用 <code>provisioner: ebs.csi.aws.com</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gp3</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">ebs.csi.aws.com</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">gp3</span></span><br><span class="line">  <span class="attr">fsType:</span> <span class="string">ext4</span></span><br><span class="line"><span class="attr">volumeBindingMode:</span> <span class="string">WaitForFirstConsumer</span></span><br></pre></td></tr></table></figure>

<p>查看新的 <code>StorageClass</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get storageclass</span></span><br><span class="line">NAME      PROVISIONER       RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">gp3-csi   ebs.csi.aws.com   Delete          WaitForFirstConsumer   false                  5s</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>之后 PVC 依旧报错</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Events:</span><br><span class="line">  Type     Reason                Age                 From                                                                                      Message</span><br><span class="line">  ----     ------                ----                ----                                                                                      -------</span><br><span class="line">  Normal   WaitForPodScheduled   107s                persistentvolume-controller                                                               waiting for pod prometheus-eks-monitor-kube-prometheu-prometheus-0 to be scheduled</span><br><span class="line">  Normal   Provisioning          44s (x7 over 107s)  ebs.csi.aws.com_ebs-csi-controller-6849f9b895-tpbhp_e1da4dcf-1ddf-49f7-9b83-b3973b11647f  External provisioner is provisioning volume for claim &quot;monitoring/prometheus-eks-monitor-kube-prometheu-prometheus-db-prometheus-eks-monitor-kube-prometheu-prometheus-0&quot;</span><br><span class="line">  Warning  ProvisioningFailed    44s (x7 over 107s)  ebs.csi.aws.com_ebs-csi-controller-6849f9b895-tpbhp_e1da4dcf-1ddf-49f7-9b83-b3973b11647f  error generating accessibility requirements: no topology key found for node i-019f302416033febc</span><br><span class="line">  Normal   ExternalProvisioning  1s (x9 over 107s)   persistentvolume-controller                                                               Waiting for a volume to be created either by the external provisioner &#x27;ebs.csi.aws.com&#x27; or manually by the system administrator. If volume creation is delayed, please verify that the provisioner is running and correctly registered.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这大概率是因为只有 <code>ebs-csi-controller</code> 而没有 <code>ebs-csi-node</code> 。CSI 驱动依赖一个叫做 CSINode 的集群资源来识别节点支持哪些驱动及其所在区域。确保每个节点对应的 <code>ebs-csi-node-xxxx</code> 都是 Running 状态。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pods -n kube-system</span> </span><br><span class="line">NAME                                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">aws-load-balancer-controller-949f9d848-8d8nt   1/1     Running   0          45m</span><br><span class="line">aws-load-balancer-controller-949f9d848-nzkz7   1/1     Running   0          45m</span><br><span class="line">ebs-csi-controller-6849f9b895-fx42c            6/6     Running   0          43m</span><br><span class="line">ebs-csi-controller-6849f9b895-tpbhp            6/6     Running   0          45m</span><br><span class="line">metrics-server-5bb789d889-7n2vv                1/1     Running   0          45m</span><br><span class="line">metrics-server-5bb789d889-vx5bl                1/1     Running   0          44m</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>没有 <code>ebs-csi-node</code> DaemonSet</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="../tags/Aws/" rel="tag"><i class="fa fa-tag"></i> Aws</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="../20260122164301/" rel="prev" title="Docker compose 部署 Confluence 和 Jira">
                  <i class="fa fa-chevron-left"></i> Docker compose 部署 Confluence 和 Jira
                </a>
            </div>
            <div class="post-nav-item">
                <a href="../20260207135211/" rel="next" title="Amazon AWS 概念及相关操作步骤">
                  Amazon AWS 概念及相关操作步骤 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">COSMOS</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="300" alpha="0.3" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="../js/comments.js"></script><script src="../js/utils.js"></script><script src="../js/motion.js"></script><script src="../js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="../js/third-party/search/local-search.js"></script>




  <script src="../js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"fl9999","repo":"fl9999.github.io","client_id":"a11bf6f7860762b725b5","client_secret":"a99046105f8bddc72ec718d54dc3fd7f22070821","admin_user":"fl9999","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"d41d8cd98f00b204e9800998ecf8427e"}</script>
<script src="../js/third-party/comments/gitalk.js"></script>

</body>
</html>
